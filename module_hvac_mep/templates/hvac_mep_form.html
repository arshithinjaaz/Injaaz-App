<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>HVAC & MEP - Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .signature-pad { border:1px solid #ccc; width:100%; height:120px; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h2>HVAC & MEP Form</h2>

    <form id="mainForm" enctype="multipart/form-data" onsubmit="return false;">
      <div class="row g-3">
        <div class="col-md-6 mb-3">
          <label for="site_name" class="form-label">Site name</label>
          <input id="site_name" name="site_name" class="form-control" required>
        </div>

        <div class="col-md-6 mb-3">
          <label for="visit_date" class="form-label">Date</label>
          <input id="visit_date" name="visit_date" type="date" class="form-control" required>
        </div>

        <div class="col-12 mb-3">
          <label for="assetSelect" class="form-label">Asset</label>
          <select id="assetSelect" class="form-select"></select>
        </div>

        <div class="col-md-6 mb-3">
          <label for="systemSelect" class="form-label">System</label>
          <select id="systemSelect" class="form-select" disabled></select>
        </div>

        <div class="col-md-6 mb-3">
          <label for="descriptionSelect" class="form-label">Description</label>
          <select id="descriptionSelect" class="form-select" disabled></select>
        </div>

        <div class="col-12 mb-3">
          <label class="form-label">Technician Signature</label>
          <canvas id="techSignaturePad" class="signature-pad"></canvas>
          <input type="hidden" id="techSignatureData" name="tech_signature">
        </div>

        <div class="col-12 mb-3">
          <label class="form-label">Operation Manager Signature</label>
          <canvas id="opManSignaturePad" class="signature-pad"></canvas>
          <input type="hidden" id="opManSignatureData" name="opMan_signature">
        </div>

        <div class="col-12 mb-3">
          <label for="photos" class="form-label">Photos</label>
          <input id="photos" name="photos" type="file" multiple class="form-control">
        </div>

        <div class="col-12 d-flex gap-2">
          <button type="button" id="prevButton" class="btn btn-secondary" disabled>Previous</button>
          <button type="button" id="nextButton" class="btn btn-success">Next / Submit</button>
          <button type="button" id="clearTech" class="btn btn-outline-secondary">Clear Tech Sig</button>
          <button type="button" id="clearOp" class="btn btn-outline-secondary">Clear Op Sig</button>
        </div>

        <div class="col-12">
          <div id="statusBox" class="mt-3"></div>
        </div>
      </div>
    </form>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

  <!-- Module-specific static: dropdown helper (served from the blueprint static) -->
  <script src="{{ url_for('hvac_mep_bp.static', filename='dropdown_init.js') }}"></script>
  <!-- App-level helpers (form.js) - keep if present in your top-level static/ -->
  <script src="{{ url_for('static', filename='form.js') }}"></script>

  <script>
    // compute module base from blueprint index
    const modulePrefix = "{{ url_for('hvac_mep_bp.index') }}".replace('/form','');

    // simple signature pads initialization (fallback if form.js doesn't provide)
    function initSignaturePads() {
      const techCanvas = document.getElementById('techSignaturePad');
      const opCanvas = document.getElementById('opManSignaturePad');
      const techPad = new SignaturePad(techCanvas);
      const opPad = new SignaturePad(opCanvas);

      // Resize canvases to device pixel ratio
      function resizeCanvas(canvas, pad) {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const width = canvas.offsetWidth * ratio;
        const height = canvas.offsetHeight * ratio;
        canvas.width = width;
        canvas.height = height;
        canvas.getContext('2d').scale(ratio, ratio);
        if (!pad.isEmpty()) {
          // no-op: pad data will be lost on resize; in production consider using toDataURL/fromDataURL
        }
      }
      resizeCanvas(techCanvas, techPad);
      resizeCanvas(opCanvas, opPad);
      window.addEventListener('resize', () => {
        resizeCanvas(techCanvas, techPad);
        resizeCanvas(opCanvas, opPad);
      });

      // expose simple helpers
      document.getElementById('clearTech').addEventListener('click', () => { techPad.clear(); document.getElementById('techSignatureData').value=''; });
      document.getElementById('clearOp').addEventListener('click', () => { opPad.clear(); document.getElementById('opManSignatureData').value=''; });

      return { techPad, opPad };
    }

    (function(){
      const form = document.getElementById('mainForm');
      const statusBox = document.getElementById('statusBox');
      const pads = initSignaturePads();

      // wire dropdown helper already injected by dropdown_init.js

      // helper: capture signatures into hidden inputs
      function captureSignatures() {
        const techData = pads.techPad.isEmpty() ? '' : pads.techPad.toDataURL('image/png');
        const opData = pads.opPad.isEmpty() ? '' : pads.opPad.toDataURL('image/png');
        document.getElementById('techSignatureData').value = techData;
        document.getElementById('opManSignatureData').value = opData;
      }

      async function postFormData(url, formData) {
        const res = await fetch(url, { method: 'POST', body: formData });
        if (!res.ok) throw new Error('Submission failed: ' + res.statusText);
        return res.json();
      }

      // nextButton triggers submit flow
      document.getElementById('nextButton').addEventListener('click', async () => {
        try {
          statusBox.innerText = "Preparing submission...";
          // capture signatures
          captureSignatures();

          // build multipart/formdata:
          const fd = new FormData();
          // fields
          new FormData(form).forEach((v,k) => fd.append(k,v));
          // photos
          const files = document.getElementById('photos').files;
          for (let i=0;i<files.length;i++) fd.append('photo', files[i]);

          // Post to module submit endpoint (we expect JSON endpoints; adapt if your backend differs)
          const submitUrl = modulePrefix + '/submit';
          statusBox.innerText = "Uploading...";
          const json = await postFormData(submitUrl, fd);

          if (json && json.job_id) {
            statusBox.innerText = "Queued job: " + json.job_id;
            // poll status (poll endpoint implemented server-side at /status/<job_id>)
            const pollUrl = modulePrefix + '/status/' + json.job_id;
            const interval = 1500;
            const maxAttempts = 200;
            let attempts = 0;
            const p = setInterval(async () => {
              attempts++;
              try {
                const r = await fetch(pollUrl);
                if (!r.ok) throw new Error('Status fetch failed');
                const body = await r.json();
                statusBox.innerText = `State: ${body.state}  progress: ${body.progress || 0}%`;
                if (body.state === 'done' || body.state === 'failed') {
                  clearInterval(p);
                  if (body.state === 'done') {
                    const links = (body.results || []).map(x => `<a href="${x.url}" target="_blank">${x.filename}</a>`).join('<br>');
                    statusBox.innerHTML = 'Done.<br>' + links;
                  } else {
                    statusBox.innerText = 'Job failed: ' + JSON.stringify(body.results || body);
                  }
                }
                if (attempts > maxAttempts) {
                  clearInterval(p);
                  statusBox.innerText = 'Timeout waiting for job completion.';
                }
              } catch (err) {
                clearInterval(p);
                statusBox.innerText = 'Polling error: ' + err.message;
              }
            }, interval);
          } else {
            statusBox.innerText = 'Unexpected response: ' + JSON.stringify(json);
          }
        } catch (e) {
          statusBox.innerText = "Error: " + e.message;
        }
      });
    })();
  </script>
</body>
</html>