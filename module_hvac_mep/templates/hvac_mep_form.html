<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>HVAC & MEP - Inspection Form</title>
  <meta name="description" content="HVAC and MEP site inspection form - Works offline">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#125435">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Injaaz HVAC">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
  <script src="{{ url_for('static', filename='pwa-install.js') }}" defer></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='photo_upload_queue.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='mobile_responsive.css') }}">
  <script src="{{ url_for('static', filename='mobile_utils.js') }}" defer></script>
  <script src="{{ url_for('static', filename='production_logger.js') }}" defer></script>
  <script src="{{ url_for('static', filename='photo_upload_queue.js') }}"></script>
  <script src="{{ url_for('static', filename='photo_queue_ui.js') }}"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #125435;
      --primary-light: #1a7a4d;
      --primary-dark: #0d3d24;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-light: #9ca3af;
      --border-light: #e5e7eb;
      --bg-page: #fafafa;
      --white: #ffffff;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    body {
      background: var(--bg-page);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 0;
      margin: 0;
      line-height: 1.5;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Clean Navigation Bar */
    .navbar {
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 0.875rem 0;
      margin-bottom: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(18, 84, 53, 0.1);
    }
    
    .navbar-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      align-items: center;
      gap: 2rem;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary) !important;
      text-decoration: none;
      letter-spacing: -0.5px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .navbar-brand img {
      height: 32px;
      width: auto;
    }
    
    .navbar-brand:hover {
      transform: translateY(-1px);
      opacity: 0.85;
    }
    
    .module-badge {
      font-size: 0.875rem;
      font-weight: 600;
      color: #6c757d;
      padding: 0.5rem 1rem;
      background: #f8f9fa;
      border-radius: 6px;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }
    
    .navbar-nav {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-left: auto;
    }
    
    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #495057;
      background: #ffffff;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      white-space: nowrap;
    }
    
    .nav-btn:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .nav-btn.next-btn {
      color: #0d6efd;
      border-color: #0d6efd;
    }
    
    .nav-btn.next-btn:hover {
      background: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    
    @media (max-width: 768px) {
      .navbar-container {
        padding: 0.75rem 1rem;
        gap: 1rem;
        flex-wrap: wrap;
      }
      
      .navbar-brand {
        font-size: 1.2rem;
      }
      
      .navbar-brand img {
        height: 28px;
      }
      
      .module-badge {
        font-size: 0.8125rem;
        padding: 0.375rem 0.75rem;
      }
      
      .navbar-brand span {
        font-size: 1rem;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .navbar-nav {
        width: 100%;
        justify-content: flex-end;
        margin-left: 0;
        margin-top: 0.5rem;
        gap: 0.5rem;
      }
      
      .nav-btn {
        flex: 0 0 auto;
        justify-content: center;
        font-size: 0.8125rem;
        padding: 0.625rem 0.75rem;
        min-height: 44px;
      }
      
      .container {
        padding: 1.25rem 1rem;
        margin: 0.75rem auto;
      }
      
      h2 {
        font-size: 1.5rem;
      }
    }
    
    @media (max-width: 480px) {
      .navbar-brand span {
        font-size: 0.9rem;
        max-width: 140px;
      }
      
      .nav-btn {
        font-size: 0.75rem;
        padding: 0.5rem;
      }
      
      .container {
        padding: 1rem 0.75rem;
      }
      
      h2 {
        font-size: 1.35rem;
      }
    }
    
    /* Clean, spacious container */
    .container {
      max-width: 1200px;
      background: var(--white);
      border-radius: 8px;
      padding: 2rem 2.5rem;
      box-shadow: var(--shadow-sm);
      margin: 1.5rem auto;
      border: 1px solid var(--border-light);
    }
    
    /* Minimal typography */
    h2 {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 0.375rem;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }
    
    h5 {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 1rem;
      margin-top: 2rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-light);
      letter-spacing: -0.2px;
    }
    
    .text-muted {
      color: var(--text-secondary) !important;
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    /* Minimal form labels */
    .form-label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.875rem;
      margin-bottom: 0.375rem;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.75rem;
    }
    
    /* Clean inputs with subtle borders */
    .form-control, .form-select {
      border: 1px solid var(--border-light);
      border-radius: 4px;
      padding: 0.625rem 0.875rem;
      transition: all 0.15s ease;
      font-size: 0.9375rem;
      background: var(--white);
      color: var(--text-primary);
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 84, 53, 0.06);
      outline: none;
    }
    
    /* Minimal flat buttons */
    .btn {
      border-radius: 4px;
      padding: 0.625rem 1.25rem;
      font-weight: 600;
      border: none;
      transition: all 0.15s ease;
      font-size: 0.875rem;
      letter-spacing: 0.2px;
    }
    
    .btn-success {
      background: var(--primary);
      color: white;
    }
    
    .btn-success:hover {
      background: var(--primary-dark);
      box-shadow: 0 2px 8px rgba(18, 84, 53, 0.2);
    }
    
    .btn-outline-secondary {
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      background: transparent;
    }
    
    .btn-outline-secondary:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
      background: #fafafa;
    }
    
    .btn-outline-danger {
      border: 1px solid #dc3545;
      color: #dc3545;
      background: transparent;
    }
    
    .btn-outline-danger:hover {
      background: #dc3545;
      color: white;
    }
    
    /* Upload Progress Modal */
    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .upload-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .upload-progress-bar {
      height: 30px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .upload-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #125435, #1a7a4f);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    /* Thumbnail Container */
    .photo-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 1rem;
      padding: 0.5rem;
      border: 1px dashed var(--border-light);
      border-radius: 4px;
      min-height: 60px;
    }
    
    .photo-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 4px;
      overflow: hidden;
      border: 2px solid var(--border-light);
    }
    
    .photo-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-preview-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #dc3545;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .photo-preview-remove:hover {
      background: #c82333;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #e9ecef;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 1.5rem;
      font-size: 1.125rem;
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .loading-subtitle {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    /* File size warning */
    .file-warning {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }
    
    .btn-lg {
      padding: 0.75rem 1.75rem;
      font-size: 0.9375rem;
    }
    
    /* Signature pad - Standardized size */
    .signature-pad,
    canvas.signature-pad,
    #techSignaturePad,
    #opManSignaturePad {
      border: 2px solid var(--border-light);
      border-radius: 6px;
      width: 100%;
      max-width: 500px;
      height: 180px;
      min-height: 180px;
      background: #ffffff;
      cursor: crosshair;
      display: block;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Ensure canvas doesn't stretch */
    .signature-pad,
    canvas.signature-pad {
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    
    .signature-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .signature-hint {
      font-size: 0.75rem;
      color: var(--text-light);
      font-weight: 400;
    }
    
    /* Clean item cards */
    .item-card {
      border: 1px solid var(--border-light);
      padding: 1.25rem;
      border-radius: 4px;
      margin-bottom: 0.875rem;
      background: var(--white);
      transition: all 0.15s ease;
    }
    
    .item-card:hover {
      box-shadow: var(--shadow-sm);
    }
    
    /* Minimal thumbnails */
    .thumb-container {
      display: inline-block;
      position: relative;
      margin: 3px;
    }
    
    .thumb {
      width: 90px;
      height: 60px;
      object-fit: cover;
      border: 1px solid var(--border-light);
      border-radius: 3px;
      transition: all 0.15s;
    }
    
    .thumb:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .thumb-delete {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Minimal download section */
    .download-links {
      background: #f8faf9;
      border: 1px solid var(--primary);
      padding: 1.5rem;
      border-radius: 4px;
      margin-top: 1.5rem;
    }
    
    .download-links h5 {
      color: var(--primary-dark);
      margin-bottom: 0.875rem;
      border: none;
      margin-top: 0;
      font-size: 1rem;
    }
    
    .download-links a {
      display: block;
      margin: 0.5rem 0;
      padding: 0.75rem 1rem;
      background: var(--white);
      border-radius: 4px;
      text-decoration: none;
      color: var(--primary);
      font-weight: 600;
      transition: all 0.15s ease;
      border: 1px solid var(--border-light);
      font-size: 0.875rem;
    }
    
    .download-links a:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Minimal drop zone */
    .drop-zone {
      border: 2px dashed var(--border-light);
      border-radius: 4px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: var(--primary);
      background: #f8faf9;
    }
    
    .drop-zone-content {
      color: var(--text-secondary);
      font-size: 0.9375rem;
    }
    
    .drop-zone-content strong {
      display: block;
      color: var(--text-primary);
      margin-bottom: 0.375rem;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .drop-zone-content small {
      display: block;
      font-size: 0.8125rem;
      margin-top: 0.375rem;
      color: var(--text-light);
    }
    
    .upload-progress {
      margin-top: 0.875rem;
      display: none;
    }
    
    .progress {
      height: 4px;
      border-radius: 2px;
      background: var(--border-light);
    }
    
    .progress-bar {
      border-radius: 2px;
    }
    
    .photo-count {
      color: var(--text-secondary);
      font-size: 0.8125rem;
      margin-top: 0.5rem;
      padding: 0.375rem 0.75rem;
      background: var(--white);
      border-radius: 3px;
      display: inline-block;
      border: 1px solid var(--border-light);
      font-weight: 500;
    }
    
    .photo-count.warning {
      background: #fff8e1;
      border-color: #ffa000;
      color: #664d03;
    }
    
    .photo-count.danger {
      background: #ffebee;
      border-color: #d32f2f;
      color: #5f2120;
    }
    
    .alert {
      border-radius: 4px;
      border: none;
      font-size: 0.875rem;
      padding: 0.875rem 1rem;
    }
    
    .progress-bar-container {
      margin-top: 1rem;
    }
    
    /* Empty state */
    .items-list .text-muted {
      padding: 1.5rem;
      text-align: center;
      background: #fafafa;
      border: 1px dashed var(--border-light);
      border-radius: 4px;
      font-size: 0.9375rem;
    }
    
    /* Section spacing */
    .mb-section {
      margin-bottom: 2.5rem;
    }
    
    /* Grid improvements */
    .row {
      --bs-gutter-x: 1.25rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1.25rem 1rem;
        margin: 0.75rem auto;
        border-radius: 6px;
      }
      
      .navbar-container {
        padding: 0 1rem;
      }
      
      .d-flex {
        flex-direction: column;
      }
      
      .gap-2 > * {
        width: 100%;
      }
      
      .row.g-3 > [class*="col-"] {
        margin-bottom: 1rem;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 1rem 0.75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-container">
      <a class="navbar-brand" href="/dashboard">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Injaaz">
        <span>Injaaz</span>
      </a>
      <div class="module-badge">HVAC & MEP</div>
      <div class="navbar-nav">
        {% if is_edit_mode %}
        <a href="/admin/dashboard" class="nav-btn next-btn">← Back to Admin</a>
        {% else %}
        <a href="/civil/form" class="nav-btn next-btn">Next →</a>
        {% endif %}
      </div>
    </div>
  </nav>
  
  <div class="container">
    <h2>HVAC & MEP Inspection{% if is_edit_mode %} - Edit Mode{% endif %}</h2>
    <p class="text-muted mb-4">{% if is_edit_mode %}Review and edit the submission below. Signatures cannot be modified.{% else %}Complete site visit documentation with photos and signatures{% endif %}</p>

    <form id="mainForm" enctype="multipart/form-data" onsubmit="return false;">
      <div class="row g-3">
        <!-- Site Info -->
        <div class="col-md-6 mb-3">
          <label for="site_name" class="form-label">Site Name</label>
          <input id="site_name" name="site_name" class="form-control" required>
        </div>

        <div class="col-md-6 mb-3">
          <label for="visit_date" class="form-label">Visit Date</label>
          <input id="visit_date" name="visit_date" type="date" class="form-control" required>
        </div>

        <!-- Add Item Section -->
        <div class="col-12 mb-section">
          <h5>Add Inspection Item</h5>
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">Asset</label>
          <select id="curAsset" class="form-select" disabled>
            <option value="">Select Asset</option>
          </select>
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">System</label>
          <select id="curSystem" class="form-select" disabled>
            <option value="">Select System</option>
          </select>
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">Description</label>
          <select id="curDescription" class="form-select" disabled>
            <option value="">Select Description</option>
          </select>
        </div>

        <!-- Photos -->
        <div class="col-12 mb-3">
          <label class="form-label">Photos (Maximum 100 per item)</label>
          <input id="curPhotos" type="file" class="form-control d-none" accept="image/*" multiple>
          
          <div id="dropZone" class="drop-zone">
            <div class="drop-zone-content">
              <strong>Drag and drop images here</strong>
              <small>or click to browse • Maximum 100 images • Auto-compressed to 1280px • Max 10MB per file</small>
            </div>
          </div>
          
          <div id="fileWarning" class="file-warning">
            ⚠️ Some files are larger than 10MB and will be skipped
          </div>
          
          <div id="uploadProgress" class="upload-progress">
            <div class="progress">
              <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 0%"></div>
            </div>
          </div>
          
          <div id="photoCount" class="photo-count" style="display:none;"></div>
          
          <!-- Photo Preview Container with Remove Buttons -->
          <div id="photoPreviewContainer" class="photo-preview-container" style="display:none;"></div>
        </div>

        <!-- Action Buttons -->
        <div class="col-12 mb-3 d-flex gap-2">
          <button id="addItemBtn" type="button" class="btn btn-success">Add Item</button>
          <button id="clearCurrentBtn" type="button" class="btn btn-outline-secondary">Clear Current</button>
          <button id="clearItemsBtn" type="button" class="btn btn-outline-danger">Clear All Items</button>
        </div>

        <!-- Items List -->
        <div class="col-12 mb-section">
          <h5>Inspection Items</h5>
          <div id="itemsList" class="items-list"></div>
        </div>

        <!-- Signatures -->
        <div class="col-md-6 mb-3">
          <div class="signature-label">
            <label class="form-label mb-0">Technician Signature</label>
            <span class="signature-hint">Draw signature</span>
          </div>
          <canvas id="techSignaturePad" class="signature-pad"></canvas>
          <input type="hidden" id="techSignatureData" name="tech_signature">
          <button type="button" id="clearTech" class="btn btn-outline-secondary btn-sm mt-2">Clear</button>
        </div>

        {% if user_designation != 'technician' or is_edit_mode %}
        <div class="col-md-6 mb-3" id="opManSignatureContainer">
          <div class="signature-label">
            <label class="form-label mb-0">Operation Manager Signature</label>
            {% if is_supervisor_edit %}
            <span class="signature-hint" style="color: var(--primary); font-weight: 600;">Verify & Sign as Supervisor</span>
            {% else %}
            <span class="signature-hint">Draw signature</span>
            {% endif %}
          </div>
          <canvas id="opManSignaturePad" class="signature-pad"></canvas>
          <input type="hidden" id="opManSignatureData" name="opMan_signature">
          <button type="button" id="clearOp" class="btn btn-outline-secondary btn-sm mt-2">Clear</button>
        </div>
        {% endif %}

        <!-- Submit Section -->
        <div class="col-12 mb-4">
          <button type="button" id="submitAllBtn" class="btn btn-success btn-lg">{% if is_edit_mode %}Update Submission{% else %}Submit Inspection{% endif %}</button>
        </div>

        <!-- Status & Downloads -->
        <div class="col-12">
          <div id="statusBox" class="mt-3"></div>
          <div id="progressContainer" class="progress-bar-container" style="display:none;">
            <div class="progress">
              <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
            </div>
          </div>
          <div id="downloadLinks" class="download-links" style="display:none;">
            <h5>Reports Ready!</h5>
            <a id="excelLink" href="#" download="hvac_mep_report.xlsx" target="_blank">Download Excel Report</a>
            <a id="pdfLink" href="#" download="hvac_mep_report.pdf" target="_blank">Download PDF Report</a>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Upload Progress Modal -->
  <div id="uploadModal" class="upload-modal">
    <div class="upload-modal-content">
      <h4 style="margin-bottom: 1rem;">Uploading Photos</h4>
      <div id="uploadModalText" style="margin-bottom: 1rem; color: #666;">
        Preparing images...
      </div>
      <div class="upload-progress-bar">
        <div id="uploadModalProgress" class="upload-progress-fill" style="width: 0%">
          0%
        </div>
      </div>
      <small style="color: #999; display: block; margin-top: 0.5rem;">Please wait, this may take a few minutes for large batches</small>
    </div>
  </div>

  <!-- Loading Overlay for Report Generation -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Generating Reports...</div>
    <div class="loading-subtitle">This typically takes 2-3 minutes for large submissions</div>
    <div class="loading-subtitle" style="margin-top: 1.5rem; font-size: 0.8rem;">Creating Excel and PDF reports with all photos</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="{{ url_for('static', filename='dropdown_init.js') }}"></script>
  <script src="{{ url_for('static', filename='form.js') }}"></script>

  <script>
    const modulePrefix = "{{ url_for('hvac_mep_bp.index') }}".replace('/form','');
    const MAX_PHOTOS_PER_ITEM = 100;
    const MAX_IMAGE_DIMENSION = 1280; // Reduced from 1920 for faster uploads
    const JPEG_QUALITY = 0.85;
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    const UPLOAD_RETRY_ATTEMPTS = 3;
    const DRAFT_SAVE_INTERVAL = 30000; // 30 seconds

    function checkBrowserSupport() {
      if (!window.FileReader) {
        alert('Your browser does not support file uploads. Please use a modern browser.');
        return false;
      }
      if (!HTMLCanvasElement.prototype.toBlob) {
        console.warn('Canvas.toBlob not supported, using polyfill');
        Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
          value: function (callback, type, quality) {
            const canvas = this;
            setTimeout(() => {
              const binStr = atob(canvas.toDataURL(type, quality).split(',')[1]);
              const len = binStr.length;
              const arr = new Uint8Array(len);
              for (let i = 0; i < len; i++) { arr[i] = binStr.charCodeAt(i); }
              callback(new Blob([arr], { type: type || 'image/png' }));
            });
          }
        });
      }
      return true;
    }

    function initSignaturePads() {
      const techCanvas = document.getElementById('techSignaturePad');
      const opCanvas = document.getElementById('opManSignaturePad');
      
      // Enhance touch events for mobile
      if (typeof enhanceTouchEvents !== 'undefined') {
        if (techCanvas) enhanceTouchEvents(techCanvas);
        if (opCanvas) enhanceTouchEvents(opCanvas);
      }
      
      const techPad = new SignaturePad(techCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3,
        throttle: 16
      });
      
      // Only initialize operations manager pad if the canvas exists
      let opPad = null;
      if (opCanvas) {
        opPad = new SignaturePad(opCanvas, {
          backgroundColor: 'rgb(255, 255, 255)',
          penColor: 'rgb(0, 0, 0)',
          minWidth: 1,
          maxWidth: 3,
          throttle: 16
        });
      }

      function resizeCanvas(canvas, pad) {
        if (!canvas || canvas.offsetWidth === 0) return;
        
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const rect = canvas.getBoundingClientRect();
        
        // Set display size
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';
        
        // Set actual size in memory (scaled for DPI)
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        
        // Scale the drawing context so everything draws at correct size
        const ctx = canvas.getContext('2d');
        ctx.scale(ratio, ratio);
        
        // Redraw signature if it exists
        if (pad && !pad.isEmpty()) {
          const data = pad.toData();
          pad.clear();
          pad.fromData(data);
        }
      }
      
      // Initial resize
      resizeCanvas(techCanvas, techPad);
      if (opCanvas && opPad) {
        resizeCanvas(opCanvas, opPad);
      }
      
      // Resize on window resize
      window.addEventListener('resize', () => { 
        resizeCanvas(techCanvas, techPad); 
        if (opCanvas && opPad) {
          resizeCanvas(opCanvas, opPad); 
        }
      });

      document.getElementById('clearTech').addEventListener('click', () => { techPad.clear(); document.getElementById('techSignatureData').value=''; });
      
      // Only attach clear button if operations manager pad exists
      const clearOpBtn = document.getElementById('clearOp');
      if (clearOpBtn && opPad) {
        clearOpBtn.addEventListener('click', () => { opPad.clear(); document.getElementById('opManSignatureData').value=''; });
      }

      return { techPad, opPad };
    }

    (function(){
      const curAsset = document.getElementById('curAsset');
      const curSystem = document.getElementById('curSystem');
      const curDescription = document.getElementById('curDescription');
      const curPhotos = document.getElementById('curPhotos');
      const dropZone = document.getElementById('dropZone');
      const photoCount = document.getElementById('photoCount');
      const photoPreviewContainer = document.getElementById('photoPreviewContainer');
      const fileWarning = document.getElementById('fileWarning');
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadModal = document.getElementById('uploadModal');
      const uploadModalText = document.getElementById('uploadModalText');
      const uploadModalProgress = document.getElementById('uploadModalProgress');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const addItemBtn = document.getElementById('addItemBtn');
      const clearCurrentBtn = document.getElementById('clearCurrentBtn');
      const clearItemsBtn = document.getElementById('clearItemsBtn');
      const itemsList = document.getElementById('itemsList');
      const submitAllBtn = document.getElementById('submitAllBtn');
      const statusBox = document.getElementById('statusBox');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const downloadLinks = document.getElementById('downloadLinks');
      const excelLink = document.getElementById('excelLink');
      const pdfLink = document.getElementById('pdfLink');
      
      const pads = initSignaturePads();
      
      // Make pads available globally for loadSubmissionData
      window.signaturePads = pads;

      // Initialize Upload Queue System
      let photoQueue = null;
      let photoQueueUI = null;
      
      if (window.PhotoUploadQueue && window.PhotoQueueUI) {
        photoQueue = new window.PhotoUploadQueue({
          uploadEndpoint: modulePrefix + '/upload-photo',
          maxConcurrent: 3,
          onProgress: (stats) => {
            if (photoQueueUI) photoQueueUI.updateProgress(stats);
          },
          onItemComplete: (item, success) => {
            // Update UI when individual items complete
            if (photoQueueUI) {
              photoQueueUI.updatePhotoStatus(item);
            }
            // Update the currentFiles array with the uploaded URL
            if (success && item.url) {
              const fileIndex = currentFiles.findIndex(f => f._queueId === item.id);
              if (fileIndex !== -1) {
                currentFiles[fileIndex].url = item.url;
                currentFiles[fileIndex].is_cloud = true;
              }
            }
            updatePhotoCount();
          },
          onQueueComplete: (stats) => {
            if (window.safeLog) window.safeLog.log('✅ All uploads complete:', stats);
            updatePhotoCount();
            // Show success message if all completed
            if (stats.completed === stats.total && stats.failed === 0) {
              if (window.safeLog) window.safeLog.log(`✅ Successfully uploaded ${stats.completed} photo(s)`);
            }
          },
          onError: (error) => {
            console.error('Upload error:', error);
          }
        });

        photoQueueUI = new window.PhotoQueueUI({
          containerId: 'photoPreviewContainer',
          onRetry: (photoId) => {
            photoQueue.retryUpload(photoId);
          },
          onRemove: (photoId) => {
            photoQueue.removePhoto(photoId);
            updatePhotoCount();
          }
        });

        // Create progress container (only if photoPreviewContainer exists)
        if (photoPreviewContainer && photoPreviewContainer.parentNode) {
          const progressDiv = document.createElement('div');
          progressDiv.id = 'queue-progress-container';
          progressDiv.className = 'mb-3';
          photoPreviewContainer.parentNode.insertBefore(progressDiv, photoPreviewContainer);
        }

        // Add retry all button event listener
        document.addEventListener('click', (e) => {
          if (e.target.id === 'retry-all-failed-btn' || e.target.closest('#retry-all-failed-btn')) {
            photoQueue.retryAllFailed();
          }
        });
        
        // Handle window resize and orientation changes for mobile responsiveness
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            if (photoQueueUI) {
              photoQueueUI.updateLayout();
            }
          }, 250);
        });
        
        window.addEventListener('orientationchange', () => {
          setTimeout(() => {
            if (photoQueueUI) {
              photoQueueUI.updateLayout();
            }
          }, 100);
        });
      }

      function updatePhotoCount() {
        const stats = photoQueue ? photoQueue.getStats() : { completed: currentFiles.length };
        const count = stats.completed || currentFiles.length;
        photoCount.textContent = `${count} / ${MAX_PHOTOS_PER_ITEM}`;
      }

      let items = [];
      let currentFiles = [];
      let currentPreviews = [];
      let pollingInterval = null;

      // Auto-download helper function
      function autoDownload(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      if (!checkBrowserSupport()) {
        dropZone.style.display = 'none';
        curPhotos.classList.remove('d-none');
        uploadProgress.innerHTML = '<div class="alert alert-warning">Using fallback mode</div>';
        uploadProgress.style.display = 'block';
      }

      async function compressImage(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let { width, height } = img;
              
              if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                if (width > height) {
                  height = Math.round((height / width) * MAX_IMAGE_DIMENSION);
                  width = MAX_IMAGE_DIMENSION;
                } else {
                  width = Math.round((width / height) * MAX_IMAGE_DIMENSION);
                  height = MAX_IMAGE_DIMENSION;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              canvas.toBlob((blob) => {
                if (!blob) {
                  reject(new Error('Compression failed'));
                  return;
                }
                const compressed = new File([blob], file.name.replace(/\.\w+$/, '.jpg'), {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                resolve(compressed);
              }, 'image/jpeg', JPEG_QUALITY);
            };
            img.onerror = () => reject(new Error('Image load failed'));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error('File read failed'));
          reader.readAsDataURL(file);
        });
      }

      async function handleFiles(files) {
        if (!files || files.length === 0) return;
        
        const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (imageFiles.length === 0) {
          alert('Please select image files only.');
          return;
        }
        
        // File size validation upfront
        const oversizedFiles = imageFiles.filter(f => f.size > MAX_FILE_SIZE);
        if (oversizedFiles.length > 0) {
          fileWarning.style.display = 'block';
          fileWarning.textContent = `⚠️ ${oversizedFiles.length} file(s) exceed 10MB limit and will be skipped`;
          setTimeout(() => { fileWarning.style.display = 'none'; }, 5000);
        }
        
        const validFiles = imageFiles.filter(f => f.size <= MAX_FILE_SIZE);
        if (validFiles.length === 0) {
          alert('All files exceed 10MB size limit. Please compress them first.');
          return;
        }
        
        const totalAfter = currentFiles.length + validFiles.length;
        if (totalAfter > MAX_PHOTOS_PER_ITEM) {
          alert(`Maximum ${MAX_PHOTOS_PER_ITEM} photos per item. You have ${currentFiles.length}, trying to add ${validFiles.length}.`);
          return;
        }
        
        // Use upload queue if available
        if (photoQueue && photoQueueUI) {
          const addedItems = await photoQueue.addPhotos(validFiles);
          addedItems.forEach(item => {
            currentFiles.push({ _queueId: item.id, url: null, is_cloud: false });
            photoQueueUI.renderPhotoItem(item);
          });
          updatePhotoCount();
          saveDraft();
          return;
        }
        
        // Fallback to original compression logic
        uploadProgress.style.display = 'block';
        
        const BATCH_SIZE = 3;
        let successCount = 0;
        let failedFiles = [];
        
        for (let i = 0; i < validFiles.length; i += BATCH_SIZE) {
          const batch = validFiles.slice(i, i + BATCH_SIZE);
          const promises = batch.map(file => compressImage(file));
          
          try {
            const compressed = await Promise.all(promises);
            compressed.forEach(c => {
              if (c) {
                currentFiles.push(c);
                currentPreviews.push(URL.createObjectURL(c));
                successCount++;
              }
            });
          } catch (err) {
            console.error('Batch compression error:', err);
            batch.forEach(f => failedFiles.push(f.name));
          }
          
          const progress = Math.round(((i + batch.length) / validFiles.length) * 100);
          uploadProgressBar.style.width = progress + '%';
          uploadProgressBar.textContent = `Compressing ${Math.min(i + batch.length, validFiles.length)}/${validFiles.length}...`;
        }
        
        uploadProgress.style.display = 'none';
        
        if (failedFiles.length > 0) {
          alert(`⚠️ Failed to process ${failedFiles.length} file(s): ${failedFiles.slice(0, 3).join(', ')}${failedFiles.length > 3 ? '...' : ''}`);
        }
        
        renderPhotoPreview();
        saveDraft(); // Auto-save after adding photos
      }

      function renderPhotoPreview() {
        // Ensure container exists
        if (!photoPreviewContainer) {
          console.warn('⚠️ photoPreviewContainer not found, skipping preview render');
          return;
        }
        
        photoPreviewContainer.innerHTML = '';
        const count = currentFiles.length;
        
        if (count === 0) {
          if (photoCount) photoCount.style.display = 'none';
          photoPreviewContainer.style.display = 'none';
          return;
        }
        
        photoPreviewContainer.style.display = 'flex';
        photoCount.style.display = 'inline-block';
        photoCount.textContent = `${count} / ${MAX_PHOTOS_PER_ITEM} photos`;
        photoCount.className = 'photo-count mt-2';
        if (count >= MAX_PHOTOS_PER_ITEM * 0.8) photoCount.classList.add('warning');
        if (count >= MAX_PHOTOS_PER_ITEM) photoCount.classList.add('danger');
        
        currentPreviews.forEach((url, idx) => {
          const item = document.createElement('div');
          item.className = 'photo-preview-item';
          
          const img = document.createElement('img');
          img.src = url;
          img.alt = `Photo ${idx + 1}`;
          
          const removeBtn = document.createElement('div');
          removeBtn.className = 'photo-preview-remove';
          removeBtn.textContent = '×';
          removeBtn.title = 'Remove this photo';
          removeBtn.onclick = () => removePhoto(idx);
          
          item.appendChild(img);
          item.appendChild(removeBtn);
          if (photoPreviewContainer) {
            photoPreviewContainer.appendChild(item);
          }
        });
      }
      
      function removePhoto(index) {
        if (index < 0 || index >= currentFiles.length) return;
        URL.revokeObjectURL(currentPreviews[index]);
        currentFiles.splice(index, 1);
        currentPreviews.splice(index, 1);
        renderPhotoPreview();
        saveDraft(); // Auto-save after removing photo
      }

      dropZone.addEventListener('click', () => curPhotos.click());
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
      dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
      dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
      curPhotos.addEventListener('change', () => handleFiles(curPhotos.files));

      // CRITICAL: Dropdown logic
      function clearSelect(el, placeholder='Select') {
        el.innerHTML = `<option value="">${placeholder}</option>`;
        el.disabled = true;
      }

      function fillAssets() {
        clearSelect(curAsset, 'Select Asset');
        if (typeof DROPDOWN_DATA === 'object' && Object.keys(DROPDOWN_DATA).length > 0) {
          Object.keys(DROPDOWN_DATA).forEach(cat => {
            const o = document.createElement('option');
            o.value = cat;
            o.textContent = cat;
            curAsset.appendChild(o);
          });
          curAsset.disabled = false;
        } else {
          curAsset.disabled = true;
          console.error('DROPDOWN_DATA not loaded');
        }
        clearSelect(curSystem, 'Select System');
        clearSelect(curDescription, 'Select Description');
      }

      curAsset.addEventListener('change', () => {
        curSystem.innerHTML = '<option value="">Select System</option>';
        curDescription.innerHTML = '<option value="">Select Description</option>';
        const cat = curAsset.value;
        if (!cat) { 
          curSystem.disabled = true; 
          curDescription.disabled = true; 
          return; 
        }
        const sysObj = (window.DROPDOWN_DATA && window.DROPDOWN_DATA[cat]) ? window.DROPDOWN_DATA[cat] : null;
        if (sysObj && typeof sysObj === 'object') {
          Object.keys(sysObj).forEach(sk => {
            const o = document.createElement('option');
            o.value = sk;
            o.textContent = sk;
            curSystem.appendChild(o);
          });
          curSystem.disabled = false;
          curDescription.disabled = true;
        } else {
          curSystem.disabled = true;
          curDescription.disabled = true;
        }
      });

      curSystem.addEventListener('change', () => {
        curDescription.innerHTML = '<option value="">Select Description</option>';
        const cat = curAsset.value;
        const sk = curSystem.value;
        if (!cat || !sk) { 
          curDescription.disabled = true; 
          return; 
        }
        const arr = (window.DROPDOWN_DATA && window.DROPDOWN_DATA[cat]) ? window.DROPDOWN_DATA[cat][sk] || [] : [];
        arr.forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          curDescription.appendChild(o);
        });
        curDescription.disabled = false;
      });

      addItemBtn.addEventListener('click', async () => {
        const asset = curAsset.value || '';
        const system = curSystem.value || '';
        const description = curDescription.value || '';
        if (!asset || !system || !description) {
          alert('Please select Asset, System and Description before adding.');
          return;
        }
        
        // Check if there are photos to upload
        if (currentFiles.length === 0) {
          alert('Please add at least one photo for this item.');
          return;
        }
        
        // Check if using queue system
        if (photoQueue) {
          const stats = photoQueue.getStats();
          
          if (!stats.isComplete && stats.total > 0) {
            alert(`⏳ Please wait for photo uploads to complete.\n\n${stats.uploading + stats.queued} photo(s) still uploading...`);
            return;
          }
          
          if (stats.failed > 0) {
            const proceed = confirm(`⚠️ ${stats.failed} photo(s) failed to upload.\n\nDo you want to add this item without them?\n\nClick "Retry All Failed" to try uploading them again.`);
            if (!proceed) return;
          }
          
          // Get uploaded URLs from queue
          const uploadedPhotos = photoQueue.getUploadedUrls();
          const uploadedPhotoUrls = uploadedPhotos.map(p => p.url);
          
          // Add item with cloud URLs
          items.push({ 
            asset, 
            system, 
            description, 
            photoUrls: uploadedPhotoUrls,
            photoCount: uploadedPhotoUrls.length
          });
          
          renderItems();
          resetCurrent();
          
          // Clear the queue for next item
          uploadedPhotos.forEach(p => photoQueue.removePhoto(p.id));
          
          saveDraft();
          statusBox.innerHTML = `<div class="alert alert-success">✅ Item added with ${uploadedPhotoUrls.length} photo(s)</div>`;
          setTimeout(() => { statusBox.innerHTML = ''; }, 3000);
          return;
        }
        
        // Fallback: Original upload logic
        addItemBtn.disabled = true;
        addItemBtn.textContent = 'Uploading photos...';
        
        const uploadedPhotoUrls = [];
        const totalPhotos = currentFiles.length;
        
        uploadModal.style.display = 'flex';
        uploadModalText.textContent = `Uploading ${totalPhotos} photos for this item...`;
        
        try {
          for (let i = 0; i < currentFiles.length; i++) {
            const file = currentFiles[i];
            const formData = new FormData();
            formData.append('photo', file, file.name);
            
            const progress = Math.round(((i + 1) / totalPhotos) * 100);
            uploadModalProgress.style.width = progress + '%';
            uploadModalProgress.textContent = `${i + 1}/${totalPhotos} (${progress}%)`;
            
            try {
              const uploadUrl = modulePrefix + '/upload-photo';
              const response = await fetch(uploadUrl, {
                method: 'POST',
                body: formData
              });
              
              if (!response.ok) {
                throw new Error(`Upload failed for ${file.name}`);
              }
              
              const result = await response.json();
              uploadedPhotoUrls.push(result.url);
            } catch (err) {
              console.error(`Failed to upload ${file.name}:`, err);
              if (!confirm(`Failed to upload ${file.name}. Continue anyway?`)) {
                throw err;
              }
            }
          }
          
          items.push({ 
            asset, 
            system, 
            description, 
            photoUrls: uploadedPhotoUrls,
            photoCount: uploadedPhotoUrls.length
          });
          
          renderItems();
          resetCurrent();
          saveDraft();
          
          statusBox.innerHTML = `<div class="alert alert-success">✅ Item added with ${uploadedPhotoUrls.length} photo(s) uploaded to cloud</div>`;
          setTimeout(() => { statusBox.innerHTML = ''; }, 3000);
          
        } catch (err) {
          statusBox.innerHTML = `<div class="alert alert-danger">❌ Failed to upload photos: ${err.message}</div>`;
        } finally {
          uploadModal.style.display = 'none';
          addItemBtn.disabled = false;
          addItemBtn.textContent = 'Add Item';
        }
      });

      clearCurrentBtn.addEventListener('click', resetCurrent);
      clearItemsBtn.addEventListener('click', () => {
        if (!confirm('Clear all items? (Photos already uploaded to cloud will remain there)')) return;
        items = [];
        renderItems();
        saveDraft();
      });

      function resetCurrent() {
        curAsset.value = '';
        curSystem.innerHTML = '<option value="">Select System</option>';
        curSystem.disabled = true;
        curDescription.innerHTML = '<option value="">Select Description</option>';
        curDescription.disabled = true;
        curPhotos.value = '';
        currentPreviews.forEach(u => URL.revokeObjectURL(u));
        currentFiles = [];
        currentPreviews = [];
        if (photoPreviewContainer) {
          photoPreviewContainer.innerHTML = '';
          photoPreviewContainer.style.display = 'none';
        }
        if (photoCount) photoCount.style.display = 'none';
        fileWarning.style.display = 'none';
      }

      function renderItems() {
        itemsList.innerHTML = '';
        if (items.length === 0) {
          itemsList.innerHTML = '<div class="text-muted">No items added yet</div>';
          return;
        }
        items.forEach((it, idx) => {
          const card = document.createElement('div');
          card.className = 'item-card';
          
          const photoCount = it.photoUrls ? it.photoUrls.length : (it.photoCount || 0);
          const uploadStatus = it.photoUrls ? '☁️ Uploaded to cloud' : '⏳ Not uploaded';
          
          card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div style="flex:1;">
                <div class="meta"><strong>Asset:</strong> ${escapeHtml(it.asset)} &nbsp; <strong>System:</strong> ${escapeHtml(it.system)} &nbsp; <strong>Description:</strong> ${escapeHtml(it.description)}</div>
                <div class="photo-count mt-1" style="font-size:0.85rem;">📷 ${photoCount} photo(s) ${uploadStatus}</div>
                <div class="mt-2 thumbs-row"></div>
              </div>
              <div><button data-idx="${idx}" class="btn btn-sm btn-danger remove-item">🗑️ Remove</button></div>
            </div>
          `;
          const thumbsRow = card.querySelector('.thumbs-row');
          const maxShow = 6;
          
          // Show cloud URLs if available
          if (it.photoUrls && Array.isArray(it.photoUrls) && it.photoUrls.length > 0) {
            it.photoUrls.slice(0, maxShow).forEach((url, urlIdx) => {
              if (!url || typeof url !== 'string') {
                console.warn('Invalid photo URL at index', urlIdx, ':', url);
                return; // Skip invalid URLs
              }
              
              const img = document.createElement('img');
              img.className = 'thumb';
              img.src = url;
              img.alt = `Photo ${urlIdx + 1}`;
              img.style.width = '70px';
              img.style.height = '50px';
              img.style.marginRight = '4px';
              img.style.marginBottom = '4px';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '4px';
              img.style.border = '1px solid #e5e7eb';
              img.style.cursor = 'pointer';
              img.style.backgroundColor = '#f3f4f6';
              img.loading = 'lazy';
              
              img.onerror = function() {
                console.error('Failed to load thumbnail:', url);
                // Show placeholder instead of hiding
                this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="70" height="50"%3E%3Crect width="70" height="50" fill="%23e5e7eb"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999" font-size="10"%3EFailed%3C/text%3E%3C/svg%3E';
                this.style.cursor = 'default';
              };
              
              img.onload = function() {
                console.log('Thumbnail loaded successfully:', url);
              };
              
              img.onclick = function() {
                window.open(url, '_blank');
              };
              
              thumbsRow.appendChild(img);
            });
            
            if (it.photoUrls.length > maxShow) {
              const more = document.createElement('span');
              more.textContent = `+${it.photoUrls.length - maxShow} more`;
              more.className = 'badge bg-secondary';
              more.style.marginLeft = '8px';
              thumbsRow.appendChild(more);
            }
          } else {
            console.log('No photo URLs for item:', it);
          }
          
          card.querySelector('.remove-item').addEventListener('click', (e) => {
            const i = Number(e.currentTarget.dataset.idx);
            if (confirm('Remove this item? (Photos remain in cloud storage)')) removeItem(i);
          });
          itemsList.appendChild(card);
        });
      }

      function removeItem(index) {
        if (index < 0 || index >= items.length) return;
        items.splice(index, 1);
        renderItems();
        saveDraft();
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
      }

      function pollJobStatus(jobId) {
        if (pollingInterval) clearInterval(pollingInterval);
        progressContainer.style.display = 'block';
        downloadLinks.style.display = 'none';
        pollingInterval = setInterval(async () => {
          try {
            const statusUrl = `${modulePrefix}/status/${jobId}`;
            const res = await fetch(statusUrl);
            if (!res.ok) throw new Error('Status check failed');
            const job = await res.json();
            const progress = job.progress || 0;
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            
            // Check both legacy 'state' and current 'status'
            const isDone = job.state === 'done' || job.status === 'completed';
            const isFailed = job.state === 'failed' || job.status === 'failed';
            // Support both 'results' and 'result_data'
            const results = job.results || job.result_data || {};
            
            if (isDone) {
              clearInterval(pollingInterval);
              loadingOverlay.style.display = 'none'; // Hide loading overlay
              progressBar.classList.remove('progress-bar-animated');
              progressBar.classList.add('bg-success');
              statusBox.innerHTML = '<div class="alert alert-success"><strong>✅ Reports generated successfully!</strong><br><div class="mt-2 text-muted" style="font-size:0.9em;">Click the download links below to get your reports.</div></div>';
              
              // Support both excel_url/pdf_url AND excel/pdf field names
              const excelUrl = results.excel_url || results.excel;
              const pdfUrl = results.pdf_url || results.pdf;
              
              if (excelUrl || pdfUrl) {
                // Show download links
                downloadLinks.style.display = 'block';
                
                // Use download proxy route for auto-download (jobId is available in closure)
                if (excelUrl) {
                  excelLink.href = `${modulePrefix}/download/${jobId}/excel`;
                  excelLink.textContent = '📥 Download Excel Report';
                  excelLink.style.display = 'block';
                  // Use mobile-friendly download handler
                  if (typeof downloadWithRetry !== 'undefined') {
                    setTimeout(() => downloadWithRetry(`${modulePrefix}/download/${jobId}/excel`, results.excel_filename || 'hvac_report.xlsx', 2), 500);
                  } else {
                    setTimeout(() => excelLink.click(), 500);
                  }
                } else {
                  excelLink.style.display = 'none';
                }
                
                if (pdfUrl) {
                  pdfLink.href = `${modulePrefix}/download/${jobId}/pdf`;
                  pdfLink.textContent = '📥 Download PDF Report';
                  pdfLink.style.display = 'block';
                  // Use mobile-friendly download handler
                  if (typeof downloadWithRetry !== 'undefined') {
                    setTimeout(() => downloadWithRetry(`${modulePrefix}/download/${jobId}/pdf`, results.pdf_filename || 'hvac_report.pdf', 2), 700);
                  } else {
                    setTimeout(() => pdfLink.click(), 700);
                  }
                } else {
                  pdfLink.style.display = 'none';
                }
              }
            } else if (isFailed) {
              clearInterval(pollingInterval);
              loadingOverlay.style.display = 'none'; // Hide loading overlay
              progressBar.classList.remove('progress-bar-animated');
              progressBar.classList.add('bg-danger');
              const errorMsg = results.error || job.error_message || 'Unknown error';
              statusBox.innerHTML = `<div class="alert alert-danger">❌ Generation failed: ${errorMsg}</div>`;
            }
          } catch (err) {
            console.error('Polling error:', err);
          }
        }, 1000);
      }

      function autoDownload(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || '';
        a.target = '_blank';  // Open in new tab if download fails
        a.rel = 'noopener noreferrer';
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => document.body.removeChild(a), 100);
      }

      async function submitAll() {
        // In edit mode, preserve original signatures
        let techData = '';
        let opData = '';
        
        {% if is_edit_mode %}
        // In edit mode, use existing signatures (read-only for tech, editable for supervisor)
        techData = document.getElementById('techSignatureData').value || '';
        const opManInput = document.getElementById('opManSignatureData');
        if (opManInput) {
          // If supervisor is editing, allow them to sign
          {% if is_supervisor_edit %}
          if (pads.opPad && !pads.opPad.isEmpty()) {
            opData = pads.opPad.toDataURL('image/png');
            opManInput.value = opData;
          } else {
            opData = opManInput.value || '';
          }
          {% else %}
          opData = opManInput.value || '';
          {% endif %}
        } else {
          opData = '';
        }
        {% else %}
        // Normal mode - get from signature pads
        techData = pads.techPad.isEmpty() ? '' : pads.techPad.toDataURL('image/png');
        const opManInput = document.getElementById('opManSignatureData');
        if (opManInput && pads.opPad) {
          opData = pads.opPad.isEmpty() ? '' : pads.opPad.toDataURL('image/png');
          opManInput.value = opData;
        } else {
          opData = '';
        }
        document.getElementById('techSignatureData').value = techData;
        {% endif %}

        if (items.length === 0) {
          statusBox.innerHTML = '<div class="alert alert-warning">⚠️ Please add at least one item before submitting.</div>';
          return;
        }

        // Count total photos (already uploaded)
        const totalPhotos = items.reduce((sum, item) => sum + (item.photoUrls?.length || item.photoCount || 0), 0);
        
        // Check if all items have photos uploaded
        const hasUnuploadedItems = items.some(item => !item.photoUrls);
        if (hasUnuploadedItems) {
          alert('⚠️ Some items do not have photos uploaded. Please check your items.');
          return;
        }
        
        if (totalPhotos === 0) {
          // Allow submission without photos
          statusBox.innerHTML = '<div class="alert alert-info">ℹ️ Submitting form without photos...</div>';
        }

        // Show loading overlay (photos already uploaded, just generating reports)
        loadingOverlay.style.display = 'flex';
        statusBox.innerHTML = '';
        progressContainer.style.display = 'none';
        downloadLinks.style.display = 'none';
        
        // Prepare JSON payload (photos already in cloud)
        const payload = {
          site_name: document.getElementById('site_name').value || '',
          visit_date: document.getElementById('visit_date').value || '',
          tech_signature: techData || '',
          opMan_signature: opData || '',
          items: items.map(it => ({
            asset: it.asset,
            system: it.system,
            description: it.description,
            photo_urls: it.photoUrls || [] // Cloud URLs
          }))
        };

        try {
          {% if is_edit_mode %}
          // Update existing submission
          const submissionId = window.editSubmissionId;
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          
          const res = await fetch(`/api/admin/submissions/${submissionId}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify({
              site_name: payload.site_name,
              visit_date: payload.visit_date,
              form_data: payload
            }),
            credentials: 'include'
          });
          
          if (!res.ok) {
            const txt = await res.text();
            throw new Error('Server error: ' + res.status + ' ' + txt);
          }
          
          const json = await res.json();
          
          if (json.success) {
            // If documents are being regenerated, poll job status
            if (json.data && json.data.job_id && json.data.regenerating) {
              statusBox.innerHTML = '<div class="alert alert-info">✅ Submission updated! Regenerating documents... This may take a moment.</div>';
              loadingOverlay.style.display = 'flex';
              pollJobStatus(json.data.job_id);
            } else {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = '<div class="alert alert-success">✅ Submission updated successfully! <a href="/admin/dashboard">Return to Admin Dashboard</a></div>';
              clearDraft();
            }
          } else {
            throw new Error(json.error || 'Update failed');
          }
          {% else %}
          // Create new submission
          const submitUrl = modulePrefix + '/submit-with-urls';
          // Get JWT token from localStorage
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          const res = await fetch(submitUrl, { 
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload),
            credentials: 'include'  // Include cookies for JWT
          });
          
          if (!res.ok) {
            const txt = await res.text();
            throw new Error('Server error: ' + res.status + ' ' + txt);
          }
          
          const json = await res.json();
          
          // Hide upload modal, show loading overlay
          uploadModal.style.display = 'none';
          loadingOverlay.style.display = 'flex';
          
          if (json.job_id) {
            clearDraft(); // Clear draft after successful submission
            pollJobStatus(json.job_id);
          } else {
            loadingOverlay.style.display = 'none';
            statusBox.innerHTML = '<div class="alert alert-warning">Submission accepted but no job ID</div>';
          }
          {% endif %}
        } catch (err) {
          loadingOverlay.style.display = 'none';
          statusBox.innerHTML = `<div class="alert alert-danger">❌ {% if is_edit_mode %}Update{% else %}Submission{% endif %} failed: ${err.message}</div>`;
        }
      }

      submitAllBtn.addEventListener('click', submitAll);

      // Draft Auto-Save Functionality
      function saveDraft() {
        try {
          const draft = {
            site_name: document.getElementById('site_name').value || '',
            visit_date: document.getElementById('visit_date').value || '',
            items: items.map(it => ({
              asset: it.asset,
              system: it.system,
              description: it.description,
              photoCount: it.files?.length || 0
            })),
            timestamp: Date.now()
          };
          localStorage.setItem('hvac_mep_draft', JSON.stringify(draft));
        } catch (err) {
          console.error('Failed to save draft:', err);
        }
      }

      function loadDraft() {
        try {
          const draftJson = localStorage.getItem('hvac_mep_draft');
          if (!draftJson) return false;
          
          const draft = JSON.parse(draftJson);
          const ageMinutes = (Date.now() - draft.timestamp) / 60000;
          
          // Only load drafts less than 24 hours old
          if (ageMinutes > 1440) {
            clearDraft();
            return false;
          }
          
          // Auto-load draft without confirmation
          document.getElementById('site_name').value = draft.site_name || '';
          document.getElementById('visit_date').value = draft.visit_date || '';
          // Note: Can't restore files, only metadata
          if (draft.items && draft.items.length > 0) {
            console.log(`ℹ️ Draft loaded: ${draft.items.length} items`);
          }
          return true;
        } catch (err) {
          console.error('Failed to load draft:', err);
        }
        return false;
      }

      function clearDraft() {
        try {
          localStorage.removeItem('hvac_mep_draft');
        } catch (err) {
          console.error('Failed to clear draft:', err);
        }
      }

      // Auto-save every 30 seconds
      setInterval(saveDraft, DRAFT_SAVE_INTERVAL);

      // Save on form field changes
      document.getElementById('site_name').addEventListener('input', saveDraft);
      document.getElementById('visit_date').addEventListener('change', saveDraft);

      // Load submission data if in edit mode
      function loadSubmissionData() {
        {% if is_edit_mode and submission_data %}
        try {
          const submissionData = {{ submission_data|tojson }};
          
          // Pre-fill basic fields
          if (submissionData.site_name) {
            document.getElementById('site_name').value = submissionData.site_name;
          }
          if (submissionData.visit_date) {
            document.getElementById('visit_date').value = submissionData.visit_date;
          }
          
          // Pre-populate items
          const formData = submissionData.form_data || {};
          console.log('Loading submission data, formData:', formData);
          
          if (formData.items && Array.isArray(formData.items)) {
            formData.items.forEach((item, idx) => {
              // Extract photo URLs - handle different formats
              let photoUrls = [];
              
              // Try photo_urls first (direct array of URLs)
              if (item.photo_urls && Array.isArray(item.photo_urls)) {
                photoUrls = item.photo_urls.filter(url => url && typeof url === 'string');
              } 
              // Try photos array (array of objects with 'url' property)
              else if (item.photos && Array.isArray(item.photos)) {
                photoUrls = item.photos.map(photo => {
                  if (typeof photo === 'string') {
                    return photo;
                  } else if (photo && typeof photo === 'object') {
                    // Could be {url: "...", saved: ..., path: ...} or just {url: "..."}
                    return photo.url || photo.cloud_url || null;
                  }
                  return null;
                }).filter(url => url !== null && typeof url === 'string');
              }
              
              console.log(`Item ${idx}: asset=${item.asset}, photoUrls count=${photoUrls.length}`, photoUrls);
              
              items.push({
                asset: item.asset || '',
                system: item.system || '',
                description: item.description || '',
                photoUrls: photoUrls,
                photoCount: photoUrls.length
              });
            });
            
            // Render items after all are loaded
            setTimeout(() => {
              renderItems();
            }, 100);
          }
          
          // Load signatures as read-only images (if they exist)
          // Wait for signature pads to be initialized
          function loadSignatures() {
            const pads = window.signaturePads;
            if (!pads || !pads.techPad || !pads.opPad) {
              // Retry after a short delay if pads aren't ready
              setTimeout(loadSignatures, 200);
              return;
            }
            
            if (formData.tech_signature || formData.techSignatureData) {
              let techSig = formData.tech_signature || formData.techSignatureData;
              // Handle object format with url property (from Cloudinary)
              if (techSig && typeof techSig === 'object' && techSig.url) {
                techSig = techSig.url;
              }
              if (techSig && typeof techSig === 'string' && (techSig.startsWith('data:image') || techSig.startsWith('http'))) {
                const techCanvas = document.getElementById('techSignaturePad');
                if (techCanvas) {
                  // Hide canvas and show signature as image instead (more reliable)
                  techCanvas.style.display = 'none';
                  
                  // Create image element to display the signature
                  const sigImg = document.createElement('img');
                  sigImg.src = techSig;
                  sigImg.alt = 'Technician Signature';
                  sigImg.style.cssText = 'width: 100%; max-height: 180px; object-fit: contain; border: 2px solid #10b981; border-radius: 8px; background: #f0fdf4; padding: 10px;';
                  techCanvas.parentElement.insertBefore(sigImg, techCanvas);
                  
                  // Hide clear button
                  const clearBtn = document.getElementById('clearTech');
                  if (clearBtn) clearBtn.style.display = 'none';
                  
                  // Store signature URL in hidden input
                  const techSigInput = document.getElementById('techSignatureData');
                  if (techSigInput) techSigInput.value = techSig;
                  
                  // Add label and message
                  const techLabel = techCanvas.parentElement.querySelector('label');
                  if (techLabel) {
                    techLabel.innerHTML = 'TECHNICIAN SIGNATURE <span style="color: #10b981; font-weight: bold; font-size: 0.9rem;">✓ Already Signed</span>';
                  }
                  
                  // Update hint text
                  const hintSpan = techCanvas.parentElement.querySelector('.signature-hint');
                  if (hintSpan) hintSpan.style.display = 'none';
                  
                  // Add info message below
                  const techInfo = document.createElement('div');
                  techInfo.style.cssText = 'margin-top: 0.5rem; padding: 0.5rem; background-color: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; color: #92400e; font-size: 0.875rem;';
                  techInfo.textContent = '⚠️ This signature was provided by the technician and cannot be modified.';
                  techCanvas.parentElement.appendChild(techInfo);
                }
              }
            }
            
            if (formData.opMan_signature || formData.opManSignatureData) {
              let opSig = formData.opMan_signature || formData.opManSignatureData;
              // Handle object format with url property (from Cloudinary)
              if (opSig && typeof opSig === 'object' && opSig.url) {
                opSig = opSig.url;
              }
              if (opSig && typeof opSig === 'string' && (opSig.startsWith('data:image') || opSig.startsWith('http'))) {
                const opCanvas = document.getElementById('opManSignaturePad');
                if (opCanvas) {
                  // Hide canvas and show signature as image instead (more reliable)
                  opCanvas.style.display = 'none';
                  
                  // Create image element to display the signature
                  const sigImg = document.createElement('img');
                  sigImg.src = opSig;
                  sigImg.alt = 'Manager Signature';
                  sigImg.style.cssText = 'width: 100%; max-height: 180px; object-fit: contain; border: 2px solid #10b981; border-radius: 8px; background: #f0fdf4; padding: 10px;';
                  opCanvas.parentElement.insertBefore(sigImg, opCanvas);
                  
                  // Hide clear button
                  // Store signature URL in hidden input
                  const opSigInput = document.getElementById('opManSignatureData');
                  if (opSigInput) opSigInput.value = opSig;
                  
                  // Add label and message
                  const opLabel = opCanvas.parentElement.querySelector('label');
                  if (opLabel) {
                    opLabel.innerHTML = 'OPERATIONS MANAGER SIGNATURE <span style="color: #10b981; font-weight: bold; font-size: 0.9rem;">✓ Already Signed</span>';
                  }
                  
                  // Update hint text
                  const hintSpan = opCanvas.parentElement.querySelector('.signature-hint');
                  if (hintSpan) hintSpan.style.display = 'none';
                  
                  // Add info message below
                  const opInfo = document.createElement('div');
                  opInfo.style.cssText = 'margin-top: 0.5rem; padding: 0.5rem; background-color: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; color: #92400e; font-size: 0.875rem;';
                  opInfo.textContent = '⚠️ This signature was already provided and cannot be modified.';
                  opCanvas.parentElement.appendChild(opInfo);
                }
              }
            }
          }
          
          // Start loading signatures after a short delay to ensure pads are initialized
          setTimeout(loadSignatures, 300);
          
          // Store submission ID for update
          window.editSubmissionId = submissionData.submission_id;
          
          console.log('✅ Submission data loaded for editing');
        } catch (err) {
          console.error('Failed to load submission data:', err);
        }
        {% endif %}
      }
      
      // Load draft on page load (only if not in edit mode)
      window.addEventListener('DOMContentLoaded', () => {
        {% if not is_edit_mode %}
        loadDraft();
        {% else %}
        loadSubmissionData();
        {% endif %}
      });

      function onDropdownsReady() { 
        fillAssets(); 
      }
      
      if (typeof DROPDOWN_DATA !== 'undefined' && Object.keys(DROPDOWN_DATA || {}).length > 0) {
        fillAssets();
      } else {
        window.addEventListener('dropdowns:loaded', onDropdownsReady, { once: true });
      }

      renderItems();
    })();
  </script>
</body>
</html>