<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>HVAC & MEP - Inspection Form</title>
  <meta name="description" content="HVAC and MEP site inspection form - Works offline">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#125435">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Injaaz HVAC">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
  <script src="{{ url_for('static', filename='pwa-install.js') }}" defer></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='photo_upload_queue.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='mobile_responsive.css') }}">
  <script src="{{ url_for('static', filename='mobile_utils.js') }}" defer></script>
  <script src="{{ url_for('static', filename='production_logger.js') }}" defer></script>
  <script src="{{ url_for('static', filename='photo_upload_queue.js') }}"></script>
  <script src="{{ url_for('static', filename='photo_queue_ui.js') }}"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #125435;
      --primary-light: #1a7a4d;
      --primary-dark: #0d3d24;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-light: #9ca3af;
      --border-light: #e5e7eb;
      --bg-page: #fafafa;
      --white: #ffffff;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    body {
      background: var(--bg-page);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 0;
      margin: 0;
      line-height: 1.5;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Clean Navigation Bar */
    .navbar {
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 0.875rem 0;
      margin-bottom: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(18, 84, 53, 0.1);
    }
    
    .navbar-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      align-items: center;
      gap: 2rem;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary) !important;
      text-decoration: none;
      letter-spacing: -0.5px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .navbar-brand img {
      height: 32px;
      width: auto;
    }
    
    .navbar-brand:hover {
      transform: translateY(-1px);
      opacity: 0.85;
    }
    
    .module-badge {
      font-size: 0.875rem;
      font-weight: 600;
      color: #6c757d;
      padding: 0.5rem 1rem;
      background: #f8f9fa;
      border-radius: 6px;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }
    
    .navbar-nav {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-left: auto;
    }
    
    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #495057;
      background: #ffffff;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      white-space: nowrap;
    }
    
    .nav-btn:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .nav-btn.next-btn {
      color: #0d6efd;
      border-color: #0d6efd;
    }
    
    .nav-btn.next-btn:hover {
      background: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    
    @media (max-width: 768px) {
      .navbar-container {
        padding: 0.75rem 1rem;
        gap: 1rem;
        flex-wrap: wrap;
      }
      
      .navbar-brand {
        font-size: 1.2rem;
      }
      
      .navbar-brand img {
        height: 28px;
      }
      
      .module-badge {
        font-size: 0.8125rem;
        padding: 0.375rem 0.75rem;
      }
      
      .navbar-brand span {
        font-size: 1rem;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .navbar-nav {
        width: 100%;
        justify-content: flex-end;
        margin-left: 0;
        margin-top: 0.5rem;
        gap: 0.5rem;
      }
      
      .nav-btn {
        flex: 0 0 auto;
        justify-content: center;
        font-size: 0.8125rem;
        padding: 0.625rem 0.75rem;
        min-height: 44px;
      }
      
      .container {
        padding: 1.25rem 1rem;
        margin: 0.75rem auto;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      /* Tab navigation for mobile */
      .nav-tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        border-bottom: 1px solid var(--border-light);
        margin-bottom: 1.5rem;
      }
      
      .nav-tabs::-webkit-scrollbar {
        display: none;
      }
      
      .nav-tabs .nav-link {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        white-space: nowrap;
        flex-shrink: 0;
      }
      
      /* Form inputs */
      .form-label {
        font-size: 0.9rem;
      }
      
      .form-control, .form-select {
        font-size: 1rem;
        padding: 0.75rem;
        min-height: 48px;
      }
      
      textarea.form-control {
        min-height: 100px;
      }
      
      /* Buttons */
      .btn {
        min-height: 48px;
        font-size: 1rem;
        padding: 0.75rem 1.5rem;
      }
      
      .btn-sm {
        min-height: 40px;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
      }
      
      /* Item cards */
      .item-card {
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .item-card h6 {
        font-size: 1rem;
      }
      
      /* Signature canvas */
      canvas {
        max-width: 100%;
        height: auto;
        min-height: 150px;
        touch-action: none;
      }
      
      /* Photo grid */
      .photo-preview {
        width: 100%;
        max-width: 150px;
        height: 150px;
      }
    }
    
    @media (max-width: 480px) {
      .navbar-brand span {
        font-size: 0.9rem;
        max-width: 140px;
      }
      
      .nav-btn {
        font-size: 0.75rem;
        padding: 0.5rem;
      }
      
      .container {
        padding: 1rem 0.75rem;
      }
      
      h2 {
        font-size: 1.35rem;
      }
    }
    
    /* Clean, spacious container */
    .container {
      max-width: 1200px;
      background: var(--white);
      border-radius: 8px;
      padding: 2rem 2.5rem;
      box-shadow: var(--shadow-sm);
      margin: 1.5rem auto;
      border: 1px solid var(--border-light);
    }
    
    /* Tab Navigation Styling */
    .nav-tabs {
      border-bottom: 2px solid var(--border-light);
      margin-bottom: 2rem;
      gap: 0.5rem;
    }
    
    .nav-tabs .nav-link {
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-secondary);
      font-weight: 500;
      padding: 0.75rem 1.5rem;
      transition: all 0.2s ease;
      background: transparent;
    }
    
    .nav-tabs .nav-link:hover {
      border-bottom-color: var(--primary-light);
      color: var(--primary);
    }
    
    .nav-tabs .nav-link.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: transparent;
    }
    
    .tab-content {
      padding: 1.5rem 0;
    }
    
    .tab-pane {
      min-height: 300px;
    }
    
    .section-heading {
      color: var(--primary);
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
    }
    
    /* Minimal typography */
    h2 {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 0.375rem;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }
    
    h5 {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 1rem;
      margin-top: 2rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-light);
      letter-spacing: -0.2px;
    }
    
    .text-muted {
      color: var(--text-secondary) !important;
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    /* Minimal form labels */
    .form-label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.875rem;
      margin-bottom: 0.375rem;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.75rem;
    }
    
    /* Clean inputs with subtle borders */
    .form-control, .form-select {
      border: 1px solid var(--border-light);
      border-radius: 4px;
      padding: 0.625rem 0.875rem;
      transition: all 0.15s ease;
      font-size: 0.9375rem;
      background: var(--white);
      color: var(--text-primary);
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 84, 53, 0.06);
      outline: none;
    }
    
    /* Minimal flat buttons */
    .btn {
      border-radius: 4px;
      padding: 0.625rem 1.25rem;
      font-weight: 600;
      border: none;
      transition: all 0.15s ease;
      font-size: 0.875rem;
      letter-spacing: 0.2px;
    }
    
    .btn-success {
      background: var(--primary);
      color: white;
    }
    
    .btn-success:hover {
      background: var(--primary-dark);
      box-shadow: 0 2px 8px rgba(18, 84, 53, 0.2);
    }
    
    .btn-outline-secondary {
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      background: transparent;
    }
    
    .btn-outline-secondary:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
      background: #fafafa;
    }
    
    .btn-outline-danger {
      border: 1px solid #dc3545;
      color: #dc3545;
      background: transparent;
    }
    
    .btn-outline-danger:hover {
      background: #dc3545;
      color: white;
    }
    
    /* Upload Progress Modal */
    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .upload-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .upload-progress-bar {
      height: 30px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .upload-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #125435, #1a7a4f);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    /* Thumbnail Container */
    .photo-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 1rem;
      padding: 0.5rem;
      border: 1px dashed var(--border-light);
      border-radius: 4px;
      min-height: 60px;
    }
    
    .photo-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 4px;
      overflow: hidden;
      border: 2px solid var(--border-light);
    }
    
    .photo-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-preview-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #dc3545;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .photo-preview-remove:hover {
      background: #c82333;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #e9ecef;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 1.5rem;
      font-size: 1.125rem;
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .loading-subtitle {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    /* File size warning */
    .file-warning {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }
    
    .btn-lg {
      padding: 0.75rem 1.75rem;
      font-size: 0.9375rem;
    }
    
    /* Edit mode styling */
    .item-card[data-edit-mode="true"] {
      border-color: #059669 !important;
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1) !important;
    }
    
    .item-card[data-edit-mode="false"] .editable-field:disabled {
      background-color: #f9fafb;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .edit-asset-toggle .edit-icon {
      transition: transform 0.2s;
    }
    
    .item-card[data-edit-mode="true"] .edit-asset-toggle .edit-icon {
      transform: rotate(180deg);
    }
    
    /* Signature pad - Standardized size */
    .signature-pad,
    canvas.signature-pad,
    #techSignaturePad,
    #opManSignaturePad,
    #supervisorSignaturePad,
    #businessDevSignaturePad,
    #procurementSignaturePad,
    #generalManagerSignaturePad {
      border: 2px solid var(--border-light);
      border-radius: 6px;
      width: 100% !important;
      max-width: 500px;
      height: 160px !important;
      max-height: 160px !important;
      min-height: 160px !important;
      background: #ffffff;
      cursor: crosshair;
      display: block;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      touch-action: none; /* Crucial for mobile drawing */
    }
    
    /* Ensure canvas doesn't stretch */
    .signature-pad,
    canvas.signature-pad {
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    
    .signature-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
      width: 100%;
      max-width: 500px;
    }
    
    .signature-label label {
      flex: 1;
      margin-bottom: 0;
    }
    
    .signature-hint {
      font-size: 0.75rem;
      color: var(--text-light);
      font-weight: 400;
      white-space: nowrap;
      flex-shrink: 0;
      text-align: right;
    }
    
    /* Ensure signature container properly wraps label and pad */
    .signature-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 500px;
    }
    
    /* Clean item cards */
    .item-card {
      border: 1px solid var(--border-light);
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      background: var(--white);
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }
    
    .item-card:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.06);
      border-color: var(--primary-light);
    }
    
    .editable-item-card {
      border-left: 4px solid #059669 !important;
      background: #fcfdfc !important;
    }
    
    /* Minimal thumbnails */
    .thumb-container {
      display: inline-block;
      position: relative;
      margin: 3px;
    }
    
    .thumb {
      width: 90px;
      height: 60px;
      object-fit: cover;
      border: 1px solid var(--border-light);
      border-radius: 3px;
      transition: all 0.15s;
    }
    
    .thumb:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .thumb-delete {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Minimal download section */
    .download-links {
      background: #f8faf9;
      border: 1px solid var(--primary);
      padding: 1.5rem;
      border-radius: 4px;
      margin-top: 1.5rem;
    }
    
    .download-links h5 {
      color: var(--primary-dark);
      margin-bottom: 0.875rem;
      border: none;
      margin-top: 0;
      font-size: 1rem;
    }
    
    .download-links a {
      /* Standardized to match Civil form style */
      text-decoration: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      display: inline-block;
    }
    
    .download-links a:hover {
      opacity: 0.9;
    }
    
    /* Minimal drop zone */
    .drop-zone {
      border: 2px dashed var(--border-light);
      border-radius: 4px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: var(--primary);
      background: #f8faf9;
    }
    
    .drop-zone-content {
      color: var(--text-secondary);
      font-size: 0.9375rem;
    }
    
    .drop-zone-content strong {
      display: block;
      color: var(--text-primary);
      margin-bottom: 0.375rem;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .drop-zone-content small {
      display: block;
      font-size: 0.8125rem;
      margin-top: 0.375rem;
      color: var(--text-light);
    }
    
    .upload-progress {
      margin-top: 0.875rem;
      display: none;
    }
    
    .progress {
      height: 4px;
      border-radius: 2px;
      background: var(--border-light);
    }
    
    .progress-bar {
      border-radius: 2px;
    }
    
    .photo-count {
      color: var(--text-secondary);
      font-size: 0.8125rem;
      margin-top: 0.5rem;
      padding: 0.375rem 0.75rem;
      background: var(--white);
      border-radius: 3px;
      display: inline-block;
      border: 1px solid var(--border-light);
      font-weight: 500;
    }
    
    .photo-count.warning {
      background: #fff8e1;
      border-color: #ffa000;
      color: #664d03;
    }
    
    .photo-count.danger {
      background: #ffebee;
      border-color: #d32f2f;
      color: #5f2120;
    }
    
    .alert {
      border-radius: 4px;
      border: none;
      font-size: 0.875rem;
      padding: 0.875rem 1rem;
    }
    
    .progress-bar-container {
      margin-top: 1rem;
    }
    
    /* Empty state */
    .items-list .text-muted {
      padding: 1.5rem;
      text-align: center;
      background: #fafafa;
      border: 1px dashed var(--border-light);
      border-radius: 4px;
      font-size: 0.9375rem;
    }
    
    /* Section spacing */
    .mb-section {
      margin-bottom: 2.5rem;
    }
    
    /* Grid improvements */
    .row {
      --bs-gutter-x: 1.25rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1.25rem 1rem;
        margin: 0.75rem auto;
        border-radius: 6px;
      }
      
      .navbar-container {
        padding: 0 1rem;
      }
      
      .d-flex {
        flex-direction: column;
      }
      
      .gap-2 > * {
        width: 100%;
      }
      
      .row.g-3 > [class*="col-"] {
        margin-bottom: 1rem;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 1rem 0.75rem;
      }
      
      .nav-tabs .nav-link {
        padding: 0.625rem 0.75rem;
        font-size: 0.8125rem;
      }
      
      .form-control, .form-select {
        font-size: 0.9375rem;
      }
      
      .btn {
        font-size: 0.9375rem;
        padding: 0.625rem 1.25rem;
      }
      
      .item-card {
        padding: 0.875rem;
      }
      
      .photo-preview {
        max-width: 120px;
        height: 120px;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-container">
      <a class="navbar-brand" href="/dashboard">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Injaaz">
        <span>Injaaz</span>
      </a>
      <div class="module-badge">HVAC & MEP</div>
      <div class="navbar-nav">
        {% if is_edit_mode %}
        <a href="/dashboard" class="nav-btn next-btn">‚Üê Back to Dashboard</a>
        {% else %}
        <a href="/civil/form" class="nav-btn next-btn">Next ‚Üí</a>
        {% endif %}
      </div>
    </div>
  </nav>
  
  <div class="container">
    <h2>HVAC & MEP Inspection{% if is_edit_mode %} - Edit Mode{% endif %}</h2>
    <p class="text-muted mb-4">
      {% if is_supervisor_edit %}
      Review the technician's submission below. You can edit any fields, add new items, add your comments, verify, and sign to approve.
      {% elif is_edit_mode %}
      Review and edit the submission below. Signatures cannot be modified.
      {% else %}
      Complete site visit documentation with photos and signatures
      {% endif %}
    </p>

    <form id="mainForm" enctype="multipart/form-data" onsubmit="return false;" novalidate>
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs" id="hvacTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-1-link" data-bs-toggle="tab" data-bs-target="#tab-1" type="button" role="tab">1. Project Info</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-2-link" data-bs-toggle="tab" data-bs-target="#tab-2" type="button" role="tab">2. Work Items</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-3-link" data-bs-toggle="tab" data-bs-target="#tab-3" type="button" role="tab">3. Sign-off & Submit</button>
        </li>
      </ul>

      <div class="tab-content" id="hvacTabContent">
        <!-- TAB 1: Project Info -->
        <div class="tab-pane fade show active" id="tab-1" role="tabpanel">
          <h4 class="section-heading">Project Information</h4>
          <div class="row g-3">
            <div class="col-md-6 mb-3">
              <label for="site_name" class="form-label">Site Name</label>
              <input id="site_name" name="site_name" class="form-control" 
                     {% if is_edit_mode and submission_data %}value="{{ submission_data.site_name or (submission_data.form_data.site_name if submission_data.form_data else '') }}"{% endif %}
                     {% if not is_supervisor_edit %}required{% endif %}>
            </div>

            <div class="col-md-6 mb-3">
              <label for="visit_date" class="form-label">Visit Date</label>
              <input id="visit_date" name="visit_date" type="date" class="form-control" 
                     {% if is_edit_mode and submission_data %}value="{{ submission_data.visit_date or (submission_data.form_data.visit_date if submission_data.form_data else '') }}"{% endif %}
                     {% if not is_supervisor_edit %}required{% endif %} max="">
            </div>
          </div>

          <div class="d-flex mt-4">
            <button type="button" class="btn btn-primary ms-auto" onclick="goToTab(2)">Next: Work Items &raquo;</button>
          </div>
        </div>

        <!-- TAB 2: Work Items -->
        <div class="tab-pane fade" id="tab-2" role="tabpanel">
          
          {% if is_edit_mode and submission_data %}
          <!-- Debug: Submission data loaded -->
          <script>
            console.log('üîç DEBUG: Submission data from Jinja:', {{ submission_data|tojson|safe }});
          </script>
          {% endif %}

          <div class="row g-3">
          <!-- ============================================= -->
          <!-- SUPERVISOR/MANAGER VIEW: Submitted Items First -->
          <!-- ============================================= -->
        {% if is_supervisor_edit %}
        
        <!-- Submitted Inspection Items (TOP for Supervisor/Manager) -->
        <div class="col-12 mb-section">
          <h5 style="color: #059669; font-weight: 700; border-bottom: 2px solid #059669; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">SUBMITTED INSPECTION ITEMS</h5>
          <p class="text-muted small" style="margin-top: -1rem; margin-bottom: 1.5rem;">Review and edit the items submitted by the technician below.</p>
          
          <!-- Server-side rendered items for supervisor view (editable) -->
          {% if is_edit_mode and submission_data and submission_data.form_data and submission_data.form_data['items'] %}
          <div id="serverRenderedItems" class="items-list mb-3">
            {% for item in submission_data.form_data['items'] %}
            <div class="item-card editable-item-card" data-item-index="{{ loop.index0 }}" data-edit-mode="false" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="d-flex align-items-center gap-2">
                  <h6 style="margin: 0; color: #059669; font-weight: 700;">Item {{ loop.index }}</h6>
                  <span class="badge bg-light text-success border border-success-subtle small px-2 py-1">‚úì Already Registered Asset</span>
                </div>
                <div class="d-flex flex-column align-items-end gap-2">
                  <button type="button" class="btn btn-sm btn-danger remove-server-item" data-idx="{{ loop.index0 }}">üóëÔ∏è Remove</button>
                  <button type="button" class="btn btn-sm btn-outline-primary edit-asset-toggle" data-idx="{{ loop.index0 }}" style="display: flex; align-items: center; gap: 0.25rem;">
                    <span class="edit-icon">‚úé</span> <span class="edit-text">Edit this Asset</span>
                  </button>
                </div>
              </div>
              
              <div class="row g-3">
                <!-- Asset -->
                <div class="col-md-4">
                  <label class="form-label"><strong>Asset</strong></label>
                  <select class="form-select editable-field editable-dropdown" data-field="asset" data-item-index="{{ loop.index0 }}" disabled>
                    <option value="">Select Asset</option>
                  </select>
                </div>
                
                <!-- System -->
                <div class="col-md-4">
                  <label class="form-label"><strong>System</strong></label>
                  <select class="form-select editable-field editable-dropdown" data-field="system" data-item-index="{{ loop.index0 }}" disabled>
                    <option value="">Select System</option>
                  </select>
                </div>
                
                <!-- Description -->
                <div class="col-md-4">
                  <label class="form-label"><strong>Description</strong></label>
                  <select class="form-select editable-field editable-dropdown" data-field="description" data-item-index="{{ loop.index0 }}" disabled>
                    <option value="">Select Description</option>
                  </select>
                </div>
                
                <!-- Quantity -->
                <div class="col-md-4">
                  <label class="form-label"><strong>Quantity</strong></label>
                  <input type="number" class="form-control editable-field" data-field="quantity" value="{{ item.quantity or '1' }}" min="1" placeholder="1" disabled>
                </div>
                
                <!-- Brand -->
                <div class="col-md-4">
                  <label class="form-label"><strong>Brand</strong></label>
                  <input type="text" class="form-control editable-field" data-field="brand" value="{{ item.brand or '' }}" placeholder="Brand name" disabled>
                </div>
                
                <!-- Specification -->
                <div class="col-md-4">
                  <label class="form-label"><strong>Specification</strong></label>
                  <input type="text" class="form-control editable-field" data-field="specification" value="{{ item.specification or '' }}" placeholder="Specification" disabled>
                </div>
                
                <!-- Comments -->
                <div class="col-12">
                  <label class="form-label"><strong>Comments</strong></label>
                  <textarea class="form-control editable-field" data-field="comments" rows="3" placeholder="Enter comments" disabled>{{ item.comments or '' }}</textarea>
                </div>
                
                <!-- Photos -->
                <div class="col-12">
                  <label class="form-label"><strong>Photos</strong></label>
                  {% if item.photos and item.photos|length > 0 %}
                  <div class="photo-count mb-2" style="font-size: 0.85rem;">
                    üì∑ {{ item.photos|length }} photo(s) ‚òÅÔ∏è Uploaded
                  </div>
                  <div class="thumbs-row mb-2" style="display: flex; flex-wrap: wrap; gap: 4px;">
                    {% for photo in item.photos[:6] %}
                      {% set photo_url = photo.url if photo is mapping else photo %}
                      {% if photo_url %}
                      <img src="{{ photo_url }}" alt="Photo {{ loop.index }}" 
                           style="width: 70px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #e5e7eb; cursor: pointer; background: #f3f4f6;"
                           onclick="window.open('{{ photo_url }}', '_blank')"
                           onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2270%22 height=%2250%22%3E%3Crect width=%2270%22 height=%2250%22 fill=%22%23e5e7eb%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2210%22%3EFailed%3C/text%3E%3C/svg%3E'">
                      {% endif %}
                    {% endfor %}
                    {% if item.photos|length > 6 %}
                    <span class="badge bg-secondary" style="margin-left: 8px; align-self: center;">+{{ item.photos|length - 6 }} more</span>
                    {% endif %}
                  </div>
                  {% else %}
                  <div class="photo-count mb-2" style="font-size: 0.85rem; color: #6b7280;">
                    üì∑ No photos attached
                  </div>
                  {% endif %}
                  
                  <!-- Add more photos button -->
                  <button type="button" class="btn btn-sm btn-outline-primary add-photos-to-item" data-item-index="{{ loop.index0 }}">
                    üì∑ Add More Photos
                  </button>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="alert alert-info">No items submitted yet.</div>
          {% endif %}
          
        </div>
        
        <!-- Add New Item Section (BELOW submitted items for Supervisor) -->
        <div class="col-12 mb-section">
          <h5>Add New Item (Optional)</h5>
          <p class="text-muted" style="font-size: 0.9rem;">If needed, you can add additional items to this submission.</p>
        </div>
        
        {% else %}
        <!-- ============================================= -->
        <!-- SUPERVISOR VIEW: Add Item Form First -->
        <!-- ============================================= -->
        
        <!-- Add Inspection Item Section (FIRST for Supervisor) -->
        <div class="col-12 mb-section">
          <h5>Add Inspection Item</h5>
        </div>
        {% endif %}

        <div class="col-md-4 mb-2">
          <label class="form-label">Asset</label>
          <select id="curAsset" class="form-select" disabled>
            <option value="">Select Asset</option>
          </select>
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">System</label>
          <select id="curSystem" class="form-select" disabled>
            <option value="">Select System</option>
          </select>
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">Description</label>
          <select id="curDescription" class="form-select" disabled>
            <option value="">Select Description</option>
          </select>
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">Quantity</label>
          <input type="number" id="curQuantity" class="form-control" placeholder="Enter quantity" min="1" value="1">
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">Brand</label>
          <input type="text" id="curBrand" class="form-control" placeholder="Enter brand name">
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">Specification</label>
          <input type="text" id="curSpecification" class="form-control" placeholder="Enter specification">
        </div>

        <div class="col-12 mb-2">
          <label class="form-label">Comments</label>
          <textarea id="curComments" class="form-control" rows="3" placeholder="Enter any comments"></textarea>
        </div>

        <!-- Photos -->
        <div class="col-12 mb-3">
          <label class="form-label">Photos (Maximum 100 per item)</label>
          <input id="curPhotos" type="file" class="form-control d-none" accept="image/*" multiple>
          
          <div id="dropZone" class="drop-zone">
            <div class="drop-zone-content">
              <strong>Drag and drop images here</strong>
              <small>or click to browse ‚Ä¢ Maximum 100 images ‚Ä¢ Auto-compressed to 1280px ‚Ä¢ Max 10MB per file</small>
            </div>
          </div>
          
          <div id="fileWarning" class="file-warning">
            ‚ö†Ô∏è Some files are larger than 10MB and will be skipped
          </div>
          
          <div id="uploadProgress" class="upload-progress">
            <div class="progress">
              <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 0%"></div>
            </div>
          </div>
          
          <div id="photoCount" class="photo-count" style="display:none;"></div>
          
          <!-- Photo Preview Container with Remove Buttons -->
          <div id="photoPreviewContainer" class="photo-preview-container" style="display:none;"></div>
        </div>

        <!-- Action Buttons -->
        <div class="col-12 mb-3 d-flex gap-2">
          <button id="addItemBtn" type="button" class="btn btn-success">Add Item</button>
          <button id="clearCurrentBtn" type="button" class="btn btn-outline-secondary">Clear Current</button>
          <button id="clearItemsBtn" type="button" class="btn btn-outline-danger">Clear All Items</button>
        </div>
        
        <!-- Items List (Unified section for all views) -->
        <div class="col-12 mb-section">
          <h5 id="itemsListTitle">{% if is_supervisor_edit %}Newly Added Items{% else %}Inspection Items{% endif %}</h5>
          <div id="itemsList" class="items-list"></div>
        </div>

        {% if is_edit_mode and submission_data %}
        <!-- Pre-load items data for JavaScript access -->
        <script>
          // Store submission items globally for the main script to access
          window.preloadedSubmissionData = {{ submission_data|tojson|safe }};
          {% if submission_data.form_data and submission_data.form_data['items'] %}
          window.preloadedItems = {{ submission_data.form_data['items']|tojson|safe }};
          {% else %}
          window.preloadedItems = [];
          {% endif %}
          console.log('üì¶ Preloaded submission data:', window.preloadedSubmissionData);
          console.log('üì¶ Preloaded items:', window.preloadedItems);
          console.log('üì¶ Preloaded items count:', window.preloadedItems ? window.preloadedItems.length : 0);
          
          // Mark that server-rendered items exist
          window.hasServerRenderedItems = {{ 'true' if submission_data.form_data and submission_data.form_data['items'] else 'false' }};
        </script>
        {% endif %}

          </div>

          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="goToTab(1)">&laquo; Previous</button>
            <button type="button" class="btn btn-primary" onclick="goToTab(3)">Next: Sign-off & Submit &raquo;</button>
          </div>
        </div>

        <!-- TAB 3: Sign-off & Submit -->
        <div class="tab-pane fade" id="tab-3" role="tabpanel">
          <h4 class="section-heading">Signatures & Submission</h4>
          <div class="row g-3">
        
        {% if not (user_designation == 'supervisor' or is_supervisor_edit) %}
        <!-- Supervisor signature display - Hidden for all supervisor users -->
        <div class="col-md-6 mb-3">
          <div class="signature-container">
          <div class="signature-label">
              <label class="form-label mb-0" style="flex: 1;">Supervisor Signature</label>
              <span class="signature-hint">Draw signature</span>
          </div>
          <canvas id="techSignaturePad" class="signature-pad"></canvas>
          <input type="hidden" id="techSignatureData" name="tech_signature">
          <button type="button" id="clearTech" class="btn btn-outline-secondary btn-sm mt-2">Clear</button>
          </div>
        </div>
        {% endif %}

        {% if is_supervisor_edit or user_designation == 'supervisor' %}
        <!-- Supervisor Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-lg-7 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Supervisor Comments</label>
              <textarea id="supervisorComments" class="form-control" rows="6" style="border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-lg-5 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Supervisor Signature</label>
                  <span class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="supervisorSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="supervisorSignatureData" name="supervisor_signature">
                <button type="button" id="clearSupervisor" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'operations_manager' and is_edit_mode %}
        <!-- Operations Manager Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-lg-7 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Comments</label>
              <textarea id="operationsManagerComments" class="form-control" rows="6" style="border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-lg-5 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Operations Manager Signature</label>
                  <span class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="opManSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="opManSignatureData" name="opMan_signature">
                <button type="button" id="clearOp" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'business_development' and is_edit_mode %}
        <!-- Previous Reviewers: Operations Manager + Procurement (Read-only for BD) -->
        <div class="col-12 mb-4" id="previousForBDSection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlySection" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Comments</label>
                <div id="opsManagerCommentsReadOnly" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 100px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <div class="signature-container h-100 d-flex flex-column">
                  <div class="signature-label">
                    <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Operations Manager Signature</label>
                    <span class="signature-hint text-success small">‚úì Signed</span>
                  </div>
                  <div id="opsManagerSignatureReadOnly" style="min-height: 160px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: #9ca3af;">Loading signature...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Procurement (so BD can see if PO has signed) -->
          <div id="procurementReadOnlyBD" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Procurement Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Comments</label>
                <div id="procurementCommentsReadOnlyBD" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Signature</label>
                <div id="procurementSignatureReadOnlyBD" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Business Development Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-lg-7 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Business Development Comments</label>
              <textarea id="businessDevComments" class="form-control" rows="6" style="border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-lg-5 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Business Development Signature</label>
                  <span class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="businessDevSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="businessDevSignatureData" name="business_dev_signature">
                <button type="button" id="clearBusinessDev" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'procurement' and is_edit_mode %}
        <!-- Previous Reviewers: Operations Manager + Business Development (Read-only for Procurement) -->
        <div class="col-12 mb-4" id="previousForProcurementSection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlyProc" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="opsManagerCommentsReadOnlyProc" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="opsManagerSignatureReadOnlyProc" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Business Development -->
          <div id="bdReadOnlyProc" style="display: none;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Business Development Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="bdCommentsReadOnlyProc" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="bdSignatureReadOnlyProc" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Procurement Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-lg-7 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Comments</label>
              <textarea id="procurementComments" class="form-control" rows="6" style="border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-lg-5 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Procurement Signature</label>
                  <span class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="procurementSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="procurementSignatureData" name="procurement_signature">
                <button type="button" id="clearProcurement" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'general_manager' and is_edit_mode %}
        <!-- Previous Reviewers: Operations Manager, BD, Procurement (Read-only for GM) -->
        <div class="col-12 mb-4" id="previousReviewersReadOnlySection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlyGM" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="opsManagerCommentsReadOnlyGM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="opsManagerSignatureReadOnlyGM" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px;"></div>
              </div>
            </div>
          </div>
          
          <!-- Business Development -->
          <div id="bdReadOnlyGM" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Business Development Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="bdCommentsReadOnlyGM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="bdSignatureReadOnlyGM" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px;"></div>
              </div>
            </div>
          </div>
          
          <!-- Procurement -->
          <div id="procurementReadOnlyGM" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Procurement Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="procurementCommentsReadOnlyGM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="procurementSignatureReadOnlyGM" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- General Manager Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-lg-7 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">General Manager Comments</label>
              <textarea id="generalManagerComments" class="form-control" rows="6" style="border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-lg-5 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">General Manager Signature</label>
                  <span class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="generalManagerSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="generalManagerSignatureData" name="general_manager_signature">
                <button type="button" id="clearGeneralManager" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Submit Section -->
        <div class="col-12 mb-5 mt-4 text-center">
          <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-secondary" onclick="goToTab(2)">&laquo; Previous</button>
          </div>
          <button type="button" id="submitAllBtn" class="btn btn-success px-5 py-2 shadow-sm" style="font-weight: 700; letter-spacing: 0.5px; border-radius: 8px;">
            {% if is_edit_mode %}‚úì UPDATE SUBMISSION{% else %}üöÄ SUBMIT INSPECTION{% endif %}
          </button>
        </div>

        <!-- Status & Downloads -->
        <div class="col-12">
          <div id="statusBox" class="mt-3"></div>
          <div id="progressContainer" class="progress-bar-container" style="display:none;">
            <div class="progress">
              <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
            </div>
          </div>
          
          <!-- Download Links Container (green buttons below submit) -->
          <div id="downloadLinks" class="mt-3"></div>
        </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Upload Progress Modal -->
  <div id="uploadModal" class="upload-modal">
    <div class="upload-modal-content">
      <h4 style="margin-bottom: 1rem;">Uploading Photos</h4>
      <div id="uploadModalText" style="margin-bottom: 1rem; color: #666;">
        Preparing images...
      </div>
      <div class="upload-progress-bar">
        <div id="uploadModalProgress" class="upload-progress-fill" style="width: 0%">
          0%
        </div>
      </div>
      <small style="color: #999; display: block; margin-top: 0.5rem;">Please wait, this may take a few minutes for large batches</small>
    </div>
  </div>

  <!-- Loading Overlay for Report Generation -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Generating Reports...</div>
    <div class="loading-subtitle">This typically takes 2-3 minutes for large submissions</div>
    <div class="loading-subtitle" style="margin-top: 1.5rem; font-size: 0.8rem;">Creating Excel and PDF reports with all photos</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="{{ url_for('static', filename='dropdown_init.js') }}"></script>
  <script src="{{ url_for('static', filename='form.js') }}"></script>

  <script>
    const modulePrefix = "{{ url_for('hvac_mep_bp.index') }}".replace('/form','');
    const MAX_PHOTOS_PER_ITEM = 100;
    const MAX_IMAGE_DIMENSION = 1280; // Reduced from 1920 for faster uploads
    const JPEG_QUALITY = 0.85;
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    const UPLOAD_RETRY_ATTEMPTS = 3;
    const DRAFT_SAVE_INTERVAL = 30000; // 30 seconds

    // Define goToTab function early for onclick handlers
    function goToTab(tabNumber) {
      console.log('üîÑ goToTab called with tabNumber:', tabNumber);
      
      // Check if Bootstrap is loaded
      if (typeof bootstrap === 'undefined') {
        console.error('‚ùå Bootstrap is not loaded yet!');
        return;
      }
      
      const tabLink = document.getElementById(`tab-${tabNumber}-link`);
      console.log('  Tab link element:', tabLink);
      
      if (tabLink) {
        try {
          const tab = new bootstrap.Tab(tabLink);
          tab.show();
          console.log('‚úÖ Tab switched successfully to tab', tabNumber);
          
          // Scroll to top of form
          const hvacTabs = document.getElementById('hvacTabs');
          if (hvacTabs) {
            hvacTabs.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        } catch (error) {
          console.error('‚ùå Error switching tab:', error);
        }
      } else {
        console.error('‚ùå Tab link not found for tab:', tabNumber);
        console.log('  Available tab links:');
        for (let i = 1; i <= 3; i++) {
          const link = document.getElementById(`tab-${i}-link`);
          console.log(`    tab-${i}-link:`, link);
        }
      }
    }
    
    // Make goToTab available globally immediately
    window.goToTab = goToTab;
    console.log('‚úÖ goToTab function defined and available globally');

    // Initialize form will be called later in attemptLoadData()

    function checkBrowserSupport() {
      if (!window.FileReader) {
        alert('Your browser does not support file uploads. Please use a modern browser.');
        return false;
      }
      if (!HTMLCanvasElement.prototype.toBlob) {
        console.warn('Canvas.toBlob not supported, using polyfill');
        Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
          value: function (callback, type, quality) {
            const canvas = this;
            setTimeout(() => {
              const binStr = atob(canvas.toDataURL(type, quality).split(',')[1]);
              const len = binStr.length;
              const arr = new Uint8Array(len);
              for (let i = 0; i < len; i++) { arr[i] = binStr.charCodeAt(i); }
              callback(new Blob([arr], { type: type || 'image/png' }));
            });
          }
        });
      }
      return true;
    }

    function initSignaturePads() {
      const techCanvas = document.getElementById('techSignaturePad');
      const opCanvas = document.getElementById('opManSignaturePad');
      const supervisorCanvas = document.getElementById('supervisorSignaturePad');
      const businessDevCanvas = document.getElementById('businessDevSignaturePad');
      const procurementCanvas = document.getElementById('procurementSignaturePad');
      const generalManagerCanvas = document.getElementById('generalManagerSignaturePad');
      
      // Enhance touch events for mobile
      if (typeof enhanceTouchEvents !== 'undefined') {
        if (techCanvas) enhanceTouchEvents(techCanvas);
        if (opCanvas) enhanceTouchEvents(opCanvas);
        if (supervisorCanvas) enhanceTouchEvents(supervisorCanvas);
        if (businessDevCanvas) enhanceTouchEvents(businessDevCanvas);
        if (procurementCanvas) enhanceTouchEvents(procurementCanvas);
        if (generalManagerCanvas) enhanceTouchEvents(generalManagerCanvas);
      }
      
      const techPad = techCanvas ? new SignaturePad(techCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3,
        throttle: 16
      }) : null;
      
      const opPad = opCanvas ? new SignaturePad(opCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3,
        throttle: 16
      }) : null;

      const supervisorPad = supervisorCanvas ? new SignaturePad(supervisorCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3,
        throttle: 16
      }) : null;

      const businessDevPad = businessDevCanvas ? new SignaturePad(businessDevCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3,
        throttle: 16
      }) : null;

      const procurementPad = procurementCanvas ? new SignaturePad(procurementCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3,
        throttle: 16
      }) : null;

      const generalManagerPad = generalManagerCanvas ? new SignaturePad(generalManagerCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3,
        throttle: 16
      }) : null;

      function resizeCanvas(canvas, pad) {
        if (!canvas || canvas.offsetParent === null) return; // Skip hidden canvases
        
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        
        // Get the CSS size of the canvas
        const styles = window.getComputedStyle(canvas);
        const width = parseInt(styles.width, 10);
        const height = parseInt(styles.height, 10);
        
        // Only resize if dimensions changed significantly
        if (canvas.width === width * ratio && canvas.height === height * ratio) return;

        // Save the current signature data
        const currentData = pad && !pad.isEmpty() ? pad.toDataURL() : null;
        
        canvas.width = width * ratio;
        canvas.height = height * ratio;
        
        const ctx = canvas.getContext('2d');
        ctx.scale(ratio, ratio);
        
        // Restore the signature if it existed
        if (currentData && pad) {
          pad.fromDataURL(currentData);
        }
      }
      
      // Initial resize with a slight delay to ensure layout is ready
      setTimeout(() => {
        if (techCanvas) resizeCanvas(techCanvas, techPad);
        if (opCanvas) resizeCanvas(opCanvas, opPad);
        if (supervisorCanvas) resizeCanvas(supervisorCanvas, supervisorPad);
        if (businessDevCanvas) resizeCanvas(businessDevCanvas, businessDevPad);
        if (procurementCanvas) resizeCanvas(procurementCanvas, procurementPad);
        if (generalManagerCanvas) resizeCanvas(generalManagerCanvas, generalManagerPad);
      }, 500);
      
      // Resize on window resize
      window.addEventListener('resize', () => {
        if (techCanvas) resizeCanvas(techCanvas, techPad);
        if (opCanvas) resizeCanvas(opCanvas, opPad);
        if (supervisorCanvas) resizeCanvas(supervisorCanvas, supervisorPad);
        if (businessDevCanvas) resizeCanvas(businessDevCanvas, businessDevPad);
        if (procurementCanvas) resizeCanvas(procurementCanvas, procurementPad);
        if (generalManagerCanvas) resizeCanvas(generalManagerCanvas, generalManagerPad);
      });

      const clearTechBtn = document.getElementById('clearTech');
      if (clearTechBtn && techPad) {
        clearTechBtn.addEventListener('click', () => { 
          techPad.clear(); 
          const techSigInput = document.getElementById('techSignatureData');
          if (techSigInput) techSigInput.value = '';
        });
      }
      
      const clearOpBtn = document.getElementById('clearOp');
      if (clearOpBtn && opPad) {
        clearOpBtn.addEventListener('click', () => { 
          opPad.clear(); 
          const opSigInput = document.getElementById('opManSignatureData');
          if (opSigInput) opSigInput.value = '';
        });
      }

      const clearSupervisorBtn = document.getElementById('clearSupervisor');
      if (clearSupervisorBtn && supervisorPad) {
        clearSupervisorBtn.addEventListener('click', () => { 
          supervisorPad.clear(); 
          const supervisorSigInput = document.getElementById('supervisorSignatureData');
          if (supervisorSigInput) supervisorSigInput.value = '';
        });
      }

      const clearBusinessDevBtn = document.getElementById('clearBusinessDev');
      if (clearBusinessDevBtn && businessDevPad) {
        clearBusinessDevBtn.addEventListener('click', () => { 
          businessDevPad.clear(); 
          const businessDevSigInput = document.getElementById('businessDevSignatureData');
          if (businessDevSigInput) businessDevSigInput.value = '';
        });
      }

      const clearProcurementBtn = document.getElementById('clearProcurement');
      if (clearProcurementBtn && procurementPad) {
        clearProcurementBtn.addEventListener('click', () => { 
          procurementPad.clear(); 
          const procurementSigInput = document.getElementById('procurementSignatureData');
          if (procurementSigInput) procurementSigInput.value = '';
        });
      }

      const clearGeneralManagerBtn = document.getElementById('clearGeneralManager');
      if (clearGeneralManagerBtn && generalManagerPad) {
        clearGeneralManagerBtn.addEventListener('click', () => { 
          generalManagerPad.clear(); 
          const generalManagerSigInput = document.getElementById('generalManagerSignatureData');
          if (generalManagerSigInput) generalManagerSigInput.value = '';
        });
      }

      return { techPad, opPad, supervisorPad, businessDevPad, procurementPad, generalManagerPad };
    }

    (function(){
      const curAsset = document.getElementById('curAsset');
      const curSystem = document.getElementById('curSystem');
      const curDescription = document.getElementById('curDescription');
      const curQuantity = document.getElementById('curQuantity');
      const curBrand = document.getElementById('curBrand');
      const curSpecification = document.getElementById('curSpecification');
      const curComments = document.getElementById('curComments');
      const curPhotos = document.getElementById('curPhotos');
      const dropZone = document.getElementById('dropZone');
      const photoCount = document.getElementById('photoCount');
      const photoPreviewContainer = document.getElementById('photoPreviewContainer');
      const fileWarning = document.getElementById('fileWarning');
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadModal = document.getElementById('uploadModal');
      const uploadModalText = document.getElementById('uploadModalText');
      const uploadModalProgress = document.getElementById('uploadModalProgress');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const addItemBtn = document.getElementById('addItemBtn');
      const clearCurrentBtn = document.getElementById('clearCurrentBtn');
      const clearItemsBtn = document.getElementById('clearItemsBtn');
      const itemsList = document.getElementById('itemsList');
      const submitAllBtn = document.getElementById('submitAllBtn');
      const statusBox = document.getElementById('statusBox');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const downloadLinks = document.getElementById('downloadLinks');
      
      const pads = initSignaturePads();
      
      // Make pads available globally for loadSubmissionData
      window.signaturePads = pads;

      // Initialize Upload Queue System
      let photoQueue = null;
      let photoQueueUI = null;
      
      if (window.PhotoUploadQueue && window.PhotoQueueUI) {
        photoQueue = new window.PhotoUploadQueue({
          uploadEndpoint: modulePrefix + '/upload-photo',
          maxConcurrent: 3,
          onProgress: (stats) => {
            if (photoQueueUI) photoQueueUI.updateProgress(stats);
          },
          onItemComplete: (item, success) => {
            // Update UI when individual items complete
            if (photoQueueUI) {
              photoQueueUI.updatePhotoStatus(item);
            }
            // Update the currentFiles array with the uploaded URL
            if (success && item.url) {
              const fileIndex = currentFiles.findIndex(f => f._queueId === item.id);
              if (fileIndex !== -1) {
                currentFiles[fileIndex].url = item.url;
                currentFiles[fileIndex].is_cloud = true;
              }
            }
            updatePhotoCount();
          },
          onQueueComplete: (stats) => {
            if (window.safeLog) window.safeLog.log('‚úÖ All uploads complete:', stats);
            updatePhotoCount();
            // Show success message if all completed
            if (stats.completed === stats.total && stats.failed === 0) {
              if (window.safeLog) window.safeLog.log(`‚úÖ Successfully uploaded ${stats.completed} photo(s)`);
            }
          },
          onError: (error) => {
            console.error('Upload error:', error);
          }
        });

        photoQueueUI = new window.PhotoQueueUI({
          containerId: 'photoPreviewContainer',
          onRetry: (photoId) => {
            photoQueue.retryUpload(photoId);
          },
          onRemove: (photoId) => {
            photoQueue.removePhoto(photoId);
            updatePhotoCount();
          }
        });

        // Create progress container (only if photoPreviewContainer exists)
        if (photoPreviewContainer && photoPreviewContainer.parentNode) {
          const progressDiv = document.createElement('div');
          progressDiv.id = 'queue-progress-container';
          progressDiv.className = 'mb-3';
          photoPreviewContainer.parentNode.insertBefore(progressDiv, photoPreviewContainer);
        }

        // Add retry all button event listener
        document.addEventListener('click', (e) => {
          if (e.target.id === 'retry-all-failed-btn' || e.target.closest('#retry-all-failed-btn')) {
            photoQueue.retryAllFailed();
          }
        });
        
        // Handle window resize and orientation changes for mobile responsiveness
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            if (photoQueueUI) {
              photoQueueUI.updateLayout();
            }
          }, 250);
        });
        
        window.addEventListener('orientationchange', () => {
          setTimeout(() => {
            if (photoQueueUI) {
              photoQueueUI.updateLayout();
            }
          }, 100);
        });
      }

      function updatePhotoCount() {
        const stats = photoQueue ? photoQueue.getStats() : { completed: currentFiles.length };
        const count = stats.completed || currentFiles.length;
        photoCount.textContent = `${count} / ${MAX_PHOTOS_PER_ITEM}`;
      }

      let items = [];
      window.formItems = items; // Make accessible globally
      let currentFiles = [];
      let currentPreviews = [];
      let pollingInterval = null;

      // Auto-download helper function
      function autoDownload(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      if (!checkBrowserSupport()) {
        dropZone.style.display = 'none';
        curPhotos.classList.remove('d-none');
        uploadProgress.innerHTML = '<div class="alert alert-warning">Using fallback mode</div>';
        uploadProgress.style.display = 'block';
      }

      async function compressImage(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let { width, height } = img;
              
              if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                if (width > height) {
                  height = Math.round((height / width) * MAX_IMAGE_DIMENSION);
                  width = MAX_IMAGE_DIMENSION;
                } else {
                  width = Math.round((width / height) * MAX_IMAGE_DIMENSION);
                  height = MAX_IMAGE_DIMENSION;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              canvas.toBlob((blob) => {
                if (!blob) {
                  reject(new Error('Compression failed'));
                  return;
                }
                const compressed = new File([blob], file.name.replace(/\.\w+$/, '.jpg'), {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                resolve(compressed);
              }, 'image/jpeg', JPEG_QUALITY);
            };
            img.onerror = () => reject(new Error('Image load failed'));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error('File read failed'));
          reader.readAsDataURL(file);
        });
      }

      async function handleFiles(files) {
        if (!files || files.length === 0) return;
        
        const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (imageFiles.length === 0) {
          alert('Please select image files only.');
          return;
        }
        
        // File size validation upfront
        const oversizedFiles = imageFiles.filter(f => f.size > MAX_FILE_SIZE);
        if (oversizedFiles.length > 0) {
          fileWarning.style.display = 'block';
          fileWarning.textContent = `‚ö†Ô∏è ${oversizedFiles.length} file(s) exceed 10MB limit and will be skipped`;
          setTimeout(() => { fileWarning.style.display = 'none'; }, 5000);
        }
        
        const validFiles = imageFiles.filter(f => f.size <= MAX_FILE_SIZE);
        if (validFiles.length === 0) {
          alert('All files exceed 10MB size limit. Please compress them first.');
          return;
        }
        
        const totalAfter = currentFiles.length + validFiles.length;
        if (totalAfter > MAX_PHOTOS_PER_ITEM) {
          alert(`Maximum ${MAX_PHOTOS_PER_ITEM} photos per item. You have ${currentFiles.length}, trying to add ${validFiles.length}.`);
          return;
        }
        
        // Use upload queue if available
        if (photoQueue && photoQueueUI) {
          const addedItems = await photoQueue.addPhotos(validFiles);
          addedItems.forEach(item => {
            currentFiles.push({ _queueId: item.id, url: null, is_cloud: false });
            photoQueueUI.renderPhotoItem(item);
          });
          updatePhotoCount();
          saveDraft();
          return;
        }
        
        // Fallback to original compression logic
        uploadProgress.style.display = 'block';
        
        const BATCH_SIZE = 3;
        let successCount = 0;
        let failedFiles = [];
        
        for (let i = 0; i < validFiles.length; i += BATCH_SIZE) {
          const batch = validFiles.slice(i, i + BATCH_SIZE);
          const promises = batch.map(file => compressImage(file));
          
          try {
            const compressed = await Promise.all(promises);
            compressed.forEach(c => {
              if (c) {
                currentFiles.push(c);
                currentPreviews.push(URL.createObjectURL(c));
                successCount++;
              }
            });
          } catch (err) {
            console.error('Batch compression error:', err);
            batch.forEach(f => failedFiles.push(f.name));
          }
          
          const progress = Math.round(((i + batch.length) / validFiles.length) * 100);
          uploadProgressBar.style.width = progress + '%';
          uploadProgressBar.textContent = `Compressing ${Math.min(i + batch.length, validFiles.length)}/${validFiles.length}...`;
        }
        
        uploadProgress.style.display = 'none';
        
        if (failedFiles.length > 0) {
          alert(`‚ö†Ô∏è Failed to process ${failedFiles.length} file(s): ${failedFiles.slice(0, 3).join(', ')}${failedFiles.length > 3 ? '...' : ''}`);
        }
        
        renderPhotoPreview();
        saveDraft(); // Auto-save after adding photos
      }

      function renderPhotoPreview() {
        // Ensure container exists
        if (!photoPreviewContainer) {
          console.warn('‚ö†Ô∏è photoPreviewContainer not found, skipping preview render');
          return;
        }
        
        photoPreviewContainer.innerHTML = '';
        const count = currentFiles.length;
        
        if (count === 0) {
          if (photoCount) photoCount.style.display = 'none';
          photoPreviewContainer.style.display = 'none';
          return;
        }
        
        photoPreviewContainer.style.display = 'flex';
        photoCount.style.display = 'inline-block';
        photoCount.textContent = `${count} / ${MAX_PHOTOS_PER_ITEM} photos`;
        photoCount.className = 'photo-count mt-2';
        if (count >= MAX_PHOTOS_PER_ITEM * 0.8) photoCount.classList.add('warning');
        if (count >= MAX_PHOTOS_PER_ITEM) photoCount.classList.add('danger');
        
        currentPreviews.forEach((url, idx) => {
          const item = document.createElement('div');
          item.className = 'photo-preview-item';
          
          const img = document.createElement('img');
          img.src = url;
          img.alt = `Photo ${idx + 1}`;
          
          const removeBtn = document.createElement('div');
          removeBtn.className = 'photo-preview-remove';
          removeBtn.textContent = '√ó';
          removeBtn.title = 'Remove this photo';
          removeBtn.onclick = () => removePhoto(idx);
          
          item.appendChild(img);
          item.appendChild(removeBtn);
          if (photoPreviewContainer) {
            photoPreviewContainer.appendChild(item);
          }
        });
      }
      
      function removePhoto(index) {
        if (index < 0 || index >= currentFiles.length) return;
        URL.revokeObjectURL(currentPreviews[index]);
        currentFiles.splice(index, 1);
        currentPreviews.splice(index, 1);
        renderPhotoPreview();
        saveDraft(); // Auto-save after removing photo
      }

      dropZone.addEventListener('click', () => curPhotos.click());
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
      dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
      dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
      curPhotos.addEventListener('change', () => handleFiles(curPhotos.files));

      // CRITICAL: Dropdown logic
      function clearSelect(el, placeholder='Select') {
        el.innerHTML = `<option value="">${placeholder}</option>`;
        el.disabled = true;
      }

      function fillAssets() {
        clearSelect(curAsset, 'Select Asset');
        if (typeof DROPDOWN_DATA === 'object' && Object.keys(DROPDOWN_DATA).length > 0) {
          Object.keys(DROPDOWN_DATA).forEach(cat => {
            const o = document.createElement('option');
            o.value = cat;
            o.textContent = cat;
            curAsset.appendChild(o);
          });
          curAsset.disabled = false;
        } else {
          curAsset.disabled = true;
          console.error('DROPDOWN_DATA not loaded');
        }
        clearSelect(curSystem, 'Select System');
        clearSelect(curDescription, 'Select Description');
      }

      curAsset.addEventListener('change', () => {
        curSystem.innerHTML = '<option value="">Select System</option>';
        curDescription.innerHTML = '<option value="">Select Description</option>';
        const cat = curAsset.value;
        if (!cat) { 
          curSystem.disabled = true; 
          curDescription.disabled = true; 
          return; 
        }
        const sysObj = (window.DROPDOWN_DATA && window.DROPDOWN_DATA[cat]) ? window.DROPDOWN_DATA[cat] : null;
        if (sysObj && typeof sysObj === 'object') {
          Object.keys(sysObj).forEach(sk => {
            const o = document.createElement('option');
            o.value = sk;
            o.textContent = sk;
            curSystem.appendChild(o);
          });
          curSystem.disabled = false;
          curDescription.disabled = true;
        } else {
          curSystem.disabled = true;
          curDescription.disabled = true;
        }
      });

      curSystem.addEventListener('change', () => {
        curDescription.innerHTML = '<option value="">Select Description</option>';
        const cat = curAsset.value;
        const sk = curSystem.value;
        if (!cat || !sk) { 
          curDescription.disabled = true; 
          return; 
        }
        const arr = (window.DROPDOWN_DATA && window.DROPDOWN_DATA[cat]) ? window.DROPDOWN_DATA[cat][sk] || [] : [];
        arr.forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          curDescription.appendChild(o);
        });
        curDescription.disabled = false;
      });

      addItemBtn.addEventListener('click', async () => {
        const asset = curAsset.value || '';
        const system = curSystem.value || '';
        const description = curDescription.value || '';
        const quantity = curQuantity.value || '1';
        const brand = curBrand.value || '';
        const specification = curSpecification.value || '';
        const comments = curComments.value || '';
        if (!asset || !system || !description) {
          alert('Please select Asset, System and Description before adding.');
          return;
        }
        
        // Check if there are photos to upload
        if (currentFiles.length === 0) {
          alert('Please add at least one photo for this item.');
          return;
        }
        
        // Check if using queue system
        if (photoQueue) {
          const stats = photoQueue.getStats();
          
          if (!stats.isComplete && stats.total > 0) {
            alert(`‚è≥ Please wait for photo uploads to complete.\n\n${stats.uploading + stats.queued} photo(s) still uploading...`);
            return;
          }
          
          if (stats.failed > 0) {
            const proceed = confirm(`‚ö†Ô∏è ${stats.failed} photo(s) failed to upload.\n\nDo you want to add this item without them?\n\nClick "Retry All Failed" to try uploading them again.`);
            if (!proceed) return;
          }
          
          // Get uploaded URLs from queue
          const uploadedPhotos = photoQueue.getUploadedUrls();
          const uploadedPhotoUrls = uploadedPhotos.map(p => p.url);
          
          // Add item with cloud URLs
          items.push({ 
            asset, 
            system, 
            description, 
            quantity: quantity || '1',
            brand: brand || '',
            specification: specification || '',
            comments: comments || '',
            photoUrls: uploadedPhotoUrls,
            photoCount: uploadedPhotoUrls.length
          });
          
          renderItems();
          resetCurrent();
          
          // Clear the queue for next item
          uploadedPhotos.forEach(p => photoQueue.removePhoto(p.id));
          
          saveDraft();
          statusBox.innerHTML = `<div class="alert alert-success">‚úÖ Item added with ${uploadedPhotoUrls.length} photo(s)</div>`;
          setTimeout(() => { statusBox.innerHTML = ''; }, 3000);
          return;
        }
        
        // Fallback: Original upload logic
        addItemBtn.disabled = true;
        addItemBtn.textContent = 'Uploading photos...';
        
        const uploadedPhotoUrls = [];
        const totalPhotos = currentFiles.length;
        
        uploadModal.style.display = 'flex';
        uploadModalText.textContent = `Uploading ${totalPhotos} photos for this item...`;
        
        try {
          for (let i = 0; i < currentFiles.length; i++) {
            const file = currentFiles[i];
            const formData = new FormData();
            formData.append('photo', file, file.name);
            
            const progress = Math.round(((i + 1) / totalPhotos) * 100);
            uploadModalProgress.style.width = progress + '%';
            uploadModalProgress.textContent = `${i + 1}/${totalPhotos} (${progress}%)`;
            
            try {
              const uploadUrl = modulePrefix + '/upload-photo';
              const response = await fetch(uploadUrl, {
                method: 'POST',
                body: formData
              });
              
              if (!response.ok) {
                throw new Error(`Upload failed for ${file.name}`);
              }
              
              const result = await response.json();
              uploadedPhotoUrls.push(result.url);
            } catch (err) {
              console.error(`Failed to upload ${file.name}:`, err);
              if (!confirm(`Failed to upload ${file.name}. Continue anyway?`)) {
                throw err;
              }
            }
          }
          
          items.push({ 
            asset, 
            system, 
            description, 
            quantity: quantity || '1',
            brand: brand || '',
            specification: specification || '',
            comments: comments || '',
            photoUrls: uploadedPhotoUrls,
            photoCount: uploadedPhotoUrls.length
          });
          
          renderItems();
          resetCurrent();
          saveDraft();
          
          statusBox.innerHTML = `<div class="alert alert-success">‚úÖ Item added with ${uploadedPhotoUrls.length} photo(s) uploaded to cloud</div>`;
          setTimeout(() => { statusBox.innerHTML = ''; }, 3000);
          
        } catch (err) {
          statusBox.innerHTML = `<div class="alert alert-danger">‚ùå Failed to upload photos: ${err.message}</div>`;
        } finally {
          uploadModal.style.display = 'none';
          addItemBtn.disabled = false;
          addItemBtn.textContent = 'Add Item';
        }
      });

      clearCurrentBtn.addEventListener('click', resetCurrent);
      clearItemsBtn.addEventListener('click', () => {
        if (!confirm('Clear all items? (Photos already uploaded to cloud will remain there)')) return;
        items = [];
        renderItems();
        saveDraft();
      });

      function resetCurrent() {
        curAsset.value = '';
        curSystem.innerHTML = '<option value="">Select System</option>';
        curSystem.disabled = true;
        curDescription.innerHTML = '<option value="">Select Description</option>';
        curDescription.disabled = true;
        curQuantity.value = '1';
        curBrand.value = '';
        curSpecification.value = '';
        curComments.value = '';
        curPhotos.value = '';
        currentPreviews.forEach(u => URL.revokeObjectURL(u));
        currentFiles = [];
        currentPreviews = [];
        if (photoPreviewContainer) {
          photoPreviewContainer.innerHTML = '';
          photoPreviewContainer.style.display = 'none';
        }
        if (photoCount) photoCount.style.display = 'none';
        fileWarning.style.display = 'none';
      }

      function renderItems() {
        console.log(`üñºÔ∏è renderItems() called - items.length: ${items.length}`);
        const itemsListEl = document.getElementById('itemsList');
        if (!itemsListEl) {
          console.error('‚ùå itemsList element not found in renderItems!');
          console.error('  Document ready state:', document.readyState);
          console.error('  Available IDs with "item":', Array.from(document.querySelectorAll('[id*="item"]')).map(el => el.id));
          return;
        }
        
        console.log(`üñºÔ∏è itemsList element found, clearing and rendering ${items.length} items...`);
        itemsListEl.innerHTML = '';
        
        if (items.length === 0) {
          itemsListEl.innerHTML = '<div class="text-muted">No items added yet</div>';
          console.log('‚ö†Ô∏è No items to render, showing empty message');
          return;
        }
        
        console.log(`üñºÔ∏è Starting to render ${items.length} items...`);
        
        items.forEach((it, idx) => {
          // If in supervisor view, don't re-render items that were already rendered server-side
          // This prevents duplication between the editable server-rendered cards and these summary cards
          {% if is_supervisor_edit %}
          if (it.isServerRendered) {
            console.log(`  ‚è≠Ô∏è Skipping item ${idx} (already rendered server-side)`);
            return;
          }
          {% endif %}
          
          console.log(`  Rendering item ${idx}:`, it);
          const card = document.createElement('div');
          card.className = 'item-card';
          
          const photoCount = it.photoUrls ? it.photoUrls.length : (it.photoCount || 0);
          const uploadStatus = it.photoUrls ? '‚òÅÔ∏è Uploaded to cloud' : '‚è≥ Not uploaded';
          
          const quantity = escapeHtml(it.quantity || '1');
          const brand = escapeHtml(it.brand || '');
          const specification = escapeHtml(it.specification || '');
          const comments = escapeHtml(it.comments || '');
          
          const isSupervisorView = {% if is_supervisor_edit %}true{% else %}false{% endif %};
          
          card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div style="flex:1;">
                <div class="meta"><strong>Asset:</strong> ${escapeHtml(it.asset)} &nbsp; <strong>System:</strong> ${escapeHtml(it.system)}</div>
                <div class="meta mt-1"><strong>Description:</strong> ${escapeHtml(it.description)}</div>
                <div class="meta mt-1" style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                  <span><strong>Quantity:</strong> ${quantity}</span>
                  ${brand ? `<span><strong>Brand:</strong> ${brand}</span>` : '<span><strong>Brand:</strong> <em class="text-muted">Not specified</em></span>'}
                  ${specification ? `<span><strong>Specification:</strong> ${specification}</span>` : '<span><strong>Specification:</strong> <em class="text-muted">Not specified</em></span>'}
                </div>
                ${comments ? `<div class="meta mt-1" style="border-top: 1px solid #e5e7eb; padding-top: 0.5rem; margin-top: 0.5rem;"><strong>Comments:</strong> <br><span style="white-space: pre-wrap;">${comments.replace(/\n/g, '<br>')}</span></div>` : '<div class="meta mt-1" style="border-top: 1px solid #e5e7eb; padding-top: 0.5rem; margin-top: 0.5rem;"><strong>Comments:</strong> <em class="text-muted">No comments</em></div>'}
                <div class="photo-count mt-1" style="font-size:0.85rem;">üì∑ ${photoCount} photo(s) ${uploadStatus}</div>
                <div class="mt-2 thumbs-row"></div>
              </div>
              <div><button data-idx="${idx}" class="btn btn-sm btn-danger remove-item">üóëÔ∏è Remove</button></div>
            </div>
          `;
          const thumbsRow = card.querySelector('.thumbs-row');
          const maxShow = 6;
          
          // Show cloud URLs if available
          if (it.photoUrls && Array.isArray(it.photoUrls) && it.photoUrls.length > 0) {
            it.photoUrls.slice(0, maxShow).forEach((url, urlIdx) => {
              if (!url || typeof url !== 'string') {
                console.warn('Invalid photo URL at index', urlIdx, ':', url);
                return; // Skip invalid URLs
              }
              
              const img = document.createElement('img');
              img.className = 'thumb';
              img.src = url;
              img.alt = `Photo ${urlIdx + 1}`;
              img.style.width = '70px';
              img.style.height = '50px';
              img.style.marginRight = '4px';
              img.style.marginBottom = '4px';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '4px';
              img.style.border = '1px solid #e5e7eb';
              img.style.cursor = 'pointer';
              img.style.backgroundColor = '#f3f4f6';
              img.loading = 'lazy';
              
              img.onerror = function() {
                console.error('Failed to load thumbnail:', url);
                // Show placeholder instead of hiding
                this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="70" height="50"%3E%3Crect width="70" height="50" fill="%23e5e7eb"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999" font-size="10"%3EFailed%3C/text%3E%3C/svg%3E';
                this.style.cursor = 'default';
              };
              
              img.onload = function() {
                console.log('Thumbnail loaded successfully:', url);
              };
              
              img.onclick = function() {
                window.open(url, '_blank');
              };
              
              thumbsRow.appendChild(img);
            });
            
            if (it.photoUrls.length > maxShow) {
              const more = document.createElement('span');
              more.textContent = `+${it.photoUrls.length - maxShow} more`;
              more.className = 'badge bg-secondary';
              more.style.marginLeft = '8px';
              thumbsRow.appendChild(more);
            }
          } else {
            console.log('No photo URLs for item:', it);
          }
          
          const removeBtn = card.querySelector('.remove-item');
          if (removeBtn) {
            removeBtn.addEventListener('click', (e) => {
            const i = Number(e.currentTarget.dataset.idx);
            if (confirm('Remove this item? (Photos remain in cloud storage)')) removeItem(i);
          });
          } else {
            console.warn('Remove button not found for item', idx);
          }
          itemsListEl.appendChild(card);  // Use local variable, not outer scope
          console.log(`  ‚úÖ Appended item ${idx} card to DOM`);
        });
        
        const finalCount = itemsListEl.children.length;
        console.log(`‚úÖ renderItems() completed: ${finalCount} cards in DOM (expected ${items.length})`);
        if (finalCount !== items.length) {
          console.error(`‚ùå MISMATCH: Expected ${items.length} items but only ${finalCount} in DOM!`);
        }
      }

      function removeItem(index) {
        if (index < 0 || index >= items.length) return;
        items.splice(index, 1);
        renderItems();
        saveDraft();
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
      }

      function pollJobStatus(jobId) {
        if (pollingInterval) clearInterval(pollingInterval);
        progressContainer.style.display = 'block';
        downloadLinks.style.display = 'none';
        pollingInterval = setInterval(async () => {
          try {
            const statusUrl = `${modulePrefix}/status/${jobId}`;
            const res = await fetch(statusUrl);
            if (!res.ok) throw new Error('Status check failed');
            const job = await res.json();
            const progress = job.progress || 0;
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            
            // Check both legacy 'state' and current 'status'
            const isDone = job.state === 'done' || job.status === 'completed';
            const isFailed = job.state === 'failed' || job.status === 'failed';
            // Support both 'results' and 'result_data'
            const results = job.results || job.result_data || {};
            
            if (isDone) {
              clearInterval(pollingInterval);
              loadingOverlay.style.display = 'none'; // Hide loading overlay
              progressBar.classList.remove('progress-bar-animated');
              progressBar.classList.add('bg-success');
              
              // Support both excel_url/pdf_url AND excel/pdf field names
              const excelUrl = results.excel_url || results.excel;
              const pdfUrl = results.pdf_url || results.pdf;
              
              if (excelUrl || pdfUrl) {
                // Remove any existing success message or h5
                const existingSuccess = downloadLinks.querySelector('.alert.alert-success');
                const existingH5 = downloadLinks.querySelector('h5');
                if (existingSuccess) {
                  existingSuccess.remove();
                }
                if (existingH5) {
                  existingH5.remove();
                }
                
                // Show success message above download links
                // Check if this is a supervisor updating their own form
                const isSupervisorOwnUpdate = window.isSupervisorOwnUpdate === true;
                
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-success mb-3';
                
                if (isSupervisorOwnUpdate) {
                  successMsg.innerHTML = `
                    <h5 class="alert-heading">‚úÖ Form Updated & Reports Generated Successfully!</h5>
                    <hr style="margin: 0.5rem 0;">
                    <p class="mb-2"><strong>Your form has been updated with new details and will be sent to Operations Manager for review.</strong></p>
                    <p class="mb-0 small">Download your updated PDF and Excel reports below.</p>
                  `;
                } else {
                  // Check if this is Operations Manager approval
                  {% if user_designation == 'operations_manager' %}
                  successMsg.innerHTML = '<strong>‚úÖ Form Approved & Reports Generated Successfully!</strong>';
                  {% else %}
                  successMsg.innerHTML = '<strong>‚úÖ Reports generated successfully!</strong>';
                  {% endif %}
                }
                
                // Clear the flag after use
                window.isSupervisorOwnUpdate = false;
                
                // Insert success message at the top
                downloadLinks.insertBefore(successMsg, downloadLinks.firstChild);
                
                // Clear statusBox since message is now in download container
                statusBox.style.display = 'none';
                
                // Create and add download buttons
                if (excelUrl) {
                  const excelBtn = document.createElement('a');
                  excelBtn.href = `${modulePrefix}/download/${jobId}/excel`;
                  excelBtn.download = results.excel_filename || 'hvac_report.xlsx';
                  excelBtn.className = 'btn btn-success me-2 mt-2';
                  excelBtn.style.cssText = 'text-decoration: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; display: inline-block; font-weight: 600;';
                  excelBtn.textContent = 'üì• Download Excel Report';
                  downloadLinks.appendChild(excelBtn);
                }
                
                if (pdfUrl) {
                  const pdfBtn = document.createElement('a');
                  pdfBtn.href = `${modulePrefix}/download/${jobId}/pdf`;
                  pdfBtn.download = results.pdf_filename || 'hvac_report.pdf';
                  pdfBtn.className = 'btn btn-success me-2 mt-2';
                  pdfBtn.style.cssText = 'text-decoration: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; display: inline-block; font-weight: 600;';
                  pdfBtn.textContent = 'üì• Download PDF Report';
                  downloadLinks.appendChild(pdfBtn);
                }
                
                // Add Return to Dashboard button
                const dashboardBtn = document.createElement('a');
                dashboardBtn.href = '/dashboard';
                dashboardBtn.className = 'btn btn-primary me-2 mt-2';
                dashboardBtn.style.cssText = 'text-decoration: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; display: inline-block; font-weight: 600;';
                dashboardBtn.textContent = '‚Üê Return to Dashboard';
                downloadLinks.appendChild(dashboardBtn);
                
                downloadLinks.style.display = 'block';
              }
            } else if (isFailed) {
              clearInterval(pollingInterval);
              loadingOverlay.style.display = 'none'; // Hide loading overlay
              progressBar.classList.remove('progress-bar-animated');
              progressBar.classList.add('bg-danger');
              const errorMsg = results.error || job.error_message || 'Unknown error';
              statusBox.innerHTML = `<div class="alert alert-danger">‚ùå Generation failed: ${errorMsg}</div>`;
            }
          } catch (err) {
            console.error('Polling error:', err);
          }
        }, 1000);
      }

      function autoDownload(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || '';
        a.target = '_blank';  // Open in new tab if download fails
        a.rel = 'noopener noreferrer';
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => document.body.removeChild(a), 100);
      }

      async function submitAll() {
        // In edit mode, preserve original signatures
        let techData = '';
        let opData = '';
        
        {% if is_edit_mode %}
        // In edit mode, use existing signatures (read-only for tech, editable for supervisor)
        const techSigInput = document.getElementById('techSignatureData');
        techData = techSigInput ? techSigInput.value || '' : '';
        const opManInput = document.getElementById('opManSignatureData');
        if (opManInput) {
          // Get signature from pad if Operations Manager is reviewing
          {% if user_designation == 'operations_manager' %}
          if (pads && pads.opPad && !pads.opPad.isEmpty()) {
            opData = pads.opPad.toDataURL('image/png');
            opManInput.value = opData;
          } else {
            opData = opManInput.value || '';
          }
          {% elif is_supervisor_edit %}
          // If supervisor is editing, allow them to sign
          if (pads && pads.opPad && !pads.opPad.isEmpty()) {
            opData = pads.opPad.toDataURL('image/png');
            opManInput.value = opData;
          } else {
            opData = opManInput.value || '';
          }
          {% else %}
          opData = opManInput.value || '';
          {% endif %}
        } else {
          opData = '';
        }
        {% else %}
        // Normal mode - get from signature pads
        if (pads.techPad) {
          techData = pads.techPad.isEmpty() ? '' : pads.techPad.toDataURL('image/png');
          const techSigInput = document.getElementById('techSignatureData');
          if (techSigInput) techSigInput.value = techData;
        }
        const opManInput = document.getElementById('opManSignatureData');
        if (opManInput && pads.opPad) {
          opData = pads.opPad.isEmpty() ? '' : pads.opPad.toDataURL('image/png');
          opManInput.value = opData;
        } else {
          opData = '';
        }
        {% endif %}

        if (items.length === 0) {
          statusBox.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Please add at least one item before submitting.</div>';
          return;
        }

        // Count total photos (already uploaded)
        const totalPhotos = items.reduce((sum, item) => sum + (item.photoUrls?.length || item.photoCount || 0), 0);
        
        // Check if all items have photos uploaded
        const hasUnuploadedItems = items.some(item => !item.photoUrls);
        if (hasUnuploadedItems) {
          alert('‚ö†Ô∏è Some items do not have photos uploaded. Please check your items.');
          return;
        }
        
        if (totalPhotos === 0) {
          // Allow submission without photos
          statusBox.innerHTML = '<div class="alert alert-info">‚ÑπÔ∏è Submitting form without photos...</div>';
        }

        // Show loading overlay (photos already uploaded, just generating reports)
        loadingOverlay.style.display = 'flex';
        statusBox.innerHTML = '';
        progressContainer.style.display = 'none';
        downloadLinks.style.display = 'none';
        
        // Get supervisor signature and comments if supervisor is submitting
        let supervisorData = '';
        let supervisorComments = '';
        const supervisorCommentsField = document.getElementById('supervisorComments');
        const supervisorSignatureData = document.getElementById('supervisorSignatureData');
        const supervisorCanvas = document.getElementById('supervisorSignaturePad');
        
        {% if is_supervisor_edit or user_designation == 'supervisor' %}
        // Always check canvas first (if supervisor signed on canvas, use that)
        if (pads && pads.supervisorPad && !pads.supervisorPad.isEmpty()) {
          supervisorData = pads.supervisorPad.toDataURL('image/png');
          if (supervisorSignatureData) {
            supervisorSignatureData.value = supervisorData;
          }
          console.log('‚úÖ Supervisor signature captured from canvas');
        } else if (supervisorSignatureData && supervisorSignatureData.value) {
          // Fallback to hidden input if canvas is empty but hidden input has value
          supervisorData = supervisorSignatureData.value;
          console.log('‚úÖ Supervisor signature captured from hidden input');
        } else if (supervisorCanvas) {
          // Check if canvas has been drawn on (even if isEmpty() returns true, might have data)
          try {
            if (pads && pads.supervisorPad) {
              const canvasData = pads.supervisorPad.toDataURL('image/png');
              // If canvas has data (not blank/transparent), use it
              if (canvasData && canvasData !== 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==') {
                supervisorData = canvasData;
                if (supervisorSignatureData) supervisorSignatureData.value = supervisorData;
                console.log('‚úÖ Supervisor signature captured from canvas (non-empty)');
              }
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è Error checking canvas for signature:', e);
          }
        }
        
        if (supervisorCommentsField) {
          supervisorComments = supervisorCommentsField.value || '';
        }
        
        // Validate supervisor signature if submitting as supervisor
        // Always require signature when supervisor is submitting/updating
        if (!supervisorData || supervisorData.trim() === '') {
          alert('Please provide your supervisor signature before submitting. Draw your signature in the signature pad.');
          loadingOverlay.style.display = 'none';
          return;
        }
        
        console.log('üìù Supervisor signature length:', supervisorData ? supervisorData.length : 0);
        console.log('üìù Supervisor signature preview:', supervisorData ? supervisorData.substring(0, 50) + '...' : 'empty');
        {% endif %}
        
        // Get reviewer comments and signatures for all roles
        let operationsManagerComments = '';
        let businessDevComments = '';
        let procurementComments = '';
        let generalManagerComments = '';
        let businessDevSignature = '';
        let procurementSignature = '';
        let generalManagerSignature = '';

        {% if user_designation == 'operations_manager' %}
        const operationsManagerCommentsField = document.getElementById('operationsManagerComments');
        if (operationsManagerCommentsField) {
          operationsManagerComments = operationsManagerCommentsField.value || '';
        }
        // Operations Manager signature is already collected in opData above
        {% endif %}

        {% if user_designation == 'business_development' %}
        const businessDevCommentsField = document.getElementById('businessDevComments');
        if (businessDevCommentsField) {
          businessDevComments = businessDevCommentsField.value || '';
        }
        if (pads && pads.businessDevPad && !pads.businessDevPad.isEmpty()) {
          businessDevSignature = pads.businessDevPad.toDataURL('image/png');
          const businessDevSigInput = document.getElementById('businessDevSignatureData');
          if (businessDevSigInput) businessDevSigInput.value = businessDevSignature;
        } else {
          const businessDevSigInput = document.getElementById('businessDevSignatureData');
          if (businessDevSigInput) businessDevSignature = businessDevSigInput.value || '';
        }
        {% endif %}

        {% if user_designation == 'procurement' %}
        const procurementCommentsField = document.getElementById('procurementComments');
        if (procurementCommentsField) {
          procurementComments = procurementCommentsField.value || '';
        }
        if (pads && pads.procurementPad && !pads.procurementPad.isEmpty()) {
          procurementSignature = pads.procurementPad.toDataURL('image/png');
          const procurementSigInput = document.getElementById('procurementSignatureData');
          if (procurementSigInput) procurementSigInput.value = procurementSignature;
        } else {
          const procurementSigInput = document.getElementById('procurementSignatureData');
          if (procurementSigInput) procurementSignature = procurementSigInput.value || '';
        }
        {% endif %}

        {% if user_designation == 'general_manager' %}
        const generalManagerCommentsField = document.getElementById('generalManagerComments');
        if (generalManagerCommentsField) {
          generalManagerComments = generalManagerCommentsField.value || '';
        }
        if (pads && pads.generalManagerPad && !pads.generalManagerPad.isEmpty()) {
          generalManagerSignature = pads.generalManagerPad.toDataURL('image/png');
          const generalManagerSigInput = document.getElementById('generalManagerSignatureData');
          if (generalManagerSigInput) generalManagerSigInput.value = generalManagerSignature;
        } else {
          const generalManagerSigInput = document.getElementById('generalManagerSignatureData');
          if (generalManagerSigInput) generalManagerSignature = generalManagerSigInput.value || '';
        }
        {% endif %}

        // Prepare JSON payload (photos already in cloud)
        // Start with shared fields only; reviewer-specific fields are added conditionally
        const payload = {
          site_name: document.getElementById('site_name').value || '',
          visit_date: document.getElementById('visit_date').value || '',
          tech_signature: techData || '',
          items: items.map(it => ({
            asset: it.asset,
            system: it.system,
            description: it.description,
            quantity: String(it.quantity || '1'),
            brand: it.brand || '',
            specification: it.specification || '',
            comments: it.comments || '',
            photo_urls: it.photoUrls || [] // Cloud URLs
          }))
        };

        // Only attach supervisor data when supervisor is actually editing/submitting
        // Include supervisor data if supervisor is editing OR if user is a supervisor
        {% if is_supervisor_edit or user_designation == 'supervisor' %}
        // Only include signature if it has a value (don't send empty string which might become null)
        if (supervisorData && supervisorData.trim() !== '') {
          payload.supervisor_signature = supervisorData;
          console.log('‚úÖ Adding supervisor signature to payload (length:', supervisorData.length, ')');
        } else {
          console.warn('‚ö†Ô∏è Supervisor signature is empty, not including in payload');
        }
        // Always include comments (even if empty, so it's preserved)
        payload.supervisor_comments = supervisorComments || '';
        console.log('‚úÖ Adding supervisor comments to payload:', supervisorComments ? 'has value' : 'empty');
        {% endif %}

        // Only attach Operations Manager data when OM is submitting
        {% if user_designation == 'operations_manager' %}
        payload.opMan_signature = opData || '';
        payload.operations_manager_comments = operationsManagerComments || '';
        {% endif %}

        // Only attach BD data when BD is submitting
        {% if user_designation == 'business_development' %}
        payload.business_dev_comments = businessDevComments || '';
        payload.business_dev_signature = businessDevSignature || '';
        {% endif %}

        // Only attach Procurement data when Procurement is submitting
        {% if user_designation == 'procurement' %}
        payload.procurement_comments = procurementComments || '';
        payload.procurement_signature = procurementSignature || '';
        {% endif %}

        // Only attach GM data when GM is submitting
        {% if user_designation == 'general_manager' %}
        payload.general_manager_comments = generalManagerComments || '';
        payload.general_manager_signature = generalManagerSignature || '';
        {% endif %}
        
        // If in edit mode, add the submission_id to payload
        {% if is_edit_mode %}
        payload.edit_submission_id = window.editSubmissionId || '{{ submission_data.submission_id if submission_data else '' }}';
        console.log('üìù Edit mode: Updating submission', payload.edit_submission_id);
        {% endif %}

        console.log('üì§ Submitting payload:', payload);
        console.log(`üì§ Items count: ${payload.items.length}`);
        
        // Final validation for items
        if (payload.items.length === 0) {
          if (!confirm('Warning: You are submitting a report with 0 items. Are you sure?')) {
            loadingOverlay.style.display = 'none';
            return;
          }
        }

        try {
          {% if is_edit_mode %}
          {% if is_supervisor_edit %}
          // Check if supervisor is editing their own submission or reviewing another's
          const submissionId = window.editSubmissionId;
          {% if submission_data and submission_data.workflow_status %}
          const workflowStatus = {{ submission_data.workflow_status|tojson|safe }};
          {% else %}
          const workflowStatus = 'submitted';
          {% endif %}
          {% if submission_data and submission_data.supervisor_id %}
          const submissionSupervisorId = {{ submission_data.supervisor_id|tojson|safe }};
          {% else %}
          const submissionSupervisorId = null;
          {% endif %}
          {% if current_user_id is defined and current_user_id is not none %}
          const currentUserId = {{ current_user_id|tojson|safe }};
          {% else %}
          const currentUserId = null;
          {% endif %}
          // Check ownership: supervisor owns submission if supervisor_id matches currentUserId
          // Also allow editing if status is submitted/rejected/null (new drafts)
          // Supervisors can always update their own submissions as long as Operations Manager hasn't approved yet
          // If supervisor_id matches, it's always their own submission regardless of status
          const supervisorOwnsSubmission = submissionSupervisorId && currentUserId && 
                                          (submissionSupervisorId === currentUserId || submissionSupervisorId == currentUserId);
          
          // Safety check: If user is supervisor and supervisor_id matches, it's always their own submission
          {% if user_designation == 'supervisor' %}
          let isOwnSubmission = supervisorOwnsSubmission || 
                               workflowStatus === 'submitted' || 
                               workflowStatus === 'rejected' || 
                               !workflowStatus;
          {% else %}
          let isOwnSubmission = (
            (submissionSupervisorId && currentUserId && submissionSupervisorId === currentUserId) ||
            workflowStatus === 'submitted' || 
            workflowStatus === 'rejected' || 
            !workflowStatus
          );
          {% endif %}
          
          console.log('üìã Workflow status:', workflowStatus);
          console.log('üìã Submission supervisor_id:', submissionSupervisorId);
          console.log('üìã Current user_id:', currentUserId);
          console.log('üìã Supervisor owns submission:', supervisorOwnsSubmission);
          console.log('üìã Is own submission:', isOwnSubmission);
          
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          
          if (isOwnSubmission) {
            // Supervisor is updating their own submitted/rejected form - just update, don't approve
            console.log('‚úÖ Supervisor updating their own submission - using workflow update endpoint');
            
            // Re-capture signature right before submitting to ensure we have the latest
            // Check canvas first (if supervisor signed on canvas, use that)
            const supervisorCanvas = document.getElementById('supervisorSignaturePad');
            const supervisorSigInput = document.getElementById('supervisorSignatureData');
            if (pads && pads.supervisorPad) {
              if (!pads.supervisorPad.isEmpty()) {
                supervisorData = pads.supervisorPad.toDataURL('image/png');
                if (supervisorSigInput) supervisorSigInput.value = supervisorData;
                console.log('üìù Re-captured supervisor signature from canvas before update');
              } else if (supervisorSigInput && supervisorSigInput.value) {
                // Canvas is empty, use hidden input if it has value
                supervisorData = supervisorSigInput.value;
                console.log('üìù Using supervisor signature from hidden input');
              }
            }
            
            // Validate signature is present before updating
            if (!supervisorData || supervisorData.trim() === '') {
              alert('Please provide your supervisor signature before submitting. Draw your signature in the signature pad.');
              loadingOverlay.style.display = 'none';
              return;
            }
            
            // Update payload with latest signature
            payload.supervisor_signature = supervisorData;
            
            console.log('üì§ Updating with supervisor signature (length:', supervisorData.length, ')');
            
            const updateRes = await fetch(`/api/workflow/submissions/${submissionId}/update`, {
              method: 'PUT',
              headers: headers,
              body: JSON.stringify({
                site_name: payload.site_name,
                visit_date: payload.visit_date,
                form_data: payload
              }),
              credentials: 'include'
            });
            
            if (!updateRes.ok) {
              const txt = await updateRes.text();
              throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
            }
            
            const updateJson = await updateRes.json();
            
            if (updateJson.success) {
              // Check if documents are being regenerated
              const jobId = updateJson.data?.job_id || updateJson.job_id;
              const isRegenerating = updateJson.data?.regenerating || updateJson.regenerating || false;
              
              if (jobId && isRegenerating) {
                // Documents are being regenerated, poll for status
                // Set flag to indicate this is a supervisor updating their own form
                window.isSupervisorOwnUpdate = isOwnSubmission;
                statusBox.innerHTML = '<div class="alert alert-info">‚úÖ Form updated! Regenerating documents with your changes... This may take a moment.</div>';
                loadingOverlay.style.display = 'flex';
                pollJobStatus(jobId);
              } else {
                // No regeneration needed (shouldn't happen, but handle gracefully)
                loadingOverlay.style.display = 'none';
                statusBox.innerHTML = `
                  <div class="alert alert-success">
                    <h5 class="alert-heading">‚úÖ Form Updated Successfully!</h5>
                    <hr>
                    <p class="mb-2"><strong>Your form has been updated with the new changes.</strong></p>
                    ${workflowStatus === 'rejected' ? `
                      <p class="mb-2">You can resubmit this form to send it back to Operations Manager for review.</p>
                    ` : `
                      <p class="mb-2">The form will be sent to Operations Manager for review once you resubmit.</p>
                    `}
                    <hr class="mt-3 mb-2">
                    <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
                  </div>
                `;
                clearDraft();
              }
            } else {
              throw new Error(updateJson.error || 'Update failed');
            }
          } else {
            // Supervisor is reviewing/approving another's submission - use approval workflow
            // BUT: If this is actually their own submission (supervisor_id matches), force update instead
            {% if user_designation == 'supervisor' %}
            if (supervisorOwnsSubmission) {
              console.warn('‚ö†Ô∏è Supervisor owns submission but isOwnSubmission was false - forcing update path');
              
              // Re-capture signature right before submitting to ensure we have the latest
              const supervisorCanvas = document.getElementById('supervisorSignaturePad');
              const supervisorSigInput = document.getElementById('supervisorSignatureData');
              if (pads && pads.supervisorPad) {
                if (!pads.supervisorPad.isEmpty()) {
                  supervisorData = pads.supervisorPad.toDataURL('image/png');
                  if (supervisorSigInput) supervisorSigInput.value = supervisorData;
                  console.log('üìù Re-captured supervisor signature from canvas before update (safety path)');
                } else if (supervisorSigInput && supervisorSigInput.value) {
                  supervisorData = supervisorSigInput.value;
                  console.log('üìù Using supervisor signature from hidden input (safety path)');
                }
              }
              
              // Validate signature is present before updating
              if (!supervisorData || supervisorData.trim() === '') {
                alert('Please provide your supervisor signature before submitting. Draw your signature in the signature pad.');
                loadingOverlay.style.display = 'none';
                return;
              }
              
              // Update payload with latest signature
              payload.supervisor_signature = supervisorData;
              
              // Force update path instead of approval
              const updateRes = await fetch(`/api/workflow/submissions/${submissionId}/update`, {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify({
                  site_name: payload.site_name,
                  visit_date: payload.visit_date,
                  form_data: payload
                }),
                credentials: 'include'
              });
              
              if (!updateRes.ok) {
                const txt = await updateRes.text();
                throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
              }
              
              const updateJson = await updateRes.json();
              if (updateJson.success) {
                const jobId = updateJson.data?.job_id || updateJson.job_id;
                const isRegenerating = updateJson.data?.regenerating || updateJson.regenerating || false;
                
                if (jobId && isRegenerating) {
                  window.isSupervisorOwnUpdate = true;
                  statusBox.innerHTML = '<div class="alert alert-info">‚úÖ Form updated! Regenerating documents with your changes... This may take a moment.</div>';
                  loadingOverlay.style.display = 'flex';
                  pollJobStatus(jobId);
                } else {
                  loadingOverlay.style.display = 'none';
                  statusBox.innerHTML = `
                    <div class="alert alert-success">
                      <h5 class="alert-heading">‚úÖ Form Updated Successfully!</h5>
                      <hr>
                      <p class="mb-2"><strong>Your form has been updated with the new changes.</strong></p>
                      <hr class="mt-3 mb-2">
                      <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
                    </div>
                  `;
                  clearDraft();
                }
                return; // Exit early, don't continue to approval
              } else {
                throw new Error(updateJson.error || 'Update failed');
              }
            }
            {% endif %}
            
            // Supervisor is reviewing/approving another's submission - use approval workflow
            console.log('‚úÖ Supervisor reviewing another\'s submission - using approval endpoint');
            
            // First update the submission with new data using workflow endpoint
            const updateRes = await fetch(`/api/workflow/submissions/${submissionId}/update`, {
              method: 'PUT',
              headers: headers,
              body: JSON.stringify({
                site_name: payload.site_name,
                visit_date: payload.visit_date,
                form_data: payload
              }),
              credentials: 'include'
            });
            
            if (!updateRes.ok) {
              const txt = await updateRes.text();
              throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
            }
            
            // Then approve via workflow endpoint
            const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve`, {
              method: 'POST',
              headers: headers,
              body: JSON.stringify({
                comments: supervisorComments,
                supervisor_signature: supervisorData,
                items: payload.items // Send updated items here as well
              }),
              credentials: 'include'
            });
            
            if (!approveRes.ok) {
              const txt = await approveRes.text();
              throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
            }
            
            const approveJson = await approveRes.json();
            
            if (approveJson.success) {
              loadingOverlay.style.display = 'none';
              // Show correct workflow hierarchy based on who is approving
              {% if user_designation == 'supervisor' %}
              // Supervisor is submitting/approving - form goes to Operations Manager first
              const workflowList = `
                <li>‚Üí Operations Manager</li>
                <li>‚Üí Business Development & Procurement (parallel review)</li>
                <li>‚Üí General Manager (final approval)</li>
              `;
              {% elif user_designation == 'operations_manager' %}
              // Operations Manager is approving - form goes to BD & Procurement, then GM
              const workflowList = `
                <li>‚Üí Business Development & Procurement (parallel review)</li>
                <li>‚Üí General Manager (final approval)</li>
              `;
              {% elif user_designation in ['business_development', 'procurement'] %}
              // BD or Procurement is approving - form goes to GM (if both approved) or stays in BD/Proc review
              const workflowList = `
                <li>‚Üí General Manager (final approval)</li>
              `;
              {% elif user_designation == 'general_manager' %}
              // General Manager is approving - form is complete
              const workflowList = `
                <li>‚Üí Form Completed ‚úì</li>
              `;
              {% else %}
              // Default fallback
              const workflowList = `
                <li>‚Üí Operations Manager</li>
                <li>‚Üí Business Development & Procurement (parallel review)</li>
                <li>‚Üí General Manager (final approval)</li>
              `;
              {% endif %}
              
              statusBox.innerHTML = `
                <div class="alert alert-success">
                  <h5 class="alert-heading">‚úÖ Form Signed Successfully!</h5>
                  <hr>
                  <p class="mb-2"><strong>This form will now be sent to:</strong></p>
                  <ul class="mb-0" style="list-style-position: inside;">
                    ${workflowList}
                  </ul>
                  <hr class="mt-3 mb-2">
                  <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
                </div>
              `;
              clearDraft();
            } else {
              throw new Error(approveJson.error || 'Approval failed');
            }
          }
          {% else %}
          // Edit mode for reviewers (operations_manager, business_development, procurement, general_manager) or admin
          const submissionId = window.editSubmissionId;
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          
          {% if user_designation == 'operations_manager' %}
          // Operations Manager: First update, then approve (to trigger document generation)
          const updateUrl = `/api/workflow/submissions/${submissionId}/update`;
          const updateBody = {
            site_name: payload.site_name,
            visit_date: payload.visit_date,
            form_data: payload
          };
          
          // Step 1: Update the submission
          const updateRes = await fetch(updateUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(updateBody),
            credentials: 'include'
          });
          
          if (!updateRes.ok) {
            const txt = await updateRes.text();
            throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
          }
          
          const updateJson = await updateRes.json();
          
          if (!updateJson.success) {
            throw new Error(updateJson.error || 'Update failed');
          }
          
          // Step 2: Approve to trigger document generation and move to next stage
          // Ensure signature is in both places for compatibility
          const approvalPayload = {
            comments: operationsManagerComments || '',
            signature: opData || '',
            form_data: payload
          };
          
          // Also ensure signature is in form_data for consistency
          if (opData && opData.trim()) {
            approvalPayload.form_data.operations_manager_signature = opData;
            approvalPayload.form_data.opMan_signature = opData;
            console.log('‚úÖ Operations Manager signature included in approval payload (both top-level and form_data)');
          } else {
            console.warn('‚ö†Ô∏è Operations Manager signature is empty - opData:', opData ? 'exists but empty' : 'undefined');
          }
          
          console.log('üì§ Operations Manager approval payload:', {
            commentsLength: (operationsManagerComments || '').length,
            signatureLength: (opData || '').length,
            signaturePreview: opData ? opData.substring(0, 50) + '...' : 'none',
            formDataKeys: Object.keys(approvalPayload.form_data || {})
          });
          
          const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve-ops-manager`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(approvalPayload),
            credentials: 'include'
          });
          
          if (!approveRes.ok) {
            const txt = await approveRes.text();
            throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
          }
          
          const approveJson = await approveRes.json();
          
          if (approveJson.success) {
            // Check if documents are being regenerated
            const jobId = approveJson.data?.job_id || updateJson.data?.job_id;
            const isRegenerating = approveJson.data?.regenerating || updateJson.data?.regenerating || false;
            
            if (jobId && isRegenerating) {
              statusBox.innerHTML = '<div class="alert alert-info">‚úÖ Form approved! Regenerating documents with your comments and signature... This may take a moment.</div>';
              loadingOverlay.style.display = 'flex';
              pollJobStatus(jobId);
            } else {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = `
                <div class="alert alert-success">
                  <h5 class="alert-heading">‚úÖ Form Approved & Signed Successfully!</h5>
                  <hr>
                  <p class="mb-2"><strong>This form will now be sent to:</strong></p>
                  <ul class="mb-0" style="list-style-position: inside;">
                    <li>‚Üí Business Development & Procurement (parallel review)</li>
                    <li>‚Üí General Manager (final approval)</li>
                  </ul>
                  <hr class="mt-3 mb-2">
                  <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
                </div>
              `;
              clearDraft();
            }
          } else {
            throw new Error(approveJson.error || 'Approval failed');
          }
          
          {% elif user_designation == 'business_development' %}
          // Business Development: First update, then approve
          const updateUrl = `/api/workflow/submissions/${submissionId}/update`;
          const updateBody = {
            site_name: payload.site_name,
            visit_date: payload.visit_date,
            form_data: payload
          };
          
          // Step 1: Update the submission
          const updateRes = await fetch(updateUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(updateBody),
            credentials: 'include'
          });
          
          if (!updateRes.ok) {
            const txt = await updateRes.text();
            throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
          }
          
          const updateJson = await updateRes.json();
          if (!updateJson.success) {
            throw new Error(updateJson.error || 'Update failed');
          }
          
          // Step 2: Approve BD
          const bdSigData = (pads && pads.businessDevPad && !pads.businessDevPad.isEmpty()) 
                           ? pads.businessDevPad.toDataURL('image/png') 
                           : (document.getElementById('businessDevSignatureData')?.value || '');
          
          const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve-bd`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              comments: businessDevComments || '',
              signature: bdSigData || '',
              form_data: payload
            }),
            credentials: 'include'
          });
          
          if (!approveRes.ok) {
            const txt = await approveRes.text();
            throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
          }
          
          const approveJson = await approveRes.json();
          if (approveJson.success) {
            loadingOverlay.style.display = 'none';
            statusBox.innerHTML = `
              <div class="alert alert-success">
                <h5 class="alert-heading">‚úÖ Form Approved & Signed Successfully!</h5>
                <hr>
                <p class="mb-2"><strong>${approveJson.data?.message || approveJson.message || 'Approved successfully. Waiting for Procurement approval.'}</strong></p>
                <hr class="mt-3 mb-2">
                <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
              </div>
            `;
            clearDraft();
          } else {
            throw new Error(approveJson.error || 'Approval failed');
          }
          
          {% elif user_designation == 'procurement' %}
          // Procurement: First update, then approve
          const updateUrl = `/api/workflow/submissions/${submissionId}/update`;
          const updateBody = {
            site_name: payload.site_name,
            visit_date: payload.visit_date,
            form_data: payload
          };
          
          // Step 1: Update the submission
          const updateRes = await fetch(updateUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(updateBody),
            credentials: 'include'
          });
          
          if (!updateRes.ok) {
            const txt = await updateRes.text();
            throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
          }
          
          const updateJson = await updateRes.json();
          if (!updateJson.success) {
            throw new Error(updateJson.error || 'Update failed');
          }
          
          // Step 2: Approve Procurement
          const procurementSigData = (pads && pads.procurementPad && !pads.procurementPad.isEmpty()) 
                                     ? pads.procurementPad.toDataURL('image/png') 
                                     : (document.getElementById('procurementSignatureData')?.value || '');
          
          const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve-procurement`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              comments: procurementComments || '',
              signature: procurementSigData || '',
              form_data: payload
            }),
            credentials: 'include'
          });
          
          if (!approveRes.ok) {
            const txt = await approveRes.text();
            throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
          }
          
          const approveJson = await approveRes.json();
          if (approveJson.success) {
            loadingOverlay.style.display = 'none';
            statusBox.innerHTML = `
              <div class="alert alert-success">
                <h5 class="alert-heading">‚úÖ Form Approved & Signed Successfully!</h5>
                <hr>
                <p class="mb-2"><strong>${approveJson.data?.message || approveJson.message || 'Approved successfully. Waiting for Business Development approval.'}</strong></p>
                <hr class="mt-3 mb-2">
                <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
              </div>
            `;
            clearDraft();
          } else {
            throw new Error(approveJson.error || 'Approval failed');
          }
          
          {% elif user_designation == 'general_manager' %}
          // General Manager: First update, then approve (final approval)
          const updateUrl = `/api/workflow/submissions/${submissionId}/update`;
          const updateBody = {
            site_name: payload.site_name,
            visit_date: payload.visit_date,
            form_data: payload
          };
          
          // Step 1: Update the submission
          const updateRes = await fetch(updateUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(updateBody),
            credentials: 'include'
          });
          
          if (!updateRes.ok) {
            const txt = await updateRes.text();
            throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
          }
          
          const updateJson = await updateRes.json();
          if (!updateJson.success) {
            throw new Error(updateJson.error || 'Update failed');
          }
          
          // Step 2: Approve General Manager (final approval)
          const gmSigData = (pads && pads.generalManagerPad && !pads.generalManagerPad.isEmpty()) 
                           ? pads.generalManagerPad.toDataURL('image/png') 
                           : (document.getElementById('generalManagerSignatureData')?.value || '');
          
          const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve-gm`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              comments: generalManagerComments || '',
              signature: gmSigData || '',
              form_data: payload
            }),
            credentials: 'include'
          });
          
          if (!approveRes.ok) {
            const txt = await approveRes.text();
            throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
          }
          
          const approveJson = await approveRes.json();
          if (approveJson.success) {
            // Check if documents are being regenerated
            const jobId = approveJson.data?.job_id || updateJson.data?.job_id;
            const isRegenerating = approveJson.data?.regenerating || updateJson.data?.regenerating || false;
            
            if (jobId && isRegenerating) {
              statusBox.innerHTML = '<div class="alert alert-info">‚úÖ Form approved! Regenerating final documents with all signatures... This may take a moment.</div>';
              loadingOverlay.style.display = 'flex';
              pollJobStatus(jobId);
            } else {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = `
                <div class="alert alert-success">
                  <h5 class="alert-heading">‚úÖ Form Completed Successfully!</h5>
                  <hr>
                  <p class="mb-2"><strong>${approveJson.data?.message || approveJson.message || 'All approvals complete. Form is now finalized.'}</strong></p>
                  <hr class="mt-3 mb-2">
                  <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
                </div>
              `;
              clearDraft();
            }
          } else {
            throw new Error(approveJson.error || 'Approval failed');
          }
          {% else %}
          // Admin role - use admin endpoint
          const updateUrl = `/api/admin/submissions/${submissionId}`;
          const updateBody = {
            site_name: payload.site_name,
            visit_date: payload.visit_date,
            form_data: payload
          };
          
          const res = await fetch(updateUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(updateBody),
            credentials: 'include'
          });
          
          if (!res.ok) {
            const txt = await res.text();
            throw new Error('Update failed: ' + res.status + ' ' + txt);
          }
          
          const json = await res.json();
          
          if (json.success) {
            const jobId = json.data?.job_id || json.job_id;
            const isRegenerating = json.data?.regenerating || json.regenerating || false;
            
            if (jobId && isRegenerating) {
              statusBox.innerHTML = '<div class="alert alert-info">‚úÖ Submission updated! Regenerating documents... This may take a moment.</div>';
              loadingOverlay.style.display = 'flex';
              pollJobStatus(jobId);
            } else {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = '<div class="alert alert-success">‚úÖ Submission updated successfully! <a href="/dashboard">Return to Dashboard</a></div>';
              clearDraft();
            }
          } else {
            throw new Error(json.error || 'Update failed');
          }
          {% endif %}
          {% endif %}
          {% else %}
          // Create new submission
          const submitUrl = modulePrefix + '/submit-with-urls';
          // Get JWT token from localStorage
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          const res = await fetch(submitUrl, { 
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload),
            credentials: 'include'  // Include cookies for JWT
          });
          
          if (!res.ok) {
            const txt = await res.text();
            throw new Error('Server error: ' + res.status + ' ' + txt);
          }
          
          const json = await res.json();
          
          // Hide upload modal, show loading overlay
          uploadModal.style.display = 'none';
          loadingOverlay.style.display = 'flex';
          
          if (json.job_id) {
            clearDraft(); // Clear draft after successful submission
            pollJobStatus(json.job_id);
          } else {
            loadingOverlay.style.display = 'none';
            statusBox.innerHTML = '<div class="alert alert-warning">Submission accepted but no job ID</div>';
          }
          {% endif %}
        } catch (err) {
          console.error('‚ùå Submission failed:', err);
          loadingOverlay.style.display = 'none';
          statusBox.innerHTML = `<div class="alert alert-danger">‚ùå {% if is_edit_mode %}Update{% else %}Submission{% endif %} failed: ${err.message}</div>`;
        }
      }

      submitAllBtn.addEventListener('click', submitAll);

      // Tab Navigation Function
      // goToTab function already defined at top of script for onclick handlers

      // Draft Auto-Save Functionality
      function saveDraft() {
        try {
          const draft = {
            site_name: document.getElementById('site_name').value || '',
            visit_date: document.getElementById('visit_date').value || '',
            items: items.map(it => ({
              asset: it.asset,
              system: it.system,
              description: it.description,
              photoCount: it.files?.length || 0
            })),
            timestamp: Date.now()
          };
          localStorage.setItem('hvac_mep_draft', JSON.stringify(draft));
        } catch (err) {
          console.error('Failed to save draft:', err);
        }
      }

      function loadDraft() {
        try {
          const draftJson = localStorage.getItem('hvac_mep_draft');
          if (!draftJson) return false;
          
          const draft = JSON.parse(draftJson);
          const ageMinutes = (Date.now() - draft.timestamp) / 60000;
          
          // Only load drafts less than 24 hours old
          if (ageMinutes > 1440) {
            clearDraft();
            return false;
          }
          
          // Auto-load draft without confirmation
          document.getElementById('site_name').value = draft.site_name || '';
          document.getElementById('visit_date').value = draft.visit_date || '';
          // Note: Can't restore files, only metadata
          if (draft.items && draft.items.length > 0) {
            console.log(`‚ÑπÔ∏è Draft loaded: ${draft.items.length} items`);
          }
          return true;
        } catch (err) {
          console.error('Failed to load draft:', err);
        }
        return false;
      }

      function clearDraft() {
        try {
          localStorage.removeItem('hvac_mep_draft');
        } catch (err) {
          console.error('Failed to clear draft:', err);
        }
      }

      // Auto-save every 30 seconds
      setInterval(saveDraft, DRAFT_SAVE_INTERVAL);

      // Save on form field changes
      document.getElementById('site_name').addEventListener('input', saveDraft);
      document.getElementById('visit_date').addEventListener('change', saveDraft);

      // Load submission data if in edit mode
      function loadSubmissionData() {
        {% if is_edit_mode and submission_data %}
        console.log('üîÑ Loading submission data for edit mode...');
        try {
          // Get submission data - prefer Jinja-rendered, fall back to window global
          let submissionData = null;
          try {
            {% if submission_data %}
            submissionData = {{ submission_data|tojson|safe }};
            console.log('üì¶ Using Jinja-rendered submission data');
            {% else %}
            console.warn('‚ö†Ô∏è No submission_data from Jinja, using window.preloadedSubmissionData');
            submissionData = window.preloadedSubmissionData || {};
            {% endif %}
          } catch (e) {
            console.error('‚ùå Error parsing submission_data:', e);
            console.warn('‚ö†Ô∏è Failed to parse Jinja submission_data, trying window.preloadedSubmissionData');
            submissionData = window.preloadedSubmissionData || {};
          }
          
          // Fall back to window global if Jinja version is incomplete
          if (!submissionData || !submissionData.form_data) {
            if (window.preloadedSubmissionData && window.preloadedSubmissionData.form_data) {
              console.log('üì¶ Jinja submission data incomplete, using window.preloadedSubmissionData');
              submissionData = window.preloadedSubmissionData;
            }
          }
          
          console.log('üì¶ Full submission data object:', submissionData);
          console.log('üì¶ submissionData keys:', Object.keys(submissionData || {}));
          console.log('üì¶ submissionData.site_name:', submissionData?.site_name);
          console.log('üì¶ submissionData.visit_date:', submissionData?.visit_date);
          console.log('üì¶ submissionData.form_data:', submissionData?.form_data);
          console.log('üì¶ submissionData.form_data?.items:', submissionData?.form_data?.items);
          console.log('üì¶ submissionData.form_data?.site_name:', submissionData?.form_data?.site_name);
          
          // Pre-fill basic fields - check both top-level and form_data
          const siteNameField = document.getElementById('site_name');
          if (siteNameField) {
            const siteName = submissionData.site_name || (submissionData.form_data && submissionData.form_data.site_name) || '';
            if (siteName) {
              siteNameField.value = siteName;
              console.log('‚úÖ Set site_name to:', siteName);
            } else {
              console.warn('‚ö†Ô∏è site_name not found in submission data or form_data');
              console.warn('  submissionData.site_name:', submissionData.site_name);
              console.warn('  submissionData.form_data?.site_name:', submissionData.form_data?.site_name);
            }
          } else {
            console.error('‚ùå site_name field not found in DOM');
          }
          
          const visitDateField = document.getElementById('visit_date');
          if (visitDateField) {
            const visitDate = submissionData.visit_date || (submissionData.form_data && submissionData.form_data.visit_date) || '';
            if (visitDate) {
              visitDateField.value = visitDate;
              console.log('‚úÖ Set visit_date to:', visitDate);
            } else {
              console.warn('‚ö†Ô∏è visit_date not found in submission data or form_data');
              console.warn('  submissionData.visit_date:', submissionData.visit_date);
              console.warn('  submissionData.form_data?.visit_date:', submissionData.form_data?.visit_date);
            }
          } else {
            console.error('‚ùå visit_date field not found in DOM');
          }
          
          // Define formData for use in both supervisor and non-supervisor edit modes
          // Handle both string (JSON) and object formats
          let formData = {};
          if (submissionData && submissionData.form_data) {
            if (typeof submissionData.form_data === 'string') {
              try {
                formData = JSON.parse(submissionData.form_data);
              } catch (e) {
                console.error('‚ùå Error parsing form_data string:', e);
                formData = {};
              }
            } else if (typeof submissionData.form_data === 'object') {
              formData = submissionData.form_data;
            }
          }
          console.log('üì¶ formData available for loading:', Object.keys(formData));
          console.log('üì¶ formData.supervisor_comments:', formData?.supervisor_comments ? 'exists' : 'missing');
          console.log('üì¶ formData.supervisor_signature:', formData?.supervisor_signature ? 'exists' : 'missing');
          
          // Pre-populate items - use form_data directly
          // For supervisor edit, we use loadPreloadedItemsIntoArray instead to match server-rendered items
          {% if is_supervisor_edit %}
          console.log('‚è≠Ô∏è Supervisor mode: skipping item population in loadSubmissionData (handled by loadPreloadedItemsIntoArray)');
          {% else %}
          if (!submissionData) {
            console.error('‚ùå submissionData is null or undefined!');
            return;
          }
          console.log('üì¶ Loading submission data, formData:', formData);
          console.log('üì¶ Items in formData:', formData.items);
          console.log('üì¶ formData keys:', Object.keys(formData));
          console.log('üì¶ formData.items type:', typeof formData.items);
          console.log('üì¶ formData.items is array?', Array.isArray(formData.items));
          console.log('üì¶ formData.items length:', formData.items?.length);
          
          // Also check preloaded items from window
          console.log('üì¶ window.preloadedItems:', window.preloadedItems);
          console.log('üì¶ window.preloadedItems type:', typeof window.preloadedItems);
          console.log('üì¶ window.preloadedItems is array?', Array.isArray(window.preloadedItems));
          console.log('üì¶ window.preloadedItems length:', window.preloadedItems?.length);
          
          // Only clear items if they're empty (don't overwrite if already loaded)
          let shouldReloadItems = true;
          if (items.length > 0) {
            console.log(`‚ö†Ô∏è Items array already has ${items.length} items, checking if we need to reload...`);
            // If items are already loaded, skip reloading unless formData has different items
            const existingItemCount = items.length;
            const formDataItemCount = (formData.items && Array.isArray(formData.items)) ? formData.items.length : 0;
            const preloadedItemCount = (window.preloadedItems && Array.isArray(window.preloadedItems)) ? window.preloadedItems.length : 0;
            
            if (existingItemCount > 0 && (formDataItemCount === existingItemCount || preloadedItemCount === existingItemCount)) {
              console.log('‚úÖ Items already loaded correctly, will skip reloading items but still render...');
              shouldReloadItems = false; // Don't reload, but continue to render
            } else {
              console.log('üîÑ Items count mismatch, will reload...');
              items.length = 0; // Clear for reload
            }
          } else {
            console.log('üßπ Items array is empty, will load items...');
          }
          
          // Check for items in formData, fall back to preloaded items
          // Prioritize formData.items, but if it's empty/undefined, use window.preloadedItems
          let itemsArray = null;
          
          // DEBUG: Check all possible sources
          console.log('üîç DEBUGGING ITEM SOURCES:');
          console.log('  formData:', formData);
          console.log('  formData.items:', formData.items);
          console.log('  formData.items type:', typeof formData.items);
          console.log('  formData.items isArray?', Array.isArray(formData.items));
          console.log('  window.preloadedItems:', window.preloadedItems);
          console.log('  window.preloadedItems type:', typeof window.preloadedItems);
          console.log('  window.preloadedItems isArray?', Array.isArray(window.preloadedItems));
          
          if (formData.items && Array.isArray(formData.items) && formData.items.length > 0) {
            itemsArray = formData.items;
            console.log('‚úÖ Using formData.items - found', itemsArray.length, 'items');
          } else if (window.preloadedItems && Array.isArray(window.preloadedItems) && window.preloadedItems.length > 0) {
            itemsArray = window.preloadedItems;
            console.log('‚úÖ Using window.preloadedItems (fallback) - found', itemsArray.length, 'items');
          } else {
            itemsArray = [];
            console.warn('‚ö†Ô∏è NO ITEMS FOUND in any source!');
            console.warn('  formData.items:', formData.items);
            console.warn('  window.preloadedItems:', window.preloadedItems);
          }
          console.log('üìã itemsArray:', itemsArray);
          console.log('üìã itemsArray type:', typeof itemsArray, Array.isArray(itemsArray));
          console.log('üìã itemsArray length:', itemsArray?.length);
          
          // Only load items if shouldReloadItems is true
          if (!shouldReloadItems && items.length > 0) {
            console.log('‚è≠Ô∏è Skipping item reload (items already loaded), just rendering...');
            renderItems();
          } else if (Array.isArray(itemsArray) && itemsArray.length > 0) {
            {% if is_supervisor_edit %}
            console.log('üìù Supervisor edit mode detected, skipping automatic items loading into array (handled by loadPreloadedItemsIntoArray)');
            {% else %}
            console.log(`üì¶ Found ${itemsArray.length} items to load`);
            itemsArray.forEach((item, idx) => {
              console.log(`  Processing item ${idx}:`, item);
              
              // Extract photo URLs - handle different formats
              let photoUrls = [];
              
              // Try photo_urls first (direct array of URLs)
              if (item.photo_urls && Array.isArray(item.photo_urls)) {
                photoUrls = item.photo_urls.filter(url => url && typeof url === 'string');
                console.log(`    Item ${idx}: Using photo_urls array, found ${photoUrls.length} URLs`);
              } 
              // Try photos array (array of objects with 'url' property) - THIS IS THE EXPECTED FORMAT
              else if (item.photos && Array.isArray(item.photos)) {
                photoUrls = item.photos.map(photo => {
                  if (typeof photo === 'string') {
                    return photo;
                  } else if (photo && typeof photo === 'object') {
                    // Format: {url: "...", saved: ..., path: ..., is_cloud: true}
                    const url = photo.url || photo.cloud_url || null;
                    console.log(`    Item ${idx}: Extracted photo URL from object:`, url?.substring(0, 50));
                    return url;
                  }
                  return null;
                }).filter(url => url !== null && typeof url === 'string');
                console.log(`    Item ${idx}: Using photos array, extracted ${photoUrls.length} URLs`);
              } else {
                console.warn(`    Item ${idx}: No photos found. photo_urls:`, item.photo_urls, 'photos:', item.photos);
              }
              
              const itemData = {
                asset: item.asset || '',
                system: item.system || '',
                description: item.description || '',
                quantity: item.quantity || '1',
                brand: item.brand || '',
                specification: item.specification || '',
                comments: item.comments || '',
                photoUrls: photoUrls,
                photoCount: photoUrls.length
              };
              
              console.log(`    Item ${idx} loaded:`, itemData);
              items.push(itemData);
            });
            {% endif %}
            
            // Render items after all are loaded
            console.log(`‚úÖ Loaded ${items.length} items from submission into items array`);
            console.log(`‚úÖ Items array contents:`, JSON.stringify(items, null, 2));
            
            // Function to attempt rendering with retries
            function attemptRenderItems(retryCount = 0) {
              const maxRetries = 15;
              const itemsListEl = document.getElementById('itemsList');
              
              if (itemsListEl) {
                console.log(`‚úÖ itemsList element found (attempt ${retryCount + 1}), calling renderItems...`);
                console.log(`  Items array has ${items.length} items`);
              renderItems();
                
                // Check if rendering succeeded after a delay
                setTimeout(() => {
                  const renderedCount = itemsListEl.children.length || 0;
                  console.log(`‚úÖ After renderItems: ${renderedCount} cards in DOM`);
                  
                  if (renderedCount === 0 && items.length > 0 && retryCount < maxRetries) {
                    console.warn(`‚ö†Ô∏è Items not rendered (attempt ${retryCount + 1}/${maxRetries}), retrying...`);
                    setTimeout(() => attemptRenderItems(retryCount + 1), 300);
                  } else if (renderedCount > 0) {
                    console.log(`‚úÖ Successfully rendered ${renderedCount} item cards!`);
                  } else if (retryCount >= maxRetries) {
                    console.error(`‚ùå Failed to render items after ${maxRetries} attempts`);
                    console.error('  Items array:', items);
                    console.error('  itemsList element:', itemsListEl);
                  }
                }, 200);
              } else {
                if (retryCount < maxRetries) {
                  console.warn(`‚ö†Ô∏è itemsList element not found (attempt ${retryCount + 1}/${maxRetries}), retrying in 200ms...`);
                  setTimeout(() => attemptRenderItems(retryCount + 1), 200);
                } else {
                  console.error(`‚ùå itemsList element not found after ${maxRetries} attempts!`);
                  console.error('  Document ready state:', document.readyState);
                  console.error('  Available elements with "items" in id:', Array.from(document.querySelectorAll('[id*="items"]')).map(el => el.id));
                }
              }
            }
            
            // Try rendering immediately and with multiple delays
            console.log('üîÑ Starting render attempts...');
            attemptRenderItems(0);
            setTimeout(() => attemptRenderItems(0), 300);
            setTimeout(() => attemptRenderItems(0), 600);
            setTimeout(() => attemptRenderItems(0), 1000);
          } else {
            console.warn('‚ö†Ô∏è No items found in formData');
            console.warn('  formData:', formData);
            console.warn('  formData.items:', formData.items);
            console.warn('  formData.items type:', typeof formData.items);
            console.warn('  Is array?', Array.isArray(formData.items));
            console.warn('  Length?', formData.items?.length);
            
            // Try alternative paths
            if (submissionData.items && Array.isArray(submissionData.items)) {
              console.log('‚ö†Ô∏è Found items in submissionData.items instead of formData.items');
              formData.items = submissionData.items;
              // Retry loading
              setTimeout(() => {
                loadSubmissionData();
            }, 100);
            }
          }
          {% endif %}
          
          // Load signatures as read-only images (if they exist)
          function loadSignatures() {
            console.log('üîç Loading signatures...');
            
            // Load technician signature - show as read-only for supervisor/manager
            // Signature is stored as an object: {saved: ..., path: ..., url: "...", is_cloud: true}
            let techSig = null;
            
            // Try multiple paths to find the signature - check ALL possible locations
            if (formData) {
              if (formData.tech_signature) {
                techSig = formData.tech_signature;
                console.log('üìù Found tech_signature in formData:', typeof techSig, techSig);
              } else if (formData.techSignatureData) {
                techSig = formData.techSignatureData;
                console.log('üìù Found techSignatureData in formData:', typeof techSig);
              } else if (formData.data && typeof formData.data === 'object' && formData.data.tech_signature) {
                techSig = formData.data.tech_signature;
                console.log('üìù Found tech_signature in formData.data');
              }
            }
            
            if (!techSig && submissionData) {
              if (submissionData.tech_signature) {
                techSig = submissionData.tech_signature;
                console.log('üìù Found tech_signature in submissionData (top level)');
              } else if (submissionData.form_data) {
                let checkFormData = submissionData.form_data;
                if (typeof checkFormData === 'string') {
                  try {
                    checkFormData = JSON.parse(checkFormData);
                  } catch (e) {
                    console.error('‚ùå Error parsing submissionData.form_data for tech signature:', e);
                  }
                }
                if (checkFormData) {
                  if (checkFormData.tech_signature) {
                    techSig = checkFormData.tech_signature;
                    console.log('üìù Found tech_signature in submissionData.form_data:', typeof techSig, techSig);
                  } else if (checkFormData.data && typeof checkFormData.data === 'object' && checkFormData.data.tech_signature) {
                    techSig = checkFormData.data.tech_signature;
                    console.log('üìù Found tech_signature in submissionData.form_data.data');
                  }
                }
              }
            }
            
            if (techSig) {
              console.log('üìù Processing technician signature:', typeof techSig, techSig);
              
              // Handle object format with url property (from database storage)
              if (typeof techSig === 'object' && techSig !== null) {
                if (techSig.url) {
                  techSig = techSig.url;
                  console.log('üìù Extracted URL from signature object:', techSig);
                } else {
                  console.warn('‚ö†Ô∏è Signature object found but no url property:', Object.keys(techSig));
                  techSig = null;
                }
              }
              
              // Accept data URLs, http/https URLs, or relative paths starting with /
              const isValidUrl = typeof techSig === 'string' && techSig.length > 0 && (
                techSig.startsWith('data:image') || 
                techSig.startsWith('http://') || 
                techSig.startsWith('https://') || 
                techSig.startsWith('/')
              );
              
              if (isValidUrl) {
                console.log('‚úÖ Valid signature URL found:', techSig.substring(0, 80));
                {% if is_supervisor_edit %}
                // Show in read-only display for supervisor/manager
                const techDisplay = document.getElementById('techSignatureDisplay');
                if (techDisplay) {
                  console.log('‚úÖ Displaying technician signature in read-only mode');
                  const sigImg = document.createElement('img');
                  sigImg.src = techSig;
                  sigImg.alt = 'Supervisor Signature';
                  sigImg.style.cssText = 'width: 100%; max-width: 500px; max-height: 150px; object-fit: contain; border-radius: 4px; border: 1px solid #e5e7eb;';
                  sigImg.onerror = function() {
                    console.error('‚ùå Failed to load technician signature image:', techSig);
                    this.style.display = 'none';
                    techDisplay.innerHTML = '<span style="color: #dc2626;">‚ö†Ô∏è Signature not accessible. URL: ' + techSig.substring(0, 50) + '...</span>';
                  };
                  sigImg.onload = function() {
                    console.log('‚úÖ Supervisor signature image loaded successfully');
                  };
                  techDisplay.innerHTML = '';
                  techDisplay.appendChild(sigImg);
                  
                  // Store in hidden input for submission
                  const techSigInput = document.getElementById('techSignatureData');
                  if (techSigInput) techSigInput.value = techSig;
                } else {
                  console.warn('‚ö†Ô∏è techSignatureDisplay element not found');
                }
              } else {
                console.warn('‚ö†Ô∏è Invalid signature URL format:', typeof techSig, techSig);
              }
            } else {
              console.warn('‚ö†Ô∏è No technician signature found in formData');
              console.warn('  formData keys:', Object.keys(formData));
              console.warn('  Looking for: tech_signature, techSignatureData');
            }
            {% else %}
                // Normal edit mode - show in canvas (for technician editing their own submission)
                if (techSig && typeof techSig === 'string' && (
                  techSig.startsWith('data:image') || 
                  techSig.startsWith('http://') || 
                  techSig.startsWith('https://') || 
                  techSig.startsWith('/')
                )) {
                const techCanvas = document.getElementById('techSignaturePad');
                  if (techCanvas && pads && pads.techPad) {
                  // Hide canvas and show signature as image instead (more reliable)
                  techCanvas.style.display = 'none';
                  
                  // Create image element to display the signature
                  const sigImg = document.createElement('img');
                  sigImg.src = techSig;
                  sigImg.alt = 'Supervisor Signature';
                  sigImg.style.cssText = 'width: 100%; max-height: 180px; object-fit: contain; border: 2px solid #10b981; border-radius: 8px; background: #f0fdf4; padding: 10px;';
                  techCanvas.parentElement.insertBefore(sigImg, techCanvas);
                  
                  // Hide clear button
                  const clearBtn = document.getElementById('clearTech');
                  if (clearBtn) clearBtn.style.display = 'none';
                  
                  // Store signature URL in hidden input
                  const techSigInput = document.getElementById('techSignatureData');
                  if (techSigInput) techSigInput.value = techSig;
                  
                  // Add label and message
                  const techLabel = techCanvas.parentElement.querySelector('label');
                  if (techLabel) {
                    techLabel.innerHTML = 'SUPERVISOR SIGNATURE <span style="color: #10b981; font-weight: bold; font-size: 0.9rem;">‚úì Already Signed</span>';
                  }
                  
                  // Update hint text
                  const hintSpan = techCanvas.parentElement.querySelector('.signature-hint');
                  if (hintSpan) hintSpan.style.display = 'none';
                  }
                }
                {% endif %}
            
            // Load supervisor comments and signature if supervisor is editing
            // Always check for supervisor data if user is supervisor or in supervisor edit mode
            {% if is_supervisor_edit or user_designation == 'supervisor' %}
            // Try multiple paths to find supervisor comments - check ALL possible locations
            let supervisorComments = null;
            console.log('üîç Looking for supervisor_comments...');
            console.log('  formData:', formData);
            console.log('  formData.supervisor_comments:', formData?.supervisor_comments);
            console.log('  submissionData.form_data:', submissionData?.form_data);
            console.log('  submissionData.form_data?.supervisor_comments:', submissionData?.form_data?.supervisor_comments);
            console.log('  submissionData.supervisor_comments:', submissionData?.supervisor_comments);
            
            // Check formData first (already parsed) - including nested data
            if (formData) {
              if (formData.supervisor_comments !== undefined && formData.supervisor_comments !== null) {
                supervisorComments = formData.supervisor_comments;
                console.log('üìù Found supervisor_comments in formData:', supervisorComments ? 'has value' : 'empty string');
              }
              // Also check nested formData.data
              else if (formData.data && typeof formData.data === 'object' && formData.data.supervisor_comments !== undefined) {
                supervisorComments = formData.data.supervisor_comments;
                console.log('üìù Found supervisor_comments in formData.data');
              }
            }
            
            // Check submissionData.form_data (might be string or object)
            if (supervisorComments === null && submissionData && submissionData.form_data) {
              let checkFormData = submissionData.form_data;
              if (typeof checkFormData === 'string') {
                try {
                  checkFormData = JSON.parse(checkFormData);
                } catch (e) {
                  console.error('‚ùå Error parsing submissionData.form_data:', e);
                }
              }
              if (checkFormData) {
                if (checkFormData.supervisor_comments !== undefined && checkFormData.supervisor_comments !== null) {
                  supervisorComments = checkFormData.supervisor_comments;
                  console.log('üìù Found supervisor_comments in submissionData.form_data (parsed)');
                }
                // Also check nested form_data.data
                else if (checkFormData.data && typeof checkFormData.data === 'object' && checkFormData.data.supervisor_comments !== undefined) {
                  supervisorComments = checkFormData.data.supervisor_comments;
                  console.log('üìù Found supervisor_comments in submissionData.form_data.data');
                }
              }
            }
            
            // Check top-level submissionData
            if (supervisorComments === null && submissionData && submissionData.supervisor_comments !== undefined && submissionData.supervisor_comments !== null) {
              supervisorComments = submissionData.supervisor_comments;
              console.log('üìù Found supervisor_comments in submissionData (top level)');
            }
            
            // Only set if not null/undefined (empty string is OK)
            if (supervisorComments !== null && supervisorComments !== undefined) {
              const commentsField = document.getElementById('supervisorComments');
              if (commentsField) {
                // Remove the "[Form updated by supervisor with new details]" suffix if present for display
                const displayComments = String(supervisorComments).replace(/\n\n\[Form updated by supervisor with new details\]$/g, '');
                commentsField.value = displayComments;
                console.log('‚úÖ Loaded supervisor comments into field:', displayComments.substring(0, 50));
              } else {
                console.error('‚ùå supervisorComments field not found in DOM');
              }
            } else {
              console.warn('‚ö†Ô∏è No supervisor comments found in any location');
              console.warn('  Checked: formData.supervisor_comments, submissionData.form_data.supervisor_comments, submissionData.supervisor_comments');
            }
            
            // Try multiple paths to find supervisor signature - check ALL possible locations
            let supervisorSig = null;
            console.log('üîç Looking for supervisor_signature...');
            console.log('  formData.supervisor_signature:', formData?.supervisor_signature !== undefined ? 
                       `exists (value: ${formData?.supervisor_signature}, type: ${typeof formData?.supervisor_signature})` : 'not found');
            console.log('  submissionData.form_data?.supervisor_signature:', submissionData?.form_data?.supervisor_signature !== undefined ? 
                       `exists (value: ${submissionData?.form_data?.supervisor_signature}, type: ${typeof submissionData?.form_data?.supervisor_signature})` : 'not found');
            console.log('  submissionData.supervisor_signature:', submissionData?.supervisor_signature !== undefined ? 
                       `exists (value: ${submissionData?.supervisor_signature}, type: ${typeof submissionData?.supervisor_signature})` : 'not found');
            
            // Check formData first (already parsed) - including nested data
            // IMPORTANT: Check for null/undefined explicitly, not just truthy values
            if (formData) {
              if (formData.supervisor_signature !== null && formData.supervisor_signature !== undefined && formData.supervisor_signature !== '') {
                supervisorSig = formData.supervisor_signature;
                console.log('üìù Found supervisor_signature in formData:', typeof supervisorSig, supervisorSig ? 'has value' : 'empty');
              }
              // Also check nested formData.data
              else if (formData.data && typeof formData.data === 'object' && 
                       formData.data.supervisor_signature !== null && 
                       formData.data.supervisor_signature !== undefined && 
                       formData.data.supervisor_signature !== '') {
                supervisorSig = formData.data.supervisor_signature;
                console.log('üìù Found supervisor_signature in formData.data');
              }
            }
            
            // Check submissionData.form_data (might be string or object)
            if (!supervisorSig && submissionData && submissionData.form_data) {
              let checkFormData = submissionData.form_data;
              if (typeof checkFormData === 'string') {
                try {
                  checkFormData = JSON.parse(checkFormData);
                } catch (e) {
                  console.error('‚ùå Error parsing submissionData.form_data for signature:', e);
                }
              }
              if (checkFormData) {
                if (checkFormData.supervisor_signature !== null && 
                    checkFormData.supervisor_signature !== undefined && 
                    checkFormData.supervisor_signature !== '') {
                  supervisorSig = checkFormData.supervisor_signature;
                  console.log('üìù Found supervisor_signature in submissionData.form_data (parsed)');
                }
                // Also check nested form_data.data
                else if (checkFormData.data && typeof checkFormData.data === 'object' && 
                         checkFormData.data.supervisor_signature !== null && 
                         checkFormData.data.supervisor_signature !== undefined && 
                         checkFormData.data.supervisor_signature !== '') {
                  supervisorSig = checkFormData.data.supervisor_signature;
                  console.log('üìù Found supervisor_signature in submissionData.form_data.data');
                }
              }
            }
            
            // Check top-level submissionData
            if (!supervisorSig && submissionData && 
                submissionData.supervisor_signature !== null && 
                submissionData.supervisor_signature !== undefined && 
                submissionData.supervisor_signature !== '') {
              supervisorSig = submissionData.supervisor_signature;
              console.log('üìù Found supervisor_signature in submissionData (top level)');
            }
            
            // Log the actual value for debugging
            if (formData && formData.hasOwnProperty('supervisor_signature')) {
              console.log('  formData.supervisor_signature value:', formData.supervisor_signature, 'type:', typeof formData.supervisor_signature);
            }
            
            if (supervisorSig) {
              console.log('üìù Processing supervisor signature:', typeof supervisorSig, supervisorSig);
              
              // Handle object format with url property
              if (supervisorSig && typeof supervisorSig === 'object' && supervisorSig !== null) {
                if (supervisorSig.url) {
                  supervisorSig = supervisorSig.url;
                  console.log('üìù Extracted supervisor signature URL from object:', supervisorSig.substring(0, 80));
                } else {
                  console.warn('‚ö†Ô∏è Supervisor signature is object but has no url property:', Object.keys(supervisorSig));
                  supervisorSig = null;
                }
              }
              
              if (supervisorSig && typeof supervisorSig === 'string' && supervisorSig.trim() !== '' && (
                supervisorSig.startsWith('data:image') || 
                supervisorSig.startsWith('http://') || 
                supervisorSig.startsWith('https://') || 
                supervisorSig.startsWith('/')
              )) {
                console.log('‚úÖ Valid supervisor signature URL found');
                const supervisorCanvas = document.getElementById('supervisorSignaturePad');
                const supervisorSigInput = document.getElementById('supervisorSignatureData');
                
                if (supervisorCanvas && supervisorSigInput) {
                  // Check if supervisor is editing their own form (can clear/re-sign)
                  {% if submission_data and submission_data.workflow_status %}
                  const workflowStatus = {{ submission_data.workflow_status|tojson|safe }};
                  {% else %}
                  const workflowStatus = null;
                  {% endif %}
                  // Check ownership: supervisor owns submission if supervisor_id matches
                  {% if submission_data and submission_data.supervisor_id %}
                  const submissionSupervisorId = {{ submission_data.supervisor_id|tojson|safe }};
                  {% else %}
                  const submissionSupervisorId = null;
                  {% endif %}
                  {% if current_user_id is defined and current_user_id is not none %}
                  const currentUserId = {{ current_user_id|tojson|safe }};
                  {% else %}
                  const currentUserId = null;
                  {% endif %}
                  const isOwnSubmission = (submissionSupervisorId && submissionSupervisorId === currentUserId) || 
                                          workflowStatus === 'submitted' || 
                                          workflowStatus === 'rejected' || 
                                          !workflowStatus;
                  
                  // Check if image already exists to avoid duplicates
                  const existingImg = supervisorCanvas.parentElement.querySelector('img[alt="Supervisor Signature"]');
                  if (existingImg) {
                    console.log('‚ö†Ô∏è Signature image already exists, removing duplicate');
                    existingImg.remove();
                  }
                  
                  // Store in hidden input
                  supervisorSigInput.value = supervisorSig;
                  
                  if (isOwnSubmission) {
                    // Supervisor editing their own form - load into canvas for editing (allow clear/re-sign)
                    console.log('‚úÖ Supervisor editing own form - loading signature into canvas for editing');
                    // Ensure canvas is visible for editing
                    supervisorCanvas.style.display = 'block';
                    
                    // Ensure clear button is visible and functional
                    const clearSupervisorBtn = document.getElementById('clearSupervisor');
                    if (clearSupervisorBtn) {
                      clearSupervisorBtn.style.display = 'block';
                      clearSupervisorBtn.style.visibility = 'visible';
                      // Re-attach event listener to ensure it works after signature is loaded
                      // Remove existing click listeners
                      const newClearBtn = clearSupervisorBtn.cloneNode(true);
                      clearSupervisorBtn.parentNode.replaceChild(newClearBtn, clearSupervisorBtn);
                      
                      newClearBtn.addEventListener('click', function() {
                        if (pads && pads.supervisorPad) {
                          pads.supervisorPad.clear();
                          if (supervisorSigInput) supervisorSigInput.value = '';
                          console.log('‚úÖ Supervisor signature cleared');
                        } else {
                          console.warn('‚ö†Ô∏è Supervisor pad not available for clearing');
                        }
                      });
                    }
                    
                    // Load signature into pad
                    const loadSupervisorSig = () => {
                      if (pads && pads.supervisorPad && supervisorCanvas) {
                        try {
                          const img = new Image();
                          img.crossOrigin = 'anonymous';
                          img.onload = function() {
                            try {
                              // Clear pad first, then load signature
                              pads.supervisorPad.clear();
                              pads.supervisorPad.fromDataURL(supervisorSig);
                              console.log('‚úÖ Loaded supervisor signature into pad for editing');
                            } catch (e) {
                              console.error('‚ùå Error loading signature into pad:', e);
                            }
                          };
                          img.onerror = function() {
                            console.error('‚ùå Failed to load supervisor signature image');
                          };
                          img.src = supervisorSig;
                        } catch (e) {
                          console.error('‚ùå Error setting up supervisor signature image load:', e);
                        }
                      } else {
                        console.warn('‚ö†Ô∏è Supervisor signature pad not ready yet, will retry...');
                        setTimeout(loadSupervisorSig, 200);
                      }
                    };
                    loadSupervisorSig();
                  } else {
                    // Not their own form - show as read-only image
                    console.log('‚úÖ Showing supervisor signature as read-only image');
                    supervisorCanvas.style.display = 'none';
                    
                    // Create image element to display the signature
                    const sigImg = document.createElement('img');
                    sigImg.src = supervisorSig;
                    sigImg.alt = 'Supervisor Signature';
                    sigImg.style.cssText = 'width: 100%; max-width: 500px; max-height: 160px; object-fit: contain; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: block;';
                    supervisorCanvas.parentElement.insertBefore(sigImg, supervisorCanvas);
                    
                    // Hide clear button (look for button by ID)
                    const clearBtn = document.getElementById('clearSupervisor');
                    if (clearBtn) {
                      clearBtn.style.display = 'none';
                    }
                    
                    // Update label to show signature is already present
                    const label = supervisorCanvas.parentElement.querySelector('.signature-label');
                    if (label) {
                      const existingHint = label.querySelector('.signature-hint');
                      if (existingHint) {
                        existingHint.innerHTML = '<span style="color: #10b981; font-weight: bold; font-size: 0.9rem;">‚úì Already Signed</span>';
                      }
                    }
                    
                    sigImg.onload = function() {
                      console.log('‚úÖ Supervisor signature image displayed successfully');
                    };
                    
                    sigImg.onerror = function() {
                      console.error('‚ùå Failed to load supervisor signature image');
                      supervisorCanvas.style.display = 'block';
                      this.style.display = 'none';
                    };
                  }
                } else {
                  console.warn('‚ö†Ô∏è Supervisor signature canvas or input not found');
                }
              } else {
                console.warn('‚ö†Ô∏è Invalid supervisor signature format:', typeof supervisorSig);
              }
            } else {
              console.warn('‚ö†Ô∏è No supervisor signature found');
              console.warn('  formData keys:', Object.keys(formData));
              console.warn('  submissionData.form_data keys:', Object.keys(submissionData.form_data || {}));
            }
            {% endif %}
            
            // Load Operations Manager comments
            {% if user_designation == 'operations_manager' %}
            let operationsManagerComments = null;
            if (formData && formData.operations_manager_comments) {
              operationsManagerComments = formData.operations_manager_comments;
            } else if (submissionData && submissionData.form_data && submissionData.form_data.operations_manager_comments) {
              operationsManagerComments = submissionData.form_data.operations_manager_comments;
            } else if (submissionData && submissionData.operations_manager_comments) {
              operationsManagerComments = submissionData.operations_manager_comments;
            }
            
            if (operationsManagerComments) {
              const commentsField = document.getElementById('operationsManagerComments');
              if (commentsField) {
                commentsField.value = operationsManagerComments;
                console.log('‚úÖ Loaded Operations Manager comments into field');
              }
            }
            {% endif %}
            
            // Load Operations Manager comments and signature for BD (read-only) - check ALL possible locations
            {% if user_designation == 'business_development' %}
            let opsManagerCommentsBD = null;
            let opsManagerSigBD = null;
            
            // Check formData first (this is the parsed form_data from submission)
            if (formData) {
              // IMPORTANT: Only get operations_manager_comments, NOT supervisor_comments
              if (formData.operations_manager_comments !== null && formData.operations_manager_comments !== undefined && formData.operations_manager_comments !== '') {
                opsManagerCommentsBD = formData.operations_manager_comments;
              }
              
              if (formData.operations_manager_signature !== null && formData.operations_manager_signature !== undefined && formData.operations_manager_signature !== '') {
                opsManagerSigBD = formData.operations_manager_signature;
              } else if (formData.opMan_signature !== null && formData.opMan_signature !== undefined && formData.opMan_signature !== '') {
                opsManagerSigBD = formData.opMan_signature;
              }
            }
            
            // Check submissionData.form_data (might be a different reference)
            if ((!opsManagerCommentsBD || !opsManagerSigBD) && submissionData && submissionData.form_data) {
              let checkFormData = submissionData.form_data;
              if (typeof checkFormData === 'string') {
                try {
                  checkFormData = JSON.parse(checkFormData);
                } catch (e) {
                  console.error('‚ùå BD: Error parsing submissionData.form_data:', e);
                }
              }
              if (checkFormData && typeof checkFormData === 'object') {
                if (!opsManagerCommentsBD && checkFormData.operations_manager_comments !== null && checkFormData.operations_manager_comments !== undefined && checkFormData.operations_manager_comments !== '') {
                  opsManagerCommentsBD = checkFormData.operations_manager_comments;
                }
                if (!opsManagerSigBD) {
                  if (checkFormData.operations_manager_signature !== null && checkFormData.operations_manager_signature !== undefined && checkFormData.operations_manager_signature !== '') {
                    opsManagerSigBD = checkFormData.operations_manager_signature;
                  } else if (checkFormData.opMan_signature !== null && checkFormData.opMan_signature !== undefined && checkFormData.opMan_signature !== '') {
                    opsManagerSigBD = checkFormData.opMan_signature;
                  }
                }
              }
            }
            
            // Check top-level submissionData (for model fields that might be exposed)
            if (!opsManagerCommentsBD && submissionData && submissionData.operations_manager_comments !== null && submissionData.operations_manager_comments !== undefined) {
              opsManagerCommentsBD = submissionData.operations_manager_comments;
            }
            if (!opsManagerSigBD && submissionData) {
              if (submissionData.operations_manager_signature !== null && submissionData.operations_manager_signature !== undefined && submissionData.operations_manager_signature !== '') {
                opsManagerSigBD = submissionData.operations_manager_signature;
              } else if (submissionData.opMan_signature !== null && submissionData.opMan_signature !== undefined && submissionData.opMan_signature !== '') {
                opsManagerSigBD = submissionData.opMan_signature;
              }
            }
            
            // Always show OM section if we have any data OR if OM has approved (check model field)
            // Check if OM has approved by looking at submission data
            let omHasApproved = false;
            if (submissionData) {
              // Check if operations_manager_approved_at exists (means OM has approved)
              if (submissionData.operations_manager_approved_at || 
                  (submissionData.workflow_status && 
                   (submissionData.workflow_status.includes('operations_manager_approved') || 
                    submissionData.workflow_status.includes('bd_procurement')))) {
                omHasApproved = true;
              }
            }
            
            if (opsManagerCommentsBD || opsManagerSigBD || omHasApproved) {
              const section = document.getElementById('opsManagerReadOnlySection');
              if (section) {
                section.style.display = 'block';
                // Also show the parent section container
                const parentSection = document.getElementById('previousForBDSection');
                if (parentSection) {
                  parentSection.style.display = 'block';
                }
                
                const commentsDiv = document.getElementById('opsManagerCommentsReadOnly');
                if (commentsDiv) {
                  if (opsManagerCommentsBD) {
                    commentsDiv.textContent = opsManagerCommentsBD;
                  } else {
                    commentsDiv.textContent = 'No comments provided';
                    commentsDiv.style.fontStyle = 'italic';
                    commentsDiv.style.color = '#9ca3af';
                  }
                }
                
                const sigDiv = document.getElementById('opsManagerSignatureReadOnly');
                if (sigDiv) {
                  // Clear loading message first
                  sigDiv.innerHTML = '';
                  
                  if (opsManagerSigBD) {
                    // Handle object format
                    let sigUrl = opsManagerSigBD;
                    if (typeof sigUrl === 'object' && sigUrl.url) {
                      sigUrl = sigUrl.url;
                    }
                    
                    if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
                      const img = document.createElement('img');
                      img.src = sigUrl;
                      img.style.cssText = 'width: 100%; max-height: 140px; object-fit: contain;';
                      img.alt = 'Operations Manager Signature';
                      img.onerror = () => {
                        sigDiv.innerHTML = '<span style="color: #dc3545;">Failed to load signature</span>';
                      };
                      sigDiv.appendChild(img);
                    } else {
                      sigDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                    }
                  } else {
                    sigDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                  }
                }
              }
            }
            
            // Load Procurement data for BD (so BD can see if PO has signed)
            let procurementCommentsBD = null;
            let procurementSigBD = null;
            
            if (formData) {
              if (formData.procurement_comments) procurementCommentsBD = formData.procurement_comments;
              if (formData.procurement_signature) procurementSigBD = formData.procurement_signature;
            }
            
            if ((!procurementCommentsBD || !procurementSigBD) && submissionData && submissionData.form_data) {
              let checkFormData = submissionData.form_data;
              if (typeof checkFormData === 'string') {
                try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
              }
              if (checkFormData) {
                if (!procurementCommentsBD && checkFormData.procurement_comments) procurementCommentsBD = checkFormData.procurement_comments;
                if (!procurementSigBD && checkFormData.procurement_signature) procurementSigBD = checkFormData.procurement_signature;
              }
            }
            
            if (procurementCommentsBD || procurementSigBD) {
              const section = document.getElementById('procurementReadOnlyBD');
              if (section) {
                section.style.display = 'block';
                document.getElementById('previousForBDSection').style.display = 'block';
                
                const commentsDiv = document.getElementById('procurementCommentsReadOnlyBD');
                if (commentsDiv) {
                  if (procurementCommentsBD) commentsDiv.textContent = procurementCommentsBD;
                  else {
                    commentsDiv.textContent = 'No comments provided';
                    commentsDiv.style.fontStyle = 'italic';
                    commentsDiv.style.color = '#9ca3af';
                  }
                }
                
                const sigDiv = document.getElementById('procurementSignatureReadOnlyBD');
                if (sigDiv) {
                  sigDiv.innerHTML = '';
                  if (procurementSigBD) {
                    let sigUrl = procurementSigBD;
                    if (typeof sigUrl === 'object' && sigUrl.url) sigUrl = sigUrl.url;
                    
                    if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
                      const img = document.createElement('img');
                      img.src = sigUrl;
                      img.style.cssText = 'width: 100%; max-height: 140px; object-fit: contain;';
                      img.alt = 'Procurement Signature';
                      sigDiv.appendChild(img);
                    } else {
                      sigDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                    }
                  } else {
                    sigDiv.innerHTML = '<span style="color: #9ca3af;">Not signed yet</span>';
                  }
                }
              }
            }
            {% endif %}
            
            // Load Operations Manager signature (for Operations Manager editing) - check ALL possible locations
            let opSig = null;
            
            // Check formData first
            if (formData) {
              if (formData.opMan_signature) {
                opSig = formData.opMan_signature;
                console.log('üìù Found opMan_signature in formData');
              } else if (formData.opManSignatureData) {
                opSig = formData.opManSignatureData;
                console.log('üìù Found opManSignatureData in formData');
              } else if (formData.operations_manager_signature) {
                opSig = formData.operations_manager_signature;
                console.log('üìù Found operations_manager_signature in formData');
              } else if (formData.data && typeof formData.data === 'object') {
                if (formData.data.opMan_signature) {
                  opSig = formData.data.opMan_signature;
                  console.log('üìù Found opMan_signature in formData.data');
                } else if (formData.data.operations_manager_signature) {
                  opSig = formData.data.operations_manager_signature;
                  console.log('üìù Found operations_manager_signature in formData.data');
                }
              }
            }
            
            // Check submissionData
            if (!opSig && submissionData) {
              if (submissionData.opMan_signature) {
                opSig = submissionData.opMan_signature;
                console.log('üìù Found opMan_signature in submissionData (top level)');
              } else if (submissionData.operations_manager_signature) {
                opSig = submissionData.operations_manager_signature;
                console.log('üìù Found operations_manager_signature in submissionData (top level)');
              } else if (submissionData.form_data) {
                let checkFormData = submissionData.form_data;
                if (typeof checkFormData === 'string') {
                  try {
                    checkFormData = JSON.parse(checkFormData);
                  } catch (e) {
                    console.error('‚ùå Error parsing submissionData.form_data for opman signature:', e);
                  }
                }
                if (checkFormData) {
                  if (checkFormData.opMan_signature) {
                    opSig = checkFormData.opMan_signature;
                    console.log('üìù Found opMan_signature in submissionData.form_data');
                  } else if (checkFormData.operations_manager_signature) {
                    opSig = checkFormData.operations_manager_signature;
                    console.log('üìù Found operations_manager_signature in submissionData.form_data');
                  } else if (checkFormData.data && typeof checkFormData.data === 'object') {
                    if (checkFormData.data.opMan_signature) {
                      opSig = checkFormData.data.opMan_signature;
                      console.log('üìù Found opMan_signature in submissionData.form_data.data');
                    } else if (checkFormData.data.operations_manager_signature) {
                      opSig = checkFormData.data.operations_manager_signature;
                      console.log('üìù Found operations_manager_signature in submissionData.form_data.data');
                    }
                  }
                }
              }
            }
            
            if (opSig) {
              
              // Handle object format with url property (from Cloudinary)
              if (opSig && typeof opSig === 'object' && opSig.url) {
                opSig = opSig.url;
              }
              
              if (opSig && typeof opSig === 'string' && (opSig.startsWith('data:image') || opSig.startsWith('http'))) {
                const opCanvas = document.getElementById('opManSignaturePad');
                if (opCanvas) {
                  // Check if image already exists to avoid duplicates
                  const existingImg = opCanvas.parentElement.querySelector('img[alt="Manager Signature"]');
                  if (existingImg) {
                    console.log('‚ö†Ô∏è Operations Manager signature image already exists, removing duplicate');
                    existingImg.remove();
                  }
                  
                  // Check if this is Operations Manager reviewing during their stage (can edit)
                  {% if submission_data and submission_data.workflow_status %}
                  const workflowStatus = {{ submission_data.workflow_status|tojson|safe }};
                  {% else %}
                  const workflowStatus = null;
                  {% endif %}
                  const canEdit = workflowStatus === 'operations_manager_review';
                  
                  if (canEdit) {
                    // Operations Manager can edit - load into canvas, allow clear
                    console.log('‚úÖ Operations Manager editing - loading signature into canvas');
                    opCanvas.style.display = 'block';
                    
                    // Ensure clear button is visible and functional
                    const clearOpBtn = document.getElementById('clearOp');
                    if (clearOpBtn) {
                      clearOpBtn.style.display = 'block';
                      clearOpBtn.style.visibility = 'visible';
                      
                      // Re-attach event listener
                      const newClearBtn = clearOpBtn.cloneNode(true);
                      clearOpBtn.parentNode.replaceChild(newClearBtn, clearOpBtn);
                      
                      newClearBtn.addEventListener('click', function() {
                        if (pads && pads.opPad) {
                          pads.opPad.clear();
                          const opSigInput = document.getElementById('opManSignatureData');
                          if (opSigInput) opSigInput.value = '';
                          console.log('‚úÖ Operations Manager signature cleared');
                        }
                      });
                    }
                    
                    // Load signature into pad
                    const loadOpSig = () => {
                      if (pads && pads.opPad && opCanvas) {
                        try {
                          const img = new Image();
                          img.crossOrigin = 'anonymous';
                          img.onload = function() {
                            try {
                              pads.opPad.clear();
                              pads.opPad.fromDataURL(opSig);
                              console.log('‚úÖ Loaded Operations Manager signature into pad');
                            } catch (e) {
                              console.error('‚ùå Error loading signature into pad:', e);
                            }
                          };
                          img.onerror = function() {
                            console.error('‚ùå Failed to load Operations Manager signature image');
                          };
                          img.src = opSig;
                        } catch (e) {
                          console.error('‚ùå Error setting up Operations Manager signature image load:', e);
                        }
                      } else {
                        setTimeout(loadOpSig, 200);
                      }
                    };
                    loadOpSig();
                  } else {
                    // Read-only view - show as image
                    opCanvas.style.display = 'none';
                    
                    const sigImg = document.createElement('img');
                    sigImg.src = opSig;
                    sigImg.alt = 'Manager Signature';
                    sigImg.style.cssText = 'width: 100%; max-height: 180px; object-fit: contain; border: 2px solid #10b981; border-radius: 8px; background: #f0fdf4; padding: 10px;';
                    opCanvas.parentElement.insertBefore(sigImg, opCanvas);
                    
                    // Hide clear button
                    const clearOpBtn = document.getElementById('clearOp');
                    if (clearOpBtn) clearOpBtn.style.display = 'none';
                    
                    // Store signature URL in hidden input
                    const opSigInput = document.getElementById('opManSignatureData');
                    if (opSigInput) opSigInput.value = opSig;
                    
                    // Update label
                    const opLabel = opCanvas.parentElement.querySelector('label');
                    if (opLabel) {
                      opLabel.innerHTML = 'OPERATIONS MANAGER SIGNATURE <span style="color: #10b981; font-weight: bold; font-size: 0.9rem;">‚úì Already Signed</span>';
                    }
                    
                    // Update hint text
                    const hintSpan = opCanvas.parentElement.querySelector('.signature-hint');
                    if (hintSpan) hintSpan.style.display = 'none';
                  }
                }
              }
            }
          }
          
          // Load Business Development comments and signature
          {% if user_designation == 'business_development' %}
          let businessDevComments = formData.business_dev_comments || 
                                   (submissionData?.form_data?.business_dev_comments);
          let businessDevSig = formData.business_dev_signature || 
                              (submissionData?.form_data?.business_dev_signature);
          
          if (businessDevComments) {
            const commentsField = document.getElementById('businessDevComments');
            if (commentsField) {
              commentsField.value = businessDevComments;
              console.log('‚úÖ Loaded BD comments');
            }
          }
          
          if (businessDevSig) {
            let sigUrl = businessDevSig;
            if (typeof sigUrl === 'object' && sigUrl.url) {
              sigUrl = sigUrl.url;
            }
            
            if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
              const sigInput = document.getElementById('businessDevSignatureData');
              if (sigInput) sigInput.value = sigUrl;
              
              // Load into canvas if pad exists
              if (pads && pads.businessDevPad) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                  pads.businessDevPad.clear();
                  pads.businessDevPad.fromDataURL(sigUrl);
                  console.log('‚úÖ Loaded BD signature into pad');
                };
                img.src = sigUrl;
              }
            }
          }
          {% endif %}
          
          // Load Procurement comments and signature
          {% if user_designation == 'procurement' %}
          let procurementComments = formData.procurement_comments || 
                                   (submissionData?.form_data?.procurement_comments);
          let procurementSig = formData.procurement_signature || 
                              (submissionData?.form_data?.procurement_signature);
          
          if (procurementComments) {
            const commentsField = document.getElementById('procurementComments');
            if (commentsField) {
              commentsField.value = procurementComments;
              console.log('‚úÖ Loaded Procurement comments');
            }
          }
          
          if (procurementSig) {
            let sigUrl = procurementSig;
            if (typeof sigUrl === 'object' && sigUrl.url) {
              sigUrl = sigUrl.url;
            }
            
            if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
              const sigInput = document.getElementById('procurementSignatureData');
              if (sigInput) sigInput.value = sigUrl;
              
              // Load into canvas if pad exists
              if (pads && pads.procurementPad) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                  pads.procurementPad.clear();
                  pads.procurementPad.fromDataURL(sigUrl);
                  console.log('‚úÖ Loaded Procurement signature into pad');
                };
                img.src = sigUrl;
              }
            }
          }

          // Also show previous reviewers (OM + BD) in read-only blocks for Procurement
          const prevForProc = document.getElementById('previousForProcurementSection');
          let hasPrevForProc = false;

          // OM for Procurement - comprehensive data loading
          let opsManagerCommentsProc = null;
          let opsManagerSigProc = null;
          
          // Check formData first
          if (formData) {
            if (formData.operations_manager_comments) opsManagerCommentsProc = formData.operations_manager_comments;
            if (formData.operations_manager_signature) opsManagerSigProc = formData.operations_manager_signature;
            else if (formData.opMan_signature) opsManagerSigProc = formData.opMan_signature;
          }
          
          // Check submissionData.form_data
          if ((!opsManagerCommentsProc || !opsManagerSigProc) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData && typeof checkFormData === 'object') {
              if (!opsManagerCommentsProc && checkFormData.operations_manager_comments) opsManagerCommentsProc = checkFormData.operations_manager_comments;
              if (!opsManagerSigProc) {
                if (checkFormData.operations_manager_signature) opsManagerSigProc = checkFormData.operations_manager_signature;
                else if (checkFormData.opMan_signature) opsManagerSigProc = checkFormData.opMan_signature;
              }
            }
          }
          
          // Check top-level submissionData
          if (!opsManagerCommentsProc && submissionData && submissionData.operations_manager_comments) {
            opsManagerCommentsProc = submissionData.operations_manager_comments;
          }
          if (!opsManagerSigProc && submissionData) {
            if (submissionData.operations_manager_signature) opsManagerSigProc = submissionData.operations_manager_signature;
            else if (submissionData.opMan_signature) opsManagerSigProc = submissionData.opMan_signature;
          }

          if (opsManagerCommentsProc || opsManagerSigProc) {
            hasPrevForProc = true;
            const sec = document.getElementById('opsManagerReadOnlyProc');
            if (sec) {
              sec.style.display = 'block';
              document.getElementById('previousForProcurementSection').style.display = 'block';
            }

            const cDiv = document.getElementById('opsManagerCommentsReadOnlyProc');
            if (cDiv) {
              if (opsManagerCommentsProc) {
                cDiv.textContent = opsManagerCommentsProc;
              } else {
                cDiv.textContent = 'No comments provided';
                cDiv.style.fontStyle = 'italic';
                cDiv.style.color = '#9ca3af';
              }
            }

            const sDiv = document.getElementById('opsManagerSignatureReadOnlyProc');
            if (sDiv) {
              // Clear loading message first
              sDiv.innerHTML = '';
              
              if (opsManagerSigProc) {
                let sigUrl = opsManagerSigProc;
                if (typeof sigUrl === 'object' && sigUrl.url) {
                  sigUrl = sigUrl.url;
                }
                
                if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
                  const img = document.createElement('img');
                  img.src = sigUrl;
                  img.style.cssText = 'width: 100%; max-height: 140px; object-fit: contain;';
                  img.alt = 'Operations Manager Signature';
                  img.onerror = () => {
                    sDiv.innerHTML = '<span style="color: #dc3545;">Failed to load signature</span>';
                  };
                  sDiv.appendChild(img);
                } else {
                  sDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                }
              } else {
                sDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
              }
            }
          }

          // BD for Procurement - comprehensive data loading
          // CRITICAL: Only use actual BD comments, never fall back to supervisor comments
          let bdCommentsProc = null;
          let bdSigProc = null;
          const supervisorComments = formData?.supervisor_comments || (submissionData?.form_data?.supervisor_comments);
          
          // Check formData first
          if (formData) {
            // Only use BD comments if they exist AND are different from supervisor comments
            if (formData.business_dev_comments) {
              if (formData.business_dev_comments !== supervisorComments) {
                bdCommentsProc = formData.business_dev_comments;
              } else {
                console.warn('‚ö†Ô∏è Procurement: BD comments appear to be supervisor comments, ignoring');
              }
            }
            if (formData.business_dev_signature) bdSigProc = formData.business_dev_signature;
          }
          
          // Check submissionData.form_data
          if ((!bdCommentsProc || !bdSigProc) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              // Only use BD comments if they exist AND are different from supervisor comments
              if (!bdCommentsProc && checkFormData.business_dev_comments) {
                if (checkFormData.business_dev_comments !== supervisorComments) {
                  bdCommentsProc = checkFormData.business_dev_comments;
                } else {
                  console.warn('‚ö†Ô∏è Procurement: BD comments in form_data appear to be supervisor comments, ignoring');
                }
              }
              if (!bdSigProc && checkFormData.business_dev_signature) bdSigProc = checkFormData.business_dev_signature;
            }
          }
          
          // Check if BD has approved (even if data is missing, we should show the section)
          let bdHasApproved = false;
          if (submissionData) {
            if (submissionData.business_dev_approved_at || 
                (submissionData.workflow_status && 
                 (submissionData.workflow_status.includes('bd_procurement') || 
                  submissionData.workflow_status.includes('general_manager')))) {
              bdHasApproved = true;
            }
          }

          if (bdCommentsProc || bdSigProc || bdHasApproved) {
            hasPrevForProc = true;
            const sec = document.getElementById('bdReadOnlyProc');
            if (sec) {
              sec.style.display = 'block';
              document.getElementById('previousForProcurementSection').style.display = 'block';
            }

            const cDiv = document.getElementById('bdCommentsReadOnlyProc');
            if (cDiv) {
              if (bdCommentsProc) {
                cDiv.textContent = bdCommentsProc;
              } else {
                cDiv.textContent = 'No comments provided';
                cDiv.style.fontStyle = 'italic';
                cDiv.style.color = '#9ca3af';
              }
            }

            const sDiv = document.getElementById('bdSignatureReadOnlyProc');
            if (sDiv) {
              // Clear loading message first
              sDiv.innerHTML = '';
              
              if (bdSigProc) {
                let sigUrl = bdSigProc;
                if (typeof sigUrl === 'object' && sigUrl.url) sigUrl = sigUrl.url;
                
                if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
                  const img = document.createElement('img');
                  img.src = sigUrl;
                  img.style.cssText = 'width: 100%; max-height: 140px; object-fit: contain;';
                  img.alt = 'Business Development Signature';
                  img.onerror = () => {
                    sDiv.innerHTML = '<span style="color: #dc3545;">Failed to load signature</span>';
                  };
                  sDiv.appendChild(img);
                } else {
                  sDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                }
              } else {
                sDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
              }
            }
          }

          if (prevForProc && hasPrevForProc) {
            prevForProc.style.display = 'block';
          }
          {% endif %}
          
          // Load General Manager signature if it exists
          {% if user_designation == 'general_manager' %}
          let gmSignature = null;
          if (formData) {
            if (formData.general_manager_signature) {
              gmSignature = formData.general_manager_signature;
            }
          }
          
          if (!gmSignature && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData && checkFormData.general_manager_signature) {
              gmSignature = checkFormData.general_manager_signature;
            }
          }
          
          if (gmSignature) {
            // Handle object format with url property
            let sigUrl = gmSignature;
            if (typeof sigUrl === 'object' && sigUrl !== null && sigUrl.url) {
              sigUrl = sigUrl.url;
            }
            
            // Load signature into canvas or display as image
            if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
              const gmCanvas = document.getElementById('generalManagerSignaturePad');
              const gmSigInput = document.getElementById('generalManagerSignatureData');
              
              if (gmCanvas && pads && pads.generalManagerPad) {
                try {
                  // For data URLs, try to load into pad
                  if (sigUrl.startsWith('data:image')) {
                    pads.generalManagerPad.fromDataURL(sigUrl);
                    console.log('‚úÖ Loaded GM signature into canvas');
                  } else {
                    // For URL signatures, display as image instead
                    gmCanvas.style.display = 'none';
                    const sigImg = document.createElement('img');
                    sigImg.src = sigUrl;
                    sigImg.alt = 'General Manager Signature';
                    sigImg.style.cssText = 'width: 100%; max-height: 180px; object-fit: contain; border: 2px solid #10b981; border-radius: 8px; background: #f0fdf4; padding: 10px;';
                    gmCanvas.parentElement.insertBefore(sigImg, gmCanvas);
                    
                    // Hide clear button
                    const clearBtn = document.getElementById('clearGeneralManager');
                    if (clearBtn) clearBtn.style.display = 'none';
                    
                    // Update label
                    const gmLabel = gmCanvas.parentElement.querySelector('label');
                    if (gmLabel) {
                      gmLabel.innerHTML = 'GENERAL MANAGER SIGNATURE <span style="color: #10b981; font-weight: bold; font-size: 0.9rem;">‚úì Already Signed</span>';
                    }
                    
                    // Hide hint
                    const hintSpan = gmCanvas.parentElement.querySelector('.signature-hint');
                    if (hintSpan) hintSpan.style.display = 'none';
                    
                    console.log('‚úÖ Loaded GM signature as image');
                  }
                  
                  // Store in hidden input
                  if (gmSigInput) {
                    gmSigInput.value = sigUrl;
                  }
                } catch (e) {
                  console.error('‚ùå Error loading GM signature:', e);
                }
              } else if (gmSigInput) {
                // Fallback: just store in hidden input
                gmSigInput.value = sigUrl;
                console.log('‚úÖ Stored GM signature in hidden input');
              }
            }
          }
          {% endif %}
          
          // Load all previous reviewers' data for General Manager (read-only)
          {% if user_designation == 'general_manager' %}
          const prevSection = document.getElementById('previousReviewersReadOnlySection');
          let hasAnyData = false;
          
          // Operations Manager - comprehensive data loading
          let opsManagerCommentsGM = null;
          let opsManagerSigGM = null;
          
          if (formData) {
            if (formData.operations_manager_comments) opsManagerCommentsGM = formData.operations_manager_comments;
            if (formData.operations_manager_signature) opsManagerSigGM = formData.operations_manager_signature;
            else if (formData.opMan_signature) opsManagerSigGM = formData.opMan_signature;
          }
          
          if ((!opsManagerCommentsGM || !opsManagerSigGM) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!opsManagerCommentsGM && checkFormData.operations_manager_comments) opsManagerCommentsGM = checkFormData.operations_manager_comments;
              if (!opsManagerSigGM) {
                if (checkFormData.operations_manager_signature) opsManagerSigGM = checkFormData.operations_manager_signature;
                else if (checkFormData.opMan_signature) opsManagerSigGM = checkFormData.opMan_signature;
              }
            }
          }
          
          if (opsManagerCommentsGM || opsManagerSigGM) {
            hasAnyData = true;
            const section = document.getElementById('opsManagerReadOnlyGM');
            if (section) {
              section.style.display = 'block';
              
              const commentsDiv = document.getElementById('opsManagerCommentsReadOnlyGM');
              if (commentsDiv) {
                if (opsManagerCommentsGM) commentsDiv.textContent = opsManagerCommentsGM;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              const sigDiv = document.getElementById('opsManagerSignatureReadOnlyGM');
              if (sigDiv) {
                // Clear any existing content first to prevent double signatures
                sigDiv.innerHTML = '';
                
                if (opsManagerSigGM) {
                  let sigUrl = opsManagerSigGM;
                  if (typeof sigUrl === 'object' && sigUrl.url) sigUrl = sigUrl.url;
                  
                  if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
                    const img = document.createElement('img');
                    img.src = sigUrl;
                    img.style.cssText = 'width: 100%; max-height: 140px; object-fit: contain;';
                    img.alt = 'Operations Manager Signature';
                    sigDiv.appendChild(img);
                  } else {
                    sigDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                  }
                } else {
                  sigDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                }
              }
            }
          }
          
          // Business Development - comprehensive data loading
          let bdCommentsGM = null;
          let bdSigGM = null;
          
          if (formData) {
            if (formData.business_dev_comments) bdCommentsGM = formData.business_dev_comments;
            if (formData.business_dev_signature) bdSigGM = formData.business_dev_signature;
          }
          
          if ((!bdCommentsGM || !bdSigGM) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!bdCommentsGM && checkFormData.business_dev_comments) bdCommentsGM = checkFormData.business_dev_comments;
              if (!bdSigGM && checkFormData.business_dev_signature) bdSigGM = checkFormData.business_dev_signature;
            }
          }
          
          if (bdCommentsGM || bdSigGM) {
            hasAnyData = true;
            const section = document.getElementById('bdReadOnlyGM');
            if (section) {
              section.style.display = 'block';
              
              const commentsDiv = document.getElementById('bdCommentsReadOnlyGM');
              if (commentsDiv) {
                if (bdCommentsGM) commentsDiv.textContent = bdCommentsGM;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              const sigDiv = document.getElementById('bdSignatureReadOnlyGM');
              if (sigDiv) {
                // Clear any existing content first to prevent double signatures
                sigDiv.innerHTML = '';
                
                if (bdSigGM) {
                  let sigUrl = bdSigGM;
                  if (typeof sigUrl === 'object' && sigUrl.url) sigUrl = sigUrl.url;
                  
                  if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
                    const img = document.createElement('img');
                    img.src = sigUrl;
                    img.style.cssText = 'width: 100%; max-height: 140px; object-fit: contain;';
                    img.alt = 'Business Development Signature';
                    sigDiv.appendChild(img);
                  } else {
                    sigDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                  }
                } else {
                  sigDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                }
              }
            }
          }
          
          // Procurement - comprehensive data loading
          let procurementCommentsGM = null;
          let procurementSigGM = null;
          
          if (formData) {
            if (formData.procurement_comments) procurementCommentsGM = formData.procurement_comments;
            if (formData.procurement_signature) procurementSigGM = formData.procurement_signature;
          }
          
          if ((!procurementCommentsGM || !procurementSigGM) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!procurementCommentsGM && checkFormData.procurement_comments) procurementCommentsGM = checkFormData.procurement_comments;
              if (!procurementSigGM && checkFormData.procurement_signature) procurementSigGM = checkFormData.procurement_signature;
            }
          }
          
          if (procurementCommentsGM || procurementSigGM) {
            hasAnyData = true;
            const section = document.getElementById('procurementReadOnlyGM');
            if (section) {
              section.style.display = 'block';
              
              const commentsDiv = document.getElementById('procurementCommentsReadOnlyGM');
              if (commentsDiv) {
                if (procurementCommentsGM) commentsDiv.textContent = procurementCommentsGM;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              const sigDiv = document.getElementById('procurementSignatureReadOnlyGM');
              if (sigDiv) {
                // Clear any existing content first to prevent double signatures
                sigDiv.innerHTML = '';
                
                if (procurementSigGM) {
                  let sigUrl = procurementSigGM;
                  if (typeof sigUrl === 'object' && sigUrl.url) sigUrl = sigUrl.url;
                  
                  if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
                    const img = document.createElement('img');
                    img.src = sigUrl;
                    img.style.cssText = 'width: 100%; max-height: 140px; object-fit: contain;';
                    img.alt = 'Procurement Signature';
                    sigDiv.appendChild(img);
                  } else {
                    sigDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                  }
                } else {
                  sigDiv.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
                }
              }
            }
          }
          
          if (hasAnyData && prevSection) {
            prevSection.style.display = 'block';
          }
          
          // Load General Manager comments if editing existing
          let gmComments = formData.general_manager_comments || 
                          (submissionData?.form_data?.general_manager_comments);
          if (gmComments) {
            const commentsField = document.getElementById('generalManagerComments');
            if (commentsField) {
              commentsField.value = gmComments;
              console.log('‚úÖ Loaded GM comments');
            }
          }
          {% endif %}
          
          // Start loading signatures after a delay to ensure pads are initialized
          setTimeout(loadSignatures, 800);
          
          // Store submission ID for update
          window.editSubmissionId = submissionData.submission_id;
          
          console.log('‚úÖ Submission data loaded for editing');
          console.log('‚úÖ Site name:', submissionData.site_name || 'not set');
          console.log('‚úÖ Visit date:', submissionData.visit_date || 'not set');
          console.log('‚úÖ Total items loaded:', items.length);
          if (items.length > 0) {
            console.log('‚úÖ First item:', items[0]);
          }
        } catch (err) {
          console.error('‚ùå Failed to load submission data:', err);
          console.error('Error details:', err.message, err.stack);
          // Don't show alert for parse errors - just log and continue with fallback
          if (err.message && (err.message.includes('parse') || err.message.includes('JSON'))) {
            console.warn('‚ö†Ô∏è Parse error - continuing with fallback data');
            // Try to use window.preloadedSubmissionData as fallback
            if (window.preloadedSubmissionData) {
              console.log('üì¶ Using window.preloadedSubmissionData as fallback');
              try {
                const fallbackData = window.preloadedSubmissionData;
                if (fallbackData && fallbackData.form_data) {
                  // Retry with fallback data
                  setTimeout(() => {
                    if (typeof loadSubmissionData === 'function') {
                      loadSubmissionData();
                    }
                  }, 100);
                }
              } catch (fallbackErr) {
                console.error('‚ùå Fallback also failed:', fallbackErr);
              }
            }
          } else {
            alert('Failed to load submission data. Please check the browser console for details.');
          }
        }
        {% else %}
        console.log('‚ö†Ô∏è loadSubmissionData called but conditions not met');
        console.log('is_edit_mode:', {% if is_edit_mode %}true{% else %}false{% endif %});
        console.log('submission_data:', {% if submission_data %}'provided'{% else %}'not provided'{% endif %});
        {% endif %}
      }
      
      // Function to attempt loading data with retries
      function attemptLoadData() {
        {% if is_edit_mode %}
        console.log('üì• Attempting to load submission data...');
        console.log('  DOM ready state:', document.readyState);
        
        // Check if all required elements exist
        const siteNameField = document.getElementById('site_name');
        const visitDateField = document.getElementById('visit_date');
        const itemsList = document.getElementById('itemsList');
        
        console.log('  site_name field exists:', !!siteNameField);
        console.log('  visit_date field exists:', !!visitDateField);
        console.log('  itemsList exists:', !!itemsList);
        
        if (siteNameField && visitDateField && itemsList) {
          console.log('‚úÖ All required DOM elements found, loading data...');
        loadSubmissionData();
        } else {
          console.warn('‚ö†Ô∏è Some DOM elements not ready yet, retrying in 100ms...');
          setTimeout(attemptLoadData, 100);
        }
        {% else %}
        // Don't auto-load draft on page refresh - always start with a fresh form
        console.log('üìù Initializing new form (not in edit mode)');
        
        // Set default date to today and max date to today (prevent future dates)
        const visitDateField = document.getElementById('visit_date');
        if (visitDateField) {
          const today = new Date();
          const todayStr = today.toISOString().split('T')[0];
          console.log('üìÖ Setting visit date to today:', todayStr);
          visitDateField.setAttribute('max', todayStr);
          if (!visitDateField.value) {
            visitDateField.value = todayStr;
            console.log('‚úÖ Visit date set to:', visitDateField.value);
          } else {
            console.log('‚ö†Ô∏è Visit date already has value:', visitDateField.value);
          }
        } else {
          console.error('‚ùå Visit date field not found!');
          // Retry after a short delay
          setTimeout(() => {
            const retryField = document.getElementById('visit_date');
            if (retryField && !retryField.value) {
              const today = new Date();
              const todayStr = today.toISOString().split('T')[0];
              retryField.setAttribute('max', todayStr);
              retryField.value = todayStr;
              console.log('‚úÖ Visit date set on retry:', retryField.value);
            }
          }, 200);
        }
        // Clear any existing drafts on page load to ensure fresh form
        clearDraft();
        {% endif %}
      }
      
      // Try loading when DOM is ready
      if (document.readyState === 'loading') {
        console.log('üìÑ Document still loading, waiting for DOMContentLoaded...');
        window.addEventListener('DOMContentLoaded', attemptLoadData);
      } else {
        console.log('üìÑ Document already ready, loading immediately...');
        attemptLoadData();
      }
      
      // Also try after a short delay as backup
      setTimeout(() => {
        {% if is_edit_mode %}
        console.log('üì• Backup: Attempting to load submission data after delay...');
        attemptLoadData();
        {% endif %}
      }, 500);

      function onDropdownsReady() { 
        fillAssets(); 
      }
      
      if (typeof DROPDOWN_DATA !== 'undefined' && Object.keys(DROPDOWN_DATA || {}).length > 0) {
        fillAssets();
      } else {
        window.addEventListener('dropdowns:loaded', onDropdownsReady, { once: true });
      }

      // Make renderItems accessible globally
      window.renderItems = renderItems;
      
      // Load preloaded items into items array for submission (server already rendered them)
      {% if is_edit_mode and submission_data %}
      function loadPreloadedItemsIntoArray() {
        console.log('üì¶ Loading preloaded items into JavaScript array for submission...');
        
        if (window.preloadedItems && Array.isArray(window.preloadedItems) && window.preloadedItems.length > 0) {
          // Clear items first
          items.length = 0;
          
          window.preloadedItems.forEach((item, idx) => {
            // Extract photo URLs - handle both photos (objects) and photo_urls (strings)
            let photoUrls = [];
            
            // Try photo_urls first (direct array of URLs)
            if (item.photo_urls && Array.isArray(item.photo_urls)) {
              photoUrls = item.photo_urls.filter(url => url && typeof url === 'string');
            }
            // Try photos array (array of objects with 'url' property) - THIS IS THE EXPECTED FORMAT
            else if (item.photos && Array.isArray(item.photos)) {
              photoUrls = item.photos.map(photo => {
                if (typeof photo === 'string') return photo;
                if (photo && typeof photo === 'object') {
                  return photo.url || photo.cloud_url || null;
                }
                return null;
              }).filter(url => url !== null && typeof url === 'string');
            }
            
            items.push({
              asset: item.asset || '',
              system: item.system || '',
              description: item.description || '',
              quantity: item.quantity || '1',
              brand: item.brand || '',
              specification: item.specification || '',
              comments: item.comments || '',
              photoUrls: photoUrls,
              photoCount: photoUrls.length,
              isServerRendered: true  // Mark as server-rendered
            });
          });
          
          console.log(`‚úÖ Loaded ${items.length} preloaded items into JavaScript array`);
        }
      }
      
      // Load items into array immediately
      loadPreloadedItemsIntoArray();
      
      // Helper functions for cascading dropdowns in edit mode
      function populateSystemDropdown(assetDropdown, systemDropdown, selectedAsset, currentSystem) {
        systemDropdown.innerHTML = '<option value="">Select System</option>';
        const sysObj = (window.DROPDOWN_DATA && window.DROPDOWN_DATA[selectedAsset]) ? window.DROPDOWN_DATA[selectedAsset] : null;
        
        // Check if we're in edit mode
        const card = systemDropdown.closest('.editable-item-card');
        const isEditMode = card && card.dataset.editMode === 'true';
        
        if (sysObj && typeof sysObj === 'object') {
          Object.keys(sysObj).forEach(sk => {
            const option = document.createElement('option');
            option.value = sk;
            option.textContent = sk;
            systemDropdown.appendChild(option);
          });
          // Only enable if in edit mode
          systemDropdown.disabled = !isEditMode;
          
          // Set current value if provided
          if (currentSystem) {
            systemDropdown.value = currentSystem;
            // Get the description dropdown
            const descriptionDropdown = card ? card.querySelector('select[data-field="description"]') : null;
            if (descriptionDropdown) {
              const itemIndex = Number(card.dataset.itemIndex);
              const currentItem = items[itemIndex];
              if (currentItem && currentItem.description) {
                populateDescriptionDropdown(selectedAsset, currentSystem, descriptionDropdown, currentItem.description);
              }
            }
          }
        } else {
          systemDropdown.disabled = true;
        }
      }
      
      function populateDescriptionDropdown(selectedAsset, selectedSystem, descriptionDropdown, currentDescription) {
        descriptionDropdown.innerHTML = '<option value="">Select Description</option>';
        const arr = (window.DROPDOWN_DATA && window.DROPDOWN_DATA[selectedAsset]) ? window.DROPDOWN_DATA[selectedAsset][selectedSystem] || [] : [];
        
        // Check if we're in edit mode
        const card = descriptionDropdown.closest('.editable-item-card');
        const isEditMode = card && card.dataset.editMode === 'true';
        
        arr.forEach(v => {
          const option = document.createElement('option');
          option.value = v;
          option.textContent = v;
          descriptionDropdown.appendChild(option);
        });
        // Only enable if in edit mode
        descriptionDropdown.disabled = !isEditMode;
        
        // Set current value if provided
        if (currentDescription) {
          descriptionDropdown.value = currentDescription;
        }
      }
      
      // Set up editable fields to sync with items array
      function setupEditableItemFields() {
        document.querySelectorAll('.editable-item-card').forEach(card => {
          const itemIndex = Number(card.dataset.itemIndex);
          
          // Get the dropdown elements for this card
          const assetDropdown = card.querySelector('select[data-field="asset"]');
          const systemDropdown = card.querySelector('select[data-field="system"]');
          const descriptionDropdown = card.querySelector('select[data-field="description"]');
          
          // Initialize dropdowns with data
          if (assetDropdown && typeof DROPDOWN_DATA === 'object' && Object.keys(DROPDOWN_DATA).length > 0) {
            // Populate asset dropdown
            Object.keys(DROPDOWN_DATA).forEach(cat => {
              const option = document.createElement('option');
              option.value = cat;
              option.textContent = cat;
              assetDropdown.appendChild(option);
            });
            
            // Get current values from items array
            const currentItem = items[itemIndex];
            if (currentItem) {
              // Set current asset value
              if (currentItem.asset) {
                assetDropdown.value = currentItem.asset;
                // Trigger cascade to populate system
                populateSystemDropdown(assetDropdown, systemDropdown, currentItem.asset, currentItem.system);
              }
            }
            
            // Set up cascade event listeners
            assetDropdown.addEventListener('change', function() {
              const selectedAsset = this.value;
              const card = this.closest('.editable-item-card');
              const isEditMode = card && card.dataset.editMode === 'true';
              
              if (!isEditMode) {
                console.warn('‚ö†Ô∏è Cannot change asset - not in edit mode');
                return;
              }
              
              populateSystemDropdown(this, systemDropdown, selectedAsset);
              // Clear description dropdown
              descriptionDropdown.innerHTML = '<option value="">Select Description</option>';
              descriptionDropdown.disabled = true;
              
              // Update items array
              if (itemIndex >= 0 && itemIndex < items.length) {
                items[itemIndex].asset = selectedAsset;
                items[itemIndex].system = '';
                items[itemIndex].description = '';
                console.log(`‚úÖ Updated item ${itemIndex} asset to: ${selectedAsset}`);
              }
            });
            
            systemDropdown.addEventListener('change', function() {
              const card = this.closest('.editable-item-card');
              const isEditMode = card && card.dataset.editMode === 'true';
              
              if (!isEditMode) {
                console.warn('‚ö†Ô∏è Cannot change system - not in edit mode');
                return;
              }
              
              const selectedAsset = assetDropdown.value;
              const selectedSystem = this.value;
              populateDescriptionDropdown(selectedAsset, selectedSystem, descriptionDropdown);
              
              // Update items array
              if (itemIndex >= 0 && itemIndex < items.length) {
                items[itemIndex].system = selectedSystem;
                items[itemIndex].description = '';
                console.log(`‚úÖ Updated item ${itemIndex} system to: ${selectedSystem}`);
              }
            });
            
            descriptionDropdown.addEventListener('change', function() {
              const card = this.closest('.editable-item-card');
              const isEditMode = card && card.dataset.editMode === 'true';
              
              if (!isEditMode) {
                console.warn('‚ö†Ô∏è Cannot change description - not in edit mode');
                return;
              }
              
              // Update items array
              if (itemIndex >= 0 && itemIndex < items.length) {
                items[itemIndex].description = this.value;
                console.log(`‚úÖ Updated item ${itemIndex} description to: ${this.value}`);
              }
            });
          }
          
          // Sync all other editable fields (non-dropdown)
          card.querySelectorAll('.editable-field:not(.editable-dropdown)').forEach(field => {
            const fieldName = field.dataset.field;
            
            const updateItemArray = function() {
              // ALWAYS look up the current index from the card's dataset
              // this handles cases where items were removed and indices shifted
              const currentItemIndex = Number(card.dataset.itemIndex);
              
              if (currentItemIndex >= 0 && currentItemIndex < items.length) {
                if (fieldName === 'quantity') {
                  items[currentItemIndex][fieldName] = this.value || '1';
                } else {
                  items[currentItemIndex][fieldName] = this.value || '';
                }
                console.log(`‚úÖ Updated item ${currentItemIndex}.${fieldName} to:`, items[currentItemIndex][fieldName]);
              } else {
                console.warn(`‚ö†Ô∏è Could not update item: index ${currentItemIndex} out of bounds (items.length: ${items.length})`);
              }
            };

            // Update items array when field changes
            field.addEventListener('input', updateItemArray);
            
            // Also sync on blur (when field loses focus)
            field.addEventListener('blur', updateItemArray);
          });
          
          // Set up remove button
          const removeBtn = card.querySelector('.remove-server-item');
          if (removeBtn) {
            removeBtn.addEventListener('click', function(e) {
              // ALWAYS look up index from dataset at click time
              const idx = Number(this.dataset.idx);
              if (confirm('Remove this item? (Photos remain in cloud storage)')) {
                // Remove from items array
                if (idx >= 0 && idx < items.length) {
                  items.splice(idx, 1);
                  console.log(`‚úÖ Removed item ${idx} from array, ${items.length} items remaining`);
                }
                // Remove the DOM element
                const cardEl = this.closest('.item-card');
                if (cardEl) {
                  cardEl.remove();
                  console.log('‚úÖ Removed item card from DOM');
                  
                  // Update indices for remaining items
                  updateItemIndices();
                }
              }
            });
          }
          
          // Set up "Add More Photos" button
          const addPhotosBtn = card.querySelector('.add-photos-to-item');
          if (addPhotosBtn) {
            addPhotosBtn.addEventListener('click', function() {
              const idx = Number(this.dataset.itemIndex);
              console.log(`üì∑ Add photos button clicked for item ${idx}`);
              
              // Create file input for photo selection
              const fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.accept = 'image/*';
              fileInput.multiple = true;
              fileInput.style.display = 'none';
              
              fileInput.addEventListener('change', async function() {
                const files = Array.from(this.files);
                if (files.length === 0) return;
                
                // Show loading overlay
                if (typeof loadingOverlay !== 'undefined') {
                  loadingOverlay.style.display = 'flex';
                  const loadingText = document.getElementById('loadingText');
                  if (loadingText) {
                    loadingText.textContent = `Uploading ${files.length} photo(s)...`;
                  }
                }
                
                try {
                  // Get submission ID from window.editSubmissionId or template variable
                  const submissionId = window.editSubmissionId || '{{ submission_data.submission_id if submission_data else '' }}';
                  
                  if (!submissionId) {
                    alert('Cannot add photos: No submission ID found. Please save the form first.');
                    if (typeof loadingOverlay !== 'undefined') loadingOverlay.style.display = 'none';
                    return;
                  }
                  
                  // Upload photos using the same endpoint as new items
                  const uploadedUrls = [];
                  for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const formData = new FormData();
                    formData.append('photo', file, file.name);
                    
                    const uploadUrl = modulePrefix + '/upload-photo';
                    const response = await fetch(uploadUrl, {
                      method: 'POST',
                      body: formData
                    });
                    
                    if (!response.ok) {
                      throw new Error(`Upload failed for ${file.name}`);
                    }
                    
                    const result = await response.json();
                    uploadedUrls.push(result.url);
                    
                    // Update loading text with progress
                    if (typeof loadingOverlay !== 'undefined') {
                      const loadingText = document.getElementById('loadingText');
                      if (loadingText) {
                        loadingText.textContent = `Uploading ${i + 1}/${files.length} photo(s)...`;
                      }
                    }
                  }
                  
                  // Add photos to the existing item via backend
                  const addPhotosUrl = modulePrefix + '/add-photos-to-item';
                  const addResponse = await fetch(addPhotosUrl, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      submission_id: submissionId,
                      item_index: idx,
                      photo_urls: uploadedUrls
                    })
                  });
                  
                  if (!addResponse.ok) {
                    const error = await addResponse.json();
                    throw new Error(error.error || 'Failed to add photos to item');
                  }
                  
                  const result = await addResponse.json();
                  
                  // Update the items array with new photos
                  if (idx >= 0 && idx < items.length) {
                    if (!items[idx].photoUrls) {
                      items[idx].photoUrls = [];
                    }
                    items[idx].photoUrls.push(...uploadedUrls);
                    items[idx].photoCount = items[idx].photoUrls.length;
                    
                    // Update the card display
                    const photoCountSpan = card.querySelector('.photo-count');
                    if (photoCountSpan) {
                      photoCountSpan.textContent = `${items[idx].photoCount} photo(s)`;
                    }
                  }
                  
                  console.log(`‚úÖ Added ${uploadedUrls.length} photos to item ${idx}`);
                  alert(`‚úÖ Successfully added ${uploadedUrls.length} photo(s) to this item!`);
                  
                } catch (error) {
                  console.error('Photo upload error:', error);
                  alert(`‚ùå Failed to add photos: ${error.message}`);
                } finally {
                  // Hide loading overlay
                  if (typeof loadingOverlay !== 'undefined') {
                    loadingOverlay.style.display = 'none';
                  }
                }
              });
              
              // Trigger file input
              fileInput.click();
            });
          }
          
          // Set up "Edit this Asset" toggle button
          const editToggleBtn = card.querySelector('.edit-asset-toggle');
          if (editToggleBtn) {
            editToggleBtn.addEventListener('click', function() {
              const isEditMode = card.dataset.editMode === 'true';
              const newEditMode = !isEditMode;
              
              // Toggle edit mode
              card.dataset.editMode = newEditMode.toString();
              
              // Enable/disable all editable fields including dropdowns
              card.querySelectorAll('.editable-field').forEach(field => {
                field.disabled = !newEditMode;
              });
              
              // Explicitly enable Asset dropdown when entering edit mode
              if (newEditMode && assetDropdown) {
                assetDropdown.disabled = false;
                console.log('‚úÖ Asset dropdown explicitly enabled');
              } else if (!newEditMode && assetDropdown) {
                assetDropdown.disabled = true;
              }
              
              // Update button text and style
              const editText = this.querySelector('.edit-text');
              if (newEditMode) {
                editText.textContent = 'Done Editing';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-success');
                console.log(`‚úèÔ∏è Edit mode ENABLED for item ${card.dataset.itemIndex}`);
              } else {
                editText.textContent = 'Edit this Asset';
                this.classList.remove('btn-success');
                this.classList.add('btn-outline-primary');
                console.log(`üîí Edit mode DISABLED for item ${card.dataset.itemIndex}`);
              }
              
              // Focus Asset dropdown (first field) when enabling edit
              if (newEditMode && assetDropdown) {
                setTimeout(() => assetDropdown.focus(), 100);
              }
            });
          }
        });
      }
      
      // Update item indices after removal
      function updateItemIndices() {
        document.querySelectorAll('.editable-item-card').forEach((card, newIndex) => {
          card.dataset.itemIndex = newIndex;
          const removeBtn = card.querySelector('.remove-server-item');
          if (removeBtn) removeBtn.dataset.idx = newIndex;
          const addPhotosBtn = card.querySelector('.add-photos-to-item');
          if (addPhotosBtn) addPhotosBtn.dataset.itemIndex = newIndex;
        });
      }
      
      // Initialize editable fields when DOM is ready
      function initializeEditableFields() {
        // Wait for dropdown data to be available
        if (typeof DROPDOWN_DATA === 'undefined' || Object.keys(DROPDOWN_DATA || {}).length === 0) {
          console.log('‚è≥ Waiting for dropdown data...');
          setTimeout(initializeEditableFields, 100);
          return;
        }
        
        console.log('‚úÖ Dropdown data available, initializing editable fields...');
        setupEditableItemFields();
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeEditableFields);
      } else {
        setTimeout(initializeEditableFields, 100);
      }
      
      console.log('‚úÖ Server-rendered items initialized');
      {% else %}
      // Not in edit mode - do initial render
      renderItems();
      {% endif %}
      
      // Backup: Ensure items array is populated (server already rendered them visually)
      {% if is_edit_mode and submission_data %}
      setTimeout(function() {
        if (items.length === 0 && window.preloadedItems && window.preloadedItems.length > 0) {
          console.log('üîÑ Backup: Items array is empty, reloading from preloaded...');
          loadPreloadedItemsIntoArray();
        } else {
          console.log(`‚úÖ Items array has ${items.length} items ready for submission`);
        }
      }, 500);
      {% endif %}
      
      // Final check - ensure items array is populated for submission
      {% if is_edit_mode and submission_data %}
      setTimeout(function() {
        const serverRenderedItems = document.getElementById('serverRenderedItems');
        const serverItemCount = serverRenderedItems ? serverRenderedItems.querySelectorAll('.item-card').length : 0;
        console.log(`‚úÖ FINAL CHECK: ${items.length} items in array, ${serverItemCount} items rendered by server`);
        
        // Make sure items array matches what's rendered
        if (items.length === 0 && window.preloadedItems && window.preloadedItems.length > 0) {
          console.log('üîÑ FINAL CHECK: Reloading items into array...');
          loadPreloadedItemsIntoArray();
        }
      }, 1000);
      {% endif %}
    })();
  </script>
</body>
</html>