<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>HVAC & MEP - Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .signature-pad { border:1px solid #ccc; width:100%; height:120px; }
    .item-card { border:1px solid #e0e0e0; padding:12px; border-radius:6px; margin-bottom:10px; }
    .thumb { max-width:120px; max-height:80px; margin-right:6px; margin-bottom:6px; border:1px solid #ddd; padding:2px; }
    .items-list .meta { font-size:0.95rem; color:#333; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h2>HVAC & MEP Form</h2>

    <form id="mainForm" enctype="multipart/form-data" onsubmit="return false;">
      <div class="row g-3">
        <div class="col-md-6 mb-3">
          <label for="site_name" class="form-label">Site name</label>
          <input id="site_name" name="site_name" class="form-control" required>
        </div>

        <div class="col-md-6 mb-3">
          <label for="visit_date" class="form-label">Date</label>
          <input id="visit_date" name="visit_date" type="date" class="form-control" required>
        </div>

        <!-- Single item input area (user fills this then clicks Add Item) -->
        <div class="col-12 mb-2">
          <h5>Add item</h5>
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">Asset</label>
          <select id="curAsset" class="form-select" disabled>
            <option value="">-- Select --</option>
          </select>
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">System</label>
          <select id="curSystem" class="form-select" disabled>
            <option value="">-- Select --</option>
          </select>
        </div>

        <div class="col-md-4 mb-2">
          <label class="form-label">Description</label>
          <select id="curDescription" class="form-select" disabled>
            <option value="">-- Select --</option>
          </select>
        </div>

        <div class="col-12 mb-3">
          <label class="form-label">Photos (for this item)</label>
          <input id="curPhotos" type="file" class="form-control" accept="image/*" multiple>
          <div id="curPreview" class="mt-2"></div>
        </div>

        <div class="col-12 mb-3 d-flex gap-2">
          <button id="addItemBtn" type="button" class="btn btn-success">Add Item</button>
          <button id="clearCurrentBtn" type="button" class="btn btn-outline-secondary">Clear Current</button>
          <button id="clearItemsBtn" type="button" class="btn btn-outline-secondary">Clear All Items</button>
        </div>

        <!-- List of added items (read-only entries) -->
        <div class="col-12 mb-3">
          <h5>Items</h5>
          <div id="itemsList" class="items-list"></div>
        </div>

        <!-- Signatures -->
        <div class="col-12 mb-3">
          <label class="form-label">Technician Signature</label>
          <canvas id="techSignaturePad" class="signature-pad"></canvas>
          <input type="hidden" id="techSignatureData" name="tech_signature">
        </div>

        <div class="col-12 mb-3">
          <label class="form-label">Operation Manager Signature</label>
          <canvas id="opManSignaturePad" class="signature-pad"></canvas>
          <input type="hidden" id="opManSignatureData" name="opMan_signature">
        </div>

        <div class="col-12 d-flex gap-2">
          <button type="button" id="prevButton" class="btn btn-secondary" disabled>Previous</button>
          <button type="button" id="submitAllBtn" class="btn btn-success">Submit All</button>
          <button type="button" id="clearTech" class="btn btn-outline-secondary">Clear Tech Sig</button>
          <button type="button" id="clearOp" class="btn btn-outline-secondary">Clear Op Sig</button>
        </div>

        <div class="col-12">
          <div id="statusBox" class="mt-3"></div>
        </div>
      </div>
    </form>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

  <!-- dropdown initializer only (it will fetch /hvac-mep/dropdowns and dispatch "dropdowns:loaded") -->
  <script src="{{ url_for('static', filename='dropdown_init.js') }}"></script>
  <script src="{{ url_for('static', filename='form.js') }}"></script>

  <script>
    const modulePrefix = "{{ url_for('hvac_mep_bp.index') }}".replace('/form','');

    // Signature pads
    function initSignaturePads() {
      const techCanvas = document.getElementById('techSignaturePad');
      const opCanvas = document.getElementById('opManSignaturePad');
      const techPad = new SignaturePad(techCanvas);
      const opPad = new SignaturePad(opCanvas);

      function resizeCanvas(canvas, pad) {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const width = canvas.offsetWidth * ratio;
        const height = canvas.offsetHeight * ratio;
        canvas.width = width;
        canvas.height = height;
        canvas.getContext('2d').scale(ratio, ratio);
      }
      resizeCanvas(techCanvas, techPad);
      resizeCanvas(opCanvas, opPad);
      window.addEventListener('resize', () => { resizeCanvas(techCanvas, techPad); resizeCanvas(opCanvas, opPad); });

      document.getElementById('clearTech').addEventListener('click', () => { techPad.clear(); document.getElementById('techSignatureData').value=''; });
      document.getElementById('clearOp').addEventListener('click', () => { opPad.clear(); document.getElementById('opManSignatureData').value=''; });

      return { techPad, opPad };
    }

    // Items UX: single entry form that appends to items list
    (function(){
      const curAsset = document.getElementById('curAsset');
      const curSystem = document.getElementById('curSystem');
      const curDescription = document.getElementById('curDescription');
      const curPhotos = document.getElementById('curPhotos');
      const curPreview = document.getElementById('curPreview');
      const addItemBtn = document.getElementById('addItemBtn');
      const clearCurrentBtn = document.getElementById('clearCurrentBtn');
      const clearItemsBtn = document.getElementById('clearItemsBtn');
      const itemsList = document.getElementById('itemsList');
      const submitAllBtn = document.getElementById('submitAllBtn');
      const statusBox = document.getElementById('statusBox');
      const pads = initSignaturePads();

      let items = []; // array of {asset, system, description, files: [File], previews: [objectURL]}

      // Utility: clear select and set placeholder
      function clearSelect(el, placeholder='-- Select --') {
        el.innerHTML = `<option value="">${placeholder}</option>`;
        el.disabled = true;
      }

      // Fill top-level asset select from DROPDOWN_DATA
      function fillAssets() {
        clearSelect(curAsset);
        if (typeof DROPDOWN_DATA === 'object' && Object.keys(DROPDOWN_DATA).length>0) {
          Object.keys(DROPDOWN_DATA).forEach(cat=>{
            const o = document.createElement('option');
            o.value = cat;
            o.textContent = cat;
            curAsset.appendChild(o);
          });
          curAsset.disabled = false;
        } else {
          curAsset.disabled = true;
        }
        // reset dependent selects
        clearSelect(curSystem);
        clearSelect(curDescription);
      }

      // populate systems for selected asset
      curAsset.addEventListener('change', () => {
        curSystem.innerHTML = '<option value="">-- Select --</option>';
        curDescription.innerHTML = '<option value="">-- Select --</option>';
        const cat = curAsset.value;
        if (!cat) { curSystem.disabled=true; curDescription.disabled=true; return; }
        const sysObj = (window.DROPDOWN_DATA && window.DROPDOWN_DATA[cat]) ? window.DROPDOWN_DATA[cat] : null;
        if (sysObj && typeof sysObj === 'object') {
          Object.keys(sysObj).forEach(sk=>{
            const o = document.createElement('option');
            o.value = sk;
            o.textContent = sk;
            curSystem.appendChild(o);
          });
          curSystem.disabled = false;
          curDescription.disabled = true;
        } else {
          curSystem.disabled = true;
          curDescription.disabled = true;
        }
      });

      // populate descriptions for selected system
      curSystem.addEventListener('change', () => {
        curDescription.innerHTML = '<option value="">-- Select --</option>';
        const cat = curAsset.value;
        const sk = curSystem.value;
        if (!cat || !sk) { curDescription.disabled=true; return; }
        const arr = (window.DROPDOWN_DATA && window.DROPDOWN_DATA[cat]) ? window.DROPDOWN_DATA[cat][sk] || [] : [];
        arr.forEach(v=>{
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          curDescription.appendChild(o);
        });
        curDescription.disabled = false;
      });

      // preview current photos
      curPhotos.addEventListener('change', () => {
        curPreview.innerHTML = '';
        const files = Array.from(curPhotos.files || []);
        files.forEach(f=>{
          const img = document.createElement('img');
          img.className = 'thumb';
          img.src = URL.createObjectURL(f);
          curPreview.appendChild(img);
        });
      });

      // add current entry to items list
      addItemBtn.addEventListener('click', () => {
        const asset = curAsset.value || '';
        const system = curSystem.value || '';
        const description = curDescription.value || '';
        if (!asset || !system || !description) {
          alert('Please select Asset, System and Description before adding.');
          return;
        }
        const files = Array.from(curPhotos.files || []);
        const previews = files.map(f => URL.createObjectURL(f));

        items.push({ asset, system, description, files, previews });
        renderItems();
        resetCurrent();
      });

      // clear only current form inputs
      clearCurrentBtn.addEventListener('click', resetCurrent);

      // clear whole items array
      clearItemsBtn.addEventListener('click', () => {
        // revoke previews
        items.forEach(it => (it.previews||[]).forEach(u=>URL.revokeObjectURL(u)));
        items = [];
        renderItems();
      });

      function resetCurrent() {
        curAsset.value = '';
        curSystem.innerHTML = '<option value="">-- Select --</option>';
        curSystem.disabled = true;
        curDescription.innerHTML = '<option value="">-- Select --</option>';
        curDescription.disabled = true;
        curPhotos.value = '';
        curPreview.innerHTML = '';
      }

      function renderItems() {
        itemsList.innerHTML = '';
        if (items.length === 0) {
          itemsList.innerHTML = '<div class="text-muted">No items added yet</div>';
          return;
        }
        items.forEach((it, idx) => {
          const card = document.createElement('div');
          card.className = 'item-card';
          card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="meta"><strong>Asset:</strong> ${escapeHtml(it.asset)} &nbsp; <strong>System:</strong> ${escapeHtml(it.system)} &nbsp; <strong>Description:</strong> ${escapeHtml(it.description)}</div>
                <div class="mt-2 thumbs-row"></div>
              </div>
              <div>
                <button data-idx="${idx}" class="btn btn-sm btn-danger remove-item">Remove</button>
              </div>
            </div>
          `;
          const thumbsRow = card.querySelector('.thumbs-row');
          (it.previews||[]).forEach(url => {
            const img = document.createElement('img');
            img.className = 'thumb';
            img.src = url;
            thumbsRow.appendChild(img);
          });
          // remove handler
          card.querySelector('.remove-item').addEventListener('click', (e) => {
            const i = Number(e.currentTarget.dataset.idx);
            removeItem(i);
          });
          itemsList.appendChild(card);
        });
      }

      function removeItem(index) {
        if (index<0 || index>=items.length) return;
        // revoke object URLs
        (items[index].previews||[]).forEach(u=>URL.revokeObjectURL(u));
        items.splice(index,1);
        renderItems();
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
      }

      // submit all: build FormData with items and per-item photos
      async function submitAll() {
        // capture signatures
        const techData = pads.techPad.isEmpty() ? '' : pads.techPad.toDataURL('image/png');
        const opData = pads.opPad.isEmpty() ? '' : pads.opPad.toDataURL('image/png');
        document.getElementById('techSignatureData').value = techData;
        document.getElementById('opManSignatureData').value = opData;

        if (items.length === 0) {
          if (!confirm('No items added. Submit empty form?')) return;
        }

        statusBox.innerText = 'Preparing submission...';
        const fd = new FormData();
        fd.append('site_name', document.getElementById('site_name').value || '');
        fd.append('visit_date', document.getElementById('visit_date').value || '');
        fd.append('tech_signature', techData || '');
        fd.append('opMan_signature', opData || '');

        fd.append('items_count', items.length.toString());
        items.forEach((it, idx) => {
          fd.append(`item_${idx}_asset`, it.asset);
          fd.append(`item_${idx}_system`, it.system);
          fd.append(`item_${idx}_description`, it.description);
          (it.files||[]).forEach(f => {
            fd.append(`item_${idx}_photo`, f, f.name);
          });
        });

        // send
        try {
          statusBox.innerText = 'Uploading...';
          const submitUrl = modulePrefix + '/submit';
          const res = await fetch(submitUrl, { method:'POST', body: fd });
          if (!res.ok) {
            const txt = await res.text();
            throw new Error('Server error: ' + res.status + ' ' + txt);
          }
          const json = await res.json();
          statusBox.innerText = `Submission queued: ${json.job_id || json.submission_id || ''}`;
          // Optionally clear items on success:
          // clearItemsBtn.click();
        } catch (err) {
          statusBox.innerText = 'Submission failed: ' + err.message;
        }
      }

      submitAllBtn.addEventListener('click', submitAll);

      // Wait for DROPDOWN_DATA to be available, then fill assets. Dropdown initializer dispatches 'dropdowns:loaded'
      function onDropdownsReady() {
        fillAssets();
      }
      if (typeof DROPDOWN_DATA !== 'undefined' && Object.keys(DROPDOWN_DATA||{}).length>0) {
        fillAssets();
      } else {
        window.addEventListener('dropdowns:loaded', onDropdownsReady, { once: true });
      }

      // initial UI state
      renderItems();

    })();
  </script>
</body>
</html>