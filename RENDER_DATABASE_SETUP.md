# ğŸ—„ï¸ Render Database Setup Guide

**Date:** 2026-01-06  
**Status:** Updated for Flask-Migrate

---

## âœ… **Your Render Database is Sufficient**

Your Render PostgreSQL database (`dpg-d559u86r433s73dg39p0-a`) is perfect for production. The app is already configured to work with it.

---

## ğŸ”§ **Setup Steps**

### **Step 1: Verify Environment Variables**

In your Render dashboard, ensure these environment variables are set:

1. **DATABASE_URL** - âœ… Automatically set by Render (from database connection)
2. **SECRET_KEY** - âœ… Auto-generated by Render (or set manually)
3. **JWT_SECRET_KEY** - âœ… Auto-generated by Render (or set manually)
4. **CLOUDINARY_CLOUD_NAME** - Set manually
5. **CLOUDINARY_API_KEY** - Set manually
6. **CLOUDINARY_API_SECRET** - Set manually
7. **FLASK_ENV** - Set to `production`
8. **DEFAULT_ADMIN_PASSWORD** (Optional) - Set a secure password for default admin

### **Step 2: Database Schema Setup**

With the recent changes, you have **two options**:

#### **Option A: Automatic Setup (Recommended for First Time)**

The app will automatically create all tables on first startup using `db.create_all()`. However, the permission columns (`password_changed`, `access_hvac`, `access_civil`, `access_cleaning`) won't be added automatically anymore.

**After first deployment, run the migration script:**

1. Go to your Render web service dashboard
2. Open the **Shell** tab (or use Render's SSH feature)
3. Run:
   ```bash
   python scripts/create_migration_add_user_columns.py
   ```

This will add the missing columns to your users table.

#### **Option B: Use Flask-Migrate (Recommended for Future)**

For proper version-controlled migrations:

1. **Initialize migrations** (one-time):
   ```bash
   flask db init
   ```

2. **Create initial migration**:
   ```bash
   flask db migrate -m "Initial migration"
   ```

3. **Apply migrations**:
   ```bash
   flask db upgrade
   ```

**Note:** On Render, you can run these commands via:
- Render Shell (SSH into your service)
- Or add them to your build script

---

## ğŸ“‹ **Quick Setup Checklist**

### **Before First Deployment:**

- [x] Render PostgreSQL database created
- [ ] Environment variables set in Render dashboard
- [ ] Cloudinary credentials configured
- [ ] `DEFAULT_ADMIN_PASSWORD` set (optional but recommended)

### **After First Deployment:**

- [ ] Check application logs for default admin password (if not set via env var)
- [ ] Run migration script to add user permission columns
- [ ] Log in with admin credentials
- [ ] Change default password immediately
- [ ] Verify all features work

---

## ğŸ” **How to Run Migration Script on Render**

### **Method 1: Using Render Shell**

1. Go to your Render dashboard
2. Select your web service
3. Click on **Shell** tab (or use SSH)
4. Run:
   ```bash
   cd /opt/render/project/src  # or your app directory
   python scripts/create_migration_add_user_columns.py
   ```

### **Method 2: Using Render CLI**

```bash
render shell --service injaaz-app
python scripts/create_migration_add_user_columns.py
```

### **Method 3: Add to Build Script (One-Time)**

You can temporarily add it to `build.sh`:

```bash
#!/bin/bash
# ... existing build commands ...
python scripts/create_migration_add_user_columns.py
```

**âš ï¸ Remove it after first run** to avoid running on every deployment.

---

## ğŸš€ **What Happens on First Startup**

1. **Database Connection:**
   - App connects to Render PostgreSQL using `DATABASE_URL`
   - Connection string automatically converted from `postgres://` to `postgresql://`

2. **Table Creation:**
   - `db.create_all()` creates all base tables:
     - `users`
     - `submissions`
     - `jobs`
     - `files`
     - `audit_logs`
     - `sessions`

3. **Default Admin Creation:**
   - Creates admin user if it doesn't exist
   - Uses `DEFAULT_ADMIN_PASSWORD` env var or generates random password
   - Logs password at CRITICAL level (check logs!)

4. **Missing Columns:**
   - Permission columns need to be added via migration script
   - This is a one-time operation

---

## ğŸ” **Security Notes**

1. **Default Admin Password:**
   - If `DEFAULT_ADMIN_PASSWORD` is not set, a random password is generated
   - Check Render logs (CRITICAL level) to find it
   - **Change it immediately after first login!**

2. **Database Security:**
   - Render automatically secures your database
   - Connection string is encrypted
   - Only your web service can access it

---

## ğŸ“Š **Verifying Setup**

After deployment, check:

1. **Application Logs:**
   ```
   âœ… All database tables verified/created
   âœ… Database tables verified. Use 'flask db upgrade' to apply migrations.
   âœ… Default admin user created
   ```

2. **Database Connection:**
   - App should start without database errors
   - No connection timeout errors

3. **Admin Access:**
   - Can log in with admin credentials
   - Admin dashboard loads correctly
   - Can see users and documents

---

## ğŸ†˜ **Troubleshooting**

### **Issue: "DATABASE_URL environment variable is required"**

**Solution:** 
- Check Render dashboard â†’ Environment variables
- Ensure `DATABASE_URL` is set (should be automatic from database)

### **Issue: "Column already exists" errors**

**Solution:**
- This means columns were already added
- Safe to ignore, or skip the migration script

### **Issue: "Permission denied" on migration script**

**Solution:**
- Ensure you're running from the correct directory
- Check file permissions
- Try: `chmod +x scripts/create_migration_add_user_columns.py`

### **Issue: Can't find default admin password**

**Solution:**
- Check Render logs (filter by CRITICAL level)
- Or set `DEFAULT_ADMIN_PASSWORD` env var before deployment
- Password is logged as: `âš ï¸ CRITICAL: Default admin password is: <password>`

---

## ğŸ“ **Next Steps After Setup**

1. âœ… Run migration script to add permission columns
2. âœ… Log in with admin credentials
3. âœ… Change default password via `/api/auth/change-password`
4. âœ… Create additional users as needed
5. âœ… Test all modules (HVAC, Civil, Cleaning)

---

## ğŸ”— **Useful Links**

- [Render Dashboard](https://dashboard.render.com)
- [Render PostgreSQL Docs](https://render.com/docs/databases)
- [Flask-Migrate Docs](https://flask-migrate.readthedocs.io/)

---

**Your Render database is ready! Just run the migration script after first deployment.**

