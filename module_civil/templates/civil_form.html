<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Civil Works - Site Assessment Form</title>
  <meta name="description" content="Civil works site assessment form - Works offline">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#125435">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Injaaz Civil">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
  <script src="{{ url_for('static', filename='pwa-install.js') }}" defer></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='mobile_responsive.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='photo_upload_queue.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="{{ url_for('static', filename='photo_upload_queue.js') }}"></script>
  <script src="{{ url_for('static', filename='photo_queue_ui.js') }}"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #125435;
      --primary-light: #1a7a4d;
      --primary-dark: #0d3d24;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-light: #9ca3af;
      --border-light: #e5e7eb;
      --bg-page: #fafafa;
      --white: #ffffff;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    body {
      background: var(--bg-page);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 0;
      margin: 0;
      line-height: 1.5;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Clean Navigation Bar */
    .navbar {
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 0.875rem 0;
      margin-bottom: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(18, 84, 53, 0.1);
    }
    
    .navbar-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: nowrap;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary) !important;
      text-decoration: none;
      letter-spacing: -0.5px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .navbar-brand img {
      height: 32px;
      width: auto;
    }
    
    .navbar-brand:hover {
      transform: translateY(-1px);
      opacity: 0.85;
    }
    
    .module-badge {
      font-size: 0.875rem;
      font-weight: 600;
      color: #6c757d;
      padding: 0.5rem 1rem;
      background: #f8f9fa;
      border-radius: 6px;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }
    
    .navbar-nav {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-left: auto;
      flex-wrap: nowrap;
    }
    
    .nav-btn {
      display: inline-flex;
      flex-shrink: 0;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #495057;
      background: #ffffff;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      white-space: nowrap;
      min-width: fit-content;
    }
    
    .nav-btn:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .nav-btn.prev-btn {
      color: #6c757d;
      border-color: #ced4da;
    }
    
    .nav-btn.prev-btn:hover {
      background: #6c757d;
      color: white;
      border-color: #6c757d;
    }
    
    .nav-btn.next-btn {
      color: #0d6efd;
      border-color: #0d6efd;
    }
    
    .nav-btn.next-btn:hover {
      background: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    
    @media (max-width: 768px) {
      .navbar-container {
        padding: 0.75rem 1rem;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      
      .navbar-brand {
        font-size: 1.1rem;
        flex: 0 0 auto;
      }
      
      .navbar-brand img {
        height: 28px;
      }
      
      .navbar-brand span {
        font-size: 1rem;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .module-badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
        flex: 0 0 auto;
      }
      
      .navbar-nav {
        width: 100%;
        justify-content: space-between;
        margin-left: 0;
        margin-top: 0.5rem;
        gap: 0.5rem;
        flex-wrap: nowrap;
      }
      
      .nav-btn {
        flex: 1;
        justify-content: center;
        font-size: 0.8125rem;
        padding: 0.625rem 0.75rem;
        min-height: 44px;
      }
      
      .container {
        padding: 1.25rem 1rem;
        margin: 0.75rem auto;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      .row.g-3 > [class*="col-"] {
        margin-bottom: 1rem;
      }
      
      #uploadImagesBtn,
      #submitBtn {
        width: 100%;
        margin-bottom: 0.75rem;
      }
    }
    
    @media (max-width: 480px) {
      .navbar-brand span {
        font-size: 0.9rem;
        max-width: 140px;
      }
      
      .nav-btn {
        font-size: 0.75rem;
        padding: 0.5rem;
      }
      
      .container {
        padding: 1rem 0.75rem;
      }
      
      h2 {
        font-size: 1.35rem;
      }
    }
    
    /* Clean, spacious container */
    .container {
      max-width: 1200px;
      background: var(--white);
      border-radius: 8px;
      padding: 2rem 2.5rem;
      box-shadow: var(--shadow-sm);
      margin: 1.5rem auto;
      border: 1px solid var(--border-light);
    }
    
    /* Minimal typography */
    h2 {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 0.375rem;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }
    
    h5 {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 1rem;
      margin-top: 2rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-light);
      letter-spacing: -0.2px;
    }
    
    .text-muted {
      color: var(--text-secondary) !important;
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    /* Minimal form labels */
    .form-label, label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.875rem;
      margin-bottom: 0.375rem;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.75rem;
    }
    
    /* Clean inputs with subtle borders */
    .form-control, .form-select, textarea {
      border: 1px solid var(--border-light);
      border-radius: 4px;
      padding: 0.625rem 0.875rem;
      transition: all 0.15s ease;
      font-size: 0.9375rem;
      background: var(--white);
      color: var(--text-primary);
    }
    
    .form-control:focus, .form-select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 84, 53, 0.06);
      outline: none;
    }
    
    /* Minimal flat buttons */
    .btn {
      border-radius: 4px;
      padding: 0.625rem 1.25rem;
      font-weight: 600;
      border: none;
      transition: all 0.15s ease;
      font-size: 0.875rem;
      letter-spacing: 0.2px;
    }
    
    .btn-primary, .btn-success {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover, .btn-success:hover {
      background: var(--primary-dark);
      box-shadow: 0 2px 8px rgba(18, 84, 53, 0.2);
    }
    
    .btn-outline-secondary {
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      background: transparent;
    }
    
    .btn-outline-secondary:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
      background: #fafafa;
    }
    
    /* Signature pad - Standardized size */
    canvas.signature-pad,
    #techSignaturePad,
    #opManSignaturePad {
      border: 2px solid var(--border-light);
      border-radius: 6px;
      width: 100%;
      max-width: 500px;
      height: 180px;
      min-height: 180px;
      background: #ffffff;
      cursor: crosshair;
      display: block;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Ensure canvas doesn't stretch */
    canvas.signature-pad,
    #techSignaturePad,
    #opManSignaturePad {
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    
    .signature-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .signature-hint {
      font-size: 0.75rem;
      color: var(--text-light);
      font-weight: 400;
    }
    
    .alert {
      border-radius: 4px;
      border: none;
      font-size: 0.875rem;
      padding: 0.875rem 1rem;
    }
    
    #statusBox {
      padding: 1rem;
      border-radius: 4px;
      background: var(--bg-page);
      border: 1px solid var(--border-light);
      margin-top: 1rem;
    }
    
    /* Upload Progress Modal */
    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .upload-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .upload-progress-bar {
      height: 30px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .upload-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #125435, #1a7a4f);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    /* Photo Preview Container */
    .photo-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 1rem;
      padding: 0.5rem;
      border: 1px dashed var(--border-light);
      border-radius: 4px;
      min-height: 60px;
    }
    
    .photo-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 4px;
      overflow: hidden;
      border: 2px solid var(--border-light);
    }
    
    .photo-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-preview-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #dc3545;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .photo-preview-remove:hover {
      background: #c82333;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #e9ecef;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 1.5rem;
      font-size: 1.125rem;
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .loading-subtitle {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    /* Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border-light);
      border-radius: 4px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: var(--primary);
      background: #f8faf9;
    }
    
    .drop-zone-content {
      color: var(--text-secondary);
      font-size: 0.9375rem;
    }
    
    .drop-zone-content strong {
      display: block;
      color: var(--text-primary);
      margin-bottom: 0.375rem;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .drop-zone-content small {
      display: block;
      font-size: 0.8125rem;
      margin-top: 0.375rem;
      color: var(--text-light);
    }
    
    .photo-count {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      background: #e9ecef;
      border-radius: 4px;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }
    
    .photo-count.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .photo-count.danger {
      background: #f8d7da;
      color: #721c24;
    }
    
    .file-warning {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }
    
    .upload-progress {
      margin-top: 0.875rem;
      display: none;
    }
    
    /* Work Items Table */
    .table {
      font-size: 0.875rem;
    }
    
    .table th {
      background: #f8faf9;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-light);
    }
    
    .table td {
      vertical-align: middle;
    }
    
    .form-control-sm {
      font-size: 0.8125rem;
      padding: 0.375rem 0.5rem;
    }
    
    /* Button states */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
      border-width: 0.15em;
    }
    
    .gap-2 {
      gap: 0.5rem;
    }
    
    .d-flex {
      display: flex;
    }
    
    .d-none {
      display: none !important;
    }
    
    .ms-2 {
      margin-left: 0.5rem;
    }
    
    .mb-3 {
      margin-bottom: 1rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1.5rem 1.25rem;
        margin: 1rem;
        border-radius: 6px;
      }
      
      .navbar-container {
        padding: 0 1.25rem;
      }
      
      .d-flex {
        flex-direction: column;
      }
      
      .gap-2 > * {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-container">
      <a class="navbar-brand" href="/dashboard">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Injaaz">
        <span>Injaaz</span>
      </a>
      <div class="module-badge">Civil Works</div>
      <div class="navbar-nav">
        <a href="/hvac-mep/form" class="nav-btn prev-btn">‚Üê Previous</a>
        <a href="/cleaning/form" class="nav-btn next-btn">Next ‚Üí</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h2>Site Inspection Report - Civil</h2>
    <p class="text-muted">Complete the inspection form below</p>

    <form id="mainForm">
      <h5>Project Information</h5>
      <div class="row g-3">
        <div class="col-md-6 mb-3">
          <label for="date">Date</label>
          <input id="date" name="date" type="date" class="form-control" required>
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="project_name">Project Name</label>
          <input id="project_name" name="project_name" class="form-control" required>
        </div>
        
        <div class="col-12 mb-3">
          <label for="description_of_work">Description of Work</label>
          <textarea id="description_of_work" name="description_of_work" class="form-control" rows="2"></textarea>
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="location_name">Location Name</label>
          <input id="location_name" name="location_name" class="form-control">
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="floor">Floor</label>
          <input id="floor" name="floor" class="form-control">
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="developer_client">Developer/Client</label>
          <input id="developer_client" name="developer_client" class="form-control">
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="city_area">City/Area</label>
          <input id="city_area" name="city_area" class="form-control">
        </div>
      </div>

      <h5>Work Items</h5>
      <div class="mb-3">
        <button type="button" id="addRowBtn" class="btn btn-outline-secondary btn-sm">+ Add Work Item</button>
      </div>
      
      <div class="table-responsive mb-4">
        <table class="table table-bordered" id="workItemsTable">
          <thead>
            <tr>
              <th style="width: 40px;">SN</th>
              <th style="width: 200px;">Work Description</th>
              <th style="width: 80px;">Quantity</th>
              <th style="width: 180px;">Material Required with Brand</th>
              <th style="width: 80px;">Quantity</th>
              <th style="width: 80px;">Price</th>
              <th style="width: 150px;">Labour Needed (Hours/Day)</th>
              <th style="width: 60px;">Action</th>
            </tr>
          </thead>
          <tbody id="workItemsBody">
            <tr>
              <td>1</td>
              <td><input type="text" class="form-control form-control-sm" name="work_desc[]"></td>
              <td><input type="number" class="form-control form-control-sm" name="work_qty[]"></td>
              <td><input type="text" class="form-control form-control-sm" name="material[]"></td>
              <td><input type="number" class="form-control form-control-sm" name="material_qty[]"></td>
              <td><input type="number" class="form-control form-control-sm" name="price[]" step="0.01"></td>
              <td><input type="text" class="form-control form-control-sm" name="labour[]"></td>
              <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">√ó</button></td>
            </tr>
          </tbody>
        </table>
      </div>

      <h5>Pictures from Site</h5>
      
      <!-- Photos - Matching HVAC structure exactly -->
      <div class="col-12 mb-3">
        <label class="form-label">Photos (Maximum 100)</label>
        <input id="curPhotos" type="file" class="form-control d-none" accept="image/*" multiple>
        
        <div id="dropZone" class="drop-zone">
          <div class="drop-zone-content">
            <strong>Drag and drop images here</strong>
            <small>or click to browse ‚Ä¢ Maximum 100 images ‚Ä¢ Auto-compressed to 1280px ‚Ä¢ Max 10MB per file</small>
          </div>
        </div>
        
        <div id="fileWarning" class="file-warning">
          ‚ö†Ô∏è Some files are larger than 10MB and will be skipped
        </div>
        
        <div id="uploadProgress" class="upload-progress">
          <div class="progress">
            <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 0%"></div>
          </div>
        </div>
        
        <div id="photoCount" class="photo-count alert alert-info" style="display:none; padding: 0.5rem 1rem; margin-top: 0.5rem; border-radius: 4px; font-weight: 600; background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460;"></div>
        
        <!-- Photo Preview Container with Remove Buttons -->
        <div id="photoPreviewContainer" class="photo-preview-container" style="display:none; min-height: 140px;"></div>
      </div>
      
      <div class="mb-3">
        <label for="estimated_time">Project Estimated Time to Finish</label>
        <input id="estimated_time" name="estimated_time" class="form-control" placeholder="e.g., 2 weeks, 10 days">
      </div>

      <h5>Inspector & Manager Sign-off</h5>
      
      <div class="row g-3 mb-4">
        <div class="col-md-6 mb-3">
          <label for="inspector_name">Name of Inspector</label>
          <input id="inspector_name" name="inspector_name" class="form-control" placeholder="Inspector name">
        </div>
        <div class="col-md-6"></div>
      </div>

      <div class="row g-3">
        <div class="col-md-6 mb-3">
          <div class="signature-label">
            <label class="mb-0">Inspector Signature</label>
            <span class="signature-hint">Draw signature with mouse/touch</span>
          </div>
          <canvas id="techSignaturePad" class="signature-pad"></canvas>
          <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="pads.techPad.clear()">Clear</button>
        </div>

        <div class="col-md-6 mb-3">
          <div class="signature-label">
            <label class="mb-0">Manager Approval Signature</label>
            <span class="signature-hint">Draw signature with mouse/touch</span>
          </div>
          <canvas id="opManSignaturePad" class="signature-pad"></canvas>
          <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="pads.opPad.clear()">Clear</button>
        </div>
      </div>

      <div class="d-flex gap-2 mb-3">
        <button type="button" id="uploadImagesBtn" class="btn btn-success btn-lg">
          <span id="uploadImagesBtnText">üì§ Upload Images</span>
          <span id="uploadImagesBtnSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
        </button>
        <button type="button" id="submitBtn" class="btn btn-primary btn-lg" disabled>
          <span id="submitBtnText">üìÑ Generate Reports</span>
        </button>
      </div>
      <div id="uploadStatus" class="alert alert-info d-none mb-3"></div>
      <div id="statusBox" class="mt-3"></div>
    </form>
  </div>

  <!-- Upload Progress Modal -->
  <div id="uploadModal" class="upload-modal">
    <div class="upload-modal-content">
      <h4 style="margin-bottom: 1rem;">Uploading Photos</h4>
      <div id="uploadModalText" style="margin-bottom: 1rem; color: #666;">
        Preparing images...
      </div>
      <div class="upload-progress-bar">
        <div id="uploadModalProgress" class="upload-progress-fill" style="width: 0%">
          0%
        </div>
      </div>
      <small style="color: #999; display: block; margin-top: 0.5rem;">Please wait, this may take a few minutes for large batches</small>
    </div>
  </div>

  <!-- Loading Overlay for Report Generation -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Generating Reports...</div>
    <div class="loading-subtitle">This typically takes 2-3 minutes for large submissions</div>
    <div class="loading-subtitle" style="margin-top: 1.5rem; font-size: 0.8rem;">Creating Excel and PDF reports with all photos</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="{{ url_for('static', filename='dropdown_init.js') }}"></script>
  <script src="{{ url_for('static', filename='form.js') }}"></script>
  
  <script>
    // ALWAYS define pollJobStatus globally to ensure it's available
    // This will override form.js if it loaded, or serve as fallback if it didn't
    window.pollJobStatus = window.pollJobStatus || async function(modulePrefix, jobId, onUpdate, interval=1500) {
      const statusUrl = `${modulePrefix}/status/${jobId}`;
      return new Promise((resolve, reject) => {
        const id = setInterval(async () => {
          try {
            const r = await fetch(statusUrl);
            if (!r.ok) throw new Error('Job not found');
            const js = await r.json();
            if (onUpdate) onUpdate(js);
            // Check both 'state' (legacy) and 'status' (current)
            const isDone = js.state === 'done' || js.status === 'completed';
            const isFailed = js.state === 'failed' || js.status === 'failed';
            if (isDone || isFailed) {
              clearInterval(id);
              resolve(js);
            }
          } catch (e) {
            clearInterval(id);
            reject(e);
          }
        }, interval);
      });
    };
    
    // Also define it without window prefix for compatibility
    if (typeof pollJobStatus === 'undefined') {
      var pollJobStatus = window.pollJobStatus;
    }
    
    console.log('‚úÖ pollJobStatus is now available globally');
  </script>

  <script>
    const modulePrefix = "{{ url_for('civil_bp.index') }}".replace('/form','');
    const MAX_PHOTOS = 100;
    const MAX_IMAGE_DIMENSION = 1280;
    const JPEG_QUALITY = 0.85;
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    const DRAFT_SAVE_INTERVAL = 30000; // 30 seconds

    // Define initSignaturePads if not already defined in form.js
    function initSignaturePads() {
      const techPadEl = document.getElementById('techSignaturePad');
      const opPadEl = document.getElementById('opManSignaturePad');
      
      function setupSignaturePad(canvas, padName) {
        if (!canvas) return null;
        
        const pad = new SignaturePad(canvas, {
          backgroundColor: 'rgb(255, 255, 255)',
          penColor: 'rgb(0, 0, 0)',
          minWidth: 1,
          maxWidth: 3,
          throttle: 16
        });
        
        // Properly resize canvas to prevent stretching
        function resizeCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const rect = canvas.getBoundingClientRect();
          
          // Set display size
          canvas.style.width = rect.width + 'px';
          canvas.style.height = rect.height + 'px';
          
          // Set actual size in memory (scaled for DPI)
          canvas.width = rect.width * ratio;
          canvas.height = rect.height * ratio;
          
          // Scale the drawing context so everything draws at correct size
          const ctx = canvas.getContext('2d');
          ctx.scale(ratio, ratio);
          
          // Redraw signature if it exists
          if (!pad.isEmpty()) {
            const data = pad.toData();
            pad.clear();
            pad.fromData(data);
          }
        }
        
        // Initial resize
        resizeCanvas();
        
        // Resize on window resize
        window.addEventListener('resize', resizeCanvas);
        
        return pad;
      }
      
      const techPad = setupSignaturePad(techPadEl, 'tech');
      const opPad = setupSignaturePad(opPadEl, 'op');
      
      if (techPad) {
        document.getElementById('clearTech')?.addEventListener('click', () => techPad.clear());
      }
      if (opPad) {
        document.getElementById('clearOp')?.addEventListener('click', () => opPad.clear());
      }

      return { techPad, opPad, tech: techPad, op: opPad };
    }
    
    // Define checkBrowserSupport function
    function checkBrowserSupport() {
      return !!(window.FileReader && window.File && window.FileList && window.Blob);
    }

    (function(){
      // Ensure pollJobStatus is available inside this IIFE
      // Use window.pollJobStatus if available, otherwise define it inline
      const pollJobStatusFn = (typeof window !== 'undefined' && window.pollJobStatus) 
        ? window.pollJobStatus 
        : async function(modulePrefix, jobId, onUpdate, interval=1500) {
            const statusUrl = `${modulePrefix}/status/${jobId}`;
            return new Promise((resolve, reject) => {
              const id = setInterval(async () => {
                try {
                  const r = await fetch(statusUrl);
                  if (!r.ok) throw new Error('Job not found');
                  const js = await r.json();
                  if (onUpdate) onUpdate(js);
                  const isDone = js.state === 'done' || js.status === 'completed';
                  const isFailed = js.state === 'failed' || js.status === 'failed';
                  if (isDone || isFailed) {
                    clearInterval(id);
                    resolve(js);
                  }
                } catch (e) {
                  clearInterval(id);
                  reject(e);
                }
              }, interval);
            });
          };
      
      // Make it available globally as well
      if (typeof window !== 'undefined') {
        window.pollJobStatusFn = pollJobStatusFn;
      }
      
      const form = document.getElementById('mainForm');
      const statusBox = document.getElementById('statusBox');
      const curPhotos = document.getElementById('curPhotos');
      const dropZone = document.getElementById('dropZone');
      const photoPreviewContainer = document.getElementById('photoPreviewContainer');
      const photoCount = document.getElementById('photoCount');
      const fileWarning = document.getElementById('fileWarning');
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadModal = document.getElementById('uploadModal');
      const uploadModalText = document.getElementById('uploadModalText');
      const uploadModalProgress = document.getElementById('uploadModalProgress');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const uploadImagesBtn = document.getElementById('uploadImagesBtn');
      const uploadImagesBtnText = document.getElementById('uploadImagesBtnText');
      const uploadImagesBtnSpinner = document.getElementById('uploadImagesBtnSpinner');
      const uploadStatus = document.getElementById('uploadStatus');
      const submitBtn = document.getElementById('submitBtn');
      const submitBtnText = document.getElementById('submitBtnText');
      
      // Track uploaded photos
      let photosUploaded = false;
      let uploadedPhotoUrls = [];
      
      const pads = initSignaturePads();

      // Initialize Upload Queue System - Matching HVAC exactly
      let photoQueue = null;
      let photoQueueUI = null;
      
      // Wait for scripts to load, then initialize
      function initPhotoQueue() {
        console.log('üîç Checking PhotoUploadQueue availability:', {
          PhotoUploadQueue: typeof window.PhotoUploadQueue,
          PhotoQueueUI: typeof window.PhotoQueueUI
        });
        
        if (window.PhotoUploadQueue && window.PhotoQueueUI) {
          console.log('‚úÖ Initializing photo queue system...');
          photoQueue = new window.PhotoUploadQueue({
            uploadEndpoint: modulePrefix + '/upload-photo',
            maxConcurrent: 3,
            onProgress: (stats) => {
              if (photoQueueUI) photoQueueUI.updateProgress(stats);
            },
            onComplete: (stats) => {
              console.log('‚úÖ All uploads complete:', stats);
              updatePhotoCount();
            },
            onError: (error) => {
              console.error('Upload error:', error);
            }
          });

          photoQueueUI = new window.PhotoQueueUI({
            containerId: 'photoPreviewContainer',
            onRetry: (photoId) => {
              photoQueue.retryUpload(photoId);
            },
            onRemove: (photoId) => {
              photoQueue.removePhoto(photoId);
              updatePhotoCount();
            }
          });
          console.log('‚úÖ Photo queue system initialized');
          
          // Create progress container
          const progressDiv = document.createElement('div');
          progressDiv.id = 'queue-progress-container';
          progressDiv.className = 'mb-3';
          photoPreviewContainer.parentNode.insertBefore(progressDiv, photoPreviewContainer);

          // Add retry all button event listener
          document.addEventListener('click', (e) => {
            if (e.target.id === 'retry-all-failed-btn' || e.target.closest('#retry-all-failed-btn')) {
              photoQueue.retryAllFailed();
            }
          });
        } else {
          console.error('‚ùå PhotoUploadQueue or PhotoQueueUI not available!');
          console.error('Available window properties:', Object.keys(window).filter(k => k.includes('Photo')));
        }
      }
      
      // Try to initialize immediately
      initPhotoQueue();
      
      // If not available, wait a bit and try again (scripts might still be loading)
      if (!photoQueue) {
        setTimeout(() => {
          console.log('‚è≥ Retrying photo queue initialization...');
          initPhotoQueue();
        }, 500);
      }

      function updatePhotoCount() {
        let count = 0;
        
        if (photoQueue) {
          const stats = photoQueue.getStats();
          count = stats.total || 0;
          console.log('üìä Queue stats:', stats);
        } else {
          count = currentFiles.length;
        }
        
        // Also count visible thumbnails as fallback
        if (photoPreviewContainer && count === 0) {
          count = photoPreviewContainer.querySelectorAll('.photo-item').length;
        }
        
        if (count > 0) {
          photoCount.style.display = 'block';
          photoCount.textContent = `üì∏ ${count} / ${MAX_PHOTOS} photos added`;
          photoCount.className = 'photo-count alert alert-info';
          photoCount.style.cssText = 'display: block !important; padding: 0.5rem 1rem; margin-top: 0.5rem; border-radius: 4px; font-weight: 600; background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460;';
        } else {
          photoCount.style.display = 'none';
        }
        
        console.log('üìä Photo count updated:', count, 'visible thumbnails:', photoPreviewContainer?.querySelectorAll('.photo-item').length);
      }

      let currentFiles = [];
      let currentPreviews = [];
      let workItemCounter = 1;

      // Auto-download helper function
      function autoDownload(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      // Add Work Item Row
      document.getElementById('addRowBtn').addEventListener('click', () => {
        workItemCounter++;
        const tbody = document.getElementById('workItemsBody');
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${workItemCounter}</td>
          <td><input type="text" class="form-control form-control-sm" name="work_desc[]"></td>
          <td><input type="number" class="form-control form-control-sm" name="work_qty[]"></td>
          <td><input type="text" class="form-control form-control-sm" name="material[]"></td>
          <td><input type="number" class="form-control form-control-sm" name="material_qty[]"></td>
          <td><input type="number" class="form-control form-control-sm" name="price[]" step="0.01"></td>
          <td><input type="text" class="form-control form-control-sm" name="labour[]"></td>
          <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">√ó</button></td>
        `;
        tbody.appendChild(row);
        saveDraft();
      });

      // Remove Work Item Row
      document.getElementById('workItemsTable').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-row')) {
          const tbody = document.getElementById('workItemsBody');
          if (tbody.children.length > 1) {
            e.target.closest('tr').remove();
            // Renumber rows
            Array.from(tbody.children).forEach((row, idx) => {
              row.children[0].textContent = idx + 1;
            });
            workItemCounter = tbody.children.length;
            saveDraft();
          } else {
            statusBox.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è At least one work item is required</div>';
            return;
          }
        }
      });

      // Image Compression Function
      async function compressImage(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let { width, height } = img;
              
              if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                if (width > height) {
                  height = Math.round((height / width) * MAX_IMAGE_DIMENSION);
                  width = MAX_IMAGE_DIMENSION;
                } else {
                  width = Math.round((width / height) * MAX_IMAGE_DIMENSION);
                  height = MAX_IMAGE_DIMENSION;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              canvas.toBlob((blob) => {
                if (!blob) {
                  reject(new Error('Compression failed'));
                  return;
                }
                const compressed = new File([blob], file.name.replace(/\.\w+$/, '.jpg'), {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                resolve(compressed);
              }, 'image/jpeg', JPEG_QUALITY);
            };
            img.onerror = () => reject(new Error('Image load failed'));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error('File read failed'));
          reader.readAsDataURL(file);
        });
      }

      if (!checkBrowserSupport()) {
        dropZone.style.display = 'none';
        curPhotos.classList.remove('d-none');
        uploadProgress.innerHTML = '<div class="alert alert-warning">Using fallback mode</div>';
        uploadProgress.style.display = 'block';
      }

      async function handleFiles(files) {
        if (!files || files.length === 0) return;
        
        const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (imageFiles.length === 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = '‚ö†Ô∏è Please select image files only.';
          return;
          return;
        }
        
        // File size validation upfront
        const oversizedFiles = imageFiles.filter(f => f.size > MAX_FILE_SIZE);
        if (oversizedFiles.length > 0) {
          fileWarning.style.display = 'block';
          fileWarning.textContent = `‚ö†Ô∏è ${oversizedFiles.length} file(s) exceed 10MB limit and will be skipped`;
          setTimeout(() => { fileWarning.style.display = 'none'; }, 5000);
        }
        
        const validFiles = imageFiles.filter(f => f.size <= MAX_FILE_SIZE);
        if (validFiles.length === 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = '‚ö†Ô∏è All files exceed 10MB size limit. Please compress them first.';
          return;
          return;
        }
        
        const totalAfter = currentFiles.length + validFiles.length;
        if (totalAfter > MAX_PHOTOS) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = `‚ö†Ô∏è Maximum ${MAX_PHOTOS} photos. You have ${currentFiles.length}, trying to add ${validFiles.length}.`;
          return;
          return;
        }
        
        // Use upload queue if available
        if (photoQueue && photoQueueUI) {
          console.log('üì∏ Adding photos to queue:', validFiles.length);
          const addedItems = await photoQueue.addPhotos(validFiles);
          console.log('üì∏ Added items to queue:', addedItems.length);
          console.log('üì∏ Preview container element:', photoPreviewContainer);
          console.log('üì∏ Preview container display:', photoPreviewContainer?.style.display);
          
          // Show preview container
          if (photoPreviewContainer) {
            photoPreviewContainer.style.display = 'flex';
            photoPreviewContainer.style.flexWrap = 'wrap';
            photoPreviewContainer.style.gap = '10px';
            photoPreviewContainer.style.marginTop = '1rem';
            photoPreviewContainer.style.padding = '0.5rem';
            photoPreviewContainer.style.minHeight = '140px';
            photoPreviewContainer.style.border = '1px dashed #dee2e6';
            photoPreviewContainer.style.borderRadius = '4px';
            photoPreviewContainer.style.backgroundColor = '#f8f9fa';
            console.log('‚úÖ Preview container made visible');
          } else {
            console.error('‚ùå photoPreviewContainer not found!');
          }
          
          // Render each photo
          addedItems.forEach((item, idx) => {
            console.log(`üì∏ Rendering item ${idx + 1}:`, {
              id: item.id,
              preview: item.preview ? 'exists' : 'missing',
              previewUrl: item.preview,
              status: item.status,
              fileName: item.file?.name
            });
            currentFiles.push({ _queueId: item.id, url: null, is_cloud: false });
            
            // Try to render with photoQueueUI
            let rendered = null;
            if (photoQueueUI) {
              rendered = photoQueueUI.renderPhotoItem(item);
              console.log(`‚úÖ Rendered via photoQueueUI item ${idx + 1}:`, rendered);
            }
            
            // Fallback: render directly if photoQueueUI failed
            if (!rendered && photoPreviewContainer && item.preview) {
              console.log(`‚ö†Ô∏è photoQueueUI failed, rendering directly for item ${idx + 1}`);
              const photoDiv = document.createElement('div');
              photoDiv.className = 'photo-item';
              photoDiv.dataset.photoId = item.id;
              photoDiv.style.cssText = 'position: relative; display: inline-block; margin: 8px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: #f8f9fa; border: 2px solid #dee2e6;';
              
              const img = document.createElement('img');
              img.src = item.preview;
              img.alt = 'Photo';
              img.style.cssText = 'display: block !important; width: 120px !important; height: 120px !important; object-fit: cover; background: #fff;';
              img.onerror = () => console.error('‚ùå Image failed to load:', item.preview);
              img.onload = () => console.log('‚úÖ Image loaded:', item.id);
              
              const removeBtn = document.createElement('button');
              removeBtn.textContent = '√ó';
              removeBtn.className = 'photo-remove-btn';
              removeBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; border-radius: 50%; background: rgba(220, 53, 69, 0.9); border: none; color: white; font-size: 16px; cursor: pointer; z-index: 10;';
              removeBtn.onclick = (e) => {
                e.stopPropagation();
                photoQueue.removePhoto(item.id);
                photoDiv.remove();
                updatePhotoCount();
              };
              
              photoDiv.appendChild(img);
              photoDiv.appendChild(removeBtn);
              photoPreviewContainer.appendChild(photoDiv);
              rendered = photoDiv;
              console.log(`‚úÖ Rendered directly item ${idx + 1}:`, rendered);
            }
          });
          
          // Force container visibility
          if (photoPreviewContainer && addedItems.length > 0) {
            photoPreviewContainer.style.display = 'flex';
            const computedStyle = window.getComputedStyle(photoPreviewContainer);
            console.log('üì∏ Container computed display:', computedStyle.display);
            console.log('üì∏ Container computed visibility:', computedStyle.visibility);
            
            // If still not visible, force it
            if (computedStyle.display === 'none') {
              console.warn('‚ö†Ô∏è Container still hidden, forcing visibility');
              photoPreviewContainer.style.display = 'flex !important';
            }
          }
          
          console.log('üì∏ Total items in container:', photoPreviewContainer?.children.length);
          console.log('üì∏ Container display:', photoPreviewContainer?.style.display);
          console.log('üì∏ Container visibility:', window.getComputedStyle(photoPreviewContainer).display);
          
          // Update count immediately and after a short delay
          updatePhotoCount();
          setTimeout(() => {
            updatePhotoCount();
            console.log('üì∏ Delayed count check - visible thumbnails:', photoPreviewContainer?.querySelectorAll('.photo-item img').length);
          }, 100);
          
          saveDraft();
          
          // Log queue state after adding
          setTimeout(() => {
            const stats = photoQueue.getStats();
            const uploaded = photoQueue.getUploadedUrls();
            console.log('üì∏ Queue stats after adding:', stats);
            console.log('üì∏ Uploaded URLs:', uploaded);
          }, 2000);
          
          return;
        }
        
        // Fallback to original compression logic
        uploadProgress.style.display = 'block';
        
        const BATCH_SIZE = 3;
        let successCount = 0;
        let failedFiles = [];
        
        for (let i = 0; i < validFiles.length; i += BATCH_SIZE) {
          const batch = validFiles.slice(i, i + BATCH_SIZE);
          const promises = batch.map(file => compressImage(file));
          
          try {
            const compressed = await Promise.all(promises);
            compressed.forEach(c => {
              if (c) {
                currentFiles.push(c);
                currentPreviews.push(URL.createObjectURL(c));
                successCount++;
              }
            });
          } catch (err) {
            console.error('Batch compression error:', err);
            batch.forEach(f => failedFiles.push(f.name));
          }
          
          const progress = Math.round(((i + batch.length) / validFiles.length) * 100);
          uploadProgressBar.style.width = progress + '%';
          uploadProgressBar.textContent = `Compressing ${Math.min(i + batch.length, validFiles.length)}/${validFiles.length}...`;
        }
        
        uploadProgress.style.display = 'none';
        
        if (failedFiles.length > 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-danger';
          uploadStatus.innerHTML = `‚ö†Ô∏è Failed to process ${failedFiles.length} file(s): ${failedFiles.slice(0, 3).join(', ')}${failedFiles.length > 3 ? '...' : ''}`;
        }
        
        renderPhotoPreview();
        saveDraft();
      }

      function renderPhotoPreview() {
        photoPreviewContainer.innerHTML = '';
        const count = currentFiles.length;
        
        if (count === 0) {
          photoCount.style.display = 'none';
          photoPreviewContainer.style.display = 'none';
          return;
        }
        
        photoPreviewContainer.style.display = 'flex';
        photoCount.style.display = 'inline-block';
        photoCount.textContent = `${count} / ${MAX_PHOTOS} photos`;
        photoCount.className = 'photo-count mt-2';
        if (count >= MAX_PHOTOS * 0.8) photoCount.classList.add('warning');
        if (count >= MAX_PHOTOS) photoCount.classList.add('danger');
        
        currentPreviews.forEach((url, idx) => {
          const item = document.createElement('div');
          item.className = 'photo-preview-item';
          
          const img = document.createElement('img');
          img.src = url;
          img.alt = `Photo ${idx + 1}`;
          
          const removeBtn = document.createElement('div');
          removeBtn.className = 'photo-preview-remove';
          removeBtn.textContent = '√ó';
          removeBtn.title = 'Remove this photo';
          removeBtn.onclick = () => removePhoto(idx);
          
          item.appendChild(img);
          item.appendChild(removeBtn);
          photoPreviewContainer.appendChild(item);
        });
      }
      
      function removePhoto(index) {
        if (index < 0 || index >= currentFiles.length) return;
        URL.revokeObjectURL(currentPreviews[index]);
        currentFiles.splice(index, 1);
        currentPreviews.splice(index, 1);
        renderPhotoPreview();
        saveDraft();
      }

      dropZone.addEventListener('click', () => curPhotos.click());
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
      dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
      dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
      curPhotos.addEventListener('change', () => handleFiles(curPhotos.files));

      // Draft Auto-Save
      function saveDraft() {
        try {
          const draft = {
            date: document.getElementById('date').value || '',
            project_name: document.getElementById('project_name').value || '',
            description_of_work: document.getElementById('description_of_work').value || '',
            location_name: document.getElementById('location_name').value || '',
            floor: document.getElementById('floor').value || '',
            developer_client: document.getElementById('developer_client').value || '',
            city_area: document.getElementById('city_area').value || '',
            estimated_time: document.getElementById('estimated_time').value || '',
            inspector_name: document.getElementById('inspector_name').value || '',
            workItemsCount: document.getElementById('workItemsBody').children.length,
            photoCount: currentFiles.length,
            timestamp: Date.now()
          };
          localStorage.setItem('civil_draft', JSON.stringify(draft));
        } catch (err) {
          console.error('Failed to save draft:', err);
        }
      }

      function loadDraft() {
        try {
          const draftJson = localStorage.getItem('civil_draft');
          if (!draftJson) return false;
          
          const draft = JSON.parse(draftJson);
          const ageMinutes = (Date.now() - draft.timestamp) / 60000;
          
          if (ageMinutes > 1440) { // 24 hours
            clearDraft();
            return false;
          }
          
          // Auto-load draft without confirmation
          document.getElementById('date').value = draft.date || '';
          document.getElementById('project_name').value = draft.project_name || '';
          document.getElementById('description_of_work').value = draft.description_of_work || '';
          document.getElementById('location_name').value = draft.location_name || '';
          document.getElementById('floor').value = draft.floor || '';
          document.getElementById('developer_client').value = draft.developer_client || '';
          document.getElementById('city_area').value = draft.city_area || '';
          document.getElementById('estimated_time').value = draft.estimated_time || '';
          document.getElementById('inspector_name').value = draft.inspector_name || '';
          
          // Draft loaded silently
          if (draft.workItemsCount > 0 || draft.photoCount > 0) {
            console.log(`‚ÑπÔ∏è Draft loaded: ${draft.workItemsCount} work items and ${draft.photoCount} photos`);
          }
          return true;
        } catch (err) {
          console.error('Failed to load draft:', err);
        }
        return false;
      }

      function clearDraft() {
        try {
          localStorage.removeItem('civil_draft');
        } catch (err) {
          console.error('Failed to clear draft:', err);
        }
      }

      // Auto-save every 30 seconds
      setInterval(saveDraft, DRAFT_SAVE_INTERVAL);
      
      // Save on field changes
      ['date', 'project_name', 'description_of_work', 'location_name', 'floor', 
       'developer_client', 'city_area', 'estimated_time', 'inspector_name'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', saveDraft);
          el.addEventListener('change', saveDraft);
        }
      });

      // Load draft on page load
      window.addEventListener('DOMContentLoaded', loadDraft);

      // Upload Images Button Handler
      uploadImagesBtn.addEventListener('click', async () => {
        console.log('üì§ Upload button clicked. photoQueue:', photoQueue);
        if (!photoQueue) {
          console.error('‚ùå Photo queue not initialized!');
          console.error('Window.PhotoUploadQueue:', typeof window.PhotoUploadQueue);
          console.error('Window.PhotoQueueUI:', typeof window.PhotoQueueUI);
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-danger';
          uploadStatus.innerHTML = '‚ö†Ô∏è Photo upload system not available. Please refresh the page.';
          return;
          return;
        }
        
        const stats = photoQueue.getStats();
        if (stats.total === 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = '‚ö†Ô∏è Please add photos first before uploading.';
          return;
          return;
        }
        
        // Check if already uploaded
        if (photosUploaded && uploadedPhotoUrls.length > 0) {
          // Auto-reset if already uploaded
          photosUploaded = false;
          uploadedPhotoUrls = [];
        }
        
        // Disable button and show spinner
        uploadImagesBtn.disabled = true;
        uploadImagesBtnText.textContent = 'Uploading...';
        uploadImagesBtnSpinner.classList.remove('d-none');
        uploadStatus.classList.remove('d-none');
        uploadStatus.className = 'alert alert-info';
        uploadStatus.innerHTML = `Uploading ${stats.total} photo(s)...`;
        
        try {
          // Wait for all uploads to complete
          const maxWaitTime = 300000; // 5 minutes max
          const startTime = Date.now();
          
          while (!stats.isComplete && (Date.now() - startTime) < maxWaitTime) {
            await new Promise(resolve => setTimeout(resolve, 500));
            const currentStats = photoQueue.getStats();
            const progress = Math.round((currentStats.completed / currentStats.total) * 100);
            uploadStatus.innerHTML = `Uploading ${currentStats.completed}/${currentStats.total} photos (${progress}%)...`;
            
            if (currentStats.isComplete) break;
          }
          
          // Get uploaded URLs
          const uploadedPhotos = photoQueue.getUploadedUrls();
          uploadedPhotoUrls = uploadedPhotos.map(p => {
            if (typeof p === 'string') return p;
            return p.url || p;
          }).filter(Boolean);
          
          // Fallback: check queue items directly
          if (uploadedPhotoUrls.length === 0 && stats.total > 0) {
            const allItems = photoQueue.queue || [];
            const completedItems = allItems.filter(item => item.status === 'completed' && item.url);
            if (completedItems.length > 0) {
              uploadedPhotoUrls = completedItems.map(item => item.url).filter(Boolean);
            }
          }
          
          if (uploadedPhotoUrls.length === 0) {
            throw new Error('No photos were uploaded successfully. Please check for errors and try again.');
          }
          
          photosUploaded = true;
          uploadStatus.className = 'alert alert-success';
          uploadStatus.innerHTML = `‚úÖ Successfully uploaded ${uploadedPhotoUrls.length} photo(s)! You can now generate reports.`;
          
          // Enable submit button
          submitBtn.disabled = false;
          submitBtnText.textContent = `üìÑ Generate Reports (${uploadedPhotoUrls.length} photos)`;
          
          console.log('‚úÖ Photos uploaded:', uploadedPhotoUrls);
          
        } catch (error) {
          console.error('Upload error:', error);
          uploadStatus.className = 'alert alert-danger';
          uploadStatus.innerHTML = `‚ùå Upload failed: ${error.message}`;
          photosUploaded = false;
          uploadedPhotoUrls = [];
        } finally {
          uploadImagesBtn.disabled = false;
          uploadImagesBtnText.textContent = 'üì§ Upload Images';
          uploadImagesBtnSpinner.classList.add('d-none');
        }
      });

      // Submit Handler - Using HVAC method with JSON payload
      submitBtn.addEventListener('click', async () => {
        // Get signatures
        const techSig = (pads.tech && !pads.tech.isEmpty()) ? pads.tech.toDataURL('image/png') : '';
        const opSig = (pads.op && !pads.op.isEmpty()) ? pads.op.toDataURL('image/png') : '';
        
        // Check if photos have been uploaded
        if (!photosUploaded || uploadedPhotoUrls.length === 0) {
          statusBox.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Please upload images first using the "Upload Images" button before generating reports.</div>';
          return;
          return;
        }
        
        console.log('üì∏ Using pre-uploaded photo URLs:', uploadedPhotoUrls);
        console.log('üì∏ Total photos to submit:', uploadedPhotoUrls.length);
        
        // Collect work items from table
        const workItemsBody = document.getElementById('workItemsBody');
        const workItems = [];
        const rows = workItemsBody.querySelectorAll('tr');
        
        rows.forEach((row, index) => {
          const inputs = row.querySelectorAll('input');
          if (inputs.length >= 6) {
            workItems.push({
              item_number: index + 1,
              description: inputs[0].value || '', // work_desc
              quantity: inputs[1].value || '', // work_qty
              material: inputs[2].value || '', // material
              material_qty: inputs[3].value || '', // material_qty
              price: inputs[4].value || '', // price
              labour: inputs[5].value || '', // labour
              photo_urls: uploadedPhotoUrls // All photos attached to each work item
            });
          }
        });
        
        if (workItems.length === 0) {
          statusBox.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Please add at least one work item before submitting.</div>';
          return;
          return;
        }
        
        // Count total photos
        const totalPhotos = uploadedPhotoUrls.length;
        if (totalPhotos >= 30) {
          const estimatedTime = Math.ceil(totalPhotos / 10);
          // Show info message instead of confirmation
          if (totalPhotos >= 30) {
            const estimatedTime = Math.ceil(totalPhotos / 10);
            statusBox.innerHTML = `<div class="alert alert-info">‚è∞ Processing ${totalPhotos} photos. This may take ${estimatedTime}-${estimatedTime + 1} minutes...</div>`;
          }
        }

        // Show loading overlay (photos already uploaded, just generating reports)
        loadingOverlay.style.display = 'flex';
        statusBox.innerHTML = '';
        
        // Prepare JSON payload (photos already in cloud)
        const payload = {
          project_name: document.getElementById('project_name').value || '',
          location: document.getElementById('location_name').value || '',
          visit_date: document.getElementById('date').value || '',
          inspector_name: document.getElementById('inspector_name').value || '',
          inspector_signature: techSig || '',
          manager_name: document.getElementById('manager_name')?.value || '',
          manager_signature: opSig || '',
          description_of_work: document.getElementById('description_of_work').value || '',
          floor: document.getElementById('floor').value || '',
          developer_client: document.getElementById('developer_client').value || '',
          city_area: document.getElementById('city_area').value || '',
          estimated_time: document.getElementById('estimated_time').value || '',
          estimated_completion: document.getElementById('estimated_completion')?.value || '',
          work_items: workItems
        };
        
        console.log('üì§ Submitting payload with work items:', workItems);
        console.log('üì§ Each work item photo_urls:', workItems.map(wi => ({ item: wi.item_number, photo_count: wi.photo_urls?.length || 0, urls: wi.photo_urls })));

        try {
          const submitUrl = modulePrefix + '/submit-with-urls';
          const res = await fetch(submitUrl, { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          if (!res.ok) {
            const txt = await res.text();
            throw new Error('Server error: ' + res.status + ' ' + txt);
          }
          
          const json = await res.json();
          
          // Hide upload modal, show loading overlay
          uploadModal.style.display = 'none';
          loadingOverlay.style.display = 'flex';
          
          if (json.job_id) {
            clearDraft(); // Clear draft after successful submission
            
            // Ensure pollJobStatusFn is available - use multiple fallbacks
            let pollFn = null;
            try {
              // First try: use the pollJobStatusFn defined at the top of the IIFE
              if (typeof pollJobStatusFn !== 'undefined') {
                pollFn = pollJobStatusFn;
              }
              // Second try: use window.pollJobStatusFn
              else if (typeof window !== 'undefined' && typeof window.pollJobStatusFn !== 'undefined') {
                pollFn = window.pollJobStatusFn;
              }
              // Third try: use window.pollJobStatus
              else if (typeof window !== 'undefined' && typeof window.pollJobStatus !== 'undefined') {
                pollFn = window.pollJobStatus;
              }
              // Fourth try: define it inline as last resort
              else {
                pollFn = async function(modulePrefix, jobId, onUpdate, interval=1500) {
                  const statusUrl = `${modulePrefix}/status/${jobId}`;
                  return new Promise((resolve, reject) => {
                    const id = setInterval(async () => {
                      try {
                        const r = await fetch(statusUrl);
                        if (!r.ok) throw new Error('Job not found');
                        const js = await r.json();
                        if (onUpdate) onUpdate(js);
                        const isDone = js.state === 'done' || js.status === 'completed';
                        const isFailed = js.state === 'failed' || js.status === 'failed';
                        if (isDone || isFailed) {
                          clearInterval(id);
                          resolve(js);
                        }
                      } catch (e) {
                        clearInterval(id);
                        reject(e);
                      }
                    }, interval);
                  });
                };
              }
            } catch (e) {
              console.error('Error getting pollJobStatus function:', e);
            }
            
            if (!pollFn || typeof pollFn !== 'function') {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = '<div class="alert alert-danger">‚ùå Error: pollJobStatus function not available. Please refresh the page.</div>';
              console.error('pollFn is not a function. pollJobStatusFn:', typeof pollJobStatusFn, 'window.pollJobStatusFn:', typeof (window && window.pollJobStatusFn), 'window.pollJobStatus:', typeof (window && window.pollJobStatus));
              return;
            }
            
            pollFn(modulePrefix, json.job_id, (js) => {
              statusBox.innerHTML = `<div class="alert alert-info">Generating reports... ${js.progress || 0}%</div>`;
            }).then(result => {
              loadingOverlay.style.display = 'none';
              
              // Debug logging
              console.log('Job polling completed. Full result:', result);
              
              // Check both 'state' (legacy) and 'status' (current)
              const isDone = result.state === 'done' || result.status === 'completed';
              const isFailed = result.state === 'failed' || result.status === 'failed';
              
              // Support both 'results' and 'result_data'
              const results = result.results || result.result_data || {};
              
              console.log('Extracted results:', results);
              console.log('Is done?', isDone, 'Status:', result.status, 'State:', result.state);
              
              if (isDone) {
                const links = [];
                
                // Check for Excel file (try multiple possible field names)
                const excelUrl = results.excel || results.excel_url || results.excelUrl;
                const excelFilename = results.excel_filename || results.excelFilename || 'civil_report.xlsx';
                console.log('Excel URL:', excelUrl, 'Filename:', excelFilename);
                
                if (excelUrl) {
                  const excelLinkHtml = `<a href="${excelUrl}" download="${excelFilename}" class="btn btn-success me-2 mt-2" style="text-decoration: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; display: inline-block;">üì• Download Excel Report</a>`;
                  links.push(excelLinkHtml);
                }
                
                // Check for PDF file (try multiple possible field names)
                const pdfUrl = results.pdf || results.pdf_url || results.pdfUrl;
                const pdfFilename = results.pdf_filename || results.pdfFilename || 'civil_report.pdf';
                console.log('PDF URL:', pdfUrl, 'Filename:', pdfFilename);
                
                if (pdfUrl) {
                  const pdfLinkHtml = `<a href="${pdfUrl}" download="${pdfFilename}" class="btn btn-danger me-2 mt-2" style="text-decoration: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; display: inline-block;">üì• Download PDF Report</a>`;
                  links.push(pdfLinkHtml);
                }
                
                if (links.length > 0) {
                  statusBox.innerHTML = `<div class="alert alert-success"><strong>‚úÖ Reports generated successfully!</strong><br><br>${links.join(' ')}<div class="mt-2 text-muted" style="font-size:0.9em;">Click the buttons above to download your reports.</div></div>`;
                  statusBox.style.display = 'block';
                } else {
                  statusBox.innerHTML = `<div class="alert alert-warning"><strong>‚ö†Ô∏è Job completed but no download links found.</strong><br><br>Result data: <pre style="font-size: 0.8rem; margin-top: 0.5rem;">${JSON.stringify(results, null, 2)}</pre><br>Full result: <pre style="font-size: 0.8rem; margin-top: 0.5rem;">${JSON.stringify(result, null, 2)}</pre></div>`;
                  statusBox.style.display = 'block';
                }
              } else if (isFailed) {
                statusBox.innerText = "‚ùå Job failed: " + (result.error || JSON.stringify(results));
              } else {
                statusBox.innerText = "‚ùå Unknown job state: " + JSON.stringify(result);
              }
            }).catch(err => {
              loadingOverlay.style.display = 'none';
              statusBox.innerText = "‚ùå Error polling job status: " + err.message;
            });
          } else {
            loadingOverlay.style.display = 'none';
            statusBox.innerHTML = '<div class="alert alert-warning">Submission accepted but no job ID</div>';
          }
        } catch (err) {
          loadingOverlay.style.display = 'none';
          statusBox.innerHTML = `<div class="alert alert-danger">‚ùå Submission failed: ${err.message}</div>`;
        }
      });
    })();
  </script>
</body>
</html>