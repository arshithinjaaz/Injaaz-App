<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Civil Works - Site Assessment Form</title>
  <meta name="description" content="Civil works site assessment form - Works offline">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#125435">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Injaaz Civil">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
  <script src="{{ url_for('static', filename='pwa-install.js') }}" defer></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='photo_upload_queue.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="{{ url_for('static', filename='photo_upload_queue.js') }}"></script>
  <script src="{{ url_for('static', filename='photo_queue_ui.js') }}"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #125435;
      --primary-light: #1a7a4d;
      --primary-dark: #0d3d24;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-light: #9ca3af;
      --border-light: #e5e7eb;
      --bg-page: #fafafa;
      --white: #ffffff;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    body {
      background: var(--bg-page);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 0;
      margin: 0;
      line-height: 1.5;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Ultra-minimal navigation */
    .navbar {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px) saturate(180%);
      box-shadow: 0 1px 0 rgba(18, 84, 53, 0.06);
      padding: 1rem 0;
      margin-bottom: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(18, 84, 53, 0.04);
    }
    
    .navbar-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary) !important;
      text-decoration: none;
      letter-spacing: -0.3px;
      transition: opacity 0.2s ease;
    }
    
    .navbar-brand img {
      height: 28px;
      width: auto;
    }
    
    .navbar-brand:hover {
      opacity: 0.8;
    }
    
    .module-badge {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-secondary);
      padding: 0.375rem 0.875rem;
      background: #f5f5f5;
      border-radius: 4px;
      letter-spacing: 0.3px;
    }
    
    /* Clean, spacious container */
    .container {
      max-width: 1200px;
      background: var(--white);
      border-radius: 8px;
      padding: 2rem 2.5rem;
      box-shadow: var(--shadow-sm);
      margin: 1.5rem auto;
      border: 1px solid var(--border-light);
    }
    
    /* Minimal typography */
    h2 {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 0.375rem;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }
    
    h5 {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 1rem;
      margin-top: 2rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-light);
      letter-spacing: -0.2px;
    }
    
    .text-muted {
      color: var(--text-secondary) !important;
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    /* Minimal form labels */
    .form-label, label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.875rem;
      margin-bottom: 0.375rem;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.75rem;
    }
    
    /* Clean inputs with subtle borders */
    .form-control, .form-select, textarea {
      border: 1px solid var(--border-light);
      border-radius: 4px;
      padding: 0.625rem 0.875rem;
      transition: all 0.15s ease;
      font-size: 0.9375rem;
      background: var(--white);
      color: var(--text-primary);
    }
    
    .form-control:focus, .form-select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 84, 53, 0.06);
      outline: none;
    }
    
    /* Minimal flat buttons */
    .btn {
      border-radius: 4px;
      padding: 0.625rem 1.25rem;
      font-weight: 600;
      border: none;
      transition: all 0.15s ease;
      font-size: 0.875rem;
      letter-spacing: 0.2px;
    }
    
    .btn-primary, .btn-success {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover, .btn-success:hover {
      background: var(--primary-dark);
      box-shadow: 0 2px 8px rgba(18, 84, 53, 0.2);
    }
    
    .btn-outline-secondary {
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      background: transparent;
    }
    
    .btn-outline-secondary:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
      background: #fafafa;
    }
    
    /* Signature pad */
    canvas {
      border: 1px solid var(--border-light);
      border-radius: 4px;
      width: 100%;
      height: 100px;
      background: #fafafa;
      cursor: crosshair;
    }
    
    .signature-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .signature-hint {
      font-size: 0.75rem;
      color: var(--text-light);
      font-weight: 400;
    }
    
    .alert {
      border-radius: 4px;
      border: none;
      font-size: 0.875rem;
      padding: 0.875rem 1rem;
    }
    
    #statusBox {
      padding: 1rem;
      border-radius: 4px;
      background: var(--bg-page);
      border: 1px solid var(--border-light);
      margin-top: 1rem;
    }
    
    /* Upload Progress Modal */
    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .upload-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .upload-progress-bar {
      height: 30px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .upload-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #125435, #1a7a4f);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    /* Photo Preview Container */
    .photo-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 1rem;
      padding: 0.5rem;
      border: 1px dashed var(--border-light);
      border-radius: 4px;
      min-height: 60px;
    }
    
    .photo-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 4px;
      overflow: hidden;
      border: 2px solid var(--border-light);
    }
    
    .photo-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-preview-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #dc3545;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .photo-preview-remove:hover {
      background: #c82333;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #e9ecef;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 1.5rem;
      font-size: 1.125rem;
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .loading-subtitle {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    /* Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border-light);
      border-radius: 4px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: var(--primary);
      background: #f8faf9;
    }
    
    .drop-zone-content {
      color: var(--text-secondary);
      font-size: 0.9375rem;
    }
    
    .drop-zone-content strong {
      display: block;
      color: var(--text-primary);
      margin-bottom: 0.375rem;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .drop-zone-content small {
      display: block;
      font-size: 0.8125rem;
      margin-top: 0.375rem;
      color: var(--text-light);
    }
    
    .photo-count {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      background: #e9ecef;
      border-radius: 4px;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }
    
    .photo-count.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .photo-count.danger {
      background: #f8d7da;
      color: #721c24;
    }
    
    .file-warning {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }
    
    .upload-progress {
      margin-top: 0.875rem;
      display: none;
    }
    
    /* Work Items Table */
    .table {
      font-size: 0.875rem;
    }
    
    .table th {
      background: #f8faf9;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-light);
    }
    
    .table td {
      vertical-align: middle;
    }
    
    .form-control-sm {
      font-size: 0.8125rem;
      padding: 0.375rem 0.5rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1.5rem 1.25rem;
        margin: 1rem;
        border-radius: 6px;
      }
      
      .navbar-container {
        padding: 0 1.25rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-container">
      <a class="navbar-brand" href="/">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Injaaz">
        <span>Injaaz</span>
      </a>
      <div class="module-badge">Civil Works</div>
    </div>
  </nav>

  <div class="container">
    <h2>Site Inspection Report - Civil</h2>
    <p class="text-muted">Complete the inspection form below</p>

    <form id="mainForm">
      <h5>Project Information</h5>
      <div class="row g-3">
        <div class="col-md-6 mb-3">
          <label for="date">Date</label>
          <input id="date" name="date" type="date" class="form-control" required>
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="project_name">Project Name</label>
          <input id="project_name" name="project_name" class="form-control" required>
        </div>
        
        <div class="col-12 mb-3">
          <label for="description_of_work">Description of Work</label>
          <textarea id="description_of_work" name="description_of_work" class="form-control" rows="2"></textarea>
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="location_name">Location Name</label>
          <input id="location_name" name="location_name" class="form-control">
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="floor">Floor</label>
          <input id="floor" name="floor" class="form-control">
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="developer_client">Developer/Client</label>
          <input id="developer_client" name="developer_client" class="form-control">
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="city_area">City/Area</label>
          <input id="city_area" name="city_area" class="form-control">
        </div>
      </div>

      <h5>Work Items</h5>
      <div class="mb-3">
        <button type="button" id="addRowBtn" class="btn btn-outline-secondary btn-sm">+ Add Work Item</button>
      </div>
      
      <div class="table-responsive mb-4">
        <table class="table table-bordered" id="workItemsTable">
          <thead>
            <tr>
              <th style="width: 40px;">SN</th>
              <th style="width: 200px;">Work Description</th>
              <th style="width: 80px;">Quantity</th>
              <th style="width: 180px;">Material Required with Brand</th>
              <th style="width: 80px;">Quantity</th>
              <th style="width: 80px;">Price</th>
              <th style="width: 150px;">Labour Needed (Hours/Day)</th>
              <th style="width: 60px;">Action</th>
            </tr>
          </thead>
          <tbody id="workItemsBody">
            <tr>
              <td>1</td>
              <td><input type="text" class="form-control form-control-sm" name="work_desc[]"></td>
              <td><input type="number" class="form-control form-control-sm" name="work_qty[]"></td>
              <td><input type="text" class="form-control form-control-sm" name="material[]"></td>
              <td><input type="number" class="form-control form-control-sm" name="material_qty[]"></td>
              <td><input type="number" class="form-control form-control-sm" name="price[]" step="0.01"></td>
              <td><input type="text" class="form-control form-control-sm" name="labour[]"></td>
              <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">√ó</button></td>
            </tr>
          </tbody>
        </table>
      </div>

      <h5>Pictures from Site</h5>
      
      <div class="mb-3">
        <label for="photoUpload" class="form-label">Upload Photos (Maximum 100)</label>
        <input id="photoUpload" type="file" class="form-control d-none" accept="image/*" multiple>
        
        <div id="dropZone" class="drop-zone">
          <div class="drop-zone-content">
            <strong>Drag and drop images here</strong>
            <small>or click to browse ‚Ä¢ Maximum 100 images ‚Ä¢ Auto-compressed to 1280px ‚Ä¢ Max 10MB per file</small>
          </div>
        </div>
        
        <div id="fileWarning" class="file-warning">
          ‚ö†Ô∏è Some files are larger than 10MB and will be skipped
        </div>
        
        <div id="uploadProgress" class="upload-progress">
          <div class="progress">
            <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 0%"></div>
          </div>
        </div>
        
        <div id="photoCount" class="photo-count" style="display:none;"></div>
        
        <!-- Photo Preview Container with Remove Buttons -->
        <div id="photoPreviewContainer" class="photo-preview-container" style="display:none;"></div>
      </div>
      
      <div class="mb-3">
        <label for="estimated_time">Project Estimated Time to Finish</label>
        <input id="estimated_time" name="estimated_time" class="form-control" placeholder="e.g., 2 weeks, 10 days">
      </div>

      <h5>Inspector & Manager Sign-off</h5>
      
      <div class="row g-3 mb-4">
        <div class="col-md-6 mb-3">
          <label for="inspector_name">Name of Inspector</label>
          <input id="inspector_name" name="inspector_name" class="form-control" placeholder="Inspector name">
        </div>
        <div class="col-md-6"></div>
      </div>

      <div class="row g-3">
        <div class="col-md-6 mb-3">
          <div class="signature-label">
            <label class="mb-0">Inspector Signature</label>
            <span class="signature-hint">Draw signature with mouse/touch</span>
          </div>
          <canvas id="techSignaturePad"></canvas>
          <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="pads.techPad.clear()">Clear</button>
        </div>

        <div class="col-md-6 mb-3">
          <div class="signature-label">
            <label class="mb-0">Manager Approval Signature</label>
            <span class="signature-hint">Draw signature with mouse/touch</span>
          </div>
          <canvas id="opManSignaturePad"></canvas>
          <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="pads.opPad.clear()">Clear</button>
        </div>
      </div>

      <button type="button" id="submitBtn" class="btn btn-primary btn-lg">Submit</button>
      <div id="statusBox" class="mt-3"></div>
    </form>
  </div>

  <!-- Upload Progress Modal -->
  <div id="uploadModal" class="upload-modal">
    <div class="upload-modal-content">
      <h4 style="margin-bottom: 1rem;">Uploading Photos</h4>
      <div id="uploadModalText" style="margin-bottom: 1rem; color: #666;">
        Preparing images...
      </div>
      <div class="upload-progress-bar">
        <div id="uploadModalProgress" class="upload-progress-fill" style="width: 0%">
          0%
        </div>
      </div>
      <small style="color: #999; display: block; margin-top: 0.5rem;">Please wait, this may take a few minutes for large batches</small>
    </div>
  </div>

  <!-- Loading Overlay for Report Generation -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Generating Reports...</div>
    <div class="loading-subtitle">This typically takes 2-3 minutes for large submissions</div>
    <div class="loading-subtitle" style="margin-top: 1.5rem; font-size: 0.8rem;">Creating Excel and PDF reports with all photos</div>
  </div>

  <script>
    const modulePrefix = "{{ url_for('civil_bp.index') }}".replace('/form','');
    const MAX_PHOTOS = 100;
    const MAX_IMAGE_DIMENSION = 1280;
    const JPEG_QUALITY = 0.85;
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    const DRAFT_SAVE_INTERVAL = 30000; // 30 seconds
    
    let currentFiles = [];
    let currentPreviews = [];
    
    // Initialize Upload Queue with Optimistic UI
    let photoQueue, photoQueueUI;
    
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize upload queue
      photoQueue = new PhotoUploadQueue({
        maxConcurrent: 3,
        uploadEndpoint: modulePrefix + '/upload-photo',
        onProgress: (stats) => {
          if (photoQueueUI) photoQueueUI.updateProgress(stats);
        },
        onItemComplete: (item, success) => {
          if (photoQueueUI) photoQueueUI.updatePhotoStatus(item);
          if (success && item.url) {
            // Store successful uploads
            const fileObj = { url: item.url, is_cloud: true };
            const existingIndex = currentFiles.findIndex(f => f._queueId === item.id);
            if (existingIndex >= 0) {
              currentFiles[existingIndex] = fileObj;
            } else {
              currentFiles.push(fileObj);
            }
          }
        },
        onQueueComplete: (stats) => {
          console.log(`Upload complete: ${stats.completed} uploaded, ${stats.failed} failed`);
          saveDraft(); // Save after all uploads complete
        }
      });
      
      // Initialize UI helper
      photoQueueUI = new PhotoQueueUI('photoPreviewContainer', {
        maxPhotos: MAX_PHOTOS,
        onRetryAll: () => photoQueue.retryAllFailed(),
        onRemove: (photoId) => {
          photoQueue.removePhoto(photoId);
          photoQueueUI.removePhoto(photoId);
          // Remove from currentFiles
          const index = currentFiles.findIndex(f => f._queueId === photoId);
          if (index >= 0) currentFiles.splice(index, 1);
          updatePhotoCount();
          saveDraft();
        }
      });
      
      // Create progress container
      photoQueueUI.createProgressContainer();
      
      // Listen for retry events
      document.addEventListener('photo-retry', (e) => {
        photoQueue.retryUpload(e.detail.photoId);
      });
    });
    
    function updatePhotoCount() {
      const count = photoQueueUI ? photoQueueUI.getPhotoCount() : currentFiles.length;
      if (count === 0) {
        photoCount.style.display = 'none';
        photoPreviewContainer.style.display = 'none';
      } else {
        photoCount.style.display = 'inline-block';
        photoCount.textContent = `${count} / ${MAX_PHOTOS} photos`;
        photoCount.className = 'photo-count mt-2';
        if (count >= MAX_PHOTOS * 0.8) photoCount.classList.add('warning');
        if (count >= MAX_PHOTOS) photoCount.classList.add('danger');
        photoPreviewContainer.style.display = 'flex';
      }
    }
  </script>
  <script src="{{ url_for('static', filename='form.js') }}"></script>
  <script>
    (function(){
      const form = document.getElementById('mainForm');
      const statusBox = document.getElementById('statusBox');
      const photoUpload = document.getElementById('photoUpload');
      const dropZone = document.getElementById('dropZone');
      const photoPreviewContainer = document.getElementById('photoPreviewContainer');
      const photoCount = document.getElementById('photoCount');
      const fileWarning = document.getElementById('fileWarning');
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadModal = document.getElementById('uploadModal');
      const uploadModalText = document.getElementById('uploadModalText');
      const uploadModalProgress = document.getElementById('uploadModalProgress');
      const loadingOverlay = document.getElementById('loadingOverlay');
      
      const pads = initSignaturePads();
      
      let workItemCounter = 1;

      // Auto-download helper function
      function autoDownload(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      // Add Work Item Row
      document.getElementById('addRowBtn').addEventListener('click', () => {
        workItemCounter++;
        const tbody = document.getElementById('workItemsBody');
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${workItemCounter}</td>
          <td><input type="text" class="form-control form-control-sm" name="work_desc[]"></td>
          <td><input type="number" class="form-control form-control-sm" name="work_qty[]"></td>
          <td><input type="text" class="form-control form-control-sm" name="material[]"></td>
          <td><input type="number" class="form-control form-control-sm" name="material_qty[]"></td>
          <td><input type="number" class="form-control form-control-sm" name="price[]" step="0.01"></td>
          <td><input type="text" class="form-control form-control-sm" name="labour[]"></td>
          <td><button type="button" class="btn btn-sm btn-outline-danger remove-row">√ó</button></td>
        `;
        tbody.appendChild(row);
        saveDraft();
      });

      // Remove Work Item Row
      document.getElementById('workItemsTable').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-row')) {
          const tbody = document.getElementById('workItemsBody');
          if (tbody.children.length > 1) {
            e.target.closest('tr').remove();
            // Renumber rows
            Array.from(tbody.children).forEach((row, idx) => {
              row.children[0].textContent = idx + 1;
            });
            workItemCounter = tbody.children.length;
            saveDraft();
          } else {
            alert('At least one work item is required');
          }
        }
      });

      // Image Compression Function
      async function compressImage(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let { width, height } = img;
              
              if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                if (width > height) {
                  height = Math.round((height / width) * MAX_IMAGE_DIMENSION);
                  width = MAX_IMAGE_DIMENSION;
                } else {
                  width = Math.round((width / height) * MAX_IMAGE_DIMENSION);
                  height = MAX_IMAGE_DIMENSION;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              canvas.toBlob((blob) => {
                if (!blob) {
                  reject(new Error('Compression failed'));
                  return;
                }
                const compressed = new File([blob], file.name.replace(/\.\w+$/, '.jpg'), {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                resolve(compressed);
              }, 'image/jpeg', JPEG_QUALITY);
            };
            img.onerror = () => reject(new Error('Image load failed'));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error('File read failed'));
          reader.readAsDataURL(file);
        });
      }

      // Handle Files with Validation and Upload Queue
      async function handleFiles(files) {
        if (!files || files.length === 0) return;
        
        const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (imageFiles.length === 0) {
          alert('Please select image files only.');
          return;
        }
        
        // File size validation upfront
        const oversizedFiles = imageFiles.filter(f => f.size > MAX_FILE_SIZE);
        if (oversizedFiles.length > 0) {
          fileWarning.style.display = 'block';
          fileWarning.textContent = `‚ö†Ô∏è ${oversizedFiles.length} file(s) exceed 10MB limit and will be skipped`;
          setTimeout(() => { fileWarning.style.display = 'none'; }, 5000);
        }
        
        const validFiles = imageFiles.filter(f => f.size <= MAX_FILE_SIZE);
        if (validFiles.length === 0) {
          alert('All files exceed 10MB size limit. Please compress them first.');
          return;
        }
        
        const currentCount = photoQueueUI ? photoQueueUI.getPhotoCount() : currentFiles.length;
        const totalAfter = currentCount + validFiles.length;
        if (totalAfter > MAX_PHOTOS) {
          alert(`Maximum ${MAX_PHOTOS} photos. You have ${currentCount}, trying to add ${validFiles.length}.`);
          return;
        }
        
        // Add to upload queue (will upload immediately with 3 concurrent)
        const photoItems = photoQueue.addPhotos(validFiles);
        
        // Render immediately (optimistic UI)
        photoItems.forEach(item => {
          // Store queue ID for tracking
          const fileRef = { _queueId: item.id, _uploading: true };
          currentFiles.push(fileRef);
          photoQueueUI.renderPhotoItem(item);
        });
        
        updatePhotoCount();
      }

      // Legacy function - now handled by PhotoQueueUI
      function renderPhotoPreview() {
        // No-op: UI is handled by PhotoQueueUI
        updatePhotoCount();
      }
      
      // Legacy function - now handled by PhotoQueueUI
      function removePhoto(index) {
        // No-op: removal is handled by PhotoQueueUI
      }

      // Drop Zone Events
      dropZone.addEventListener('click', () => photoUpload.click());
      dropZone.addEventListener('dragover', (e) => { 
        e.preventDefault(); 
        e.stopPropagation(); 
        dropZone.classList.add('drag-over'); 
      });
      dropZone.addEventListener('dragleave', (e) => { 
        e.preventDefault(); 
        e.stopPropagation(); 
        dropZone.classList.remove('drag-over'); 
      });
      dropZone.addEventListener('drop', (e) => { 
        e.preventDefault(); 
        e.stopPropagation(); 
        dropZone.classList.remove('drag-over'); 
        handleFiles(e.dataTransfer.files); 
      });
      photoUpload.addEventListener('change', () => handleFiles(photoUpload.files));

      // Draft Auto-Save
      function saveDraft() {
        try {
          const draft = {
            date: document.getElementById('date').value || '',
            project_name: document.getElementById('project_name').value || '',
            description_of_work: document.getElementById('description_of_work').value || '',
            location_name: document.getElementById('location_name').value || '',
            floor: document.getElementById('floor').value || '',
            developer_client: document.getElementById('developer_client').value || '',
            city_area: document.getElementById('city_area').value || '',
            estimated_time: document.getElementById('estimated_time').value || '',
            inspector_name: document.getElementById('inspector_name').value || '',
            workItemsCount: document.getElementById('workItemsBody').children.length,
            photoCount: currentFiles.length,
            timestamp: Date.now()
          };
          localStorage.setItem('civil_draft', JSON.stringify(draft));
        } catch (err) {
          console.error('Failed to save draft:', err);
        }
      }

      function loadDraft() {
        try {
          const draftJson = localStorage.getItem('civil_draft');
          if (!draftJson) return false;
          
          const draft = JSON.parse(draftJson);
          const ageMinutes = (Date.now() - draft.timestamp) / 60000;
          
          if (ageMinutes > 1440) { // 24 hours
            clearDraft();
            return false;
          }
          
          if (confirm(`üìã Found a draft from ${Math.round(ageMinutes)} minutes ago.\n\nLoad it?`)) {
            document.getElementById('date').value = draft.date || '';
            document.getElementById('project_name').value = draft.project_name || '';
            document.getElementById('description_of_work').value = draft.description_of_work || '';
            document.getElementById('location_name').value = draft.location_name || '';
            document.getElementById('floor').value = draft.floor || '';
            document.getElementById('developer_client').value = draft.developer_client || '';
            document.getElementById('city_area').value = draft.city_area || '';
            document.getElementById('estimated_time').value = draft.estimated_time || '';
            document.getElementById('inspector_name').value = draft.inspector_name || '';
            
            if (draft.workItemsCount > 0 || draft.photoCount > 0) {
              alert(`‚ÑπÔ∏è Draft had ${draft.workItemsCount} work items and ${draft.photoCount} photos (work items not restored, photos not saved)`);
            }
            return true;
          }
        } catch (err) {
          console.error('Failed to load draft:', err);
        }
        return false;
      }

      function clearDraft() {
        try {
          localStorage.removeItem('civil_draft');
        } catch (err) {
          console.error('Failed to clear draft:', err);
        }
      }

      // Auto-save every 30 seconds
      setInterval(saveDraft, DRAFT_SAVE_INTERVAL);
      
      // Save on field changes
      ['date', 'project_name', 'description_of_work', 'location_name', 'floor', 
       'developer_client', 'city_area', 'estimated_time', 'inspector_name'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', saveDraft);
          el.addEventListener('change', saveDraft);
        }
      });

      // Load draft on page load
      window.addEventListener('DOMContentLoaded', loadDraft);

      // Submit Handler
      document.getElementById('submitBtn').addEventListener('click', async () => {
        // Check if uploads are complete
        if (photoQueue) {
          const stats = photoQueue.getStats();
          
          if (!stats.isComplete && stats.total > 0) {
            alert(`‚è≥ Please wait for photo uploads to complete.\n\n${stats.uploading + stats.queued} photo(s) still uploading...`);
            return;
          }
          
          if (stats.failed > 0) {
            const proceed = confirm(`‚ö†Ô∏è ${stats.failed} photo(s) failed to upload.\n\nDo you want to continue without them?\n\nClick "Retry All Failed" to try uploading them again.`);
            if (!proceed) return;
          }
          
          // Get successfully uploaded URLs
          const uploadedPhotos = photoQueue.getUploadedUrls();
          currentFiles = uploadedPhotos.map(p => ({ url: p.url, is_cloud: true }));
        }
        
        // Large submission warning
        const totalPhotos = currentFiles.length;
        if (totalPhotos >= 30) {
          const estimatedTime = Math.ceil(totalPhotos / 10);
          if (!confirm(`‚è∞ You're submitting ${totalPhotos} photos.\n\nThis may take ${estimatedTime}-${estimatedTime + 1} minutes to process.\n\nDo you want to continue?`)) {
            return;
          }
        }

        // Show upload modal
        if (totalPhotos > 0) {
          uploadModal.style.display = 'flex';
          uploadModalText.textContent = `Processing ${totalPhotos} photos...`;
          uploadModalProgress.style.width = '50%';
          uploadModalProgress.textContent = '50%';
        }

        statusBox.innerText = "Submitting...";
        
        try {
          const formData = new FormData(form);
          
          // Add photo URLs (already uploaded to cloud)
          currentFiles.forEach((fileObj, idx) => {
            if (fileObj.url && fileObj.is_cloud) {
              // Photos are already uploaded, just send URLs
              formData.append(`photo_url_${idx}`, fileObj.url);
            }
          });
          
          // Add signatures
          const techSig = (pads.tech && !pads.tech.isEmpty()) ? pads.tech.toDataURL('image/png') : '';
          const opSig = (pads.op && !pads.op.isEmpty()) ? pads.op.toDataURL('image/png') : '';
          formData.set('tech_signature', techSig);
          formData.set('op_signature', opSig);
          
          const submitUrl = modulePrefix + '/submit';
          const res = await fetch(submitUrl, { method: 'POST', body: formData });
          
          if (!res.ok) {
            throw new Error('Server error: ' + res.status);
          }
          
          const data = await res.json();
          
          // Hide upload modal, show loading overlay
          uploadModal.style.display = 'none';
          loadingOverlay.style.display = 'flex';
          
          if (data.job_id) {
            clearDraft(); // Clear draft after successful submission
            statusBox.innerText = "Queued job: " + data.job_id;
            
            const result = await pollJobStatus(modulePrefix, data.job_id, (js) => {
              statusBox.innerText = `State: ${js.state}, progress: ${js.progress}%`;
            });
            
            loadingOverlay.style.display = 'none';
            
            if (result.state === 'done') {
              const links = result.results.map(r => `<a href="${r.url}" target="_blank">${r.filename}</a>`).join('<br>');
              statusBox.innerHTML = `‚úÖ Done.<br>${links}`;
              
              // Auto-download files
              result.results.forEach((r, idx) => {
                setTimeout(() => autoDownload(r.url, r.filename), idx * 1000);
              });
            } else {
              statusBox.innerText = "‚ùå Job failed: " + JSON.stringify(result.results);
            }
          } else {
            uploadModal.style.display = 'none';
            loadingOverlay.style.display = 'none';
            statusBox.innerText = "Submission accepted but no job ID";
          }
        } catch (e) {
          uploadModal.style.display = 'none';
          loadingOverlay.style.display = 'none';
          statusBox.innerText = "‚ùå Error: " + e.message;
        }
      });
    })();
  </script>
</body>
</html>