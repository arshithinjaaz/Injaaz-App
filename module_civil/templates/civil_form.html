<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Civil Works - Site Assessment Form</title>
  <meta name="description" content="Civil works site assessment form - Works offline">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#125435">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Injaaz Civil">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
  <script src="{{ url_for('static', filename='pwa-install.js') }}" defer></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='mobile_responsive.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='photo_upload_queue.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="{{ url_for('static', filename='mobile_utils.js') }}" defer></script>
  <script src="{{ url_for('static', filename='production_logger.js') }}" defer></script>
  <script src="{{ url_for('static', filename='photo_upload_queue.js') }}"></script>
  <script src="{{ url_for('static', filename='photo_queue_ui.js') }}"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #125435;
      --primary-light: #1a7a4d;
      --primary-dark: #0d3d24;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-light: #9ca3af;
      --border-light: #e5e7eb;
      --bg-page: #fafafa;
      --white: #ffffff;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    body {
      background: var(--bg-page);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 0;
      margin: 0;
      line-height: 1.5;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Clean Navigation Bar */
    .navbar {
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 0.875rem 0;
      margin-bottom: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(18, 84, 53, 0.1);
    }
    
    .navbar-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: nowrap;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary) !important;
      text-decoration: none;
      letter-spacing: -0.5px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .navbar-brand img {
      height: 32px;
      width: auto;
    }
    
    .navbar-brand:hover {
      transform: translateY(-1px);
      opacity: 0.85;
    }
    
    .module-badge {
      font-size: 0.875rem;
      font-weight: 600;
      color: #6c757d;
      padding: 0.5rem 1rem;
      background: #f8f9fa;
      border-radius: 6px;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }
    
    .navbar-nav {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-left: auto;
      flex-wrap: nowrap;
    }
    
    .nav-btn {
      display: inline-flex;
      flex-shrink: 0;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #495057;
      background: #ffffff;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      white-space: nowrap;
      min-width: fit-content;
    }
    
    .nav-btn:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .nav-btn.prev-btn {
      color: #6c757d;
      border-color: #ced4da;
    }
    
    .nav-btn.prev-btn:hover {
      background: #6c757d;
      color: white;
      border-color: #6c757d;
    }
    
    .nav-btn.next-btn {
      color: #0d6efd;
      border-color: #0d6efd;
    }
    
    .nav-btn.next-btn:hover {
      background: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    
    @media (max-width: 768px) {
      .navbar-container {
        padding: 0.75rem 1rem;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      
      .navbar-brand {
        font-size: 1.1rem;
        flex: 0 0 auto;
      }
      
      .navbar-brand img {
        height: 28px;
      }
      
      .navbar-brand span {
        font-size: 1rem;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .module-badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
        flex: 0 0 auto;
      }
      
      .navbar-nav {
        width: 100%;
        justify-content: space-between;
        margin-left: 0;
        margin-top: 0.5rem;
        gap: 0.5rem;
        flex-wrap: nowrap;
      }
      
      .nav-btn {
        flex: 1;
        justify-content: center;
        font-size: 0.8125rem;
        padding: 0.625rem 0.75rem;
        min-height: 44px;
      }
      
      .container {
        padding: 1.25rem 1rem;
        margin: 0.75rem auto;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      .row.g-3 > [class*="col-"] {
        margin-bottom: 1rem;
      }
      
      #uploadImagesBtn,
      #submitBtn {
        width: 100%;
        margin-bottom: 0.75rem;
      }
      
      /* Form inputs */
      .form-label {
        font-size: 0.9rem;
        font-weight: 600;
      }
      
      .form-control, .form-select, textarea {
        font-size: 1rem;
        padding: 0.75rem;
        min-height: 48px;
      }
      
      textarea.form-control {
        min-height: 100px;
      }
      
      /* Buttons */
      .btn {
        min-height: 48px;
        font-size: 1rem;
        padding: 0.75rem 1.5rem;
        touch-action: manipulation;
      }
      
      .btn-sm {
        min-height: 40px;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
      }
      
      /* Work items */
      .work-item {
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .work-item h6 {
        font-size: 1rem;
        margin-bottom: 0.75rem;
      }
      
      /* Signature canvas */
      canvas {
        max-width: 100%;
        height: auto;
        min-height: 150px;
        touch-action: none;
        border: 2px solid var(--border-light);
        border-radius: 8px;
      }
      
      /* Photo preview */
      .photo-preview {
        width: 100%;
        max-width: 150px;
        height: 150px;
        object-fit: cover;
      }
      
      /* Download links container */
      #download-links-container {
        margin-top: 1.5rem;
      }
      
      #download-links-container .btn {
        width: 100%;
        margin-bottom: 0.75rem;
      }
    }
    
    @media (max-width: 480px) {
      .navbar-brand span {
        font-size: 0.9rem;
        max-width: 140px;
      }
      
      .nav-btn {
        font-size: 0.75rem;
        padding: 0.5rem;
      }
      
      .container {
        padding: 1rem 0.75rem;
      }
      
      h2 {
        font-size: 1.35rem;
      }
      
      .form-control, .form-select, textarea {
        font-size: 0.9375rem;
      }
      
      .btn {
        font-size: 0.9375rem;
        padding: 0.625rem 1.25rem;
      }
      
      .work-item {
        padding: 0.875rem;
      }
      
      .photo-preview {
        max-width: 120px;
        height: 120px;
      }
    }
    
    /* Clean, spacious container */
    .container {
      max-width: 1200px;
      width: 100%;
      background: var(--white);
      border-radius: 8px;
      padding: 2rem 2.5rem;
      box-shadow: var(--shadow-sm);
      margin: 1.5rem auto;
      border: 1px solid var(--border-light);
    }
    
    /* Minimal typography */
    h2 {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 0.375rem;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }
    
    h5 {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 1rem;
      margin-top: 2rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-light);
      letter-spacing: -0.2px;
    }
    
    .text-muted {
      color: var(--text-secondary) !important;
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    /* Minimal form labels */
    .form-label, label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.875rem;
      margin-bottom: 0.375rem;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.75rem;
    }
    
    /* Clean inputs with subtle borders */
    .form-control, .form-select, textarea {
      border: 1px solid var(--border-light);
      border-radius: 4px;
      padding: 0.625rem 0.875rem;
      transition: all 0.15s ease;
      font-size: 0.9375rem;
      background: var(--white);
      color: var(--text-primary);
    }
    
    .form-control:focus, .form-select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 84, 53, 0.06);
      outline: none;
    }
    
    /* Minimal flat buttons */
    .btn {
      border-radius: 4px;
      padding: 0.625rem 1.25rem;
      font-weight: 600;
      border: none;
      transition: all 0.15s ease;
      font-size: 0.875rem;
      letter-spacing: 0.2px;
    }
    
    .btn-primary, .btn-success {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover, .btn-success:hover {
      background: var(--primary-dark);
      box-shadow: 0 2px 8px rgba(18, 84, 53, 0.2);
    }
    
    .btn-outline-secondary {
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      background: transparent;
    }
    
    .btn-outline-secondary:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
      background: #fafafa;
    }
    
    /* Signature pad - Standardized size */
    canvas.signature-pad,
    #techSignaturePad,
    #opManSignaturePad,
    #supervisorSignaturePad,
    #businessDevSignaturePad,
    #procurementSignaturePad,
    #generalManagerSignaturePad {
      border: 2px solid var(--border-light);
      border-radius: 6px;
      width: 100% !important;
      max-width: 500px;
      height: 160px !important;
      max-height: 160px !important;
      min-height: 160px !important;
      background: #ffffff;
      cursor: crosshair;
      display: block;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      touch-action: none;
    }
    
    /* Ensure canvas doesn't stretch */
    canvas.signature-pad,
    #techSignaturePad,
    #opManSignaturePad,
    #supervisorSignaturePad,
    #businessDevSignaturePad,
    #procurementSignaturePad,
    #generalManagerSignaturePad {
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    
    .signature-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
      width: 100%;
      max-width: 500px;
    }
    
    .signature-label label {
      flex: 1;
      margin-bottom: 0;
    }
    
    .signature-hint {
      font-size: 0.75rem;
      color: var(--text-light);
      font-weight: 400;
      white-space: nowrap;
      flex-shrink: 0;
      text-align: right;
    }
    
    /* Ensure signature container properly wraps label and pad */
    .signature-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 500px;
    }
    
    .alert {
      border-radius: 4px;
      border: none;
      font-size: 0.875rem;
      padding: 0.875rem 1rem;
    }
    
    #statusBox {
      padding: 1rem;
      border-radius: 4px;
      background: var(--bg-page);
      border: 1px solid var(--border-light);
      margin-top: 1rem;
    }
    
    /* Upload Progress Modal */
    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .upload-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .upload-progress-bar {
      height: 30px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .upload-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #125435, #1a7a4f);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    /* Photo Preview Container */
    .photo-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 1rem;
      padding: 0.5rem;
      border: 1px dashed var(--border-light);
      border-radius: 4px;
      min-height: 60px;
    }
    
    .photo-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 4px;
      overflow: hidden;
      border: 2px solid var(--border-light);
    }
    
    .photo-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-preview-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #dc3545;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .photo-preview-remove:hover {
      background: #c82333;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #e9ecef;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 1.5rem;
      font-size: 1.125rem;
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .loading-subtitle {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    /* Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border-light);
      border-radius: 4px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: var(--primary);
      background: #f8faf9;
    }
    
    .drop-zone-content {
      color: var(--text-secondary);
      font-size: 0.9375rem;
    }
    
    .drop-zone-content strong {
      display: block;
      color: var(--text-primary);
      margin-bottom: 0.375rem;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .drop-zone-content small {
      display: block;
      font-size: 0.8125rem;
      margin-top: 0.375rem;
      color: var(--text-light);
    }
    
    .photo-count {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      background: #e9ecef;
      border-radius: 4px;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }
    
    .photo-count.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .photo-count.danger {
      background: #f8d7da;
      color: #721c24;
    }
    
    .file-warning {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }
    
    .upload-progress {
      margin-top: 0.875rem;
      display: none;
    }
    
    /* Tabs styling */
    .nav-tabs {
      border-bottom: 1px solid var(--border-light);
      margin-bottom: 2rem;
    }
    
    .nav-tabs .nav-link {
      color: var(--text-secondary);
      border: none;
      border-bottom: 2px solid transparent;
      padding: 0.75rem 1rem;
      margin-right: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.15s ease;
    }
    
    .nav-tabs .nav-link.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background-color: transparent;
      font-weight: 600;
    }
    
    .nav-tabs .nav-link:hover {
      color: var(--text-primary);
      border-bottom-color: var(--border-light);
    }
    
    /* Work Items Table - Better alignment and spacing */
    .table {
      font-size: 0.875rem;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .table th {
      background: #f8faf9;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-light);
      padding: 0.875rem 0.75rem;
      text-align: center;
      vertical-align: middle;
      white-space: normal;
      overflow-wrap: anywhere;
    }
    
    .table td {
      vertical-align: middle;
      padding: 0.75rem 0.5rem;
      text-align: center;
    }
    
    .table td input,
    .table td textarea,
    .table td select {
      width: 100%;
      min-width: 0;
    }

    /* Make the work-items table fit the container without horizontal scrolling */
    .work-items-table-wrap {
      width: 100%;
      overflow-x: hidden;
      overflow-y: auto;
      max-height: 300px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      background: var(--white);
      margin-bottom: 1rem;
    }

    /* Work Items: each work asset is a block containing two tables */
    #workItemsContainer {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 0.75rem;
    }

    .work-item-block {
      position: relative;
      border: 1px solid var(--border-light);
      border-radius: 10px;
      background: var(--white);
      padding: 0.9rem 1rem 0.4rem;
    }

    .work-item-block::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--primary);
      opacity: 0.8;
    }

    .work-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding-left: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .work-item-title {
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.2px;
    }

    .work-item-meta {
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* Linked highlight across both tables inside a block */
    .work-items-table tbody tr.row-active {
      background: rgba(18, 84, 53, 0.07) !important;
    }

    .work-items-table tbody tr.row-active td {
      box-shadow: inset 0 0 0 1px rgba(18, 84, 53, 0.18);
    }

    .work-item-block.active {
      box-shadow: 0 0 0 3px rgba(18, 84, 53, 0.08);
      border-color: rgba(18, 84, 53, 0.25);
    }

    .work-items-table {
      width: 100%;
      table-layout: fixed;
      margin-bottom: 0;
    }

    .work-items-table thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #f8faf9;
    }

    .work-items-table tbody tr:nth-child(even) {
      background: #fbfcfd;
    }

    .work-items-table tbody tr:hover {
      background: #f1f5f9;
    }

    .work-items-table th,
    .work-items-table td {
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .work-items-table th:nth-child(1),
    .work-items-table th:last-child {
      white-space: nowrap;
      word-break: normal;
    }

    .work-items-table .form-control-sm {
      background: var(--white);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 0.45rem 0.6rem;
    }

    .work-items-table textarea.form-control-sm {
      min-height: 42px;
    }

    .work-items-table textarea {
      resize: vertical;
    }

    .work-items-section-title {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.9rem;
      margin: 0.75rem 0 0.5rem;
    }
    
    .table td:first-child {
      text-align: center;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .form-control-sm {
      font-size: 0.8125rem;
      padding: 0.5rem 0.625rem;
      text-align: left;
    }
    
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 1.5rem;
    }
    
    /* Button states */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
      border-width: 0.15em;
    }
    
    .gap-2 {
      gap: 0.5rem;
    }
    
    .d-flex {
      display: flex;
    }
    
    .d-none {
      display: none !important;
    }
    
    .ms-2 {
      margin-left: 0.5rem;
    }
    
    .mb-3 {
      margin-bottom: 1rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1.5rem 1.25rem;
        margin: 1rem;
        border-radius: 6px;
      }
      
      .navbar-container {
        padding: 0 1.25rem;
      }
      
      .d-flex {
        flex-direction: column;
      }
      
      .gap-2 > * {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-container">
      <a class="navbar-brand" href="/dashboard">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Injaaz">
        <span>Injaaz</span>
      </a>
      <div class="module-badge">Civil Works</div>
      <div class="navbar-nav">
        {% if is_edit_mode %}
        <a href="/dashboard" class="nav-btn next-btn">← Back to Dashboard</a>
        {% else %}
        <a href="/hvac-mep/form" class="nav-btn prev-btn">← Previous</a>
        <a href="/cleaning/form" class="nav-btn next-btn">Next →</a>
        {% endif %}
      </div>
    </div>
  </nav>
  
  <div class="container">
    <h2>Site Inspection Report - Civil{% if is_edit_mode %} - Edit Mode{% endif %}</h2>
    <p class="text-muted">
      {% if is_supervisor_edit %}
      Review the inspector's submission below. You can edit any fields, add new items, add your comments, verify, and sign to approve.
      {% elif is_edit_mode %}
      Review and edit the submission below. Signatures cannot be modified.
      {% else %}
      Complete the inspection form below
      {% endif %}
    </p>

    <form id="mainForm" novalidate>
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs" id="civilTabs" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="tab-1-link" data-bs-toggle="tab" data-bs-target="#tab-1" type="button" role="tab">1. Project Info</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="tab-2-link" data-bs-toggle="tab" data-bs-target="#tab-2" type="button" role="tab">2. Work Items</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="tab-3-link" data-bs-toggle="tab" data-bs-target="#tab-3" type="button" role="tab">3. Photos & Time</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="tab-4-link" data-bs-toggle="tab" data-bs-target="#tab-4" type="button" role="tab">4. Sign-off & Submit</button></li>
      </ul>

      <div class="tab-content" id="civilTabContent">
        <!-- TAB 1: Project Information -->
        <div class="tab-pane fade show active" id="tab-1" role="tabpanel">
          <h5>Project Information</h5>
      <div class="row g-3">
        <div class="col-md-6 mb-3">
          <label for="date">Date</label>
          <input id="date" name="date" type="date" class="form-control" {% if not is_supervisor_edit %}required{% endif %} max="">
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="project_name">Project Name</label>
          <input id="project_name" name="project_name" class="form-control" {% if not is_supervisor_edit %}required{% endif %}>
        </div>
        
        <div class="col-12 mb-3">
          <label for="description_of_work">Description of Work</label>
          <textarea id="description_of_work" name="description_of_work" class="form-control" rows="2"></textarea>
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="area">Area</label>
          <select id="area" name="area" class="form-control" onchange="handleAreaChange()">
            <option value="">Select Area</option>
            <option value="General">General</option>
            <option value="Basement">Basement</option>
            <option value="Floor">Floor</option>
            <option value="Parking">Parking</option>
            <option value="Rooftop">Rooftop</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div class="col-md-6 mb-3" id="area_other_container" style="display: none;">
          <label for="area_other">Specify Other Area</label>
          <input id="area_other" name="area_other" class="form-control" placeholder="Enter area name">
        </div>
      </div>
      
      <div class="d-flex justify-content-end mt-4">
        <button type="button" class="btn btn-primary" onclick="goToTab(2)">Next →</button>
      </div>
    </div>
    
    <!-- TAB 2: Work Items -->
    <div class="tab-pane fade" id="tab-2" role="tabpanel">
      <h5>Work Items</h5>
      {% if is_supervisor_edit %}
      <p class="text-muted" style="font-size: 0.9rem;">Review and edit the work items submitted by the inspector below. You can modify fields or add new items.</p>
      {% endif %}
      <div class="mb-3">
        <button type="button" id="addRowBtn" class="btn btn-outline-secondary btn-sm">+ Add Work Item</button>
      </div>
      
      <div id="workItemsContainer" aria-label="Work items">
        <div class="work-item-block" data-index="1">
          <div class="work-item-header">
            <div>
              <div class="work-item-title">Work Item 1</div>
              <div class="work-item-meta">Details + Pricing</div>
            </div>
          </div>

          <div class="work-items-section-title">Work Item Details</div>
          <div class="work-items-table-wrap">
            <table class="table table-bordered work-items-table">
              <colgroup>
                <col style="width: 56px;">
                <col style="width: 28%;">
                <col style="width: 10%;">
                <col style="width: 32%;">
                <col style="width: 10%;">
                <col style="width: 20%;">
              </colgroup>
              <thead>
                <tr>
                  <th>SN</th>
                  <th>Work Description</th>
                  <th>Qty</th>
                  <th>Material Required with Brand</th>
                  <th>Qty</th>
                  <th>Specification</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="work-item-sn">1</td>
                  <td><input type="text" class="form-control form-control-sm" name="work_desc[]"></td>
                  <td><input type="number" class="form-control form-control-sm" name="work_qty[]"></td>
                  <td><input type="text" class="form-control form-control-sm" name="material[]"></td>
                  <td><input type="number" class="form-control form-control-sm" name="material_qty[]"></td>
                  <td><input type="text" class="form-control form-control-sm" name="specification[]"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="work-items-section-title">Pricing & Comments</div>
          <div class="work-items-table-wrap">
            <table class="table table-bordered work-items-table">
              <colgroup>
                <col style="width: 56px;">
                <col style="width: 14%;">
                <col style="width: 14%;">
                <col style="width: 22%;">
                <col style="width: 40%;">
                <col style="width: 76px;">
              </colgroup>
              <thead>
                <tr>
                  <th>SN</th>
                  <th>Unit Price</th>
                  <th>Price</th>
                  <th>Labour Needed (Hours/Day)</th>
                  <th>Comments</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="work-item-sn">1</td>
                  <td><input type="number" class="form-control form-control-sm" name="unit_price[]" step="0.01" placeholder="Unit"></td>
                  <td><input type="number" class="form-control form-control-sm" name="price[]" step="0.01"></td>
                  <td><input type="text" class="form-control form-control-sm" name="labour[]"></td>
                  <td><textarea class="form-control form-control-sm" name="comments[]" rows="2"></textarea></td>
                  <td><button type="button" class="btn btn-sm btn-outline-danger remove-work-item" title="Remove work item">×</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-outline-secondary" onclick="goToTab(1)">← Previous</button>
        <button type="button" class="btn btn-primary" onclick="goToTab(3)">Next →</button>
      </div>
    </div>
    
    <!-- TAB 3: Photos & Time Estimate -->
    <div class="tab-pane fade" id="tab-3" role="tabpanel">
      <h5>Pictures from Site</h5>
      
      <!-- Photos - Matching HVAC structure exactly -->
      <div class="col-12 mb-3">
        <label class="form-label">Photos (Maximum 100)</label>
        <input id="curPhotos" type="file" class="form-control d-none" accept="image/*" multiple>
        
        <div id="dropZone" class="drop-zone">
          <div class="drop-zone-content">
            <strong>Drag and drop images here</strong>
            <small>or click to browse • Maximum 100 images • Auto-compressed to 1280px • Max 10MB per file</small>
          </div>
        </div>
        
        <div id="fileWarning" class="file-warning">
          ⚠️ Some files are larger than 10MB and will be skipped
        </div>
        
        <div id="uploadProgress" class="upload-progress">
          <div class="progress">
            <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 0%"></div>
          </div>
        </div>
        
        <div id="photoCount" class="photo-count alert alert-info" style="display:none; padding: 0.5rem 1rem; margin-top: 0.5rem; border-radius: 4px; font-weight: 600; background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460;"></div>
        
        <!-- Photo Preview Container with Remove Buttons -->
        <div id="photoPreviewContainer" class="photo-preview-container" style="display:none; min-height: 140px;"></div>
      </div>
      
      
      <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-outline-secondary" onclick="goToTab(2)">← Previous</button>
        <button type="button" class="btn btn-primary" onclick="goToTab(4)">Next →</button>
      </div>
    </div>
    
    <!-- TAB 4: Sign-off & Submit -->
    <div class="tab-pane fade" id="tab-4" role="tabpanel">
      <h5>Inspector & Manager Sign-off</h5>
      
      <div class="row g-3 mb-4">
        <div class="col-md-6 mb-3">
          <label for="inspector_name">Name of Inspector</label>
          <input id="inspector_name" name="inspector_name" class="form-control" placeholder="Inspector name">
        </div>
        <div class="col-md-6"></div>
      </div>

      {% if user_designation == 'technician' and not is_edit_mode %}
      <div class="alert alert-info" role="alert" style="font-weight: 600; margin-bottom: 1rem;">
        Supervisor submissions only require your signature. Manager approval will be collected during review workflow.
      </div>
      {% elif is_supervisor_edit %}
      <div class="alert alert-warning" role="alert" style="font-weight: 600; margin-bottom: 1rem;">
        Inspector signature is locked. Review and add your approval notes before updating.
      </div>
      {% endif %}
      
      <div class="row g-3">
        <div class="col-md-6 mb-3">
          <div class="signature-container">
            <div class="signature-label">
              <label class="form-label mb-0" style="flex: 1;">Inspector Signature</label>
              {% if is_supervisor_edit %}
              <span class="signature-hint" style="color: #059669; font-weight: 600;">✓ Inspector has signed</span>
              {% else %}
              <span class="signature-hint">Draw signature with mouse/touch</span>
              {% endif %}
            </div>
          {% if is_supervisor_edit %}
          <!-- Show inspector signature as read-only image when supervisor/manager views -->
          {% set tech_sig = submission_data.form_data.inspector_signature if submission_data and submission_data.form_data and submission_data.form_data.inspector_signature else none %}
          {% set tech_sig_url = tech_sig.url if tech_sig is mapping and tech_sig.url else (tech_sig if tech_sig is string else none) %}
          <div id="techSignatureDisplay" style="border: 1px solid #e5e7eb; background: #f9fafb; padding: 10px; border-radius: 4px; min-height: 150px; display: flex; align-items: center; justify-content: center; max-width: 500px;">
            {% if tech_sig_url %}
            <img src="{{ tech_sig_url }}" alt="Inspector Signature" style="width: 100%; max-width: 500px; max-height: 150px; object-fit: contain; border-radius: 4px;">
            {% else %}
            <span class="text-muted">Inspector Signature (Read-only)</span>
            {% endif %}
          </div>
          {% else %}
            <canvas id="techSignaturePad" class="signature-pad"></canvas>
            <input type="hidden" id="techSignatureData" name="tech_signature">
            <button type="button" id="clearTech" class="btn btn-outline-secondary btn-sm mt-2">Clear</button>
          {% endif %}
          </div>
        </div>

        {% if is_supervisor_edit or user_designation == 'supervisor' %}
        <!-- Supervisor Review Section -->
        <div class="col-12 mb-3" style="border-top: 2px solid var(--primary); padding-top: 1.5rem; margin-top: 1rem;">
          <h5 style="color: var(--primary); margin-bottom: 1rem;">Supervisor Review</h5>
          
          <div class="col-12 mb-3">
            <label class="form-label">Supervisor Comments</label>
            <textarea id="supervisorComments" class="form-control" rows="3" placeholder="Enter your comments or observations..."></textarea>
          </div>
          
          <div class="col-12 mb-3">
            <button type="button" id="verifiedBtn" class="btn btn-success">
              <span id="verifiedBtnIcon">✓</span> Verified
            </button>
            <span id="verifiedStatus" class="ms-2" style="display: none; color: #059669; font-weight: 600;">✓ Verified</span>
          </div>
          
          <div class="col-md-6 mb-3">
            <div class="signature-container">
              <div class="signature-label">
                <label class="form-label mb-0" style="flex: 1;">Supervisor Signature</label>
                <span class="signature-hint" style="color: var(--primary); font-weight: 600;">Required for approval</span>
              </div>
              <canvas id="supervisorSignaturePad" class="signature-pad"></canvas>
              <input type="hidden" id="supervisorSignatureData" name="supervisor_signature">
              <button type="button" id="clearSupervisor" class="btn btn-outline-secondary btn-sm mt-2">Clear</button>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'operations_manager' and is_edit_mode %}
        <!-- Previous Reviewers: Supervisor (Read-only for OM) -->
        <div class="col-12 mb-4" id="previousForOMSection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Supervisor -->
          <div id="supervisorReadOnlyOM" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Supervisor Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Supervisor Comments</label>
                <div id="supervisorCommentsReadOnlyOM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Supervisor Signature</label>
                <div id="supervisorSignatureReadOnlyOM" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Operations Manager Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-lg-7 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Comments</label>
              <textarea id="operationsManagerComments" class="form-control" rows="6" style="border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-lg-5 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Operations Manager Signature</label>
                  <span class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="opManSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="opManSignatureData" name="opMan_signature">
                <button type="button" id="clearOp" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'business_development' and is_edit_mode %}
        <!-- Previous Reviewers: Operations Manager + Procurement (Read-only for BD) -->
        <div class="col-12 mb-4" id="previousForBDSection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlySection" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Comments</label>
                <div id="opsManagerCommentsReadOnly" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Signature</label>
                <div id="opsManagerSignatureReadOnly" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Procurement (so BD can see if PO has signed) -->
          <div id="procurementReadOnlyBD" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Procurement Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Comments</label>
                <div id="procurementCommentsReadOnlyBD" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Signature</label>
                <div id="procurementSignatureReadOnlyBD" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Business Development Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-lg-7 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Business Development Comments</label>
              <textarea id="businessDevComments" class="form-control" rows="6" style="border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-lg-5 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Business Development Signature</label>
                  <span class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="businessDevSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="businessDevSignatureData" name="business_dev_signature">
                <button type="button" id="clearBusinessDev" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'procurement' and is_edit_mode %}
        <!-- Previous Reviewers: Operations Manager + Business Development (Read-only for Procurement) -->
        <div class="col-12 mb-4" id="previousForProcurementSection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlyProc" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="opsManagerCommentsReadOnlyProc" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="opsManagerSignatureReadOnlyProc" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Business Development -->
          <div id="bdReadOnlyProc" style="display: none;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Business Development Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="bdCommentsReadOnlyProc" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="bdSignatureReadOnlyProc" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Procurement Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-lg-7 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Comments</label>
              <textarea id="procurementComments" class="form-control" rows="6" style="border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-lg-5 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Procurement Signature</label>
                  <span class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="procurementSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="procurementSignatureData" name="procurement_signature">
                <button type="button" id="clearProcurement" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'general_manager' and is_edit_mode %}
        <!-- Previous Reviewers: Operations Manager, BD, Procurement (Read-only for GM) -->
        <div class="col-12 mb-4" id="previousReviewersReadOnlySection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlyGM" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="opsManagerCommentsReadOnlyGM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="opsManagerSignatureReadOnlyGM" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px;"></div>
              </div>
            </div>
          </div>
          
          <!-- Business Development -->
          <div id="bdReadOnlyGM" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Business Development Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="bdCommentsReadOnlyGM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="bdSignatureReadOnlyGM" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px;"></div>
              </div>
            </div>
          </div>
          
          <!-- Procurement -->
          <div id="procurementReadOnlyGM" style="display: none; margin-bottom: 2rem;">
            <h6 class="fw-bold mb-2" style="color: #0ea5e9;">Procurement Review</h6>
            <div class="row">
              <div class="col-lg-7 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="procurementCommentsReadOnlyGM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 80px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-lg-5 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="procurementSignatureReadOnlyGM" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- General Manager Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-lg-7 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">General Manager Comments</label>
              <textarea id="generalManagerComments" class="form-control" rows="6" style="border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-lg-5 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">General Manager Signature</label>
                  <span class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="generalManagerSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="generalManagerSignatureData" name="general_manager_signature">
                <button type="button" id="clearGeneralManager" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'manager' or (is_edit_mode and user_designation == 'manager') %}
        <div class="col-md-6 mb-3" id="managerSignatureContainer">
          <div class="signature-container">
            <div class="signature-label">
              <label class="form-label mb-0" style="flex: 1;">Manager Approval Signature</label>
              {% if is_supervisor_edit %}
              <span class="signature-hint" style="color: var(--primary); font-weight: 600;">Sign as Manager</span>
              {% else %}
              <span class="signature-hint">Draw signature with mouse/touch</span>
              {% endif %}
            </div>
            <canvas id="opManSignaturePad" class="signature-pad"></canvas>
            <button type="button" id="clearOp" class="btn btn-outline-secondary btn-sm mt-2">Clear</button>
          </div>
        </div>
        {% elif user_designation != 'technician' or is_edit_mode %}
        <div class="col-md-6 mb-3" id="managerSignatureContainer">
          <div class="signature-container">
            <div class="signature-label">
              <label class="form-label mb-0" style="flex: 1;">Manager Approval Signature</label>
              {% if is_supervisor_edit %}
              <span class="signature-hint" style="color: var(--primary); font-weight: 600;">Sign as Manager</span>
              {% else %}
              <span class="signature-hint">Draw signature with mouse/touch</span>
              {% endif %}
            </div>
            <canvas id="opManSignaturePad" class="signature-pad"></canvas>
            <button type="button" id="clearOp" class="btn btn-outline-secondary btn-sm mt-2">Clear</button>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="d-flex justify-content-between align-items-center gap-2 mb-3">
        <button type="button" class="btn btn-outline-secondary" onclick="goToTab(3)">← Previous</button>
        <div class="d-flex gap-2">
          <button type="button" id="uploadImagesBtn" class="btn btn-success btn-lg">
            <span id="uploadImagesBtnText">📤 Upload Images</span>
          <span id="uploadImagesBtnSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
        </button>
        <button type="button" id="submitBtn" class="btn btn-primary btn-lg" disabled>
          <span id="submitBtnText">{% if is_edit_mode %}Update Submission{% else %}📄 Generate Reports{% endif %}</span>
        </button>
        </div>
      </div>
      <div id="uploadStatus" class="alert alert-info d-none mb-3"></div>
      <div id="statusBox" class="mt-3"></div>
      
      <!-- Download Links Container - appears below submit button -->
      <div id="download-links-container" style="display: none; margin-top: 1.5rem;"></div>
    </div>
    <!-- End TAB 4 -->
    
    </div>
    <!-- End tab-content -->
    </form>
  </div>

  <!-- Upload Progress Modal -->
  <div id="uploadModal" class="upload-modal">
    <div class="upload-modal-content">
      <h4 style="margin-bottom: 1rem;">Uploading Photos</h4>
      <div id="uploadModalText" style="margin-bottom: 1rem; color: #666;">
        Preparing images...
      </div>
      <div class="upload-progress-bar">
        <div id="uploadModalProgress" class="upload-progress-fill" style="width: 0%">
          0%
        </div>
      </div>
      <small style="color: #999; display: block; margin-top: 0.5rem;">Please wait, this may take a few minutes for large batches</small>
    </div>
  </div>

  <!-- Loading Overlay for Report Generation -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Generating Reports...</div>
    <div class="loading-subtitle">This typically takes 2-3 minutes for large submissions</div>
    <div class="loading-subtitle" style="margin-top: 1.5rem; font-size: 0.8rem;">Creating Excel and PDF reports with all photos</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="{{ url_for('static', filename='dropdown_init.js') }}"></script>
  <script src="{{ url_for('static', filename='form.js') }}"></script>
  
  <script>
    // ALWAYS define pollJobStatus globally to ensure it's available
    // This will override form.js if it loaded, or serve as fallback if it didn't
    window.pollJobStatus = window.pollJobStatus || async function(modulePrefix, jobId, onUpdate, interval=1500) {
      const statusUrl = `${modulePrefix}/status/${jobId}`;
      return new Promise((resolve, reject) => {
        const id = setInterval(async () => {
          try {
            const r = await fetch(statusUrl);
            if (!r.ok) throw new Error('Job not found');
            const js = await r.json();
            if (onUpdate) onUpdate(js);
            // Check both 'state' (legacy) and 'status' (current)
            const isDone = js.state === 'done' || js.status === 'completed';
            const isFailed = js.state === 'failed' || js.status === 'failed';
            if (isDone || isFailed) {
              clearInterval(id);
              resolve(js);
            }
          } catch (e) {
            clearInterval(id);
            reject(e);
          }
        }, interval);
      });
    };
    
    // Also define it without window prefix for compatibility
    if (typeof pollJobStatus === 'undefined') {
      var pollJobStatus = window.pollJobStatus;
    }
    
    if (window.safeLog) {
      window.safeLog.log('✅ pollJobStatus is now available globally');
    }
  </script>

  <script>
    const modulePrefix = "{{ url_for('civil_bp.index') }}".replace('/form','');
    const MAX_PHOTOS = 100;
    const MAX_IMAGE_DIMENSION = 1280;
    const JPEG_QUALITY = 0.85;
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    const DRAFT_SAVE_INTERVAL = 30000; // 30 seconds

    // Tab navigation function
    function goToTab(tabNumber) {
      const tabLink = document.getElementById(`tab-${tabNumber}-link`);
      if (tabLink) {
        tabLink.click();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }
    
    // Handle Area dropdown - show/hide "Other" text field
    function handleAreaChange() {
      const areaSelect = document.getElementById('area');
      const otherContainer = document.getElementById('area_other_container');
      const otherInput = document.getElementById('area_other');
      
      if (areaSelect.value === 'Other') {
        otherContainer.style.display = 'block';
        otherInput.required = true;
      } else {
        otherContainer.style.display = 'none';
        otherInput.required = false;
        otherInput.value = '';
      }
    }

    // Define initSignaturePads if not already defined in form.js
    function initSignaturePads() {
      if (typeof SignaturePad === 'undefined') {
        console.error('❌ SignaturePad library not loaded. Signature capture disabled.');
        return { techPad: null, opPad: null, supervisorPad: null, tech: null, op: null };
      }

      const techPadEl = document.getElementById('techSignaturePad');
      const opPadEl = document.getElementById('opManSignaturePad');
      const supervisorPadEl = document.getElementById('supervisorSignaturePad');
      
      function setupSignaturePad(canvas, padName) {
        if (!canvas) return null;
        
        const pad = new SignaturePad(canvas, {
          backgroundColor: 'rgb(255, 255, 255)',
          penColor: 'rgb(0, 0, 0)',
          minWidth: 1,
          maxWidth: 3,
          throttle: 16
        });
        
        // Properly resize canvas to prevent stretching
        function resizeCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const rect = canvas.getBoundingClientRect();

          // If this canvas is in a hidden tab, it may report 0x0.
          // We'll retry resizing when the Sign-off tab is shown.
          if (!rect.width || !rect.height) {
            pad._needsResize = true;
            return;
          }
          
          // Set display size
          canvas.style.width = rect.width + 'px';
          canvas.style.height = rect.height + 'px';
          
          // Set actual size in memory (scaled for DPI)
          canvas.width = rect.width * ratio;
          canvas.height = rect.height * ratio;
          
          // Scale the drawing context so everything draws at correct size
          const ctx = canvas.getContext('2d');
          ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
          
          // Redraw signature if it exists
          if (!pad.isEmpty()) {
            const data = pad.toData();
            pad.clear();
            pad.fromData(data);
          }

          pad._needsResize = false;
        }
        
        // Initial resize
        resizeCanvas();
        
        // Resize on window resize
        window.addEventListener('resize', resizeCanvas);

        // Expose resize hook so we can resize when the tab becomes visible
        pad._resizeCanvas = resizeCanvas;
        pad._needsResize = false;
        
        return pad;
      }
      
      const techPad = setupSignaturePad(techPadEl, 'tech');
      const opPad = setupSignaturePad(opPadEl, 'op');
      const supervisorPad = setupSignaturePad(supervisorPadEl, 'supervisor');
      const businessDevPadEl = document.getElementById('businessDevSignaturePad');
      const procurementPadEl = document.getElementById('procurementSignaturePad');
      const generalManagerPadEl = document.getElementById('generalManagerSignaturePad');
      const businessDevPad = setupSignaturePad(businessDevPadEl, 'businessDev');
      const procurementPad = setupSignaturePad(procurementPadEl, 'procurement');
      const generalManagerPad = setupSignaturePad(generalManagerPadEl, 'generalManager');
      
      if (techPad) {
        const clearTechBtn = document.getElementById('clearTech');
        if (clearTechBtn) {
          clearTechBtn.addEventListener('click', () => {
            techPad.clear();
            const techSigInput = document.getElementById('techSignatureData');
            if (techSigInput) techSigInput.value = '';
          });
        }
      }
      if (opPad) {
        const clearOpBtn = document.getElementById('clearOp');
        if (clearOpBtn) {
          clearOpBtn.addEventListener('click', () => {
            opPad.clear();
            const opSigInput = document.getElementById('opManSignatureData');
            if (opSigInput) opSigInput.value = '';
          });
        }
      }
      if (supervisorPad) {
        const clearSupervisorBtn = document.getElementById('clearSupervisor');
        if (clearSupervisorBtn) {
          clearSupervisorBtn.addEventListener('click', () => {
            supervisorPad.clear();
            const supervisorSigInput = document.getElementById('supervisorSignatureData');
            if (supervisorSigInput) supervisorSigInput.value = '';
          });
        }
      }
      if (businessDevPad) {
        const clearBusinessDevBtn = document.getElementById('clearBusinessDev');
        if (clearBusinessDevBtn) {
          clearBusinessDevBtn.addEventListener('click', () => {
            businessDevPad.clear();
            const businessDevSigInput = document.getElementById('businessDevSignatureData');
            if (businessDevSigInput) businessDevSigInput.value = '';
          });
        }
      }
      if (procurementPad) {
        const clearProcurementBtn = document.getElementById('clearProcurement');
        if (clearProcurementBtn) {
          clearProcurementBtn.addEventListener('click', () => {
            procurementPad.clear();
            const procurementSigInput = document.getElementById('procurementSignatureData');
            if (procurementSigInput) procurementSigInput.value = '';
          });
        }
      }
      if (generalManagerPad) {
        const clearGeneralManagerBtn = document.getElementById('clearGeneralManager');
        if (clearGeneralManagerBtn) {
          clearGeneralManagerBtn.addEventListener('click', () => {
            generalManagerPad.clear();
            const generalManagerSigInput = document.getElementById('generalManagerSignatureData');
            if (generalManagerSigInput) generalManagerSigInput.value = '';
          });
        }
      }

      return { techPad, opPad, supervisorPad, businessDevPad, procurementPad, generalManagerPad, tech: techPad, op: opPad };
    }
    
    // Define checkBrowserSupport function
    function checkBrowserSupport() {
      return !!(window.FileReader && window.File && window.FileList && window.Blob);
    }

    (function(){
      // Ensure pollJobStatus is available inside this IIFE
      // Use window.pollJobStatus if available, otherwise define it inline
      const pollJobStatusFn = (typeof window !== 'undefined' && window.pollJobStatus) 
        ? window.pollJobStatus 
        : async function(modulePrefix, jobId, onUpdate, interval=1500) {
            const statusUrl = `${modulePrefix}/status/${jobId}`;
            return new Promise((resolve, reject) => {
              const id = setInterval(async () => {
                try {
                  const r = await fetch(statusUrl);
                  if (!r.ok) throw new Error('Job not found');
                  const js = await r.json();
                  if (onUpdate) onUpdate(js);
                  const isDone = js.state === 'done' || js.status === 'completed';
                  const isFailed = js.state === 'failed' || js.status === 'failed';
                  if (isDone || isFailed) {
                    clearInterval(id);
                    resolve(js);
                  }
                } catch (e) {
                  clearInterval(id);
                  reject(e);
                }
              }, interval);
            });
          };
      
      // Make it available globally as well
      if (typeof window !== 'undefined') {
        window.pollJobStatusFn = pollJobStatusFn;
      }
      
      const form = document.getElementById('mainForm');
      const statusBox = document.getElementById('statusBox');
      const curPhotos = document.getElementById('curPhotos');
      const dropZone = document.getElementById('dropZone');
      const photoPreviewContainer = document.getElementById('photoPreviewContainer');
      const photoCount = document.getElementById('photoCount');
      const fileWarning = document.getElementById('fileWarning');
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadModal = document.getElementById('uploadModal');
      const uploadModalText = document.getElementById('uploadModalText');
      const uploadModalProgress = document.getElementById('uploadModalProgress');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const uploadImagesBtn = document.getElementById('uploadImagesBtn');
      const uploadImagesBtnText = document.getElementById('uploadImagesBtnText');
      const uploadImagesBtnSpinner = document.getElementById('uploadImagesBtnSpinner');
      const uploadStatus = document.getElementById('uploadStatus');
      const submitBtn = document.getElementById('submitBtn');
      const submitBtnText = document.getElementById('submitBtnText');
      
      // Verified button handler (for supervisor)
      const verifiedBtn = document.getElementById('verifiedBtn');
      const verifiedStatus = document.getElementById('verifiedStatus');
      let isVerified = false;
      
      if (verifiedBtn) {
        verifiedBtn.addEventListener('click', () => {
          isVerified = !isVerified;
          if (isVerified) {
            verifiedBtn.classList.remove('btn-success');
            verifiedBtn.classList.add('btn-outline-success');
            verifiedBtn.innerHTML = '<span id="verifiedBtnIcon">✓</span> Verified';
            if (verifiedStatus) {
              verifiedStatus.style.display = 'inline';
              verifiedStatus.textContent = '✓ Verified';
            }
          } else {
            verifiedBtn.classList.remove('btn-outline-success');
            verifiedBtn.classList.add('btn-success');
            verifiedBtn.innerHTML = '<span id="verifiedBtnIcon">✓</span> Verify';
            if (verifiedStatus) {
              verifiedStatus.style.display = 'none';
            }
          }
        });
      }
      
      // Track uploaded photos
      let photosUploaded = false;
      let uploadedPhotoUrls = [];
      
      // Initialize signature pads after DOM is fully loaded
      let pads = null;
      document.addEventListener('DOMContentLoaded', function() {
        pads = initSignaturePads();
        // Make pads available globally
        window.signaturePads = pads;
        window.pads = pads;
        
        console.log('Signature pads initialized:', pads);

        // When the Sign-off tab becomes visible, resize canvases (Bootstrap tabs hide them by default)
        const tab4Link = document.getElementById('tab-4-link');
        if (tab4Link) {
          tab4Link.addEventListener('shown.bs.tab', () => {
            if (!pads) {
              pads = initSignaturePads();
              window.signaturePads = pads;
              window.pads = pads;
            }

            ['techPad', 'opPad', 'supervisorPad'].forEach((key) => {
              const pad = pads && pads[key];
              if (pad && typeof pad._resizeCanvas === 'function') {
                pad._resizeCanvas();
              }
            });
          });
        }
      });
      
      // Also try immediate initialization in case DOMContentLoaded already fired
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(function() {
          if (!pads) {
            pads = initSignaturePads();
            window.signaturePads = pads;
            window.pads = pads;
            console.log('Signature pads initialized (immediate):', pads);
          }
        }, 100);
      }

      // Load submission data if in edit mode
      function loadSubmissionData() {
        {% if is_edit_mode and submission_data %}
        try {
          const submissionData = {{ submission_data|tojson }};
          const formData = submissionData.form_data || {};
          
          // Pre-fill basic fields
          if (submissionData.site_name) {
            const projectNameField = document.getElementById('project_name');
            if (projectNameField) projectNameField.value = submissionData.site_name;
          }
          if (submissionData.visit_date) {
            const dateField = document.getElementById('date');
            if (dateField) dateField.value = submissionData.visit_date;
          }
          
          // Load other fields from formData (guarded; some legacy fields were removed)
          ['inspector_name', 'description_of_work'].forEach(field => {
            const fieldEl = document.getElementById(field);
            if (fieldEl && formData[field]) {
              fieldEl.value = formData[field];
            }
          });

          // Area dropdown (replaces old location/floor/developer/city_area inputs)
          const areaEl = document.getElementById('area');
          const areaOtherEl = document.getElementById('area_other');
          const areaOtherContainer = document.getElementById('area_other_container');
          if (areaEl && formData.area) {
            areaEl.value = formData.area;
          }
          if (areaOtherEl && formData.area_other) {
            areaOtherEl.value = formData.area_other;
          }
          if (areaEl && areaOtherContainer && areaOtherEl) {
            if (areaEl.value === 'Other') {
              areaOtherContainer.style.display = 'block';
              areaOtherEl.required = true;
            } else {
              areaOtherContainer.style.display = 'none';
              areaOtherEl.required = false;
            }
          }
          
          // Load photo URLs
          if (formData.photo_urls && Array.isArray(formData.photo_urls)) {
            uploadedPhotoUrls = formData.photo_urls;
            photosUploaded = uploadedPhotoUrls.length > 0;
            if (photosUploaded) {
              updatePhotoCount();
            }
          }

          // Load work items into the new block-based UI
          if (Array.isArray(formData.work_items)) {
            const container = document.getElementById('workItemsContainer');
            if (container) {
              const template = container.querySelector('.work-item-block');
              const templateClone = template ? template.cloneNode(true) : null;
              container.innerHTML = '';

              const ensureTemplate = () => {
                if (templateClone) {
                  const c = templateClone.cloneNode(true);
                  // clear all values
                  c.querySelectorAll('input').forEach((input) => {
                    if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                    else input.value = '';
                  });
                  c.querySelectorAll('textarea').forEach((ta) => (ta.value = ''));
                  c.classList.remove('active');
                  c.querySelectorAll('tr.row-active').forEach((tr) => tr.classList.remove('row-active'));
                  return c;
                }
                return null;
              };

              const items = formData.work_items.length ? formData.work_items : [{}];
              items.forEach((wi, idx) => {
                const block = ensureTemplate();
                if (!block) return;
                const setIf = (sel, val) => {
                  const el = block.querySelector(sel);
                  if (el && val !== undefined && val !== null) el.value = String(val);
                };

                setIf('input[name="work_desc[]"]', wi.description ?? wi.work_desc);
                setIf('input[name="work_qty[]"]', wi.quantity ?? wi.work_qty);
                setIf('input[name="material[]"]', wi.material);
                setIf('input[name="material_qty[]"]', wi.material_qty);
                setIf('input[name="specification[]"]', wi.specification);
                setIf('input[name="unit_price[]"]', wi.unit_price);
                setIf('input[name="price[]"]', wi.price);
                setIf('input[name="labour[]"]', wi.labour);
                setIf('textarea[name="comments[]"]', wi.comments);

                container.appendChild(block);
              });

              // Renumber blocks + SN display
              if (typeof renumberWorkItems === 'function') {
                renumberWorkItems();
              }
            }
          }
          
          // Load signatures
          function loadSignatures() {
            const pads = window.signaturePads;
            if (!pads || !pads.tech || !pads.op) {
              setTimeout(loadSignatures, 200);
              return;
            }
            
            // Load inspector signature - show as read-only for supervisor/manager
            if (formData.inspector_signature) {
              let techSig = formData.inspector_signature;
              // Handle object format with url property (from Cloudinary)
              if (techSig && typeof techSig === 'object' && techSig.url) {
                techSig = techSig.url;
              }
              if (techSig && typeof techSig === 'string' && (techSig.startsWith('data:image') || techSig.startsWith('http'))) {
                {% if is_supervisor_edit %}
                // Show in read-only display for supervisor/manager
                const techDisplay = document.getElementById('techSignatureDisplay');
                if (techDisplay) {
                  const sigImg = document.createElement('img');
                  sigImg.src = techSig;
                  sigImg.alt = 'Inspector Signature';
                  sigImg.style.cssText = 'width: 100%; max-height: 150px; object-fit: contain; border-radius: 4px;';
                  sigImg.onerror = function() {
                    this.style.display = 'none';
                    techDisplay.innerHTML = '<span style="color: #dc2626;">⚠️ Failed to load signature image</span>';
                  };
                  techDisplay.innerHTML = '';
                  techDisplay.appendChild(sigImg);
                  
                  // Store in hidden input for submission
                  const techSigInput = document.getElementById('techSignatureData');
                  if (techSigInput) techSigInput.value = techSig;
                }
                {% else %}
                // Normal edit mode - show in canvas
                const techCanvas = document.getElementById('techSignaturePad');
                if (techCanvas && pads.tech) {
                  // Hide canvas and show signature as image instead (more reliable)
                  techCanvas.style.display = 'none';
                  
                  // Create image element to display the signature
                  const sigImg = document.createElement('img');
                  sigImg.src = techSig;
                  sigImg.alt = 'Inspector Signature';
                  sigImg.style.cssText = 'width: 100%; max-height: 180px; object-fit: contain; border: 2px solid #10b981; border-radius: 8px; background: #f0fdf4; padding: 10px;';
                  techCanvas.parentElement.insertBefore(sigImg, techCanvas);
                  
                  const clearBtn = techCanvas.parentElement.querySelector('button');
                  if (clearBtn) clearBtn.style.display = 'none';
                  const techLabel = techCanvas.parentElement.querySelector('label');
                  if (techLabel) {
                    techLabel.innerHTML = 'Inspector Signature <span style="color: #10b981; font-weight: bold; font-size: 0.9rem;">✓ Already Signed</span>';
                  }
                  const hintSpan = techCanvas.parentElement.querySelector('.signature-hint');
                  if (hintSpan) hintSpan.style.display = 'none';
                  
                  // Store in hidden input
                  const techSigInput = document.getElementById('techSignatureData');
                  if (techSigInput) techSigInput.value = techSig;
                }
                {% endif %}
              }
            }
            
            // Load supervisor comments and signature if supervisor is editing
            {% if is_supervisor_edit or user_designation == 'supervisor' %}
            if (formData.supervisor_comments) {
              const commentsField = document.getElementById('supervisorComments');
              if (commentsField) {
                commentsField.value = formData.supervisor_comments || '';
              }
            }
            
            if (formData.supervisor_verified) {
              if (verifiedBtn) {
                isVerified = true;
                verifiedBtn.classList.remove('btn-success');
                verifiedBtn.classList.add('btn-outline-success');
                verifiedBtn.innerHTML = '<span id="verifiedBtnIcon">✓</span> Verified';
                if (verifiedStatus) {
                  verifiedStatus.style.display = 'inline';
                  verifiedStatus.textContent = '✓ Verified';
                }
              }
            }
            
            if (formData.supervisor_signature) {
              let supervisorSig = formData.supervisor_signature;
              if (supervisorSig && typeof supervisorSig === 'object' && supervisorSig.url) {
                supervisorSig = supervisorSig.url;
              }
              if (supervisorSig && typeof supervisorSig === 'string' && (supervisorSig.startsWith('data:image') || supervisorSig.startsWith('http'))) {
                const supervisorCanvas = document.getElementById('supervisorSignaturePad');
                if (supervisorCanvas && pads && pads.supervisorPad) {
                  // Load signature into pad
                  const img = new Image();
                  img.crossOrigin = 'anonymous';
                  img.onload = function() {
                    const ctx = supervisorCanvas.getContext('2d');
                    ctx.clearRect(0, 0, supervisorCanvas.width, supervisorCanvas.height);
                    ctx.drawImage(img, 0, 0, supervisorCanvas.width, supervisorCanvas.height);
                    pads.supervisorPad.fromDataURL(supervisorSig);
                  };
                  img.src = supervisorSig;
                  
                  const supervisorSigInput = document.getElementById('supervisorSignatureData');
                  if (supervisorSigInput) supervisorSigInput.value = supervisorSig;
                }
              }
            }
            {% endif %}
            
            if (formData.manager_signature) {
              let opSig = formData.manager_signature;
              // Handle object format with url property (from Cloudinary)
              if (opSig && typeof opSig === 'object' && opSig.url) {
                opSig = opSig.url;
              }
              if (opSig && typeof opSig === 'string' && (opSig.startsWith('data:image') || opSig.startsWith('http'))) {
                const opCanvas = document.getElementById('opManSignaturePad');
                if (opCanvas && pads.op) {
                  // Hide canvas and show signature as image instead (more reliable)
                  opCanvas.style.display = 'none';
                  
                  // Create image element to display the signature
                  const sigImg = document.createElement('img');
                  sigImg.src = opSig;
                  sigImg.alt = 'Manager Signature';
                  sigImg.style.cssText = 'width: 100%; max-height: 180px; object-fit: contain; border: 2px solid #10b981; border-radius: 8px; background: #f0fdf4; padding: 10px;';
                  opCanvas.parentElement.insertBefore(sigImg, opCanvas);
                  
                  const clearBtn = opCanvas.parentElement.querySelector('button');
                  if (clearBtn) clearBtn.style.display = 'none';
                  const opLabel = opCanvas.parentElement.querySelector('label');
                  if (opLabel) {
                    opLabel.innerHTML = 'Manager Approval Signature <span style="color: #10b981; font-weight: bold; font-size: 0.9rem;">✓ Already Signed</span>';
                  }
                  const hintSpan = opCanvas.parentElement.querySelector('.signature-hint');
                  if (hintSpan) hintSpan.style.display = 'none';
                  const opInfo = document.createElement('div');
                  opInfo.style.cssText = 'margin-top: 0.5rem; padding: 0.5rem; background-color: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; color: #92400e; font-size: 0.875rem;';
                  opInfo.textContent = '⚠️ This signature was already provided and cannot be modified.';
                  opCanvas.parentElement.appendChild(opInfo);
                }
              }
            }
          }
          
          setTimeout(loadSignatures, 300);
          window.editSubmissionId = submissionData.submission_id;
          console.log('✅ Submission data loaded for editing');
        } catch (err) {
          console.error('Failed to load submission data:', err);
        }
        {% endif %}
      }
      
      {% if is_edit_mode %}
      window.addEventListener('DOMContentLoaded', loadSubmissionData);
      {% endif %}

      // Initialize Upload Queue System - Matching HVAC exactly
      let photoQueue = null;
      let photoQueueUI = null;
      
      // Wait for scripts to load, then initialize
      function initPhotoQueue() {
        console.log('🔍 Checking PhotoUploadQueue availability:', {
          PhotoUploadQueue: typeof window.PhotoUploadQueue,
          PhotoQueueUI: typeof window.PhotoQueueUI
        });
        
        if (window.PhotoUploadQueue && window.PhotoQueueUI) {
          console.log('✅ Initializing photo queue system...');
          photoQueue = new window.PhotoUploadQueue({
            uploadEndpoint: modulePrefix + '/upload-photo',
            maxConcurrent: 3,
            onProgress: (stats) => {
              if (photoQueueUI) photoQueueUI.updateProgress(stats);
            },
            onItemComplete: (item, success) => {
              // Update UI when individual items complete
              if (photoQueueUI) {
                photoQueueUI.updatePhotoStatus(item);
              }
              // Update the currentFiles array with the uploaded URL
              if (success && item.url) {
                const fileIndex = currentFiles.findIndex(f => f._queueId === item.id);
                if (fileIndex !== -1) {
                  currentFiles[fileIndex].url = item.url;
                  currentFiles[fileIndex].is_cloud = true;
                }
              }
              updatePhotoCount();
            },
            onQueueComplete: (stats) => {
              console.log('✅ All uploads complete:', stats);
              updatePhotoCount();
              // Show success message if all completed
              if (stats.completed === stats.total && stats.failed === 0) {
                console.log(`✅ Successfully uploaded ${stats.completed} photo(s)`);
              }
            },
            onError: (error) => {
              console.error('Upload error:', error);
            }
          });

          photoQueueUI = new window.PhotoQueueUI({
            containerId: 'photoPreviewContainer',
            onRetry: (photoId) => {
              photoQueue.retryUpload(photoId);
            },
            onRemove: (photoId) => {
              photoQueue.removePhoto(photoId);
              updatePhotoCount();
            }
          });
          console.log('✅ Photo queue system initialized');
          
          // Create progress container (only if photoPreviewContainer exists)
          if (photoPreviewContainer && photoPreviewContainer.parentNode) {
            const progressDiv = document.createElement('div');
            progressDiv.id = 'queue-progress-container';
            progressDiv.className = 'mb-3';
            photoPreviewContainer.parentNode.insertBefore(progressDiv, photoPreviewContainer);
          }

          // Add retry all button event listener
          document.addEventListener('click', (e) => {
            if (e.target.id === 'retry-all-failed-btn' || e.target.closest('#retry-all-failed-btn')) {
              photoQueue.retryAllFailed();
            }
          });
          
          // Handle window resize and orientation changes for mobile responsiveness
          let resizeTimeout;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
              if (photoQueueUI) {
                photoQueueUI.updateLayout();
              }
            }, 250);
          });
          
          window.addEventListener('orientationchange', () => {
            setTimeout(() => {
              if (photoQueueUI) {
                photoQueueUI.updateLayout();
              }
            }, 100);
          });
        } else {
          console.error('❌ PhotoUploadQueue or PhotoQueueUI not available!');
          console.error('Available window properties:', Object.keys(window).filter(k => k.includes('Photo')));
        }
      }
      
      // Try to initialize immediately
      initPhotoQueue();
      
      // If not available, wait a bit and try again (scripts might still be loading)
      if (!photoQueue) {
        setTimeout(() => {
          console.log('⏳ Retrying photo queue initialization...');
          initPhotoQueue();
        }, 500);
      }

      function updatePhotoCount() {
        let count = 0;
        
        if (photoQueue) {
          const stats = photoQueue.getStats();
          count = stats.total || 0;
          console.log('📊 Queue stats:', stats);
        } else {
          count = currentFiles.length;
        }
        
        // Also count visible thumbnails as fallback
        if (photoPreviewContainer && count === 0) {
          count = photoPreviewContainer.querySelectorAll('.photo-item').length;
        }
        
        if (count > 0) {
          photoCount.style.display = 'block';
          photoCount.textContent = `📸 ${count} / ${MAX_PHOTOS} photos added`;
          photoCount.className = 'photo-count alert alert-info';
          photoCount.style.cssText = 'display: block !important; padding: 0.5rem 1rem; margin-top: 0.5rem; border-radius: 4px; font-weight: 600; background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460;';
        } else {
          photoCount.style.display = 'none';
        }
        
        console.log('📊 Photo count updated:', count, 'visible thumbnails:', photoPreviewContainer?.querySelectorAll('.photo-item').length);
      }

      let currentFiles = [];
      let currentPreviews = [];
      let workItemCounter = 1;

      // Auto-download helper function
      function autoDownload(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      function getWorkItemBlocks() {
        return Array.from(document.querySelectorAll('#workItemsContainer .work-item-block'));
      }

      function renumberWorkItems() {
        const blocks = getWorkItemBlocks();
        blocks.forEach((block, idx) => {
          const n = idx + 1;
          block.dataset.index = String(n);
          const title = block.querySelector('.work-item-title');
          if (title) title.textContent = `Work Item ${n}`;
          block.querySelectorAll('.work-item-sn').forEach((el) => (el.textContent = String(n)));
        });
        workItemCounter = blocks.length;
      }

      function cloneEmptyWorkItemBlock() {
        const container = document.getElementById('workItemsContainer');
        if (!container) return null;
        const template = container.querySelector('.work-item-block');
        if (!template) return null;
        const clone = template.cloneNode(true);

        // Clear all inputs/textarea values
        clone.querySelectorAll('input').forEach((input) => {
          if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
          else input.value = '';
        });
        clone.querySelectorAll('textarea').forEach((ta) => (ta.value = ''));

        // Ensure active state cleared
        clone.classList.remove('active');
        clone.querySelectorAll('tr.row-active').forEach((tr) => tr.classList.remove('row-active'));

        return clone;
      }

      // Add Work Item Block (each work item is its own asset)
      document.getElementById('addRowBtn').addEventListener('click', () => {
        const container = document.getElementById('workItemsContainer');
        if (!container) return;
        const newBlock = cloneEmptyWorkItemBlock();
        if (!newBlock) return;
        container.appendChild(newBlock);
        renumberWorkItems();
        saveDraft();
      });

      // Remove Work Item Block (button exists inside Pricing table)
      document.getElementById('workItemsContainer')?.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-work-item');
        if (!btn) return;
        const container = document.getElementById('workItemsContainer');
        if (!container) return;
        const blocks = getWorkItemBlocks();
        if (blocks.length <= 1) {
          statusBox.innerHTML = '<div class="alert alert-warning">⚠️ At least one work item is required</div>';
          return;
        }
        const block = btn.closest('.work-item-block');
        if (block) block.remove();
        renumberWorkItems();
        saveDraft();
      });

      // Active block highlighting (keeps the two internal tables visually linked)
      const workItemsContainer = document.getElementById('workItemsContainer');
      if (workItemsContainer) {
        const clearActive = () => {
          workItemsContainer.querySelectorAll('.work-item-block.active').forEach((b) => b.classList.remove('active'));
          workItemsContainer.querySelectorAll('tbody tr.row-active').forEach((tr) => tr.classList.remove('row-active'));
        };

        const activateBlock = (block) => {
          if (!block) return;
          clearActive();
          block.classList.add('active');
          block.querySelectorAll('tbody tr').forEach((tr) => tr.classList.add('row-active'));
        };

        workItemsContainer.addEventListener('focusin', (e) => {
          activateBlock(e.target.closest('.work-item-block'));
        });
        workItemsContainer.addEventListener('mouseover', (e) => {
          activateBlock(e.target.closest('.work-item-block'));
        });
        workItemsContainer.addEventListener('mouseleave', () => {
          if (document.activeElement && workItemsContainer.contains(document.activeElement)) return;
          clearActive();
        });
      }

      // Image Compression Function
      async function compressImage(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let { width, height } = img;
              
              if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                if (width > height) {
                  height = Math.round((height / width) * MAX_IMAGE_DIMENSION);
                  width = MAX_IMAGE_DIMENSION;
                } else {
                  width = Math.round((width / height) * MAX_IMAGE_DIMENSION);
                  height = MAX_IMAGE_DIMENSION;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              canvas.toBlob((blob) => {
                if (!blob) {
                  reject(new Error('Compression failed'));
                  return;
                }
                const compressed = new File([blob], file.name.replace(/\.\w+$/, '.jpg'), {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                resolve(compressed);
              }, 'image/jpeg', JPEG_QUALITY);
            };
            img.onerror = () => reject(new Error('Image load failed'));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error('File read failed'));
          reader.readAsDataURL(file);
        });
      }

      if (!checkBrowserSupport()) {
        dropZone.style.display = 'none';
        curPhotos.classList.remove('d-none');
        uploadProgress.innerHTML = '<div class="alert alert-warning">Using fallback mode</div>';
        uploadProgress.style.display = 'block';
      }

      async function handleFiles(files) {
        if (!files || files.length === 0) return;
        
        const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (imageFiles.length === 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = '⚠️ Please select image files only.';
          return;
          return;
        }
        
        // File size validation upfront
        const oversizedFiles = imageFiles.filter(f => f.size > MAX_FILE_SIZE);
        if (oversizedFiles.length > 0) {
          fileWarning.style.display = 'block';
          fileWarning.textContent = `⚠️ ${oversizedFiles.length} file(s) exceed 10MB limit and will be skipped`;
          setTimeout(() => { fileWarning.style.display = 'none'; }, 5000);
        }
        
        const validFiles = imageFiles.filter(f => f.size <= MAX_FILE_SIZE);
        if (validFiles.length === 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = '⚠️ All files exceed 10MB size limit. Please compress them first.';
          return;
          return;
        }
        
        const totalAfter = currentFiles.length + validFiles.length;
        if (totalAfter > MAX_PHOTOS) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = `⚠️ Maximum ${MAX_PHOTOS} photos. You have ${currentFiles.length}, trying to add ${validFiles.length}.`;
          return;
          return;
        }
        
        // Use upload queue if available
        if (photoQueue && photoQueueUI) {
          console.log('📸 Adding photos to queue:', validFiles.length);
          const addedItems = await photoQueue.addPhotos(validFiles);
          console.log('📸 Added items to queue:', addedItems.length);
          console.log('📸 Preview container element:', photoPreviewContainer);
          console.log('📸 Preview container display:', photoPreviewContainer?.style.display);
          
          // Show preview container
          if (photoPreviewContainer) {
            photoPreviewContainer.style.display = 'flex';
            photoPreviewContainer.style.flexWrap = 'wrap';
            photoPreviewContainer.style.gap = '10px';
            photoPreviewContainer.style.marginTop = '1rem';
            photoPreviewContainer.style.padding = '0.5rem';
            photoPreviewContainer.style.minHeight = '140px';
            photoPreviewContainer.style.border = '1px dashed #dee2e6';
            photoPreviewContainer.style.borderRadius = '4px';
            photoPreviewContainer.style.backgroundColor = '#f8f9fa';
            console.log('✅ Preview container made visible');
          } else {
            console.error('❌ photoPreviewContainer not found!');
          }
          
          // Render each photo
          addedItems.forEach((item, idx) => {
            console.log(`📸 Rendering item ${idx + 1}:`, {
              id: item.id,
              preview: item.preview ? 'exists' : 'missing',
              previewUrl: item.preview,
              status: item.status,
              fileName: item.file?.name
            });
            currentFiles.push({ _queueId: item.id, url: null, is_cloud: false });
            
            // Try to render with photoQueueUI
            let rendered = null;
            if (photoQueueUI) {
              rendered = photoQueueUI.renderPhotoItem(item);
              console.log(`✅ Rendered via photoQueueUI item ${idx + 1}:`, rendered);
            }
            
            // Fallback: render directly if photoQueueUI failed
            if (!rendered && photoPreviewContainer && item.preview) {
              console.log(`⚠️ photoQueueUI failed, rendering directly for item ${idx + 1}`);
              const photoDiv = document.createElement('div');
              photoDiv.className = 'photo-item';
              photoDiv.dataset.photoId = item.id;
              photoDiv.style.cssText = 'position: relative; display: inline-block; margin: 8px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: #f8f9fa; border: 2px solid #dee2e6;';
              
              const img = document.createElement('img');
              img.src = item.preview;
              img.alt = 'Photo';
              img.style.cssText = 'display: block !important; width: 120px !important; height: 120px !important; object-fit: cover; background: #fff;';
              img.onerror = () => console.error('❌ Image failed to load:', item.preview);
              img.onload = () => console.log('✅ Image loaded:', item.id);
              
              const removeBtn = document.createElement('button');
              removeBtn.textContent = '×';
              removeBtn.className = 'photo-remove-btn';
              removeBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; border-radius: 50%; background: rgba(220, 53, 69, 0.9); border: none; color: white; font-size: 16px; cursor: pointer; z-index: 10;';
              removeBtn.onclick = (e) => {
                e.stopPropagation();
                photoQueue.removePhoto(item.id);
                photoDiv.remove();
                updatePhotoCount();
              };
              
              photoDiv.appendChild(img);
              photoDiv.appendChild(removeBtn);
              photoPreviewContainer.appendChild(photoDiv);
              rendered = photoDiv;
              console.log(`✅ Rendered directly item ${idx + 1}:`, rendered);
            }
          });
          
          // Force container visibility
          if (photoPreviewContainer && addedItems.length > 0) {
            photoPreviewContainer.style.display = 'flex';
            const computedStyle = window.getComputedStyle(photoPreviewContainer);
            console.log('📸 Container computed display:', computedStyle.display);
            console.log('📸 Container computed visibility:', computedStyle.visibility);
            
            // If still not visible, force it
            if (computedStyle.display === 'none') {
              console.warn('⚠️ Container still hidden, forcing visibility');
              photoPreviewContainer.style.display = 'flex !important';
            }
          }
          
          console.log('📸 Total items in container:', photoPreviewContainer?.children.length);
          console.log('📸 Container display:', photoPreviewContainer?.style.display);
          console.log('📸 Container visibility:', window.getComputedStyle(photoPreviewContainer).display);
          
          // Update count immediately and after a short delay
          updatePhotoCount();
          setTimeout(() => {
            updatePhotoCount();
            console.log('📸 Delayed count check - visible thumbnails:', photoPreviewContainer?.querySelectorAll('.photo-item img').length);
          }, 100);
          
          saveDraft();
          
          // Log queue state after adding
          setTimeout(() => {
            const stats = photoQueue.getStats();
            const uploaded = photoQueue.getUploadedUrls();
            console.log('📸 Queue stats after adding:', stats);
            console.log('📸 Uploaded URLs:', uploaded);
          }, 2000);
          
          return;
        }
        
        // Fallback to original compression logic
        uploadProgress.style.display = 'block';
        
        const BATCH_SIZE = 3;
        let successCount = 0;
        let failedFiles = [];
        
        for (let i = 0; i < validFiles.length; i += BATCH_SIZE) {
          const batch = validFiles.slice(i, i + BATCH_SIZE);
          const promises = batch.map(file => compressImage(file));
          
          try {
            const compressed = await Promise.all(promises);
            compressed.forEach(c => {
              if (c) {
                currentFiles.push(c);
                currentPreviews.push(URL.createObjectURL(c));
                successCount++;
              }
            });
          } catch (err) {
            console.error('Batch compression error:', err);
            batch.forEach(f => failedFiles.push(f.name));
          }
          
          const progress = Math.round(((i + batch.length) / validFiles.length) * 100);
          uploadProgressBar.style.width = progress + '%';
          uploadProgressBar.textContent = `Compressing ${Math.min(i + batch.length, validFiles.length)}/${validFiles.length}...`;
        }
        
        uploadProgress.style.display = 'none';
        
        if (failedFiles.length > 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-danger';
          uploadStatus.innerHTML = `⚠️ Failed to process ${failedFiles.length} file(s): ${failedFiles.slice(0, 3).join(', ')}${failedFiles.length > 3 ? '...' : ''}`;
        }
        
        renderPhotoPreview();
        saveDraft();
      }

      function renderPhotoPreview() {
        photoPreviewContainer.innerHTML = '';
        const count = currentFiles.length;
        
        if (count === 0) {
          photoCount.style.display = 'none';
          photoPreviewContainer.style.display = 'none';
          return;
        }
        
        photoPreviewContainer.style.display = 'flex';
        photoCount.style.display = 'inline-block';
        photoCount.textContent = `${count} / ${MAX_PHOTOS} photos`;
        photoCount.className = 'photo-count mt-2';
        if (count >= MAX_PHOTOS * 0.8) photoCount.classList.add('warning');
        if (count >= MAX_PHOTOS) photoCount.classList.add('danger');
        
        currentPreviews.forEach((url, idx) => {
          const item = document.createElement('div');
          item.className = 'photo-preview-item';
          
          const img = document.createElement('img');
          img.src = url;
          img.alt = `Photo ${idx + 1}`;
          
          const removeBtn = document.createElement('div');
          removeBtn.className = 'photo-preview-remove';
          removeBtn.textContent = '×';
          removeBtn.title = 'Remove this photo';
          removeBtn.onclick = () => removePhoto(idx);
          
          item.appendChild(img);
          item.appendChild(removeBtn);
          photoPreviewContainer.appendChild(item);
        });
      }
      
      function removePhoto(index) {
        if (index < 0 || index >= currentFiles.length) return;
        URL.revokeObjectURL(currentPreviews[index]);
        currentFiles.splice(index, 1);
        currentPreviews.splice(index, 1);
        renderPhotoPreview();
        saveDraft();
      }

      dropZone.addEventListener('click', () => curPhotos.click());
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
      dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
      dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
      curPhotos.addEventListener('change', () => handleFiles(curPhotos.files));

      // Draft Auto-Save
      function saveDraft() {
        try {
          const safeValue = (id) => {
            const el = document.getElementById(id);
            return el ? (el.value || '') : '';
          };

          const draft = {
            date: safeValue('date'),
            project_name: safeValue('project_name'),
            description_of_work: safeValue('description_of_work'),
            area: safeValue('area'),
            area_other: safeValue('area_other'),
            inspector_name: safeValue('inspector_name'),
            workItemsCount: document.querySelectorAll('#workItemsContainer .work-item-block').length,
            photoCount: currentFiles.length,
            timestamp: Date.now()
          };
          localStorage.setItem('civil_draft', JSON.stringify(draft));
        } catch (err) {
          console.error('Failed to save draft:', err);
        }
      }

      function loadDraft() {
        try {
          const draftJson = localStorage.getItem('civil_draft');
          if (!draftJson) return false;
          
          const draft = JSON.parse(draftJson);
          const ageMinutes = (Date.now() - draft.timestamp) / 60000;
          
          if (ageMinutes > 1440) { // 24 hours
            clearDraft();
            return false;
          }
          
          // Auto-load draft without confirmation
          const safeSet = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.value = value || '';
          };

          // Backward compatibility for older drafts (before Area dropdown)
          if (!draft.area && (draft.location_name || draft.city_area || draft.floor || draft.developer_client)) {
            const legacyBits = [draft.location_name, draft.city_area, draft.floor, draft.developer_client]
              .filter(Boolean)
              .join(' - ');
            draft.area = 'Other';
            draft.area_other = legacyBits;
          }

          safeSet('date', draft.date);
          safeSet('project_name', draft.project_name);
          safeSet('description_of_work', draft.description_of_work);
          safeSet('area', draft.area);
          safeSet('area_other', draft.area_other);
          safeSet('inspector_name', draft.inspector_name);

          if (typeof handleAreaChange === 'function') {
            handleAreaChange();
          }
          
          // Draft loaded silently
          if (draft.workItemsCount > 0 || draft.photoCount > 0) {
            console.log(`ℹ️ Draft loaded: ${draft.workItemsCount} work items and ${draft.photoCount} photos`);
          }
          return true;
        } catch (err) {
          console.error('Failed to load draft:', err);
        }
        return false;
      }

      function clearDraft() {
        try {
          localStorage.removeItem('civil_draft');
        } catch (err) {
          console.error('Failed to clear draft:', err);
        }
      }

      // Auto-save every 30 seconds
      setInterval(saveDraft, DRAFT_SAVE_INTERVAL);
      
      // Save on field changes
      ['date', 'project_name', 'description_of_work', 'area', 'area_other',
       'inspector_name'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', saveDraft);
          el.addEventListener('change', saveDraft);
        }
      });

      // Don't auto-load draft on page refresh - always start with a fresh form
      // window.addEventListener('DOMContentLoaded', loadDraft); // DISABLED - forms should be fresh on refresh
      
      // Set default date to today and max date to today (prevent future dates)
      window.addEventListener('DOMContentLoaded', function() {
        const dateField = document.getElementById('date');
        if (dateField) {
          // Always set max date to today to prevent future date selection
          const today = new Date();
          const todayStr = today.toISOString().split('T')[0];
          dateField.setAttribute('max', todayStr);
          
          // Set today's date as default only if not in edit mode and field is empty
          {% if not is_edit_mode %}
          if (!dateField.value) {
            dateField.value = todayStr;
          }
          {% endif %}
        }
        // Clear any existing drafts on page load to ensure fresh form (unless in edit mode)
        {% if not is_edit_mode %}
        clearDraft();
        {% endif %}
      });

      // Upload Images Button Handler
      uploadImagesBtn.addEventListener('click', async () => {
        console.log('📤 Upload button clicked. photoQueue:', photoQueue);
        if (!photoQueue) {
          console.error('❌ Photo queue not initialized!');
          console.error('Window.PhotoUploadQueue:', typeof window.PhotoUploadQueue);
          console.error('Window.PhotoQueueUI:', typeof window.PhotoQueueUI);
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-danger';
          uploadStatus.innerHTML = '⚠️ Photo upload system not available. Please refresh the page.';
          return;
          return;
        }
        
        const stats = photoQueue.getStats();
        if (stats.total === 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = '⚠️ Please add photos first before uploading.';
          return;
          return;
        }
        
        // Check if already uploaded
        if (photosUploaded && uploadedPhotoUrls.length > 0) {
          // Auto-reset if already uploaded
          photosUploaded = false;
          uploadedPhotoUrls = [];
        }
        
        // Disable button and show spinner
        uploadImagesBtn.disabled = true;
        uploadImagesBtnText.textContent = 'Uploading...';
        uploadImagesBtnSpinner.classList.remove('d-none');
        uploadStatus.classList.remove('d-none');
        uploadStatus.className = 'alert alert-info';
        uploadStatus.innerHTML = `Uploading ${stats.total} photo(s)...`;
        
        try {
          // Wait for all uploads to complete
          const maxWaitTime = 300000; // 5 minutes max
          const startTime = Date.now();
          
          while (!stats.isComplete && (Date.now() - startTime) < maxWaitTime) {
            await new Promise(resolve => setTimeout(resolve, 500));
            const currentStats = photoQueue.getStats();
            const progress = Math.round((currentStats.completed / currentStats.total) * 100);
            uploadStatus.innerHTML = `Uploading ${currentStats.completed}/${currentStats.total} photos (${progress}%)...`;
            
            if (currentStats.isComplete) break;
          }
          
          // Get uploaded URLs
          const uploadedPhotos = photoQueue.getUploadedUrls();
          uploadedPhotoUrls = uploadedPhotos.map(p => {
            if (typeof p === 'string') return p;
            return p.url || p;
          }).filter(Boolean);
          
          // Fallback: check queue items directly
          if (uploadedPhotoUrls.length === 0 && stats.total > 0) {
            const allItems = photoQueue.queue || [];
            const completedItems = allItems.filter(item => item.status === 'completed' && item.url);
            if (completedItems.length > 0) {
              uploadedPhotoUrls = completedItems.map(item => item.url).filter(Boolean);
            }
          }
          
          if (uploadedPhotoUrls.length === 0) {
            throw new Error('No photos were uploaded successfully. Please check for errors and try again.');
          }
          
          photosUploaded = true;
          uploadStatus.className = 'alert alert-success';
          uploadStatus.innerHTML = `✅ Successfully uploaded ${uploadedPhotoUrls.length} photo(s)! You can now generate reports.`;
          
          // Enable submit button
          submitBtn.disabled = false;
          submitBtnText.textContent = `📄 Generate Reports (${uploadedPhotoUrls.length} photos)`;
          
          console.log('✅ Photos uploaded:', uploadedPhotoUrls);
          
        } catch (error) {
          console.error('Upload error:', error);
          uploadStatus.className = 'alert alert-danger';
          uploadStatus.innerHTML = `❌ Upload failed: ${error.message}`;
          photosUploaded = false;
          uploadedPhotoUrls = [];
        } finally {
          uploadImagesBtn.disabled = false;
          uploadImagesBtnText.textContent = '📤 Upload Images';
          uploadImagesBtnSpinner.classList.add('d-none');
        }
      });

      // Submit Handler - Using HVAC method with JSON payload
      submitBtn.addEventListener('click', async () => {
        // Basic required field validation (browser built-in validation does not run because this is a JS submit)
        const projectNameValue = (document.getElementById('project_name')?.value || '').trim();
        const visitDateValue = (document.getElementById('date')?.value || '').trim();
        const areaValue = (document.getElementById('area')?.value || '').trim();

        if (!projectNameValue) {
          alert('Please enter the Project Name before submitting.');
          goToTab(1);
          return;
        }

        if (!visitDateValue) {
          alert('Please select the Date before submitting.');
          goToTab(1);
          return;
        }

        if (!areaValue) {
          alert('Please select an Area before submitting.');
          goToTab(1);
          return;
        }

        // Ensure pads are initialized
        if (!pads || !window.signaturePads) {
          pads = initSignaturePads();
          window.signaturePads = pads;
          window.pads = pads;
        }
        
        // In edit mode, preserve original signatures
        let techSig = '';
        let opSig = '';
        
        {% if is_edit_mode %}
        // In edit mode, use existing signatures (read-only)
        const techCanvas = document.getElementById('techSignaturePad');
        const opCanvas = document.getElementById('opManSignaturePad');
        if (techCanvas && pads && pads.techPad && !pads.techPad.isEmpty()) {
          techSig = pads.techPad.toDataURL('image/png');
        }
        if (opCanvas && pads && pads.opPad && !pads.opPad.isEmpty()) {
          opSig = pads.opPad.toDataURL('image/png');
        }
        {% else %}
        // Normal mode - get from signature pads
        if (pads && pads.techPad && !pads.techPad.isEmpty()) {
          techSig = pads.techPad.toDataURL('image/png');
          const techSigInput = document.getElementById('techSignatureData');
          if (techSigInput) techSigInput.value = techSig;
        }
        if (pads && pads.opPad && !pads.opPad.isEmpty()) {
          opSig = pads.opPad.toDataURL('image/png');
          const opSigInput = document.getElementById('opManSignatureData');
          if (opSigInput) opSigInput.value = opSig;
        }
        {% endif %}
        
        // Check if photos have been uploaded
        if (!photosUploaded || uploadedPhotoUrls.length === 0) {
          statusBox.innerHTML = '<div class="alert alert-warning">⚠️ Please upload images first using the "Upload Images" button before generating reports.</div>';
          return;
          return;
        }
        
        console.log('📸 Using pre-uploaded photo URLs:', uploadedPhotoUrls);
        console.log('📸 Total photos to submit:', uploadedPhotoUrls.length);
        
        // Collect work items from the block-based UI
        const workItems = [];
        const blocks = Array.from(document.querySelectorAll('#workItemsContainer .work-item-block'));

        const getVal = (root, selector) => {
          const el = root.querySelector(selector);
          return el ? (el.value || '') : '';
        };

        const isAnyFieldFilled = (item) => {
          const fields = [
            item.description,
            item.quantity,
            item.material,
            item.material_qty,
            item.specification,
            item.unit_price,
            item.price,
            item.labour,
            item.comments
          ];
          return fields.some(v => String(v || '').trim() !== '');
        };

        blocks.forEach((block, index) => {
          const item = {
            item_number: index + 1,
            description: getVal(block, 'input[name="work_desc[]"]'),
            quantity: getVal(block, 'input[name="work_qty[]"]'),
            material: getVal(block, 'input[name="material[]"]'),
            material_qty: getVal(block, 'input[name="material_qty[]"]'),
            specification: getVal(block, 'input[name="specification[]"]'),
            unit_price: getVal(block, 'input[name="unit_price[]"]'),
            price: getVal(block, 'input[name="price[]"]'),
            labour: getVal(block, 'input[name="labour[]"]'),
            comments: getVal(block, 'textarea[name="comments[]"]'),
            photo_urls: uploadedPhotoUrls
          };

          // Skip completely empty blocks
          if (!isAnyFieldFilled(item)) return;
          workItems.push(item);
        });
        
        if (workItems.length === 0) {
          statusBox.innerHTML = '<div class="alert alert-warning">⚠️ Please add at least one work item before submitting.</div>';
          return;
          return;
        }
        
        // Count total photos
        const totalPhotos = uploadedPhotoUrls.length;
        if (totalPhotos >= 30) {
          const estimatedTime = Math.ceil(totalPhotos / 10);
          // Show info message instead of confirmation
          if (totalPhotos >= 30) {
            const estimatedTime = Math.ceil(totalPhotos / 10);
            statusBox.innerHTML = `<div class="alert alert-info">⏰ Processing ${totalPhotos} photos. This may take ${estimatedTime}-${estimatedTime + 1} minutes...</div>`;
          }
        }

        // Show loading overlay (photos already uploaded, just generating reports)
        loadingOverlay.style.display = 'flex';
        statusBox.innerHTML = '';
        
        // Get supervisor signature and comments if supervisor is submitting
        let supervisorData = '';
        let supervisorComments = '';
        let supervisorVerified = false;
        const supervisorCommentsField = document.getElementById('supervisorComments');
        const supervisorSignatureData = document.getElementById('supervisorSignatureData');
        {% if is_supervisor_edit or user_designation == 'supervisor' %}
        if (pads && pads.supervisorPad && !pads.supervisorPad.isEmpty()) {
          supervisorData = pads.supervisorPad.toDataURL('image/png');
          if (supervisorSignatureData) supervisorSignatureData.value = supervisorData;
        } else if (supervisorSignatureData) {
          supervisorData = supervisorSignatureData.value || '';
        }
        if (supervisorCommentsField) {
          supervisorComments = supervisorCommentsField.value || '';
        }
        supervisorVerified = isVerified || false;
        
        // Validate supervisor signature if submitting as supervisor
        if (!supervisorData) {
          alert('Please provide your supervisor signature before submitting.');
          loadingOverlay.style.display = 'none';
          return;
        }
        {% else %}
        // Validate technician signature for regular submissions
        if (!techSig) {
          alert('Please provide your inspector signature before submitting.');
          loadingOverlay.style.display = 'none';
          return;
        }
        {% endif %}
        
        // Prepare JSON payload (photos already in cloud)
        const area = document.getElementById('area')?.value || '';
        const areaOther = document.getElementById('area_other')?.value || '';
        const location = (area === 'Other') ? (areaOther || 'Other') : area;

        if (!location) {
          alert('Please select an Area before submitting.');
          loadingOverlay.style.display = 'none';
          return;
        }

        const payload = {
          project_name: projectNameValue,
          location: location,
          visit_date: visitDateValue,
          inspector_name: document.getElementById('inspector_name').value || '',
          inspector_signature: techSig || '',
          supervisor_signature: supervisorData || '',
          supervisor_comments: supervisorComments || '',
          description_of_work: document.getElementById('description_of_work').value || '',
          area: area,
          area_other: areaOther,
          work_items: workItems
        };
        
        console.log('📤 Submitting payload with work items:', workItems);
        console.log('📤 Each work item photo_urls:', workItems.map(wi => ({ item: wi.item_number, photo_count: wi.photo_urls?.length || 0, urls: wi.photo_urls })));

        try {
          {% if is_edit_mode %}
          {% if is_supervisor_edit %}
          // Supervisor is approving/reviewing - use workflow approval endpoint
          const submissionId = window.editSubmissionId;
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          
          // First update the submission with new data
          const updateRes = await fetch(`/api/admin/submissions/${submissionId}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify({
              site_name: payload.project_name,
              visit_date: payload.visit_date,
              form_data: payload
            }),
            credentials: 'include'
          });
          
          if (!updateRes.ok) {
            const txt = await updateRes.text();
            throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
          }
          
          // Then approve via workflow endpoint
          const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              comments: supervisorComments,
              supervisor_signature: supervisorData,
              verified: supervisorVerified
            }),
            credentials: 'include'
          });
          
          if (!approveRes.ok) {
            const txt = await approveRes.text();
            throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
          }
          
          const approveJson = await approveRes.json();
          
          if (approveJson.success) {
            loadingOverlay.style.display = 'none';
            statusBox.innerHTML = `
              <div class="alert alert-success">
                <h5 class="alert-heading">✅ Form Signed Successfully!</h5>
                <hr>
                <p class="mb-2"><strong>This form will now be sent to:</strong></p>
                <ul class="mb-0" style="list-style-position: inside;">
                  <li>→ Operations Manager</li>
                  <li>→ Business Development & Procurement (parallel review)</li>
                  <li>→ General Manager (final approval)</li>
                </ul>
                <hr class="mt-3 mb-2">
                <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
              </div>
            `;
            clearDraft();
          } else {
            throw new Error(approveJson.error || 'Approval failed');
          }
          {% else %}
          // Admin or regular edit mode
          const submissionId = window.editSubmissionId;
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          
          const res = await fetch(`/api/admin/submissions/${submissionId}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify({
              site_name: payload.project_name,
              visit_date: payload.visit_date,
              form_data: payload
            }),
            credentials: 'include'
          });
          
          if (!res.ok) {
            const txt = await res.text();
            throw new Error('Server error: ' + res.status + ' ' + txt);
          }
          
          const json = await res.json();
          
          if (json.success) {
            if (json.data && json.data.job_id && json.data.regenerating) {
              statusBox.innerHTML = '<div class="alert alert-info">✅ Submission updated! Regenerating documents... This may take a moment.</div>';
              loadingOverlay.style.display = 'flex';
              // Use pollJobStatus with correct signature (modulePrefix, jobId, onUpdate, interval)
              const pollFn = window.pollJobStatus || pollJobStatusFn;
              if (pollFn && typeof pollFn === 'function') {
                pollFn(modulePrefix, json.data.job_id, (js) => {
                  statusBox.innerHTML = `<div class="alert alert-info">Regenerating documents... ${js.progress || 0}%</div>`;
                }).then(result => {
                  loadingOverlay.style.display = 'none';
                  if (result.state === 'done' || result.status === 'completed') {
                    statusBox.innerHTML = '<div class="alert alert-success">✅ Documents regenerated successfully! <a href="/dashboard">Return to Dashboard</a></div>';
                  } else {
                    statusBox.innerHTML = '<div class="alert alert-danger">❌ Document regeneration failed. Please try again.</div>';
                  }
                }).catch(err => {
                  loadingOverlay.style.display = 'none';
                  statusBox.innerHTML = `<div class="alert alert-danger">❌ Error: ${err.message}</div>`;
                });
              } else {
                // Fallback: just show success message
                loadingOverlay.style.display = 'none';
                statusBox.innerHTML = '<div class="alert alert-success">✅ Submission updated! Documents are being regenerated in the background. <a href="/dashboard">Return to Dashboard</a></div>';
              }
            } else {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = '<div class="alert alert-success">✅ Submission updated successfully! <a href="/dashboard">Return to Dashboard</a></div>';
              clearDraft();
            }
          } else {
            throw new Error(json.error || 'Update failed');
          }
          {% endif %}
        {% else %}
          // Create new submission
          const submitUrl = modulePrefix + '/submit-with-urls';
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          const res = await fetch(submitUrl, { 
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload),
            credentials: 'include'
          });
          
          if (!res.ok) {
            const txt = await res.text();
            let message = txt;
            try {
              const parsed = JSON.parse(txt);
              message = parsed.error || parsed.message || parsed.details || txt;
            } catch (e) {
              // not JSON
            }
            throw new Error(`Server error: ${res.status} ${message}`);
          }
          
          const json = await res.json();
          
          // Hide upload modal, show loading overlay
          uploadModal.style.display = 'none';
          loadingOverlay.style.display = 'flex';
          
          if (json.job_id) {
            clearDraft(); // Clear draft after successful submission
            
            // Ensure pollJobStatusFn is available - use multiple fallbacks
            let pollFn = null;
            try {
              // First try: use the pollJobStatusFn defined at the top of the IIFE
              if (typeof pollJobStatusFn !== 'undefined') {
                pollFn = pollJobStatusFn;
              }
              // Second try: use window.pollJobStatusFn
              else if (typeof window !== 'undefined' && typeof window.pollJobStatusFn !== 'undefined') {
                pollFn = window.pollJobStatusFn;
              }
              // Third try: use window.pollJobStatus
              else if (typeof window !== 'undefined' && typeof window.pollJobStatus !== 'undefined') {
                pollFn = window.pollJobStatus;
              }
              // Fourth try: define it inline as last resort
              else {
                pollFn = async function(modulePrefix, jobId, onUpdate, interval=1500) {
                  const statusUrl = `${modulePrefix}/status/${jobId}`;
                  return new Promise((resolve, reject) => {
                    const id = setInterval(async () => {
                      try {
                        const r = await fetch(statusUrl);
                        if (!r.ok) throw new Error('Job not found');
                        const js = await r.json();
                        if (onUpdate) onUpdate(js);
                        const isDone = js.state === 'done' || js.status === 'completed';
                        const isFailed = js.state === 'failed' || js.status === 'failed';
                        if (isDone || isFailed) {
                          clearInterval(id);
                          resolve(js);
                        }
                      } catch (e) {
                        clearInterval(id);
                        reject(e);
                      }
                    }, interval);
                  });
                };
              }
            } catch (e) {
              console.error('Error getting pollJobStatus function:', e);
            }
            
            if (!pollFn || typeof pollFn !== 'function') {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = '<div class="alert alert-danger">❌ Error: pollJobStatus function not available. Please refresh the page.</div>';
              console.error('pollFn is not a function. pollJobStatusFn:', typeof pollJobStatusFn, 'window.pollJobStatusFn:', typeof (window && window.pollJobStatusFn), 'window.pollJobStatus:', typeof (window && window.pollJobStatus));
              return;
            }
            
            pollFn(modulePrefix, json.job_id, (js) => {
              statusBox.innerHTML = `<div class="alert alert-info">Generating reports... ${js.progress || 0}%</div>`;
            }).then(result => {
              loadingOverlay.style.display = 'none';
              
              // Debug logging
              console.log('Job polling completed. Full result:', result);
              
              // Check both 'state' (legacy) and 'status' (current)
              const isDone = result.state === 'done' || result.status === 'completed';
              const isFailed = result.state === 'failed' || result.status === 'failed';
              
              // Support both 'results' and 'result_data'
              const results = result.results || result.result_data || {};
              
              if (window.safeLog) {
                window.safeLog.log('Extracted results:', results);
                window.safeLog.log('Is done?', isDone, 'Status:', result.status, 'State:', result.state);
              }
              
              if (isDone) {
                const links = [];
                
                // Check for Excel file (try multiple possible field names)
                const excelUrl = results.excel || results.excel_url || results.excelUrl;
                const excelFilename = results.excel_filename || results.excelFilename || 'civil_report.xlsx';
                console.log('Excel URL:', excelUrl, 'Filename:', excelFilename);
                
                if (excelUrl) {
                  const excelLinkHtml = `<a href="${excelUrl}" download="${excelFilename}" class="btn btn-success me-2 mt-2" style="text-decoration: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; display: inline-block;">📥 Download Excel Report</a>`;
                  links.push(excelLinkHtml);
                }
                
                // Check for PDF file (try multiple possible field names)
                const pdfUrl = results.pdf || results.pdf_url || results.pdfUrl;
                const pdfFilename = results.pdf_filename || results.pdfFilename || 'civil_report.pdf';
                console.log('PDF URL:', pdfUrl, 'Filename:', pdfFilename);
                
                if (pdfUrl) {
                  const pdfLinkHtml = `<a href="${pdfUrl}" download="${pdfFilename}" class="btn btn-success me-2 mt-2" style="text-decoration: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; display: inline-block;">📥 Download PDF Report</a>`;
                  links.push(pdfLinkHtml);
                }
                
                // Show success message and download links below submit button
                const downloadContainer = document.getElementById('download-links-container');
                if (downloadContainer && links.length > 0) {
                  downloadContainer.innerHTML = `<div class="alert alert-success mb-3"><strong>✅ Reports generated successfully!</strong></div>${links.join(' ')}<div class="mt-2 text-muted" style="font-size:0.9em;">Click the buttons above to download your reports.</div>`;
                  downloadContainer.style.display = 'block';
                } else if (downloadContainer && links.length === 0) {
                  downloadContainer.innerHTML = '<div class="alert alert-warning"><strong>⚠️ Job completed but no download links found.</strong></div>';
                  downloadContainer.style.display = 'block';
                }
                
                // Clear statusBox since message is now in download container
                statusBox.style.display = 'none';
              } else if (isFailed) {
                statusBox.innerText = "❌ Job failed: " + (result.error || JSON.stringify(results));
              } else {
                statusBox.innerText = "❌ Unknown job state: " + JSON.stringify(result);
              }
            }).catch(err => {
              loadingOverlay.style.display = 'none';
              statusBox.innerText = "❌ Error polling job status: " + err.message;
            });
          } else {
            loadingOverlay.style.display = 'none';
            statusBox.innerHTML = '<div class="alert alert-warning">Submission accepted but no job ID</div>';
          }
          {% endif %}
        } catch (err) {
          loadingOverlay.style.display = 'none';
          statusBox.innerHTML = `<div class="alert alert-danger">❌ Submission failed: ${err.message}</div>`;
        }
      });
    })();
  </script>
</body>
</html>