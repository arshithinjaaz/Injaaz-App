<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Civil Works - Site Assessment Form</title>
  <meta name="description" content="Civil works site assessment form - Works offline">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#125435">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Injaaz Civil">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
  <script src="{{ url_for('static', filename='pwa-install.js') }}" defer></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='mobile_responsive.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='animations.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='photo_upload_queue.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="{{ url_for('static', filename='mobile_utils.js') }}" defer></script>
  <script src="{{ url_for('static', filename='production_logger.js') }}" defer></script>
  <script src="{{ url_for('static', filename='photo_upload_queue.js') }}"></script>
  <script src="{{ url_for('static', filename='photo_queue_ui.js') }}"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #125435;
      --primary-light: #1a7a4d;
      --primary-dark: #0d3d24;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-light: #9ca3af;
      --border-light: #e5e7eb;
      --bg-page: #fafafa;
      --white: #ffffff;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

  /* Signature display: remove inner box and green background */
  div[id*="SignatureReadOnly"],
  #omOwnSignatureReadOnly {
    background: #fff !important;
    padding: 0 !important;
  }

  div[id*="SignatureReadOnly"] img,
  #omOwnSignatureReadOnly img {
    background: transparent !important;
    border: 0 !important;
    padding: 0 !important;
    box-shadow: none !important;
    max-width: 100% !important;
    max-height: 100% !important;
    width: auto !important;
    height: auto !important;
    object-fit: contain;
    display: block;
    margin: 0 auto;
  }
    
    body {
      background: var(--bg-page);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 0;
      margin: 0;
      line-height: 1.5;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Clean Navigation Bar */
    .navbar {
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 0.875rem 0;
      margin-bottom: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(18, 84, 53, 0.1);
    }
    
    .navbar-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: nowrap;
    }
    
    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary) !important;
      text-decoration: none;
      letter-spacing: -0.5px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .navbar-brand img {
      height: 32px;
      width: auto;
    }
    
    .navbar-brand:hover {
      transform: translateY(-1px);
      opacity: 0.85;
    }
    
    .module-badge {
      font-size: 0.875rem;
      font-weight: 600;
      color: #6c757d;
      padding: 0.5rem 1rem;
      background: #f8f9fa;
      border-radius: 6px;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }
    
    .navbar-nav {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-left: auto;
      flex-wrap: nowrap;
    }
    
    .nav-btn {
      display: inline-flex;
      flex-shrink: 0;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #495057;
      background: #ffffff;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      white-space: nowrap;
      min-width: fit-content;
    }
    
    .nav-btn:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .nav-btn.prev-btn {
      color: #6c757d;
      border-color: #ced4da;
    }
    
    .nav-btn.prev-btn:hover {
      background: #6c757d;
      color: white;
      border-color: #6c757d;
    }
    
    .nav-btn.next-btn {
      color: #0d6efd;
      border-color: #0d6efd;
    }
    
    .nav-btn.next-btn:hover {
      background: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    
    @media (max-width: 768px) {
      .navbar-container {
        padding: 0.75rem 1rem;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      
      .navbar-brand {
        font-size: 1.1rem;
        flex: 0 0 auto;
      }
      
      .navbar-brand img {
        height: 28px;
      }
      
      .navbar-brand span {
        font-size: 1rem;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .module-badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
        flex: 0 0 auto;
      }
      
      .navbar-nav {
        width: 100%;
        justify-content: space-between;
        margin-left: 0;
        margin-top: 0.5rem;
        gap: 0.5rem;
        flex-wrap: nowrap;
      }
      
      .nav-btn {
        flex: 1;
        justify-content: center;
        font-size: 0.8125rem;
        padding: 0.625rem 0.75rem;
        min-height: 44px;
      }
      
      .container {
        padding: 1.25rem 1rem;
        margin: 0.75rem auto;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      .row.g-3 > [class*="col-"] {
        margin-bottom: 1rem;
      }
      
      #uploadImagesBtn,
      #submitBtn {
        width: 100%;
        margin-bottom: 0.75rem;
      }
      
      /* Form inputs */
      .form-label {
        font-size: 0.9rem;
        font-weight: 600;
      }
      
      .form-control, .form-select, textarea {
        font-size: 1rem;
        padding: 0.75rem;
        min-height: 48px;
      }
      
      textarea.form-control {
        min-height: 120px;
      }
      
      /* Buttons */
      .btn {
        min-height: 48px;
        font-size: 1rem;
        padding: 0.75rem 1.5rem;
        touch-action: manipulation;
      }
      
      .btn-sm {
        min-height: 40px;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
      }
      
      /* Work items */
      .work-item {
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .work-item h6 {
        font-size: 1rem;
        margin-bottom: 0.75rem;
      }
      
      /* Signature canvas */
      canvas {
        max-width: 100%;
        height: auto;
        min-height: 150px;
        touch-action: none;
        border: 2px solid var(--border-light);
        border-radius: 8px;
      }
      
      /* Photo preview */
      .photo-preview {
        width: 100%;
        max-width: 150px;
        height: 150px;
        object-fit: cover;
      }
      
      /* Download links container */
      #download-links-container {
        margin-top: 1.5rem;
      }
      
      #download-links-container .btn {
        width: 100%;
        margin-bottom: 0.75rem;
      }
    }
    
    @media (max-width: 480px) {
      .navbar-brand span {
        font-size: 0.9rem;
        max-width: 140px;
      }
      
      .nav-btn {
        font-size: 0.75rem;
        padding: 0.5rem;
      }
      
      .container {
        padding: 1rem 0.75rem;
      }
      
      h2 {
        font-size: 1.35rem;
      }
      
      .form-control, .form-select, textarea {
        font-size: 0.9375rem;
      }
      
      .btn {
        font-size: 0.9375rem;
        padding: 0.625rem 1.25rem;
      }
      
      .work-item {
        padding: 0.875rem;
      }
      
      .photo-preview {
        max-width: 120px;
        height: 120px;
      }
    }
    
    /* Clean, spacious container */
    .container {
      max-width: 1200px;
      width: 100%;
      background: var(--white);
      border-radius: 8px;
      padding: 2rem 2.5rem;
      box-shadow: var(--shadow-sm);
      margin: 1.5rem auto;
      border: 1px solid var(--border-light);
    }
    
    /* Minimal typography */
    h2 {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 0.375rem;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }
    
    h5 {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 1rem;
      margin-top: 2rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-light);
      letter-spacing: -0.2px;
    }
    
    .text-muted {
      color: var(--text-secondary) !important;
      font-size: 0.9375rem;
      line-height: 1.5;
    }
    
    /* Minimal form labels */
    .form-label, label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.875rem;
      margin-bottom: 0.375rem;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.75rem;
    }
    
    /* Clean inputs with subtle borders */
    .form-control, .form-select, textarea {
      border: 1px solid var(--border-light);
      border-radius: 4px;
      padding: 0.625rem 0.875rem;
      transition: all 0.15s ease;
      font-size: 0.9375rem;
      background: var(--white);
      color: var(--text-primary);
    }
    
    .form-control:focus, .form-select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 84, 53, 0.06);
      outline: none;
    }
    
    /* Minimal flat buttons */
    .btn {
      border-radius: 4px;
      padding: 0.625rem 1.25rem;
      font-weight: 600;
      border: none;
      transition: all 0.15s ease;
      font-size: 0.875rem;
      letter-spacing: 0.2px;
    }
    
    .btn-primary, .btn-success {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover, .btn-success:hover {
      background: var(--primary-dark);
      box-shadow: 0 2px 8px rgba(18, 84, 53, 0.2);
    }
    
    .btn-outline-secondary {
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      background: transparent;
    }
    
    .btn-outline-secondary:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
      background: #fafafa;
    }
    
    /* Signature pad - Standardized size */
    canvas.signature-pad,
    #supervisorSignaturePad,
    #businessDevSignaturePad,
    #procurementSignaturePad,
    #generalManagerSignaturePad {
      border: 2px solid var(--border-light);
      border-radius: 6px;
      width: 100% !important;
      max-width: 100%;
      height: 120px !important;
      max-height: 120px !important;
      min-height: 120px !important;
      background: #ffffff;
      cursor: crosshair;
      display: block;
      touch-action: none;
    }
    
    /* Ensure canvas doesn't stretch */
    canvas.signature-pad,
    #supervisorSignaturePad,
    #businessDevSignaturePad,
    #procurementSignaturePad,
    #generalManagerSignaturePad {
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    
    .signature-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
      width: 100%;
      max-width: 500px;
    }
    
    .signature-label label {
      flex: 1;
      margin-bottom: 0;
    }
    
    .signature-hint {
      font-size: 0.75rem;
      color: var(--text-light);
      font-weight: 400;
      white-space: nowrap;
      flex-shrink: 0;
      text-align: right;
    }
    
    /* Ensure signature container properly wraps label and pad */
    .signature-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 500px;
    }
    
    .alert {
      border-radius: 4px;
      border: none;
      font-size: 0.875rem;
      padding: 0.875rem 1rem;
    }
    
    #statusBox {
      padding: 1rem;
      border-radius: 4px;
      background: var(--bg-page);
      border: 1px solid var(--border-light);
      margin-top: 1rem;
    }
    
    /* Upload Progress Modal */
    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .upload-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .upload-progress-bar {
      height: 30px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .upload-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #125435, #1a7a4f);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    /* Photo Preview Container */
    .photo-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 1rem;
      padding: 0.5rem;
      border: 1px dashed var(--border-light);
      border-radius: 4px;
      min-height: 60px;
    }
    
    .photo-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 4px;
      overflow: hidden;
      border: 2px solid var(--border-light);
    }
    
    .photo-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-preview-remove {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #dc3545;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .photo-preview-remove:hover {
      background: #c82333;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      flex-direction: column;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #e9ecef;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 1.5rem;
      font-size: 1.125rem;
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .loading-subtitle {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    /* Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border-light);
      border-radius: 4px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: var(--primary);
      background: #f8faf9;
    }
    
    .drop-zone-content {
      color: var(--text-secondary);
      font-size: 0.9375rem;
    }
    
    .drop-zone-content strong {
      display: block;
      color: var(--text-primary);
      margin-bottom: 0.375rem;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .drop-zone-content small {
      display: block;
      font-size: 0.8125rem;
      margin-top: 0.375rem;
      color: var(--text-light);
    }
    
    .photo-count {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      background: #e9ecef;
      border-radius: 4px;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }
    
    .photo-count.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .photo-count.danger {
      background: #f8d7da;
      color: #721c24;
    }
    
    .file-warning {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }
    
    .upload-progress {
      margin-top: 0.875rem;
      display: none;
    }
    
    /* Tabs styling */
    .nav-tabs {
      border-bottom: 1px solid var(--border-light);
      margin-bottom: 1.5rem;
    }
    
    .nav-tabs .nav-link {
      color: var(--text-secondary);
      border: none;
      border-bottom: 2px solid transparent;
      padding: 0.75rem 1rem;
      margin-right: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.15s ease;
    }
    
    .nav-tabs .nav-link.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background-color: transparent;
      font-weight: 600;
    }
    
    .nav-tabs .nav-link:hover {
      color: var(--text-primary);
      border-bottom-color: var(--border-light);
    }
    
    .section-heading {
      color: var(--primary);
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
    }
    
    .section-heading-no-border {
      color: var(--primary);
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
    }
    
    /* Work Items Table - Better alignment and spacing */
    .table {
      font-size: 0.875rem;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .table th {
      background: #f8faf9;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-light);
      padding: 0.875rem 0.75rem;
      text-align: center;
      vertical-align: middle;
      white-space: normal;
      overflow-wrap: anywhere;
    }
    
    .table td {
      vertical-align: middle;
      padding: 0.75rem 0.5rem;
      text-align: center;
    }
    
    .table td input,
    .table td textarea,
    .table td select {
      width: 100%;
      min-width: 0;
    }

    /* Make the work-items table fit the container without horizontal scrolling */
    .work-items-table-wrap {
      width: 100%;
      overflow-x: hidden;
      overflow-y: auto;
      max-height: 300px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      background: var(--white);
      margin-bottom: 1rem;
    }

    /* Work Items: each work asset is a block containing two tables */
    #workItemsContainer {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 0.75rem;
    }

    .work-item-block {
      position: relative;
      border: 1px solid var(--border-light);
      border-radius: 10px;
      background: var(--white);
      padding: 0.9rem 1rem 0.4rem;
    }

    .work-item-block::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--primary);
      opacity: 0.8;
    }

    .work-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding-left: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .work-item-title {
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.2px;
    }

    .work-item-meta {
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* Linked highlight across both tables inside a block */
    .work-items-table tbody tr.row-active {
      background: rgba(18, 84, 53, 0.07) !important;
    }

    .work-items-table tbody tr.row-active td {
      box-shadow: inset 0 0 0 1px rgba(18, 84, 53, 0.18);
    }

    .work-item-block.active {
      box-shadow: 0 0 0 3px rgba(18, 84, 53, 0.08);
      border-color: rgba(18, 84, 53, 0.25);
    }

    .work-items-table {
      width: 100%;
      table-layout: fixed;
      margin-bottom: 0;
    }

    .work-items-table thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #f8faf9;
    }

    .work-items-table tbody tr:nth-child(even) {
      background: #fbfcfd;
    }

    .work-items-table tbody tr:hover {
      background: #f1f5f9;
    }

    .work-items-table th,
    .work-items-table td {
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .work-items-table th:nth-child(1),
    .work-items-table th:last-child {
      white-space: nowrap;
      word-break: normal;
    }

    .work-items-table .form-control-sm {
      background: var(--white);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 0.45rem 0.6rem;
    }

    .work-items-table textarea.form-control-sm {
      min-height: 42px;
    }

    .work-items-table textarea {
      resize: vertical;
    }

    .work-items-section-title {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.9rem;
      margin: 0.75rem 0 0.5rem;
    }
    
    .table td:first-child {
      text-align: center;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .form-control-sm {
      font-size: 0.8125rem;
      padding: 0.5rem 0.625rem;
      text-align: left;
    }
    
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 1.5rem;
    }
    
    /* Button states */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
      border-width: 0.15em;
    }
    
    .gap-2 {
      gap: 0.5rem;
    }
    
    .d-flex {
      display: flex;
    }
    
    .d-none {
      display: none !important;
    }
    
    .ms-2 {
      margin-left: 0.5rem;
    }
    
    .mb-3 {
      margin-bottom: 1rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1.5rem 1.25rem;
        margin: 1rem;
        border-radius: 6px;
      }
      
      .navbar-container {
        padding: 0 1.25rem;
      }
      
      .d-flex {
        flex-direction: column;
      }
      
      .gap-2 > * {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-container">
      <a class="navbar-brand" href="/dashboard">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Injaaz">
        <span>Injaaz</span>
      </a>
      <div class="module-badge">Civil Works</div>
      <div class="navbar-nav">
        {% if is_edit_mode %}
        <a href="/dashboard" class="nav-btn next-btn">← Back to Dashboard</a>
        {% else %}
        <a href="/hvac-mep/form" class="nav-btn prev-btn">← Previous</a>
        <a href="/cleaning/form" class="nav-btn next-btn">Next →</a>
        {% endif %}
      </div>
    </div>
  </nav>
  
  <div class="container">
    <h2>Site Inspection Report - Civil{% if is_edit_mode %} - Edit Mode{% endif %}</h2>
    <p class="text-muted">
      {% if is_supervisor_edit %}
      Review the inspector's submission below. You can edit any fields, add new items, add your comments, verify, and sign to approve.
      {% elif is_edit_mode %}
      Review and edit the submission below. Signatures cannot be modified.
      {% else %}
      Complete the inspection form below
      {% endif %}
    </p>

    {% if is_edit_mode and can_edit == False %}
    <!-- Read-Only Mode Banner -->
    <div class="alert alert-info" style="background: #e0f2fe; border-color: #0ea5e9; margin-bottom: 1.5rem;">
      <div class="d-flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill me-3" viewBox="0 0 16 16" style="color: #0ea5e9; flex-shrink: 0;">
          <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
        </svg>
        <div>
          {% if submission_data and submission_data.workflow_status == 'closed_by_admin' %}
          <strong>Closed by Admin:</strong> This form has been closed by an administrator. It is read-only for all users.
          {% else %}
          <strong>Read-Only Mode:</strong> You are viewing this form for reference only. This form has moved past your approval stage in the workflow. Only the current reviewer can make changes.
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <form id="mainForm" novalidate>
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs" id="civilTabs" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="tab-1-link" data-bs-toggle="tab" data-bs-target="#tab-1" type="button" role="tab">1. Project Info</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="tab-2-link" data-bs-toggle="tab" data-bs-target="#tab-2" type="button" role="tab">2. Work Items</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="tab-3-link" data-bs-toggle="tab" data-bs-target="#tab-3" type="button" role="tab">3. Photos & Time</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="tab-4-link" data-bs-toggle="tab" data-bs-target="#tab-4" type="button" role="tab">4. Sign-off & Submit</button></li>
      </ul>

      <div class="tab-content" id="civilTabContent">
        <!-- TAB 1: Project Information -->
        <div class="tab-pane fade show active" id="tab-1" role="tabpanel">
          <h5>Project Information</h5>
      <div class="row g-3">
        <div class="col-md-6 mb-3">
          <label for="date">Date</label>
          <input id="date" name="date" type="date" class="form-control" {% if not is_supervisor_edit %}required{% endif %} max="">
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="project_name">Project Name</label>
          <input id="project_name" name="project_name" class="form-control" {% if not is_supervisor_edit %}required{% endif %}>
        </div>
        
        <div class="col-12 mb-3">
          <label for="description_of_work">Description of Work</label>
          <textarea id="description_of_work" name="description_of_work" class="form-control" rows="2"></textarea>
        </div>
        
        <div class="col-md-6 mb-3">
          <label for="area">Area</label>
          <select id="area" name="area" class="form-control" onchange="handleAreaChange()">
            <option value="">Select Area</option>
            <option value="General">General</option>
            <option value="Basement">Basement</option>
            <option value="Floor">Floor</option>
            <option value="Parking">Parking</option>
            <option value="Rooftop">Rooftop</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div class="col-md-6 mb-3" id="area_other_container" style="display: none;">
          <label for="area_other">Specify Other Area</label>
          <input id="area_other" name="area_other" class="form-control" placeholder="Enter area name">
        </div>
      </div>
      
      <div class="d-flex justify-content-end mt-4">
        <button type="button" class="btn btn-primary" onclick="goToTab(2)">Next →</button>
      </div>
    </div>
    
    <!-- TAB 2: Work Items -->
    <div class="tab-pane fade" id="tab-2" role="tabpanel">
      <h5>Work Items</h5>
      {% if is_supervisor_edit %}
      <p class="text-muted" style="font-size: 0.9rem;">Review and edit the work items submitted by the inspector below. You can modify fields or add new items.</p>
      {% endif %}
      <div class="mb-3">
        <button type="button" id="addRowBtn" class="btn btn-outline-secondary btn-sm">+ Add Work Item</button>
      </div>
      
      <div id="workItemsContainer" aria-label="Work items">
        <div class="work-item-block" data-index="1">
          <div class="work-item-header">
            <div>
              <div class="work-item-title">Work Item 1</div>
              <div class="work-item-meta">Details + Pricing</div>
            </div>
          </div>

          <div class="work-items-section-title">Work Item Details</div>
          <div class="work-items-table-wrap">
            <table class="table table-bordered work-items-table">
              <colgroup>
                <col style="width: 56px;">
                <col style="width: 28%;">
                <col style="width: 10%;">
                <col style="width: 32%;">
                <col style="width: 10%;">
                <col style="width: 20%;">
              </colgroup>
              <thead>
                <tr>
                  <th>SN</th>
                  <th>Work Description</th>
                  <th>Qty</th>
                  <th>Material Required with Brand</th>
                  <th>Qty</th>
                  <th>Specification</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="work-item-sn">1</td>
                  <td><input type="text" class="form-control form-control-sm" name="work_desc[]"></td>
                  <td><input type="number" class="form-control form-control-sm" name="work_qty[]"></td>
                  <td><input type="text" class="form-control form-control-sm" name="material[]"></td>
                  <td><input type="number" class="form-control form-control-sm" name="material_qty[]"></td>
                  <td><input type="text" class="form-control form-control-sm" name="specification[]"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="work-items-section-title">Pricing & Comments</div>
          <div class="work-items-table-wrap">
            <table class="table table-bordered work-items-table">
              <colgroup>
                <col style="width: 56px;">
                <col style="width: 14%;">
                <col style="width: 14%;">
                <col style="width: 22%;">
                <col style="width: 40%;">
                <col style="width: 76px;">
              </colgroup>
              <thead>
                <tr>
                  <th>SN</th>
                  <th>Unit Price</th>
                  <th>Price</th>
                  <th>Labour Needed (Hours/Day)</th>
                  <th>Comments</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="work-item-sn">1</td>
                  <td><input type="number" class="form-control form-control-sm" name="unit_price[]" step="0.01" placeholder="Unit"></td>
                  <td><input type="number" class="form-control form-control-sm" name="price[]" step="0.01"></td>
                  <td><input type="text" class="form-control form-control-sm" name="labour[]"></td>
                  <td><textarea class="form-control form-control-sm" name="comments[]" rows="2"></textarea></td>
                  <td><button type="button" class="btn btn-sm btn-outline-danger remove-work-item" title="Remove work item">×</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-outline-secondary" onclick="goToTab(1)">← Previous</button>
        <button type="button" class="btn btn-primary" onclick="goToTab(3)">Next →</button>
      </div>
    </div>
    
    <!-- TAB 3: Photos & Time Estimate -->
    <div class="tab-pane fade" id="tab-3" role="tabpanel">
      <h5>Pictures from Site</h5>
      
      <!-- Photos - Matching HVAC structure exactly -->
      <div class="col-12 mb-3">
        <label class="form-label">Photos (Maximum 100)</label>
        <input id="curPhotos" type="file" class="form-control d-none" accept="image/*" multiple>
        
        <div id="dropZone" class="drop-zone">
          <div class="drop-zone-content">
            <strong>Drag and drop images here</strong>
            <small>or click to browse • Maximum 100 images • Auto-compressed to 1280px • Max 10MB per file</small>
          </div>
        </div>
        
        <div id="fileWarning" class="file-warning">
          ⚠️ Some files are larger than 10MB and will be skipped
        </div>
        
        <div id="uploadProgress" class="upload-progress">
          <div class="progress">
            <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 0%"></div>
          </div>
        </div>
        
        <div id="photoCount" class="photo-count alert alert-info" style="display:none; padding: 0.5rem 1rem; margin-top: 0.5rem; border-radius: 4px; font-weight: 600; background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460;"></div>
        
        <!-- Photo Preview Container with Remove Buttons -->
        <div id="photoPreviewContainer" class="photo-preview-container" style="display:none; min-height: 140px;"></div>
      </div>
      
      
      <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-outline-secondary" onclick="goToTab(2)">← Previous</button>
        <button type="button" class="btn btn-primary" onclick="goToTab(4)">Next →</button>
      </div>
    </div>
    
    <!-- TAB 4: Sign-off & Submit -->
    <div class="tab-pane fade" id="tab-4" role="tabpanel">
      {% if user_designation == 'supervisor' %}
      <h4 class="section-heading-no-border">Supervisor Sign-off</h4>
      {% elif user_designation == 'operations_manager' %}
      <h4 class="section-heading-no-border">Operations Manager Review</h4>
      {% elif user_designation == 'business_development' %}
      <h4 class="section-heading-no-border">Business Development Review</h4>
      {% elif user_designation == 'procurement' %}
      <h4 class="section-heading-no-border">Procurement Review</h4>
      {% elif user_designation == 'general_manager' %}
      <h4 class="section-heading-no-border">General Manager Review</h4>
      {% else %}
      <h4 class="section-heading-no-border">Sign-off & Submit</h4>
      {% endif %}
      
      <div class="row g-3">
      <!-- Supervisor Review Section - Only visible to supervisors and admins -->
      {% if user_designation == 'supervisor' or (user and user.role == 'admin') %}
      <div class="col-12 mb-3" style="border-top: 2px solid var(--primary); padding-top: 1.5rem; margin-top: 1rem;">
        <h5 style="color: var(--primary); margin-bottom: 1rem;">Supervisor Review</h5>
          
          <div class="col-12 mb-3">
            <label class="form-label">Supervisor Comments</label>
            <textarea id="supervisorComments" class="form-control" rows="5" style="min-height: 120px;" placeholder="Enter your comments or observations..."></textarea>
          </div>
          
          <div class="col-12 mb-3">
            <button type="button" id="verifiedBtn" class="btn btn-success">
              <span id="verifiedBtnIcon">✓</span> Verified
            </button>
            <span id="verifiedStatus" class="ms-2" style="display: none; color: #059669; font-weight: 600;">✓ Verified</span>
          </div>
          
          <div class="col-md-6 mb-3">
            <div class="signature-container">
              <div class="signature-label">
                <label class="form-label mb-0" style="flex: 1;">Supervisor Signature</label>
                <span id="supervisorSignatureStatus" class="signature-hint" style="color: var(--primary); font-weight: 600;">
                  {% if is_edit_mode and submission_data and submission_data.workflow_status and (submission_data.workflow_status != 'submitted' and submission_data.workflow_status != 'rejected') %}
                    ✓ Form signed
                  {% else %}
                    Required for approval
                  {% endif %}
                </span>
              </div>
              <canvas id="supervisorSignaturePad" class="signature-pad"></canvas>
              <input type="hidden" id="supervisorSignatureData" name="supervisor_signature">
              <button type="button" id="clearSupervisor" class="btn btn-outline-secondary btn-sm mt-2">Clear</button>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'operations_manager' and is_edit_mode %}
        <!-- Previous Reviewers: Supervisor (Read-only for OM) -->
        <div class="col-12 mb-4" id="previousForOMSection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Supervisor -->
          <div id="supervisorReadOnlyOM" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Supervisor Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Supervisor Comments</label>
                <div id="supervisorCommentsReadOnlyOM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Supervisor Signature</label>
                <div id="supervisorSignatureReadOnlyOM" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Business Development -->
          <div id="bdReadOnlyOM" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Business Development Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Business Development Comments</label>
                <div id="bdCommentsReadOnlyOM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Business Development Signature</label>
                <div id="bdSignatureReadOnlyOM" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Procurement -->
          <div id="procurementReadOnlyOM" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Procurement Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Comments</label>
                <div id="procurementCommentsReadOnlyOM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Signature</label>
                <div id="procurementSignatureReadOnlyOM" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- General Manager -->
          <div id="gmReadOnlyOM" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">General Manager Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">General Manager Comments</label>
                <div id="gmCommentsReadOnlyOM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">General Manager Signature</label>
                <div id="gmSignatureReadOnlyOM" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- OM's Own Previous Review (Read-only if already approved) -->
        <div class="col-12 mb-4" id="omOwnReviewReadOnly" style="display: none;">
          <div class="alert alert-success mb-3" style="background: #f0fdf4; border-color: #10b981;">
            <strong>✓ Your Previous Review</strong>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Your Comments</label>
              <div id="omOwnCommentsReadOnly" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Your Signature</label>
              <div id="omOwnSignatureReadOnly" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <span style="color: #9ca3af;">Loading signature...</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Operations Manager Review Section (for new/pending approvals) -->
        <div class="col-12 mb-4" id="omEditableSection">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Comments</label>
              <textarea id="operationsManagerComments" class="form-control" rows="5" style="min-height: 120px; border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Operations Manager Signature</label>
                  <span id="opManSignatureHint" class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="opManSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="opManSignatureData" name="opMan_signature">
                <button type="button" id="clearOp" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'supervisor' and is_edit_mode %}
        <!-- Previous Reviewers: All reviews after Supervisor (Read-only for Supervisor) -->
        <div class="col-12 mb-4" id="previousForSupervisorSection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlySupervisor" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Comments</label>
                <div id="opsManagerCommentsReadOnlySupervisor" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Signature</label>
                <div id="opsManagerSignatureReadOnlySupervisor" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Business Development -->
          <div id="bdReadOnlySupervisor" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Business Development Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Business Development Comments</label>
                <div id="bdCommentsReadOnlySupervisor" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Business Development Signature</label>
                <div id="bdSignatureReadOnlySupervisor" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Procurement -->
          <div id="procurementReadOnlySupervisor" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Procurement Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Comments</label>
                <div id="procurementCommentsReadOnlySupervisor" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Signature</label>
                <div id="procurementSignatureReadOnlySupervisor" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- General Manager -->
          <div id="gmReadOnlySupervisor" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">General Manager Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">General Manager Comments</label>
                <div id="gmCommentsReadOnlySupervisor" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">General Manager Signature</label>
                <div id="gmSignatureReadOnlySupervisor" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'business_development' and is_edit_mode %}
        <!-- Previous Reviewers: Supervisor + Operations Manager + Procurement (Read-only for BD) -->
        <div class="col-12 mb-4" id="previousForBDSection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Supervisor -->
          <div id="supervisorReadOnlyBD" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Supervisor Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Supervisor Comments</label>
                <div id="supervisorCommentsReadOnlyBD" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Supervisor Signature</label>
                <div id="supervisorSignatureReadOnlyBD" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlySection" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Comments</label>
                <div id="opsManagerCommentsReadOnly" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Signature</label>
                <div id="opsManagerSignatureReadOnly" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Procurement (so BD can see if PO has signed) -->
          <div id="procurementReadOnlyBD" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Procurement Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Comments</label>
                <div id="procurementCommentsReadOnlyBD" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Signature</label>
                <div id="procurementSignatureReadOnlyBD" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Business Development Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Business Development Comments</label>
              <textarea id="businessDevComments" class="form-control" rows="5" style="min-height: 120px; border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Business Development Signature</label>
                  <span id="bdSignatureHint" class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="businessDevSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="businessDevSignatureData" name="business_dev_signature">
                <button type="button" id="clearBusinessDev" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'procurement' and is_edit_mode %}
        <!-- Previous Reviewers: Supervisor + Operations Manager + Business Development (Read-only for Procurement) -->
        <div class="col-12 mb-4" id="previousForProcurementSection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Supervisor -->
          <div id="supervisorReadOnlyProc" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Supervisor Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="supervisorCommentsReadOnlyProc" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="supervisorSignatureReadOnlyProc" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlyProc" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="opsManagerCommentsReadOnlyProc" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="opsManagerSignatureReadOnlyProc" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Business Development -->
          <div id="bdReadOnlyProc" style="display: none;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Business Development Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="bdCommentsReadOnlyProc" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="bdSignatureReadOnlyProc" style="min-height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; padding: 10px; display: flex; align-items: center; justify-content: center;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Procurement Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Comments</label>
              <textarea id="procurementComments" class="form-control" rows="5" style="min-height: 120px; border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">Procurement Signature</label>
                  <span id="procurementSignatureHint" class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="procurementSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="procurementSignatureData" name="procurement_signature">
                <button type="button" id="clearProcurement" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user_designation == 'general_manager' and is_edit_mode %}
        <!-- Previous Reviewers: Supervisor, Operations Manager, BD, Procurement (Read-only for GM) -->
        <div class="col-12 mb-4" id="previousReviewersReadOnlySection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>Previous Reviews</strong>
          </div>
          
          <!-- Supervisor -->
          <div id="supervisorReadOnlyGM" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Supervisor Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="supervisorCommentsReadOnlyGM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="supervisorSignatureReadOnlyGM" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlyGM" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="opsManagerCommentsReadOnlyGM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="opsManagerSignatureReadOnlyGM" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Business Development -->
          <div id="bdReadOnlyGM" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Business Development Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="bdCommentsReadOnlyGM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="bdSignatureReadOnlyGM" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Procurement -->
          <div id="procurementReadOnlyGM" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Procurement Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Comments</label>
                <div id="procurementCommentsReadOnlyGM" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; white-space: pre-wrap;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Signature</label>
                <div id="procurementSignatureReadOnlyGM" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- General Manager Review Section -->
        <div class="col-12 mb-4">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">General Manager Comments</label>
              <textarea id="generalManagerComments" class="form-control" rows="5" style="min-height: 120px; border-color: #d1d5db;" placeholder="Enter your review comments or observations here..."></textarea>
            </div>
            
            <div class="col-md-6 mb-3">
              <div class="signature-container h-100 d-flex flex-column">
                <div class="signature-label">
                  <label class="form-label fw-bold small text-uppercase mb-0" style="color: #4b5563;">General Manager Signature</label>
                  <span id="gmSignatureHint" class="signature-hint text-danger small">Required for approval</span>
                </div>
                <canvas id="generalManagerSignaturePad" class="signature-pad"></canvas>
                <input type="hidden" id="generalManagerSignatureData" name="general_manager_signature">
                <button type="button" id="clearGeneralManager" class="btn btn-link text-muted btn-sm text-decoration-none p-0 mt-1" style="width: fit-content;">Clear Signature</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user and user.role == 'admin' and is_edit_mode %}
        <!-- Admin View: All Previous Reviews (Read-only for Admin) -->
        <div class="col-12 mb-4" id="previousForAdminSection" style="display: none;">
          <div class="alert alert-info mb-3" style="background: #f0f9ff; border-color: #0ea5e9;">
            <strong>📋 Complete Review History - All Reviewers</strong>
          </div>
          
          <!-- Supervisor Review -->
          <div id="supervisorReadOnlyAdmin" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Supervisor Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Supervisor Comments</label>
                <div id="supervisorCommentsReadOnlyAdmin" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; max-height: 200px; padding: 0.75rem; white-space: pre-wrap; overflow-y: auto; word-wrap: break-word; line-height: 1.5;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Supervisor Signature</label>
                <div id="supervisorSignatureReadOnlyAdmin" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Operations Manager -->
          <div id="opsManagerReadOnlyAdmin" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Operations Manager Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Comments</label>
                <div id="opsManagerCommentsReadOnlyAdmin" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; max-height: 200px; padding: 0.75rem; white-space: pre-wrap; overflow-y: auto; word-wrap: break-word; line-height: 1.5;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Operations Manager Signature</label>
                <div id="opsManagerSignatureReadOnlyAdmin" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Business Development -->
          <div id="bdReadOnlyAdmin" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Business Development Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Business Development Comments</label>
                <div id="bdCommentsReadOnlyAdmin" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; max-height: 200px; padding: 0.75rem; white-space: pre-wrap; overflow-y: auto; word-wrap: break-word; line-height: 1.5;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Business Development Signature</label>
                <div id="bdSignatureReadOnlyAdmin" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Procurement -->
          <div id="procurementReadOnlyAdmin" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">Procurement Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Comments</label>
                <div id="procurementCommentsReadOnlyAdmin" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; max-height: 200px; padding: 0.75rem; white-space: pre-wrap; overflow-y: auto; word-wrap: break-word; line-height: 1.5;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">Procurement Signature</label>
                <div id="procurementSignatureReadOnlyAdmin" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- General Manager -->
          <div id="gmReadOnlyAdmin" style="display: none; margin-bottom: 1.5rem;">
            <h6 class="fw-bold mb-3" style="color: #0ea5e9;">General Manager Review</h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">General Manager Comments</label>
                <div id="gmCommentsReadOnlyAdmin" class="form-control" style="background: #f9fafb; border-color: #e5e7eb; min-height: 120px; max-height: 200px; padding: 0.75rem; white-space: pre-wrap; overflow-y: auto; word-wrap: break-word; line-height: 1.5;" readonly></div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold small text-uppercase" style="color: #4b5563;">General Manager Signature</label>
                <div id="gmSignatureReadOnlyAdmin" style="height: 120px; border: 2px solid #10b981; border-radius: 6px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #9ca3af;">Loading signature...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <div class="d-flex justify-content-between align-items-center gap-2 mb-3">
        <button type="button" class="btn btn-outline-secondary" onclick="goToTab(3)">← Previous</button>
        {% if can_edit != False %}
        <div class="d-flex gap-2">
          <button type="button" id="uploadImagesBtn" class="btn btn-success btn-lg">
            <span id="uploadImagesBtnText">📤 Upload Images</span>
          <span id="uploadImagesBtnSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
        </button>
        <button type="button" id="submitBtn" class="btn btn-primary btn-lg">
          <span id="submitBtnText">{% if is_edit_mode %}Update Submission{% else %}📄 Generate Reports{% endif %}</span>
        </button>
        </div>
        {% else %}
        <div class="alert alert-info mb-0" style="background: #f0f9ff; border-color: #0ea5e9; padding: 0.75rem 1rem;">
          <strong>Read-Only:</strong> This form is view-only. You cannot submit changes.
        </div>
        {% endif %}
      </div>
      <div id="uploadStatus" class="alert alert-info d-none mb-3"></div>
      <div id="statusBox" class="mt-3"></div>
      
      <!-- Download Links Container - appears below submit button -->
      <div id="download-links-container" style="display: none; margin-top: 1.5rem;"></div>
    </div>
    <!-- End TAB 4 -->
    
    </div>
    <!-- End tab-content -->
    </form>
  </div>

  <!-- Upload Progress Modal -->
  <div id="uploadModal" class="upload-modal">
    <div class="upload-modal-content">
      <h4 style="margin-bottom: 1rem;">Uploading Photos</h4>
      <div id="uploadModalText" style="margin-bottom: 1rem; color: #666;">
        Preparing images...
      </div>
      <div class="upload-progress-bar">
        <div id="uploadModalProgress" class="upload-progress-fill" style="width: 0%">
          0%
        </div>
      </div>
      <small style="color: #999; display: block; margin-top: 0.5rem;">Please wait, this may take a few minutes for large batches</small>
    </div>
  </div>

  <!-- Loading Overlay for Report Generation -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Generating Reports...</div>
    <div class="loading-subtitle">This typically takes 2-3 minutes for large submissions</div>
    <div class="loading-subtitle" style="margin-top: 1.5rem; font-size: 0.8rem;">Creating Excel and PDF reports with all photos</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="{{ url_for('static', filename='dropdown_init.js') }}"></script>
  <script src="{{ url_for('static', filename='form.js') }}"></script>
  
  <script>
    // ALWAYS define pollJobStatus globally to ensure it's available
    // This will override form.js if it loaded, or serve as fallback if it didn't
    window.pollJobStatus = window.pollJobStatus || async function(modulePrefix, jobId, onUpdate, interval=1500) {
      const statusUrl = `${modulePrefix}/status/${jobId}`;
      return new Promise((resolve, reject) => {
        const id = setInterval(async () => {
          try {
            const r = await fetch(statusUrl);
            if (!r.ok) throw new Error('Job not found');
            const js = await r.json();
            if (onUpdate) onUpdate(js);
            // Check both 'state' (legacy) and 'status' (current)
            const isDone = js.state === 'done' || js.status === 'completed';
            const isFailed = js.state === 'failed' || js.status === 'failed';
            if (isDone || isFailed) {
              clearInterval(id);
              resolve(js);
            }
          } catch (e) {
            clearInterval(id);
            reject(e);
          }
        }, interval);
      });
    };
    
    // Also define it without window prefix for compatibility
    if (typeof pollJobStatus === 'undefined') {
      var pollJobStatus = window.pollJobStatus;
    }
    
    if (window.safeLog) {
      window.safeLog.log('✅ pollJobStatus is now available globally');
    }
  </script>

  <script>
    console.log('🔄🔄🔄 CIVIL FORM JAVASCRIPT LOADED - VERSION 2026-01-24 11:58 🔄🔄🔄');
    const modulePrefix = "{{ url_for('civil_bp.index') }}".replace('/form','');
    const MAX_PHOTOS = 100;
    const MAX_IMAGE_DIMENSION = 1280;
    const JPEG_QUALITY = 0.85;
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    const DRAFT_SAVE_INTERVAL = 30000; // 30 seconds

    // Tab navigation function
    function goToTab(tabNumber) {
      const tabLink = document.getElementById(`tab-${tabNumber}-link`);
      if (tabLink) {
        tabLink.click();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }
    
    // Handle Area dropdown - show/hide "Other" text field
    function handleAreaChange() {
      const areaSelect = document.getElementById('area');
      const otherContainer = document.getElementById('area_other_container');
      const otherInput = document.getElementById('area_other');
      
      if (areaSelect.value === 'Other') {
        otherContainer.style.display = 'block';
        otherInput.required = true;
      } else {
        otherContainer.style.display = 'none';
        otherInput.required = false;
        otherInput.value = '';
      }
    }

    // Define initSignaturePads if not already defined in form.js
    function initSignaturePads() {
      if (typeof SignaturePad === 'undefined') {
        console.error('❌ SignaturePad library not loaded. Signature capture disabled.');
        return { supervisorPad: null };
      }

      const supervisorPadEl = document.getElementById('supervisorSignaturePad');
      
      function setupSignaturePad(canvas, padName) {
        if (!canvas) return null;
        
        const pad = new SignaturePad(canvas, {
          backgroundColor: 'rgb(255, 255, 255)',
          penColor: 'rgb(0, 0, 0)',
          minWidth: 1,
          maxWidth: 3,
          throttle: 16
        });
        
        // Properly resize canvas to prevent stretching
        function resizeCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const rect = canvas.getBoundingClientRect();

          // If this canvas is in a hidden tab, it may report 0x0.
          // We'll retry resizing when the Sign-off tab is shown.
          if (!rect.width || !rect.height) {
            pad._needsResize = true;
            return;
          }
          
          // Set display size
          canvas.style.width = rect.width + 'px';
          canvas.style.height = rect.height + 'px';
          
          // Set actual size in memory (scaled for DPI)
          canvas.width = rect.width * ratio;
          canvas.height = rect.height * ratio;
          
          // Scale the drawing context so everything draws at correct size
          const ctx = canvas.getContext('2d');
          ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
          
          // Redraw signature if it exists
          if (!pad.isEmpty()) {
            const data = pad.toData();
            pad.clear();
            pad.fromData(data);
          }

          pad._needsResize = false;
        }
        
        // Initial resize
        resizeCanvas();
        
        // Resize on window resize
        window.addEventListener('resize', resizeCanvas);

        // Expose resize hook so we can resize when the tab becomes visible
        pad._resizeCanvas = resizeCanvas;
        pad._needsResize = false;
        
        return pad;
      }
      
      const supervisorPad = setupSignaturePad(supervisorPadEl, 'supervisor');
      const opPadEl = document.getElementById('opManSignaturePad');
      const businessDevPadEl = document.getElementById('businessDevSignaturePad');
      const procurementPadEl = document.getElementById('procurementSignaturePad');
      const generalManagerPadEl = document.getElementById('generalManagerSignaturePad');
      const opPad = setupSignaturePad(opPadEl, 'op');
      const businessDevPad = setupSignaturePad(businessDevPadEl, 'businessDev');
      const procurementPad = setupSignaturePad(procurementPadEl, 'procurement');
      const generalManagerPad = setupSignaturePad(generalManagerPadEl, 'generalManager');
      if (supervisorPad) {
        const clearSupervisorBtn = document.getElementById('clearSupervisor');
        if (clearSupervisorBtn) {
          clearSupervisorBtn.addEventListener('click', () => {
            supervisorPad.clear();
            const supervisorSigInput = document.getElementById('supervisorSignatureData');
            if (supervisorSigInput) supervisorSigInput.value = '';
          });
        }
      }
      if (businessDevPad) {
        const clearBusinessDevBtn = document.getElementById('clearBusinessDev');
        if (clearBusinessDevBtn) {
          clearBusinessDevBtn.addEventListener('click', () => {
            businessDevPad.clear();
            const businessDevSigInput = document.getElementById('businessDevSignatureData');
            if (businessDevSigInput) businessDevSigInput.value = '';
            
            // Reset signature hint
            const bdHint = document.getElementById('bdSignatureHint');
            if (bdHint) {
              bdHint.textContent = 'Required for approval';
              bdHint.classList.remove('text-success');
              bdHint.classList.add('text-danger');
            }
          });
        }
      }
      if (procurementPad) {
        const clearProcurementBtn = document.getElementById('clearProcurement');
        if (clearProcurementBtn) {
          clearProcurementBtn.addEventListener('click', () => {
            procurementPad.clear();
            const procurementSigInput = document.getElementById('procurementSignatureData');
            if (procurementSigInput) procurementSigInput.value = '';
            
            // Reset signature hint
            const procurementHint = document.getElementById('procurementSignatureHint');
            if (procurementHint) {
              procurementHint.textContent = 'Required for approval';
              procurementHint.classList.remove('text-success');
              procurementHint.classList.add('text-danger');
            }
          });
        }
      }
      if (opPad) {
        const clearOpBtn = document.getElementById('clearOp');
        if (clearOpBtn) {
          clearOpBtn.addEventListener('click', () => {
            opPad.clear();
            const opSigInput = document.getElementById('opManSignatureData');
            if (opSigInput) opSigInput.value = '';
            
            // Reset signatureLoaded flag so resize works properly
            const opCanvas = document.getElementById('opManSignaturePad');
            if (opCanvas) opCanvas.dataset.signatureLoaded = 'false';
            
            // Reset signature hint back to "Required for approval"
            const opManHint = document.getElementById('opManSignatureHint');
            if (opManHint) {
              opManHint.textContent = 'Required for approval';
              opManHint.classList.remove('text-success');
              opManHint.classList.add('text-danger');
            }
          });
        }
      }
      if (generalManagerPad) {
        const clearGeneralManagerBtn = document.getElementById('clearGeneralManager');
        if (clearGeneralManagerBtn) {
          clearGeneralManagerBtn.addEventListener('click', () => {
            generalManagerPad.clear();
            const generalManagerSigInput = document.getElementById('generalManagerSignatureData');
            if (generalManagerSigInput) generalManagerSigInput.value = '';
            
            // Reset signature hint
            const gmHint = document.getElementById('gmSignatureHint');
            if (gmHint) {
              gmHint.textContent = 'Required for approval';
              gmHint.classList.remove('text-success');
              gmHint.classList.add('text-danger');
            }
          });
        }
      }

      return { supervisorPad, opPad, businessDevPad, procurementPad, generalManagerPad };
    }
    
    // Define checkBrowserSupport function
    function checkBrowserSupport() {
      return !!(window.FileReader && window.File && window.FileList && window.Blob);
    }

    (function(){
      // Ensure pollJobStatus is available inside this IIFE
      // Use window.pollJobStatus if available, otherwise define it inline
      const pollJobStatusFn = (typeof window !== 'undefined' && window.pollJobStatus) 
        ? window.pollJobStatus 
        : async function(modulePrefix, jobId, onUpdate, interval=1500) {
            const statusUrl = `${modulePrefix}/status/${jobId}`;
            return new Promise((resolve, reject) => {
              const id = setInterval(async () => {
                try {
                  const r = await fetch(statusUrl);
                  if (!r.ok) throw new Error('Job not found');
                  const js = await r.json();
                  if (onUpdate) onUpdate(js);
                  const isDone = js.state === 'done' || js.status === 'completed';
                  const isFailed = js.state === 'failed' || js.status === 'failed';
                  if (isDone || isFailed) {
                    clearInterval(id);
                    resolve(js);
                  }
                } catch (e) {
                  clearInterval(id);
                  reject(e);
                }
              }, interval);
            });
          };
      
      // Make it available globally as well
      if (typeof window !== 'undefined') {
        window.pollJobStatusFn = pollJobStatusFn;
      }
      
      const form = document.getElementById('mainForm');
      const statusBox = document.getElementById('statusBox');
      const curPhotos = document.getElementById('curPhotos');
      const dropZone = document.getElementById('dropZone');
      const photoPreviewContainer = document.getElementById('photoPreviewContainer');
      const photoCount = document.getElementById('photoCount');
      const fileWarning = document.getElementById('fileWarning');
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadModal = document.getElementById('uploadModal');
      const uploadModalText = document.getElementById('uploadModalText');
      const uploadModalProgress = document.getElementById('uploadModalProgress');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const uploadImagesBtn = document.getElementById('uploadImagesBtn');
      const uploadImagesBtnText = document.getElementById('uploadImagesBtnText');
      const uploadImagesBtnSpinner = document.getElementById('uploadImagesBtnSpinner');
      const uploadStatus = document.getElementById('uploadStatus');
      const submitBtn = document.getElementById('submitBtn');
      const submitBtnText = document.getElementById('submitBtnText');
      
      // Verified button handler (for supervisor)
      const verifiedBtn = document.getElementById('verifiedBtn');
      const verifiedStatus = document.getElementById('verifiedStatus');
      let isVerified = false;
      
      if (verifiedBtn) {
        verifiedBtn.addEventListener('click', () => {
          isVerified = !isVerified;
          if (isVerified) {
            verifiedBtn.classList.remove('btn-success');
            verifiedBtn.classList.add('btn-outline-success');
            verifiedBtn.innerHTML = '<span id="verifiedBtnIcon">✓</span> Verified';
            if (verifiedStatus) {
              verifiedStatus.style.display = 'inline';
              verifiedStatus.textContent = '✓ Verified';
            }
          } else {
            verifiedBtn.classList.remove('btn-outline-success');
            verifiedBtn.classList.add('btn-success');
            verifiedBtn.innerHTML = '<span id="verifiedBtnIcon">✓</span> Verify';
            if (verifiedStatus) {
              verifiedStatus.style.display = 'none';
            }
          }
        });
      }
      
      // Track uploaded photos
      let photosUploaded = false;
      let uploadedPhotoUrls = [];
      
      // Initialize signature pads after DOM is fully loaded
      let pads = null;
      document.addEventListener('DOMContentLoaded', function() {
        pads = initSignaturePads();
        // Make pads available globally
        window.signaturePads = pads;
        window.pads = pads;
        
        console.log('Signature pads initialized:', pads);
        
        // Enable submit button by default (photos are optional)
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn && !window.editSubmissionId) {
          submitBtn.disabled = false;
        }

        // When the Sign-off tab becomes visible, resize canvases (Bootstrap tabs hide them by default)
        const tab4Link = document.getElementById('tab-4-link');
        if (tab4Link) {
          tab4Link.addEventListener('shown.bs.tab', () => {
            if (!pads) {
              pads = initSignaturePads();
              window.signaturePads = pads;
              window.pads = pads;
            }

            ['techPad', 'opPad', 'supervisorPad'].forEach((key) => {
              const pad = pads && pads[key];
              if (pad && typeof pad._resizeCanvas === 'function') {
                pad._resizeCanvas();
              }
            });
            
            // Reload signatures when tab becomes visible (in case they didn't load before)
            if (window.editSubmissionId) {
              setTimeout(() => {
                if (typeof loadSignatures === 'function') {
                  loadSignatures();
                }
              }, 200);
            }
          });
        }
      });
      
      // Also try immediate initialization in case DOMContentLoaded already fired
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(function() {
          if (!pads) {
            pads = initSignaturePads();
            window.signaturePads = pads;
            window.pads = pads;
            console.log('Signature pads initialized (immediate):', pads);
          }
        }, 100);
      }

      // Helper function to format timestamp (converts UTC to Dubai time)
      function formatSigningTime(timestamp) {
        if (!timestamp) return '';
        try {
          // Ensure timestamp is treated as UTC (backend stores UTC without 'Z' suffix)
          let utcTimestamp = timestamp;
          if (typeof timestamp === 'string' && !timestamp.endsWith('Z') && !timestamp.includes('+')) {
            utcTimestamp = timestamp + 'Z';
          }
          const date = new Date(utcTimestamp);
          const options = {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true,
            timeZone: 'Asia/Dubai'
          };
          return date.toLocaleString('en-US', options) + ' (GST)';
        } catch (e) {
          return '';
        }
      }
      
      // Standard function to display signatures in read-only containers
      // This ensures all signatures are displayed consistently with proper aspect ratio
      function displaySignatureInContainer(containerId, signatureData, altText) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        // Clear container
        container.innerHTML = '';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        
        if (!signatureData) {
          container.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
          return;
        }
        
        // Extract signature URL
        let sigUrl = signatureData;
        if (typeof sigUrl === 'object' && sigUrl !== null && sigUrl.url) {
          sigUrl = sigUrl.url;
        }
        
        // Validate signature URL
        if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
          const img = document.createElement('img');
          img.src = sigUrl;
          img.alt = altText || 'Signature';
          // Standard signature display style - maintains aspect ratio, centered, contained
          img.style.cssText = 'max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; object-position: center; display: block;';
          img.onerror = () => {
            container.innerHTML = '<span style="color: #dc3545;">Failed to load signature</span>';
          };
          container.appendChild(img);
        } else {
          container.innerHTML = '<span style="color: #9ca3af;">Signature not available</span>';
        }
      }

      // Load submission data if in edit mode
      function loadSubmissionData() {
        {% if is_edit_mode and submission_data %}
        try {
          const submissionData = {{ submission_data|tojson }};
          console.log('📋 Full submissionData:', submissionData);
          
          // Parse form_data if it's a string
          let formData = submissionData.form_data || {};
          if (typeof formData === 'string') {
            try {
              formData = JSON.parse(formData);
              console.log('✅ Parsed form_data from string');
            } catch (e) {
              console.warn('⚠️ Failed to parse form_data as JSON:', e);
              formData = {};
            }
          }
          
          console.log('📋 Parsed formData:', formData);
          console.log('📋 Supervisor signature in formData:', formData.supervisor_signature);
          console.log('📋 All formData keys:', Object.keys(formData));
          
          // Pre-fill basic fields
          if (submissionData.site_name) {
            const projectNameField = document.getElementById('project_name');
            if (projectNameField) {
              projectNameField.value = submissionData.site_name;
              console.log('✅ Loaded project_name:', submissionData.site_name);
            }
          } else if (formData.project_name) {
            const projectNameField = document.getElementById('project_name');
            if (projectNameField) {
              projectNameField.value = formData.project_name;
              console.log('✅ Loaded project_name from formData:', formData.project_name);
            }
          }
          
          if (submissionData.visit_date) {
            const dateField = document.getElementById('date');
            if (dateField) {
              dateField.value = submissionData.visit_date;
              console.log('✅ Loaded visit_date:', submissionData.visit_date);
            }
          } else if (formData.visit_date) {
            const dateField = document.getElementById('date');
            if (dateField) {
              dateField.value = formData.visit_date;
              console.log('✅ Loaded visit_date from formData:', formData.visit_date);
            }
          }
          
          // Load other fields from formData (guarded; some legacy fields were removed)
          ['description_of_work'].forEach(field => {
            const fieldEl = document.getElementById(field);
            if (fieldEl && formData[field]) {
              fieldEl.value = formData[field];
              console.log(`✅ Loaded ${field}:`, formData[field]);
            }
          });

          // Area dropdown (replaces old location/floor/developer/city_area inputs)
          const areaEl = document.getElementById('area');
          const areaOtherEl = document.getElementById('area_other');
          const areaOtherContainer = document.getElementById('area_other_container');
          if (areaEl && formData.area) {
            areaEl.value = formData.area;
          }
          if (areaOtherEl && formData.area_other) {
            areaOtherEl.value = formData.area_other;
          }
          if (areaEl && areaOtherContainer && areaOtherEl) {
            if (areaEl.value === 'Other') {
              areaOtherContainer.style.display = 'block';
              areaOtherEl.required = true;
            } else {
              areaOtherContainer.style.display = 'none';
              areaOtherEl.required = false;
            }
          }
          
          // Load photo URLs - extract from work_items or direct photo_urls
          let allPhotoUrls = [];
          
          // First, try to get photos from work_items (civil form stores photos per work item)
          if (Array.isArray(formData.work_items)) {
            formData.work_items.forEach((item, itemIdx) => {
              if (item.photo_urls && Array.isArray(item.photo_urls)) {
                item.photo_urls.forEach((photoUrl) => {
                  // Convert relative URLs to absolute
                  let url = photoUrl;
                  if (typeof url === 'string' && url.startsWith('/')) {
                    url = window.location.origin + url;
                  } else if (typeof url === 'object' && url !== null) {
                    // Handle object format
                    url = url.url || url.path || url;
                    if (typeof url === 'string' && url.startsWith('/')) {
                      url = window.location.origin + url;
                    }
                  }
                  if (url) allPhotoUrls.push(url);
                });
                console.log(`📸 Found ${item.photo_urls.length} photos in work item ${itemIdx + 1}`);
              } else if (item.photos && Array.isArray(item.photos)) {
                // Handle photos as objects with url property
                item.photos.forEach((photo) => {
                  let url = typeof photo === 'string' ? photo : (photo.url || photo.path);
                  if (url && typeof url === 'string' && url.startsWith('/')) {
                    url = window.location.origin + url;
                  }
                  if (url) allPhotoUrls.push(url);
                });
                console.log(`📸 Found ${item.photos.length} photos (object format) in work item ${itemIdx + 1}`);
              }
            });
          }
          
          // Also check direct photo_urls field
          if (formData.photo_urls && Array.isArray(formData.photo_urls)) {
            formData.photo_urls.forEach((photoUrl) => {
              let url = photoUrl;
              if (typeof url === 'string' && url.startsWith('/')) {
                url = window.location.origin + url;
              } else if (typeof url === 'object' && url !== null) {
                url = url.url || url.path || url;
                if (typeof url === 'string' && url.startsWith('/')) {
                  url = window.location.origin + url;
                }
              }
              if (url) allPhotoUrls.push(url);
            });
            console.log(`📸 Found ${formData.photo_urls.length} photos in direct photo_urls field`);
          }
          
          // Remove duplicates
          uploadedPhotoUrls = [...new Set(allPhotoUrls)];
          photosUploaded = uploadedPhotoUrls.length > 0;
          
          console.log('📸 Total unique photos found:', uploadedPhotoUrls.length);
          console.log('📸 Photo URLs:', uploadedPhotoUrls);
          
          // Display photos in preview container if we have any
          if (photoPreviewContainer) {
            photoPreviewContainer.innerHTML = '';
            
            if (photosUploaded && uploadedPhotoUrls.length > 0) {
              photoPreviewContainer.style.display = 'flex';
              photoPreviewContainer.style.flexWrap = 'wrap';
              photoPreviewContainer.style.gap = '10px';
              photoPreviewContainer.style.marginTop = '1rem';
              photoPreviewContainer.style.padding = '0.5rem';
              photoPreviewContainer.style.minHeight = '140px';
              photoPreviewContainer.style.border = '1px dashed #dee2e6';
              photoPreviewContainer.style.borderRadius = '4px';
              photoPreviewContainer.style.backgroundColor = '#f8f9fa';
              
              uploadedPhotoUrls.forEach((photoUrl, idx) => {
                // Ensure URL is absolute
                let absoluteUrl = photoUrl;
                if (typeof photoUrl === 'string' && photoUrl.startsWith('/')) {
                  absoluteUrl = window.location.origin + photoUrl;
                }
                
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-item';
                photoDiv.style.cssText = 'position: relative; display: inline-block; margin: 8px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: #f8f9fa; border: 2px solid #dee2e6;';
                
                const img = document.createElement('img');
                img.src = absoluteUrl;
                img.alt = `Photo ${idx + 1}`;
                img.style.cssText = 'display: block !important; width: 120px !important; height: 120px !important; object-fit: cover; background: #fff; cursor: pointer;';
                img.onclick = () => window.open(absoluteUrl, '_blank');
                img.onerror = () => {
                  console.error('❌ Image failed to load:', absoluteUrl);
                  // Try to show error indicator
                  photoDiv.innerHTML = '<div style="width:120px;height:120px;display:flex;align-items:center;justify-content:center;color:#dc3545;font-size:12px;">Failed to load</div>';
                };
                img.onload = () => {
                  console.log(`✅ Photo ${idx + 1} loaded successfully:`, absoluteUrl);
                };
                
                photoDiv.appendChild(img);
                photoPreviewContainer.appendChild(photoDiv);
              });
              
              updatePhotoCount();
              console.log('✅ Loaded and displayed', uploadedPhotoUrls.length, 'photos from submission');
            } else {
              // Show message if no photos
              photoPreviewContainer.style.display = 'none';
              console.log('ℹ️ No photos found in submission');
            }
          } else {
            console.warn('⚠️ photoPreviewContainer element not found');
          }

          // Load work items into the new block-based UI
          if (Array.isArray(formData.work_items)) {
            const container = document.getElementById('workItemsContainer');
            if (container) {
              const template = container.querySelector('.work-item-block');
              const templateClone = template ? template.cloneNode(true) : null;
              container.innerHTML = '';

              const ensureTemplate = () => {
                if (templateClone) {
                  const c = templateClone.cloneNode(true);
                  // clear all values
                  c.querySelectorAll('input').forEach((input) => {
                    if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                    else input.value = '';
                  });
                  c.querySelectorAll('textarea').forEach((ta) => (ta.value = ''));
                  c.classList.remove('active');
                  c.querySelectorAll('tr.row-active').forEach((tr) => tr.classList.remove('row-active'));
                  return c;
                }
                return null;
              };

              const items = formData.work_items.length ? formData.work_items : [{}];
              items.forEach((wi, idx) => {
                const block = ensureTemplate();
                if (!block) return;
                const setIf = (sel, val) => {
                  const el = block.querySelector(sel);
                  if (el && val !== undefined && val !== null) {
                    el.value = String(val);
                    console.log(`✅ Loaded field ${sel} with value:`, String(val).substring(0, 50));
                  }
                };

                // Load all work item fields - check multiple possible field names for compatibility
                setIf('input[name="work_desc[]"]', wi.description ?? wi.work_desc ?? wi.work_description);
                setIf('input[name="work_qty[]"]', wi.quantity ?? wi.work_qty ?? wi.qty);
                setIf('input[name="material[]"]', wi.material ?? wi.material_name);
                setIf('input[name="material_qty[]"]', wi.material_qty ?? wi.material_quantity);
                setIf('input[name="specification[]"]', wi.specification ?? wi.spec);
                setIf('input[name="unit_price[]"]', wi.unit_price ?? wi.unitPrice);
                setIf('input[name="price[]"]', wi.price ?? wi.total_price ?? wi.totalPrice);
                setIf('input[name="labour[]"]', wi.labour ?? wi.labor ?? wi.labour_cost);
                setIf('textarea[name="comments[]"]', wi.comments ?? wi.comment ?? wi.remarks);
                
                // Preserve photo_urls in work item data (they're already extracted above for display)
                // Store them in a data attribute for reference
                if (wi.photo_urls && Array.isArray(wi.photo_urls)) {
                  block.dataset.photoUrls = JSON.stringify(wi.photo_urls);
                  console.log(`✅ Preserved ${wi.photo_urls.length} photos for work item ${idx + 1}`);
                }

                container.appendChild(block);
                console.log(`✅ Loaded work item ${idx + 1} with all fields`);
              });

              // Renumber blocks + SN display
              if (typeof renumberWorkItems === 'function') {
                renumberWorkItems();
              }
            }
          }
          
          // Load signatures
          let signatureLoadAttempts = 0;
          const maxSignatureLoadAttempts = 10;
          
          function loadSignatures() {
            const pads = window.signaturePads;
            
            // Check if supervisor signature pad element exists in DOM (only for supervisors/admins)
            const supervisorPadEl = document.getElementById('supervisorSignaturePad');
            const supervisorCommentsEl = document.getElementById('supervisorComments');
            const isSupervisorView = supervisorPadEl !== null || supervisorCommentsEl !== null;
            
            // Only wait for supervisor pad if the element exists
            if (isSupervisorView && (!pads || !pads.supervisorPad)) {
              signatureLoadAttempts++;
              if (signatureLoadAttempts < maxSignatureLoadAttempts) {
              setTimeout(loadSignatures, 200);
              } else {
                console.warn('⚠️ Signature pad not ready after', maxSignatureLoadAttempts, 'attempts');
              }
              return;
            }
            
            signatureLoadAttempts = 0; // Reset counter when pad is ready (or not needed)
            
            // Load supervisor comments and signature (only if supervisor section exists)
            if (isSupervisorView && formData.supervisor_comments) {
              const commentsField = document.getElementById('supervisorComments');
              if (commentsField) {
                commentsField.value = formData.supervisor_comments || '';
              }
            }
            
            // Load verified status (only if supervisor section exists)
            if (isSupervisorView && formData.supervisor_verified) {
              const verifiedBtn = document.getElementById('verifiedBtn');
              const verifiedStatus = document.getElementById('verifiedStatus');
              if (verifiedBtn) {
                isVerified = true;
                verifiedBtn.classList.remove('btn-success');
                verifiedBtn.classList.add('btn-outline-success');
                verifiedBtn.innerHTML = '<span id="verifiedBtnIcon">✓</span> Verified';
                if (verifiedStatus) {
                  verifiedStatus.style.display = 'inline';
                  verifiedStatus.textContent = '✓ Verified';
                }
              }
            }
            
            // Load supervisor signature - check multiple possible locations (only if supervisor section exists)
            let supervisorSig = null;
            if (isSupervisorView) {
              // First check formData
              if (formData.supervisor_signature) {
                supervisorSig = formData.supervisor_signature;
              }
              
              // Also check submissionData.form_data if formData doesn't have it
              if (!supervisorSig && submissionData && submissionData.form_data) {
                let checkFormData = submissionData.form_data;
                if (typeof checkFormData === 'string') {
                  try {
                    checkFormData = JSON.parse(checkFormData);
                  } catch (e) {
                    console.warn('Failed to parse form_data as JSON:', e);
                  }
                }
                if (checkFormData && checkFormData.supervisor_signature) {
                  supervisorSig = checkFormData.supervisor_signature;
                }
              }
              
              // Also check top-level submissionData
              if (!supervisorSig && submissionData && submissionData.supervisor_signature) {
                supervisorSig = submissionData.supervisor_signature;
              }
              
              // Process and display signature if found
              if (supervisorSig) {
              console.log('📝 Found supervisor signature:', supervisorSig);
              console.log('📝 Signature type:', typeof supervisorSig);
              console.log('📝 Signature value:', JSON.stringify(supervisorSig).substring(0, 200));
              
              // Handle object format with url property
              if (typeof supervisorSig === 'object' && supervisorSig !== null) {
                if (supervisorSig.url) {
                supervisorSig = supervisorSig.url;
                  console.log('📝 Extracted URL from object:', supervisorSig.substring(0, 50) + '...');
                } else if (supervisorSig.path) {
                  supervisorSig = supervisorSig.path;
                  console.log('📝 Extracted path from object:', supervisorSig.substring(0, 50) + '...');
                } else {
                  console.warn('⚠️ Supervisor signature object has no url or path property:', Object.keys(supervisorSig));
                }
              }
              
              // Convert relative URLs to absolute URLs
              if (typeof supervisorSig === 'string' && supervisorSig.startsWith('/')) {
                // Convert relative path to absolute URL
                supervisorSig = window.location.origin + supervisorSig;
                console.log('📝 Converted relative URL to absolute:', supervisorSig);
              }
              
              // Only proceed if we have a valid URL string
              if (typeof supervisorSig === 'string' && (supervisorSig.startsWith('data:image') || supervisorSig.startsWith('http'))) {
                const supervisorCanvas = document.getElementById('supervisorSignaturePad');
                if (supervisorCanvas && pads && pads.supervisorPad) {
                  console.log('📝 Loading supervisor signature into pad:', supervisorSig.substring(0, 50) + '...');
                  
                  // Load signature into pad
                  const img = new Image();
                  img.crossOrigin = 'anonymous';
                  
                  img.onload = function() {
                    try {
                      console.log('📝 Image loaded, dimensions:', img.width, 'x', img.height);
                      console.log('📝 Canvas dimensions:', supervisorCanvas.width, 'x', supervisorCanvas.height);
                      
                      // Use display size (getBoundingClientRect) so fit matches what user sees
                      const rect = supervisorCanvas.getBoundingClientRect();
                      const cw = rect.width || supervisorCanvas.width;
                      const ch = rect.height || supervisorCanvas.height;
                      const imgAspect = img.width / img.height;
                      const padAspect = cw / ch;
                      let drawW, drawH, drawX, drawY;
                      if (imgAspect > padAspect) {
                        drawW = cw;
                        drawH = cw / imgAspect;
                        drawX = 0;
                        drawY = (ch - drawH) / 2;
                      } else {
                        drawH = ch;
                        drawW = ch * imgAspect;
                        drawX = (cw - drawW) / 2;
                        drawY = 0;
                      }
                      const tempCanvas = document.createElement('canvas');
                      tempCanvas.width = Math.round(cw);
                      tempCanvas.height = Math.round(ch);
                      const tempCtx = tempCanvas.getContext('2d');
                      tempCtx.drawImage(img, drawX, drawY, drawW, drawH);
                      const dataUrl = tempCanvas.toDataURL('image/png');
                      console.log('📝 Fitted signature (aspect preserved), data URL length:', dataUrl.length);
                      
                      // Update the signature status label to "Form signed" if signature exists
                      const signatureStatusLabel = document.getElementById('supervisorSignatureStatus');
                      if (signatureStatusLabel && supervisorSig) {
                        signatureStatusLabel.textContent = '✓ Form signed';
                        signatureStatusLabel.style.color = '#10b981';
                        console.log('✅ Updated signature status label to "Form signed"');
                      }
                      
                      // Check if current user is a supervisor AND can edit
                      // Only supervisors should see "(You can edit and re-sign)" for supervisor signature
                      {% if user_designation == 'supervisor' %}
                      const isCurrentUserSupervisor = true;
                      {% else %}
                      const isCurrentUserSupervisor = false;
                      {% endif %}
                      const canEditSupervisor = isCurrentUserSupervisor && submissionData && submissionData.can_edit === true;
                      
                      // Always draw signature on canvas (like Cleaning form)
                      // Then make it read-only if user can't edit
                      console.log('✅ Loading supervisor signature, canEdit:', canEditSupervisor);
                      
                      {
                        // Draw signature onto pad canvas (avoids fromDataURL stretch)
                        pads.supervisorPad.clear();
                        const ctx = supervisorCanvas.getContext('2d');
                        const ratio = Math.max(window.devicePixelRatio || 1, 1);
                        const padW = supervisorCanvas.width;
                        const padH = supervisorCanvas.height;
                        const scaleX = padW / cw;
                        const scaleY = padH / ch;
                        ctx.save();
                        ctx.setTransform(1, 0, 0, 1, 0, 0);
                        ctx.drawImage(img, 0, 0, img.width, img.height,
                          Math.round(drawX * scaleX), Math.round(drawY * scaleY),
                          Math.round(drawW * scaleX), Math.round(drawH * scaleY));
                        ctx.restore();
                        
                        // Mark canvas as having a loaded signature
                        supervisorCanvas.dataset.signatureLoaded = 'true';
                        
                        const supervisorSigInput = document.getElementById('supervisorSignatureData');
                        if (supervisorSigInput) {
                          supervisorSigInput.value = dataUrl;
                          console.log('✅ Supervisor signature stored in hidden input');
                        }
                        console.log('✅ Supervisor signature drawn to pad (correct aspect, no stretch)');
                        
                        // If user can't edit, make canvas read-only
                        if (!canEditSupervisor) {
                          supervisorCanvas.style.pointerEvents = 'none';
                          supervisorCanvas.style.cursor = 'default';
                          
                          // Hide clear button
                          const clearBtn = document.getElementById('clearSupervisor');
                          if (clearBtn) {
                            clearBtn.style.display = 'none';
                          }
                          console.log('✅ Supervisor signature shown as read-only (can_edit=false)');
                        }
                      }
                    } catch (err) {
                      console.error('❌ Error loading signature:', err);
                      console.error('Error stack:', err.stack);
                    }
                  };
                  
                  img.onerror = function() {
                    console.error('❌ Failed to load signature image:', supervisorSig);
                    console.error('Image error details:', {
                      src: img.src,
                      naturalWidth: img.naturalWidth,
                      naturalHeight: img.naturalHeight
                    });
                  };
                  
                  img.src = supervisorSig;
                  
                  // Also store in hidden input (use data URL if possible, otherwise use the URL)
                  const supervisorSigInput = document.getElementById('supervisorSignatureData');
                  if (supervisorSigInput) {
                    // Try to convert to data URL for storage
                    if (supervisorSig.startsWith('http') || supervisorSig.startsWith('/')) {
                      // For HTTP URLs, we'll store the URL and convert to data URL after load
                      img.onload = (function(originalOnload) {
                        return function() {
                          originalOnload.call(this);
                          // Convert loaded image to data URL
                          try {
                            const tempCanvas = document.createElement('canvas');
                            tempCanvas.width = img.width;
                            tempCanvas.height = img.height;
                            const tempCtx = tempCanvas.getContext('2d');
                            tempCtx.drawImage(img, 0, 0);
                            const dataUrl = tempCanvas.toDataURL('image/png');
                            supervisorSigInput.value = dataUrl;
                            console.log('✅ Supervisor signature converted to data URL and stored');
                          } catch (e) {
                            console.warn('⚠️ Could not convert to data URL, storing URL instead:', e);
                            supervisorSigInput.value = supervisorSig;
                }
                        };
                      })(img.onload);
                    } else {
                      supervisorSigInput.value = supervisorSig;
                    }
                    console.log('✅ Supervisor signature stored in hidden input');
                  }
                } else {
                  console.warn('⚠️ Supervisor signature pad not ready yet');
                  console.warn('Canvas:', supervisorCanvas, 'Pad:', pads?.supervisorPad);
                }
            } else {
              console.warn('⚠️ Supervisor signature format not recognized:', typeof supervisorSig, supervisorSig);
              }
            } else {
              console.log('ℹ️ No supervisor signature found in submission data');
            }
            } // End of isSupervisorView check for supervisor signature
          }
          
          // Continue loading other reviewer signatures (Operations Manager, BD, Procurement, GM)
          // These are loaded separately in the role-specific sections below
          
          // Start loading signatures after a short delay to ensure pads are initialized
          // Also ensure the tab is visible before loading (Bootstrap tabs hide canvases)
          const loadSignaturesWhenReady = () => {
            const tab4 = document.getElementById('tab-4');
            const isTabVisible = tab4 && tab4.classList.contains('active') && tab4.classList.contains('show');
            
            if (isTabVisible || document.getElementById('tab-4-link')?.classList.contains('active')) {
              // Tab is visible, load signatures
              loadSignatures();
            } else {
              // Tab not visible yet, wait and try again
              setTimeout(loadSignaturesWhenReady, 200);
            }
          };
          
          // Try loading immediately, but also set up tab event listener
          setTimeout(loadSignaturesWhenReady, 500);
          
          // Also load when tab becomes visible
          const tab4Link = document.getElementById('tab-4-link');
          if (tab4Link) {
            const loadOnTabShow = () => {
              setTimeout(() => {
                loadSignatures();
              }, 100);
            };
            
            // Use Bootstrap's shown event
            tab4Link.addEventListener('shown.bs.tab', loadOnTabShow);
            
            // Also check if tab is already active
            if (tab4Link.classList.contains('active')) {
              setTimeout(loadSignatures, 600);
            }
          }
          window.editSubmissionId = submissionData.submission_id;
          console.log('✅ Submission data loaded for editing');
          
          // Load Operations Manager comments and signature for Supervisor (read-only)
          {% if user_designation == 'supervisor' %}
          let omCommentsSupervisor = null;
          let omSigSupervisor = null;
          
          // Check formData for OM data
          if (formData) {
            if (formData.operations_manager_comments) omCommentsSupervisor = formData.operations_manager_comments;
            if (formData.operations_manager_signature) omSigSupervisor = formData.operations_manager_signature;
            if (!omSigSupervisor && formData.opMan_signature) omSigSupervisor = formData.opMan_signature;
          }
          
          // Fallback: check submissionData
          if ((!omCommentsSupervisor || !omSigSupervisor) && submissionData) {
            if (!omCommentsSupervisor && submissionData.operations_manager_comments) {
              omCommentsSupervisor = submissionData.operations_manager_comments;
            }
            if (!omSigSupervisor && submissionData.form_data) {
              let checkFormData = submissionData.form_data;
              if (typeof checkFormData === 'string') {
                try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
              }
              if (checkFormData) {
                if (checkFormData.operations_manager_signature) omSigSupervisor = checkFormData.operations_manager_signature;
                if (!omSigSupervisor && checkFormData.opMan_signature) omSigSupervisor = checkFormData.opMan_signature;
              }
            }
          }
          
          // Display OM's previous review for supervisor (read-only)
          if (omCommentsSupervisor || omSigSupervisor) {
            const section = document.getElementById('opsManagerReadOnlySupervisor');
            const prevSection = document.getElementById('previousForSupervisorSection');
            if (section && prevSection) {
              section.style.display = 'block';
              prevSection.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.operations_manager_approved_at) {
                const timestamp = formatSigningTime(submissionData.operations_manager_approved_at);
                if (timestamp) {
                  header.innerHTML = `Operations Manager Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              // Load OM comments
              if (omCommentsSupervisor) {
                const commentsDiv = document.getElementById('opsManagerCommentsReadOnlySupervisor');
                if (commentsDiv) {
                  commentsDiv.textContent = omCommentsSupervisor;
                }
              }
              
              // Load OM signature
              displaySignatureInContainer('opsManagerSignatureReadOnlySupervisor', omSigSupervisor, 'Operations Manager Signature');
            }
          }
          
          // Load Business Development review for Supervisor (read-only)
          let bdCommentsSupervisor = null;
          let bdSigSupervisor = null;
          
          if (formData) {
            if (formData.business_dev_comments) bdCommentsSupervisor = formData.business_dev_comments;
            if (formData.business_dev_signature) bdSigSupervisor = formData.business_dev_signature;
          }
          
          // Fallback: check submissionData
          if ((!bdCommentsSupervisor || !bdSigSupervisor) && submissionData) {
            if (!bdCommentsSupervisor && submissionData.business_dev_comments) {
              bdCommentsSupervisor = submissionData.business_dev_comments;
            }
            // Check top-level signature first, then form_data
            if (!bdSigSupervisor && submissionData.business_dev_signature) {
              bdSigSupervisor = submissionData.business_dev_signature;
            }
            if (!bdSigSupervisor && submissionData.form_data) {
              let checkFormData = submissionData.form_data;
              if (typeof checkFormData === 'string') {
                try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
              }
              if (checkFormData && checkFormData.business_dev_signature) {
                bdSigSupervisor = checkFormData.business_dev_signature;
              }
            }
          }
          
          // Display BD's review for supervisor (read-only)
          if (bdCommentsSupervisor || bdSigSupervisor) {
            const section = document.getElementById('bdReadOnlySupervisor');
            const prevSection = document.getElementById('previousForSupervisorSection');
            if (section && prevSection) {
              section.style.display = 'block';
              prevSection.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.business_dev_approved_at) {
                const timestamp = formatSigningTime(submissionData.business_dev_approved_at);
                if (timestamp) {
                  header.innerHTML = `Business Development Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              // Load BD comments
              if (bdCommentsSupervisor) {
                const commentsDiv = document.getElementById('bdCommentsReadOnlySupervisor');
                if (commentsDiv) {
                  commentsDiv.textContent = bdCommentsSupervisor;
                }
              }
              
              // Load BD signature
              displaySignatureInContainer('bdSignatureReadOnlySupervisor', bdSigSupervisor, 'Business Development Signature');
            }
          }
          
          // Load Procurement review for Supervisor (read-only)
          let procCommentsSupervisor = null;
          let procSigSupervisor = null;
          
          if (formData) {
            if (formData.procurement_comments) procCommentsSupervisor = formData.procurement_comments;
            if (formData.procurement_signature) procSigSupervisor = formData.procurement_signature;
          }
          
          // Fallback: check submissionData
          if ((!procCommentsSupervisor || !procSigSupervisor) && submissionData) {
            if (!procCommentsSupervisor && submissionData.procurement_comments) {
              procCommentsSupervisor = submissionData.procurement_comments;
            }
            // Check top-level signature first, then form_data
            if (!procSigSupervisor && submissionData.procurement_signature) {
              procSigSupervisor = submissionData.procurement_signature;
            }
            if (!procSigSupervisor && submissionData.form_data) {
              let checkFormData = submissionData.form_data;
              if (typeof checkFormData === 'string') {
                try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
              }
              if (checkFormData && checkFormData.procurement_signature) {
                procSigSupervisor = checkFormData.procurement_signature;
              }
            }
          }
          
          // Display Procurement's review for supervisor (read-only)
          if (procCommentsSupervisor || procSigSupervisor) {
            const section = document.getElementById('procurementReadOnlySupervisor');
            const prevSection = document.getElementById('previousForSupervisorSection');
            if (section && prevSection) {
              section.style.display = 'block';
              prevSection.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.procurement_approved_at) {
                const timestamp = formatSigningTime(submissionData.procurement_approved_at);
                if (timestamp) {
                  header.innerHTML = `Procurement Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              // Load Procurement comments
              if (procCommentsSupervisor) {
                const commentsDiv = document.getElementById('procurementCommentsReadOnlySupervisor');
                if (commentsDiv) {
                  commentsDiv.textContent = procCommentsSupervisor;
                }
              }
              
              // Load Procurement signature
              displaySignatureInContainer('procurementSignatureReadOnlySupervisor', procSigSupervisor, 'Procurement Signature');
            }
          }
          
          // Load General Manager review for Supervisor (read-only)
          let gmCommentsSupervisor = null;
          let gmSigSupervisor = null;
          
          if (formData) {
            if (formData.general_manager_comments) gmCommentsSupervisor = formData.general_manager_comments;
            if (formData.general_manager_signature) gmSigSupervisor = formData.general_manager_signature;
          }
          
          // Fallback: check submissionData
          if ((!gmCommentsSupervisor || !gmSigSupervisor) && submissionData) {
            if (!gmCommentsSupervisor && submissionData.general_manager_comments) {
              gmCommentsSupervisor = submissionData.general_manager_comments;
            }
            // Check top-level signature first, then form_data
            if (!gmSigSupervisor && submissionData.general_manager_signature) {
              gmSigSupervisor = submissionData.general_manager_signature;
            }
            if (!gmSigSupervisor && submissionData.form_data) {
              let checkFormData = submissionData.form_data;
              if (typeof checkFormData === 'string') {
                try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
              }
              if (checkFormData && checkFormData.general_manager_signature) {
                gmSigSupervisor = checkFormData.general_manager_signature;
              }
            }
          }
          
          // Display GM's review for supervisor (read-only)
          if (gmCommentsSupervisor || gmSigSupervisor) {
            const section = document.getElementById('gmReadOnlySupervisor');
            const prevSection = document.getElementById('previousForSupervisorSection');
            if (section && prevSection) {
              section.style.display = 'block';
              prevSection.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.general_manager_approved_at) {
                const timestamp = formatSigningTime(submissionData.general_manager_approved_at);
                if (timestamp) {
                  header.innerHTML = `General Manager Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              // Load GM comments
              if (gmCommentsSupervisor) {
                const commentsDiv = document.getElementById('gmCommentsReadOnlySupervisor');
                if (commentsDiv) {
                  commentsDiv.textContent = gmCommentsSupervisor;
                }
              }
              
              // Load GM signature
              displaySignatureInContainer('gmSignatureReadOnlySupervisor', gmSigSupervisor, 'General Manager Signature');
            }
          }
          {% endif %}
          
          // Load Operations Manager comments
          {% if user_designation == 'operations_manager' %}
          console.log('🔍 Looking for operations_manager_comments...');
          console.log('  formData:', formData);
          console.log('  formData.operations_manager_comments:', formData?.operations_manager_comments);
          console.log('  submissionData.form_data:', submissionData?.form_data);
          console.log('  submissionData.form_data?.operations_manager_comments:', submissionData?.form_data?.operations_manager_comments);
          console.log('  submissionData.operations_manager_comments:', submissionData?.operations_manager_comments);
          
          let operationsManagerComments = null;
          if (formData && formData.operations_manager_comments) {
            operationsManagerComments = formData.operations_manager_comments;
            console.log('📝 Found OM comments in formData:', operationsManagerComments.substring(0, 50));
          } else if (submissionData && submissionData.form_data && submissionData.form_data.operations_manager_comments) {
            operationsManagerComments = submissionData.form_data.operations_manager_comments;
            console.log('📝 Found OM comments in submissionData.form_data:', operationsManagerComments.substring(0, 50));
          } else if (submissionData && submissionData.operations_manager_comments) {
            operationsManagerComments = submissionData.operations_manager_comments;
            console.log('📝 Found OM comments in submissionData:', operationsManagerComments.substring(0, 50));
          } else {
            console.warn('⚠️ No Operations Manager comments found in any location');
          }
          
          if (operationsManagerComments) {
            const commentsField = document.getElementById('operationsManagerComments');
            if (commentsField) {
              commentsField.value = operationsManagerComments;
              console.log('✅ Loaded Operations Manager comments into field:', operationsManagerComments.substring(0, 50));
            }
          }
          
          // Load Supervisor review for Operations Manager (read-only)
          const prevForOM = document.getElementById('previousForOMSection');
          let hasPrevForOM = false;
          
          let supervisorCommentsOM = null;
          let supervisorSigOM = null;
          
          if (formData) {
            if (formData.supervisor_comments) supervisorCommentsOM = formData.supervisor_comments;
            if (formData.supervisor_signature) supervisorSigOM = formData.supervisor_signature;
          }
          
          if ((!supervisorCommentsOM || !supervisorSigOM) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!supervisorCommentsOM && checkFormData.supervisor_comments) supervisorCommentsOM = checkFormData.supervisor_comments;
              if (!supervisorSigOM && checkFormData.supervisor_signature) supervisorSigOM = checkFormData.supervisor_signature;
            }
          }
          
          if (!supervisorCommentsOM && submissionData && submissionData.supervisor_comments) {
            supervisorCommentsOM = submissionData.supervisor_comments;
          }
          
          if (supervisorCommentsOM || supervisorSigOM) {
            hasPrevForOM = true;
            const section = document.getElementById('supervisorReadOnlyOM');
            if (section) {
              section.style.display = 'block';
              if (prevForOM) prevForOM.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.created_at) {
                const timestamp = formatSigningTime(submissionData.created_at);
                if (timestamp) {
                  header.innerHTML = `Supervisor Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              const commentsDiv = document.getElementById('supervisorCommentsReadOnlyOM');
              if (commentsDiv) {
                if (supervisorCommentsOM) commentsDiv.textContent = supervisorCommentsOM;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('supervisorSignatureReadOnlyOM', supervisorSigOM, 'Supervisor Signature');
            }
          }
          
          // Load BD for OM (read-only)
          let bdCommentsOM = null;
          let bdSigOM = null;
          
          if (formData) {
            if (formData.business_dev_comments) bdCommentsOM = formData.business_dev_comments;
            if (formData.business_dev_signature) bdSigOM = formData.business_dev_signature;
          }
          
          if ((!bdCommentsOM || !bdSigOM) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!bdCommentsOM && checkFormData.business_dev_comments) bdCommentsOM = checkFormData.business_dev_comments;
              if (!bdSigOM && checkFormData.business_dev_signature) bdSigOM = checkFormData.business_dev_signature;
            }
          }
          
          if (!bdCommentsOM && submissionData && submissionData.business_dev_comments) {
            bdCommentsOM = submissionData.business_dev_comments;
          }
          if (!bdSigOM && submissionData && submissionData.business_dev_signature) {
            bdSigOM = submissionData.business_dev_signature;
          }
          
          if (bdCommentsOM || bdSigOM) {
            hasPrevForOM = true;
            const section = document.getElementById('bdReadOnlyOM');
            if (section) {
              section.style.display = 'block';
              if (prevForOM) prevForOM.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.business_dev_approved_at) {
                const timestamp = formatSigningTime(submissionData.business_dev_approved_at);
                if (timestamp) {
                  header.innerHTML = `Business Development Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              const commentsDiv = document.getElementById('bdCommentsReadOnlyOM');
              if (commentsDiv) {
                if (bdCommentsOM) commentsDiv.textContent = bdCommentsOM;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('bdSignatureReadOnlyOM', bdSigOM, 'Business Development Signature');
            }
          }
          
          // Load Procurement for OM (read-only)
          let procCommentsOM = null;
          let procSigOM = null;
          
          if (formData) {
            if (formData.procurement_comments) procCommentsOM = formData.procurement_comments;
            if (formData.procurement_signature) procSigOM = formData.procurement_signature;
          }
          
          if ((!procCommentsOM || !procSigOM) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!procCommentsOM && checkFormData.procurement_comments) procCommentsOM = checkFormData.procurement_comments;
              if (!procSigOM && checkFormData.procurement_signature) procSigOM = checkFormData.procurement_signature;
            }
          }
          
          if (!procCommentsOM && submissionData && submissionData.procurement_comments) {
            procCommentsOM = submissionData.procurement_comments;
          }
          if (!procSigOM && submissionData && submissionData.procurement_signature) {
            procSigOM = submissionData.procurement_signature;
          }
          
          if (procCommentsOM || procSigOM) {
            hasPrevForOM = true;
            const section = document.getElementById('procurementReadOnlyOM');
            if (section) {
              section.style.display = 'block';
              if (prevForOM) prevForOM.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.procurement_approved_at) {
                const timestamp = formatSigningTime(submissionData.procurement_approved_at);
                if (timestamp) {
                  header.innerHTML = `Procurement Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              const commentsDiv = document.getElementById('procurementCommentsReadOnlyOM');
              if (commentsDiv) {
                if (procCommentsOM) commentsDiv.textContent = procCommentsOM;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('procurementSignatureReadOnlyOM', procSigOM, 'Procurement Signature');
            }
          }
          
          // Load General Manager review for OM (read-only)
          let gmCommentsOM = null;
          let gmSigOM = null;
          
          if (formData) {
            if (formData.general_manager_comments) gmCommentsOM = formData.general_manager_comments;
            if (formData.general_manager_signature) gmSigOM = formData.general_manager_signature;
          }
          
          // Fallback: check submissionData
          if ((!gmCommentsOM || !gmSigOM) && submissionData) {
            if (!gmCommentsOM && submissionData.general_manager_comments) {
              gmCommentsOM = submissionData.general_manager_comments;
            }
            if (!gmSigOM && submissionData.form_data) {
              let checkFormData = submissionData.form_data;
              if (typeof checkFormData === 'string') {
                try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
              }
              if (checkFormData && checkFormData.general_manager_signature) {
                gmSigOM = checkFormData.general_manager_signature;
              }
            }
          }
          
          // Display GM's review for OM (read-only)
          if (gmCommentsOM || gmSigOM) {
            hasPrevForOM = true;
            const section = document.getElementById('gmReadOnlyOM');
            if (section && prevForOM) {
              section.style.display = 'block';
              prevForOM.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.general_manager_approved_at) {
                const timestamp = formatSigningTime(submissionData.general_manager_approved_at);
                if (timestamp) {
                  header.innerHTML = `General Manager Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              // Load GM comments
              const commentsDiv = document.getElementById('gmCommentsReadOnlyOM');
              if (commentsDiv) {
                if (gmCommentsOM) {
                  commentsDiv.textContent = gmCommentsOM;
                } else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              // Load GM signature
              displaySignatureInContainer('gmSignatureReadOnlyOM', gmSigOM, 'General Manager Signature');
            }
          }
          // Load Operations Manager signature (for Operations Manager editing)
          console.log('🔍 Looking for operations_manager_signature...');
          console.log('  formData keys:', formData ? Object.keys(formData) : 'no formData');
          console.log('  formData.opMan_signature:', formData?.opMan_signature ? 'exists' : 'not found');
          console.log('  formData.operations_manager_signature:', formData?.operations_manager_signature ? 'exists' : 'not found');
          console.log('  submissionData.form_data keys:', submissionData?.form_data ? (typeof submissionData.form_data === 'string' ? 'string (needs parse)' : Object.keys(submissionData.form_data)) : 'no form_data');
          
          let opSig = null;
          if (formData) {
            if (formData.opMan_signature) {
              opSig = formData.opMan_signature;
              console.log('📝 Found OM signature in formData.opMan_signature');
            } else if (formData.operations_manager_signature) {
              opSig = formData.operations_manager_signature;
              console.log('📝 Found OM signature in formData.operations_manager_signature');
            }
          }
          
          if (!opSig && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (checkFormData.opMan_signature) {
                opSig = checkFormData.opMan_signature;
                console.log('📝 Found OM signature in submissionData.form_data.opMan_signature');
              } else if (checkFormData.operations_manager_signature) {
                opSig = checkFormData.operations_manager_signature;
                console.log('📝 Found OM signature in submissionData.form_data.operations_manager_signature');
              }
            }
          }
          if (!opSig && submissionData && submissionData.operations_manager_signature) {
            opSig = submissionData.operations_manager_signature;
            console.log('📝 Found OM signature in submissionData.operations_manager_signature');
          }
          
          if (!opSig) {
            console.warn('⚠️ No Operations Manager signature found in any location');
          }
          
          if (opSig) {
            console.log('📝 Found Operations Manager signature:', typeof opSig, opSig);
            console.log('📝 Signature type:', typeof opSig);
            
            // Handle object format with url property
            if (typeof opSig === 'object' && opSig !== null) {
              if (opSig.url) {
                opSig = opSig.url;
                console.log('📝 Extracted URL from object:', opSig.substring(0, 50) + '...');
              } else if (opSig.path) {
                opSig = opSig.path;
                console.log('📝 Extracted path from object:', opSig.substring(0, 50) + '...');
              }
            }
            
            // Convert relative URLs to absolute URLs
            if (typeof opSig === 'string' && opSig.startsWith('/')) {
              opSig = window.location.origin + opSig;
              console.log('📝 Converted relative URL to absolute:', opSig);
            }
            
            // Only proceed if we have a valid URL string
            if (typeof opSig === 'string' && (opSig.startsWith('data:image') || opSig.startsWith('http'))) {
              const opCanvas = document.getElementById('opManSignaturePad');
              if (opCanvas && pads && pads.opPad) {
                console.log('📝 Loading Operations Manager signature into pad:', opSig.substring(0, 50) + '...');
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                  try {
                    const rect = opCanvas.getBoundingClientRect();
                    const cw = rect.width || opCanvas.width;
                    const ch = rect.height || opCanvas.height;
                    const imgAspect = img.width / img.height;
                    const padAspect = cw / ch;
                    let drawW, drawH, drawX, drawY;
                    if (imgAspect > padAspect) {
                      drawW = cw;
                      drawH = cw / imgAspect;
                      drawX = 0;
                      drawY = (ch - drawH) / 2;
                    } else {
                      drawH = ch;
                      drawW = ch * imgAspect;
                      drawX = (cw - drawW) / 2;
                      drawY = 0;
                    }
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = Math.round(cw);
                    tempCanvas.height = Math.round(ch);
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(img, drawX, drawY, drawW, drawH);
                    const dataUrl = tempCanvas.toDataURL('image/png');
                    // Load the signature into SignaturePad using fromDataURL with the fitted image
                    // The tempCanvas already has the image fitted with correct aspect ratio
                    pads.opPad.fromDataURL(dataUrl, {
                      ratio: 1,
                      width: Math.round(cw),
                      height: Math.round(ch)
                    });
                    
                    const opSigInput = document.getElementById('opManSignatureData');
                    if (opSigInput) {
                      opSigInput.value = dataUrl;
                    }
                    
                    // Mark canvas as having a loaded signature (to prevent resize from clearing it)
                    opCanvas.dataset.signatureLoaded = 'true';
                    
                    console.log('✅ Operations Manager signature loaded into pad via fromDataURL (fitted)');
                    
                    // Update signature hint to show "Form signed" instead of "Required for approval"
                    const opManHint = document.getElementById('opManSignatureHint');
                    if (opManHint) {
                      opManHint.textContent = '✓ Form signed';
                      opManHint.classList.remove('text-danger');
                      opManHint.classList.add('text-success');
                      console.log('✅ Updated OM signature hint to "Form signed"');
                    }
                  } catch (err) {
                    console.error('❌ Error loading Operations Manager signature:', err);
                  }
                };
                
                img.onerror = function() {
                  console.error('❌ Failed to load Operations Manager signature image:', opSig);
                };
                
                img.src = opSig;
              } else {
                console.warn('⚠️ Operations Manager signature pad not ready yet');
                console.warn('Canvas:', opCanvas, 'Pad:', pads?.opPad);
              }
            } else {
              console.warn('⚠️ Operations Manager signature format not recognized:', typeof opSig, opSig);
            }
          } else {
            console.log('ℹ️ No Operations Manager signature found in submission data');
          }
          
          // Check if OM has already approved
          if (submissionData && submissionData.operations_manager_approved_at) {
            // KEY FIX: Use can_edit from backend which determines if OM can still edit
            // OM can edit if: form is at operations_manager_review OR at bd_procurement_review but BD/Procurement haven't started
            const canEditOwnReview = submissionData.can_edit === true;
            
            if (canEditOwnReview) {
              console.log('ℹ️ OM has signed but can still edit - keeping editable for re-sign');
              // Keep editable section visible (signature and comments already pre-loaded above)
              // Add a visual indicator showing they've previously signed
              const omSignatureHint = document.getElementById('omSignatureHint');
              if (omSignatureHint) {
                const timestamp = formatSigningTime(submissionData.operations_manager_approved_at);
                omSignatureHint.innerHTML = `<span class="text-success">✓ Signed: ${timestamp || 'Previously'}</span> <span class="text-muted small"></span>`;
                omSignatureHint.classList.remove('text-danger');
              }
            } else {
              console.log('✅ OM cannot edit anymore - showing read-only version');
            
              // Hide editable section, show read-only section
              const editableSection = document.getElementById('omEditableSection');
              const readOnlySection = document.getElementById('omOwnReviewReadOnly');
              
              if (editableSection) editableSection.style.display = 'none';
              if (readOnlySection) readOnlySection.style.display = 'block';
              
              // Load OM comments into read-only section
              const omCommentsReadOnly = document.getElementById('omOwnCommentsReadOnly');
              if (omCommentsReadOnly) {
                const omComments = formData?.operations_manager_comments || submissionData.operations_manager_comments;
                if (omComments) {
                  omCommentsReadOnly.textContent = omComments;
                } else {
                  omCommentsReadOnly.textContent = 'No comments provided';
                  omCommentsReadOnly.style.fontStyle = 'italic';
                  omCommentsReadOnly.style.color = '#9ca3af';
                }
              }
              
              // Add timestamp to read-only section header
              const omReadOnlyHeader = readOnlySection?.querySelector('h6') || readOnlySection?.querySelector('.alert');
              if (omReadOnlyHeader && submissionData.operations_manager_approved_at) {
                const timestamp = formatSigningTime(submissionData.operations_manager_approved_at);
                if (timestamp) {
                  omReadOnlyHeader.innerHTML = `<strong>✓ Your Previous Review</strong> <span style="color: #10b981; font-size: 0.75rem; font-weight: normal; margin-left: 0.5rem;">Signed: ${timestamp}</span>`;
                }
              }
              
              // Load OM signature into read-only section
              const omSigReadOnly = document.getElementById('omOwnSignatureReadOnly');
              if (omSigReadOnly && opSig) {
                displaySignatureInContainer('omOwnSignatureReadOnly', opSig, 'Your Signature');
                console.log('✅ Loaded OM signature into read-only section');
              }
            }
          } else {
            console.log('ℹ️ OM has not yet approved - showing editable section');
          }
          {% endif %}
          
          // Load Supervisor comments and signature for BD (read-only)
          {% if user_designation == 'business_development' %}
          let supervisorCommentsBD = null;
          let supervisorSigBD = null;
          
          if (formData) {
            if (formData.supervisor_comments) supervisorCommentsBD = formData.supervisor_comments;
            if (formData.supervisor_signature) supervisorSigBD = formData.supervisor_signature;
          }
          
          if (supervisorCommentsBD || supervisorSigBD) {
            const section = document.getElementById('supervisorReadOnlyBD');
            if (section) {
              section.style.display = 'block';
              document.getElementById('previousForBDSection').style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.created_at) {
                const timestamp = formatSigningTime(submissionData.created_at);
                if (timestamp) {
                  header.innerHTML = `Supervisor Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              const commentsDiv = document.getElementById('supervisorCommentsReadOnlyBD');
              if (commentsDiv) {
                if (supervisorCommentsBD) commentsDiv.textContent = supervisorCommentsBD;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('supervisorSignatureReadOnlyBD', supervisorSigBD, 'Supervisor Signature');
            }
          }
          
          // Load Operations Manager comments and signature for BD (read-only)
          let opsManagerCommentsBD = null;
          let opsManagerSigBD = null;
          
          if (formData) {
            if (formData.operations_manager_comments) opsManagerCommentsBD = formData.operations_manager_comments;
            if (formData.operations_manager_signature) opsManagerSigBD = formData.operations_manager_signature;
            else if (formData.opMan_signature) opsManagerSigBD = formData.opMan_signature;
          }
          
          if ((!opsManagerCommentsBD || !opsManagerSigBD) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!opsManagerCommentsBD && checkFormData.operations_manager_comments) opsManagerCommentsBD = checkFormData.operations_manager_comments;
              if (!opsManagerSigBD) {
                if (checkFormData.operations_manager_signature) opsManagerSigBD = checkFormData.operations_manager_signature;
                else if (checkFormData.opMan_signature) opsManagerSigBD = checkFormData.opMan_signature;
              }
            }
          }
          
          if (!opsManagerCommentsBD && submissionData && submissionData.operations_manager_comments) {
            opsManagerCommentsBD = submissionData.operations_manager_comments;
          }
          if (!opsManagerSigBD && submissionData && submissionData.operations_manager_signature) {
            opsManagerSigBD = submissionData.operations_manager_signature;
          }
          
          let omHasApproved = false;
          if (submissionData) {
            if (submissionData.operations_manager_approved_at || 
                (submissionData.workflow_status && 
                 (submissionData.workflow_status.includes('operations_manager_approved') || 
                  submissionData.workflow_status.includes('bd_procurement')))) {
              omHasApproved = true;
            }
          }
          
          if (opsManagerCommentsBD || opsManagerSigBD || omHasApproved) {
            const section = document.getElementById('opsManagerReadOnlySection');
            if (section) {
              section.style.display = 'block';
              document.getElementById('previousForBDSection').style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.operations_manager_approved_at) {
                const timestamp = formatSigningTime(submissionData.operations_manager_approved_at);
                if (timestamp) {
                  header.innerHTML = `Operations Manager Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              const commentsDiv = document.getElementById('opsManagerCommentsReadOnly');
              if (commentsDiv) {
                if (opsManagerCommentsBD) commentsDiv.textContent = opsManagerCommentsBD;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('opsManagerSignatureReadOnly', opsManagerSigBD, 'Operations Manager Signature');
            }
          }
          
          // Load Procurement data for BD (so BD can see if PO has signed)
          let procurementCommentsBD = null;
          let procurementSigBD = null;
          
          if (formData) {
            if (formData.procurement_comments) procurementCommentsBD = formData.procurement_comments;
            if (formData.procurement_signature) procurementSigBD = formData.procurement_signature;
          }
          
          if ((!procurementCommentsBD || !procurementSigBD) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!procurementCommentsBD && checkFormData.procurement_comments) procurementCommentsBD = checkFormData.procurement_comments;
              if (!procurementSigBD && checkFormData.procurement_signature) procurementSigBD = checkFormData.procurement_signature;
            }
          }
          if (!procurementCommentsBD && submissionData && submissionData.procurement_comments) {
            procurementCommentsBD = submissionData.procurement_comments;
          }
          if (!procurementSigBD && submissionData && submissionData.procurement_signature) {
            procurementSigBD = submissionData.procurement_signature;
          }
          
          if (procurementCommentsBD || procurementSigBD) {
            const section = document.getElementById('procurementReadOnlyBD');
            if (section) {
              section.style.display = 'block';
              document.getElementById('previousForBDSection').style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.procurement_approved_at) {
                const timestamp = formatSigningTime(submissionData.procurement_approved_at);
                if (timestamp) {
                  header.innerHTML = `Procurement Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              const commentsDiv = document.getElementById('procurementCommentsReadOnlyBD');
              if (commentsDiv) {
                if (procurementCommentsBD) commentsDiv.textContent = procurementCommentsBD;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('procurementSignatureReadOnlyBD', procurementSigBD, 'Procurement Signature');
            }
          }
          
          // Load Business Development comments and signature
          let businessDevComments = formData?.business_dev_comments || (submissionData?.form_data?.business_dev_comments) || (submissionData?.business_dev_comments);
          let businessDevSig = formData?.business_dev_signature || formData?.businessDevSignature || (submissionData?.form_data?.business_dev_signature) || (submissionData?.form_data?.businessDevSignature) || submissionData?.business_dev_signature;
          
          if (businessDevComments) {
            const commentsField = document.getElementById('businessDevComments');
            if (commentsField) {
              commentsField.value = businessDevComments;
              console.log('✅ Loaded BD comments');
            }
          }
          
          if (businessDevSig) {
            let sigUrl = businessDevSig;
            if (typeof sigUrl === 'object' && sigUrl.url) {
              sigUrl = sigUrl.url;
            }
            
            if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
              const sigInput = document.getElementById('businessDevSignatureData');
              if (sigInput) sigInput.value = sigUrl;
              
              if (pads && pads.businessDevPad) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                  pads.businessDevPad.clear();
                  pads.businessDevPad.fromDataURL(sigUrl);
                  console.log('✅ Loaded BD signature into pad');
                  
                  // Check if BD can still edit (based on can_edit from backend)
                  const bdCanEdit = submissionData && submissionData.can_edit === true;
                  if (bdCanEdit && submissionData.business_dev_approved_at) {
                    console.log('ℹ️ BD can still edit - showing re-sign hint');
                    const bdHint = document.getElementById('bdSignatureHint');
                    if (bdHint) {
                      const timestamp = typeof formatSigningTime === 'function' ? formatSigningTime(submissionData.business_dev_approved_at) : '';
                      bdHint.innerHTML = `<span class="text-success">✓ Signed${timestamp ? ': ' + timestamp : ''}</span> <span class="text-muted small"></span>`;
                      bdHint.classList.remove('text-danger');
                    }
                  }
                };
                img.src = sigUrl;
              }
            }
          }
          {% endif %}
          
          // Load Procurement comments and signature
          {% if user_designation == 'procurement' %}
          let procurementComments = formData?.procurement_comments || (submissionData?.form_data?.procurement_comments) || (submissionData?.procurement_comments);
          let procurementSig = formData?.procurement_signature || formData?.procurementSignature || (submissionData?.form_data?.procurement_signature) || (submissionData?.form_data?.procurementSignature) || submissionData?.procurement_signature;
          
          if (procurementComments) {
            const commentsField = document.getElementById('procurementComments');
            if (commentsField) {
              commentsField.value = procurementComments;
              console.log('✅ Loaded Procurement comments');
            }
          }
          
          if (procurementSig) {
            let sigUrl = procurementSig;
            if (typeof sigUrl === 'object' && sigUrl.url) {
              sigUrl = sigUrl.url;
            }
            
            if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
              const sigInput = document.getElementById('procurementSignatureData');
              if (sigInput) sigInput.value = sigUrl;
              
              if (pads && pads.procurementPad) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                  pads.procurementPad.clear();
                  pads.procurementPad.fromDataURL(sigUrl);
                  console.log('✅ Loaded Procurement signature into pad');
                  
                  // Check if Procurement can still edit (based on can_edit from backend)
                  const procCanEdit = submissionData && submissionData.can_edit === true;
                  if (procCanEdit && submissionData.procurement_approved_at) {
                    console.log('ℹ️ Procurement can still edit - showing re-sign hint');
                    const procHint = document.getElementById('procurementSignatureHint');
                    if (procHint) {
                      const timestamp = typeof formatSigningTime === 'function' ? formatSigningTime(submissionData.procurement_approved_at) : '';
                      procHint.innerHTML = `<span class="text-success">✓ Signed${timestamp ? ': ' + timestamp : ''}</span> <span class="text-muted small"></span>`;
                      procHint.classList.remove('text-danger');
                    }
                  }
                };
                img.src = sigUrl;
              }
            }
          }
          
          // Load previous reviewers (Supervisor + OM + BD) in read-only blocks for Procurement
          const prevForProc = document.getElementById('previousForProcurementSection');
          let hasPrevForProc = false;
          
          // Supervisor for Procurement
          let supervisorCommentsProc = null;
          let supervisorSigProc = null;
          
          if (formData) {
            if (formData.supervisor_comments) supervisorCommentsProc = formData.supervisor_comments;
            if (formData.supervisor_signature) supervisorSigProc = formData.supervisor_signature;
          }
          
          if (supervisorCommentsProc || supervisorSigProc) {
            hasPrevForProc = true;
            const sec = document.getElementById('supervisorReadOnlyProc');
            if (sec) {
              sec.style.display = 'block';
              document.getElementById('previousForProcurementSection').style.display = 'block';
              
              // Add timestamp if available
              const header = sec.querySelector('h6');
              if (header && submissionData && submissionData.created_at) {
                const timestamp = formatSigningTime(submissionData.created_at);
                if (timestamp) {
                  header.innerHTML = `Supervisor Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
            }
            
            const cDiv = document.getElementById('supervisorCommentsReadOnlyProc');
            if (cDiv) {
              if (supervisorCommentsProc) {
                cDiv.textContent = supervisorCommentsProc;
              } else {
                cDiv.textContent = 'No comments provided';
                cDiv.style.fontStyle = 'italic';
                cDiv.style.color = '#9ca3af';
              }
            }
            
            displaySignatureInContainer('supervisorSignatureReadOnlyProc', supervisorSigProc, 'Supervisor Signature');
          }
          
          // OM for Procurement
          let opsManagerCommentsProc = null;
          let opsManagerSigProc = null;
          
          if (formData) {
            if (formData.operations_manager_comments) opsManagerCommentsProc = formData.operations_manager_comments;
            if (formData.operations_manager_signature) opsManagerSigProc = formData.operations_manager_signature;
            else if (formData.opMan_signature) opsManagerSigProc = formData.opMan_signature;
          }
          
          if ((!opsManagerCommentsProc || !opsManagerSigProc) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData && typeof checkFormData === 'object') {
              if (!opsManagerCommentsProc && checkFormData.operations_manager_comments) opsManagerCommentsProc = checkFormData.operations_manager_comments;
              if (!opsManagerSigProc) {
                if (checkFormData.operations_manager_signature) opsManagerSigProc = checkFormData.operations_manager_signature;
                else if (checkFormData.opMan_signature) opsManagerSigProc = checkFormData.opMan_signature;
              }
            }
          }
          
          if (!opsManagerCommentsProc && submissionData && submissionData.operations_manager_comments) {
            opsManagerCommentsProc = submissionData.operations_manager_comments;
          }
          
          if (opsManagerCommentsProc || opsManagerSigProc) {
            hasPrevForProc = true;
            const sec = document.getElementById('opsManagerReadOnlyProc');
            if (sec) {
              sec.style.display = 'block';
              document.getElementById('previousForProcurementSection').style.display = 'block';
              
              // Add timestamp if available
              const header = sec.querySelector('h6');
              if (header && submissionData && submissionData.operations_manager_approved_at) {
                const timestamp = formatSigningTime(submissionData.operations_manager_approved_at);
                if (timestamp) {
                  header.innerHTML = `Operations Manager Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
            }
            
            const cDiv = document.getElementById('opsManagerCommentsReadOnlyProc');
            if (cDiv) {
              if (opsManagerCommentsProc) {
                cDiv.textContent = opsManagerCommentsProc;
              } else {
                cDiv.textContent = 'No comments provided';
                cDiv.style.fontStyle = 'italic';
                cDiv.style.color = '#9ca3af';
              }
            }
            
            displaySignatureInContainer('opsManagerSignatureReadOnlyProc', opsManagerSigProc, 'Operations Manager Signature');
          }
          
          // BD for Procurement
          let bdCommentsProc = null;
          let bdSigProc = null;
          const supervisorComments = formData?.supervisor_comments || (submissionData?.form_data?.supervisor_comments);
          
          if (formData) {
            if (formData.business_dev_comments && formData.business_dev_comments !== supervisorComments) {
              bdCommentsProc = formData.business_dev_comments;
            }
            if (formData.business_dev_signature) bdSigProc = formData.business_dev_signature;
          }
          
          if ((!bdCommentsProc || !bdSigProc) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!bdCommentsProc && checkFormData.business_dev_comments && checkFormData.business_dev_comments !== supervisorComments) {
                bdCommentsProc = checkFormData.business_dev_comments;
              }
              if (!bdSigProc && checkFormData.business_dev_signature) bdSigProc = checkFormData.business_dev_signature;
            }
          }
          
          let bdHasApproved = false;
          if (submissionData) {
            if (submissionData.business_dev_approved_at || 
                (submissionData.workflow_status && 
                 (submissionData.workflow_status.includes('bd_procurement') || 
                  submissionData.workflow_status.includes('general_manager')))) {
              bdHasApproved = true;
            }
          }
          
          if (bdCommentsProc || bdSigProc || bdHasApproved) {
            hasPrevForProc = true;
            const sec = document.getElementById('bdReadOnlyProc');
            if (sec) {
              sec.style.display = 'block';
              document.getElementById('previousForProcurementSection').style.display = 'block';
              
              // Add timestamp if available
              const header = sec.querySelector('h6');
              if (header && submissionData && submissionData.business_dev_approved_at) {
                const timestamp = formatSigningTime(submissionData.business_dev_approved_at);
                if (timestamp) {
                  header.innerHTML = `Business Development Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
            }
            
            const cDiv = document.getElementById('bdCommentsReadOnlyProc');
            if (cDiv) {
              if (bdCommentsProc) {
                cDiv.textContent = bdCommentsProc;
              } else {
                cDiv.textContent = 'No comments provided';
                cDiv.style.fontStyle = 'italic';
                cDiv.style.color = '#9ca3af';
              }
            }
            
            displaySignatureInContainer('bdSignatureReadOnlyProc', bdSigProc, 'Business Development Signature');
          }
          
          if (prevForProc && hasPrevForProc) {
            prevForProc.style.display = 'block';
          }
          {% endif %}
          
          // Load General Manager signature if it exists
          {% if user_designation == 'general_manager' %}
          let gmSignature = null;
          if (formData) {
            if (formData.general_manager_signature) {
              gmSignature = formData.general_manager_signature;
            }
          }
          
          if (!gmSignature && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              gmSignature = checkFormData.general_manager_signature || checkFormData.generalManagerSignature;
            }
          }
          if (!gmSignature && submissionData && submissionData.general_manager_signature) {
            gmSignature = submissionData.general_manager_signature;
          }
          if (!gmSignature && submissionData && submissionData.generalManagerSignature) {
            gmSignature = submissionData.generalManagerSignature;
          }
          
          if (gmSignature) {
            let sigUrl = gmSignature;
            if (typeof sigUrl === 'object' && sigUrl !== null && sigUrl.url) {
              sigUrl = sigUrl.url;
            }
            
            if (typeof sigUrl === 'string' && (sigUrl.startsWith('data:') || sigUrl.startsWith('http') || sigUrl.startsWith('/'))) {
              const gmCanvas = document.getElementById('generalManagerSignaturePad');
              const gmSigInput = document.getElementById('generalManagerSignatureData');
              
              if (gmCanvas && pads && pads.generalManagerPad) {
                // Check if GM can still edit (based on can_edit from backend)
                const gmCanEdit = submissionData && submissionData.can_edit === true;
                
                try {
                  if (sigUrl.startsWith('data:image')) {
                    pads.generalManagerPad.fromDataURL(sigUrl);
                    console.log('✅ Loaded GM signature into canvas');
                    
                    // Show edit hint if GM can still edit
                    if (gmCanEdit && submissionData.general_manager_approved_at) {
                      console.log('ℹ️ GM can still edit - showing re-sign hint');
                      const gmHint = document.getElementById('gmSignatureHint');
                      if (gmHint) {
                        const timestamp = typeof formatSigningTime === 'function' ? formatSigningTime(submissionData.general_manager_approved_at) : '';
                        gmHint.innerHTML = `<span class="text-success">✓ Signed${timestamp ? ': ' + timestamp : ''}</span> <span class="text-muted small"></span>`;
                        gmHint.classList.remove('text-danger');
                      }
                    }
                  } else if (gmCanEdit) {
                    // GM can edit but signature is HTTP URL - load into canvas using image
                    console.log('ℹ️ GM can edit - loading HTTP signature into editable canvas');
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = function() {
                      const ctx = gmCanvas.getContext('2d');
                      const rect = gmCanvas.getBoundingClientRect();
                      const ratio = Math.max(window.devicePixelRatio || 1, 1);
                      gmCanvas.width = rect.width * ratio;
                      gmCanvas.height = rect.height * ratio;
                      ctx.scale(ratio, ratio);
                      ctx.fillStyle = 'white';
                      ctx.fillRect(0, 0, rect.width, rect.height);
                      const scale = Math.min(rect.width / img.width, rect.height / img.height) * 0.9;
                      const drawW = img.width * scale;
                      const drawH = img.height * scale;
                      const x = (rect.width - drawW) / 2;
                      const y = (rect.height - drawH) / 2;
                      ctx.drawImage(img, x, y, drawW, drawH);
                      gmCanvas.dataset.signatureLoaded = 'true';
                      console.log('✅ GM signature drawn to editable canvas');
                    };
                    img.src = sigUrl;
                    
                    // Show edit hint
                    if (submissionData.general_manager_approved_at) {
                      const gmHint = document.getElementById('gmSignatureHint');
                      if (gmHint) {
                        const timestamp = typeof formatSigningTime === 'function' ? formatSigningTime(submissionData.general_manager_approved_at) : '';
                        gmHint.innerHTML = `<span class="text-success">✓ Signed${timestamp ? ': ' + timestamp : ''}</span> <span class="text-muted small"></span>`;
                        gmHint.classList.remove('text-danger');
                      }
                    }
                  } else {
                    // GM cannot edit - show as read-only image
                    gmCanvas.style.display = 'none';
                  const sigImg = document.createElement('img');
                    sigImg.src = sigUrl;
                    sigImg.alt = 'General Manager Signature';
                    sigImg.style.cssText = 'max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; object-position: center; display: block; margin: 0 auto;';
                    gmCanvas.parentElement.insertBefore(sigImg, gmCanvas);
                  
                    const clearBtn = document.getElementById('clearGeneralManager');
                  if (clearBtn) clearBtn.style.display = 'none';
                    
                    const gmLabel = gmCanvas.parentElement.querySelector('label');
                    if (gmLabel) {
                      gmLabel.innerHTML = 'GENERAL MANAGER SIGNATURE <span style="color: #10b981; font-weight: bold; font-size: 0.9rem;">✓ Already Signed</span>';
                  }
                    
                    const hintSpan = gmCanvas.parentElement.querySelector('.signature-hint');
                  if (hintSpan) hintSpan.style.display = 'none';
                    
                    console.log('✅ Loaded GM signature as image (read-only)');
                  }
                  
                  if (gmSigInput) {
                    gmSigInput.value = sigUrl;
                  }
                } catch (e) {
                  console.error('❌ Error loading GM signature:', e);
                }
              } else if (gmSigInput) {
                gmSigInput.value = sigUrl;
                console.log('✅ Stored GM signature in hidden input');
              }
            }
          }
          
          // Load all previous reviewers' data for General Manager (read-only)
          const prevSection = document.getElementById('previousReviewersReadOnlySection');
          let hasAnyData = false;
          
          // Supervisor
          let supervisorCommentsGM = null;
          let supervisorSigGM = null;
          
          if (formData) {
            if (formData.supervisor_comments) supervisorCommentsGM = formData.supervisor_comments;
            if (formData.supervisor_signature) supervisorSigGM = formData.supervisor_signature;
          }
          
          if (supervisorCommentsGM || supervisorSigGM) {
            hasAnyData = true;
            const section = document.getElementById('supervisorReadOnlyGM');
            if (section) {
              section.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.created_at) {
                const timestamp = formatSigningTime(submissionData.created_at);
                if (timestamp) {
                  header.innerHTML = `Supervisor Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              const commentsDiv = document.getElementById('supervisorCommentsReadOnlyGM');
              if (commentsDiv) {
                if (supervisorCommentsGM) commentsDiv.textContent = supervisorCommentsGM;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('supervisorSignatureReadOnlyGM', supervisorSigGM, 'Supervisor Signature');
            }
          }
          
          // Operations Manager
          let opsManagerCommentsGM = null;
          let opsManagerSigGM = null;
          
          if (formData) {
            if (formData.operations_manager_comments) opsManagerCommentsGM = formData.operations_manager_comments;
            if (formData.operations_manager_signature) opsManagerSigGM = formData.operations_manager_signature;
            else if (formData.opMan_signature) opsManagerSigGM = formData.opMan_signature;
          }
          
          if ((!opsManagerCommentsGM || !opsManagerSigGM) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!opsManagerCommentsGM && checkFormData.operations_manager_comments) opsManagerCommentsGM = checkFormData.operations_manager_comments;
              if (!opsManagerSigGM) {
                if (checkFormData.operations_manager_signature) opsManagerSigGM = checkFormData.operations_manager_signature;
                else if (checkFormData.opMan_signature) opsManagerSigGM = checkFormData.opMan_signature;
              }
            }
          }
          
          if (!opsManagerCommentsGM && submissionData && submissionData.operations_manager_comments) {
            opsManagerCommentsGM = submissionData.operations_manager_comments;
          }
          
          if (opsManagerCommentsGM || opsManagerSigGM) {
            hasAnyData = true;
            const section = document.getElementById('opsManagerReadOnlyGM');
            if (section) {
              section.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.operations_manager_approved_at) {
                const timestamp = formatSigningTime(submissionData.operations_manager_approved_at);
                if (timestamp) {
                  header.innerHTML = `Operations Manager Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              const commentsDiv = document.getElementById('opsManagerCommentsReadOnlyGM');
              if (commentsDiv) {
                if (opsManagerCommentsGM) commentsDiv.textContent = opsManagerCommentsGM;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('opsManagerSignatureReadOnlyGM', opsManagerSigGM, 'Operations Manager Signature');
            }
          }
          
          // Business Development
          let bdCommentsGM = null;
          let bdSigGM = null;
          
          if (formData) {
            if (formData.business_dev_comments) bdCommentsGM = formData.business_dev_comments;
            if (formData.business_dev_signature) bdSigGM = formData.business_dev_signature;
          }
          
          if ((!bdCommentsGM || !bdSigGM) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!bdCommentsGM && checkFormData.business_dev_comments) bdCommentsGM = checkFormData.business_dev_comments;
              if (!bdSigGM && checkFormData.business_dev_signature) bdSigGM = checkFormData.business_dev_signature;
            }
          }
          
          if (!bdCommentsGM && submissionData && submissionData.business_dev_comments) {
            bdCommentsGM = submissionData.business_dev_comments;
          }
          
          if (bdCommentsGM || bdSigGM) {
            hasAnyData = true;
            const section = document.getElementById('bdReadOnlyGM');
            if (section) {
              section.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.business_dev_approved_at) {
                const timestamp = formatSigningTime(submissionData.business_dev_approved_at);
                if (timestamp) {
                  header.innerHTML = `Business Development Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              const commentsDiv = document.getElementById('bdCommentsReadOnlyGM');
              if (commentsDiv) {
                if (bdCommentsGM) commentsDiv.textContent = bdCommentsGM;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('bdSignatureReadOnlyGM', bdSigGM, 'Business Development Signature');
            }
          }
          
          // Procurement
          let procurementCommentsGM = null;
          let procurementSigGM = null;
          
          if (formData) {
            if (formData.procurement_comments) procurementCommentsGM = formData.procurement_comments;
            if (formData.procurement_signature) procurementSigGM = formData.procurement_signature;
          }
          
          if ((!procurementCommentsGM || !procurementSigGM) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!procurementCommentsGM && checkFormData.procurement_comments) procurementCommentsGM = checkFormData.procurement_comments;
              if (!procurementSigGM && checkFormData.procurement_signature) procurementSigGM = checkFormData.procurement_signature;
            }
          }
          
          if (!procurementCommentsGM && submissionData && submissionData.procurement_comments) {
            procurementCommentsGM = submissionData.procurement_comments;
          }
          
          if (procurementCommentsGM || procurementSigGM) {
            hasAnyData = true;
            const section = document.getElementById('procurementReadOnlyGM');
            if (section) {
              section.style.display = 'block';
              
              // Add timestamp if available
              const header = section.querySelector('h6');
              if (header && submissionData && submissionData.procurement_approved_at) {
                const timestamp = formatSigningTime(submissionData.procurement_approved_at);
                if (timestamp) {
                  header.innerHTML = `Procurement Review <span style="color: #10b981; font-size: 0.75rem; font-weight: normal;">✓ Signed: ${timestamp}</span>`;
                }
              }
              
              const commentsDiv = document.getElementById('procurementCommentsReadOnlyGM');
              if (commentsDiv) {
                if (procurementCommentsGM) commentsDiv.textContent = procurementCommentsGM;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('procurementSignatureReadOnlyGM', procurementSigGM, 'Procurement Signature');
            }
          }
          
          if (prevSection && hasAnyData) {
            prevSection.style.display = 'block';
          }
          
          // Load General Manager comments
          let generalManagerComments = null;
          if (formData && formData.general_manager_comments) {
            generalManagerComments = formData.general_manager_comments;
          } else if (submissionData && submissionData.form_data && submissionData.form_data.general_manager_comments) {
            generalManagerComments = submissionData.form_data.general_manager_comments;
          } else if (submissionData && submissionData.general_manager_comments) {
            generalManagerComments = submissionData.general_manager_comments;
          }
          
          if (generalManagerComments) {
            const commentsField = document.getElementById('generalManagerComments');
            if (commentsField) {
              commentsField.value = generalManagerComments;
              console.log('✅ Loaded General Manager comments into field');
            }
          }
          {% endif %}
          
          // Load all previous reviewers' data for Admin (read-only) - shows ALL reviewers
          {% if user and user.role == 'admin' %}
          const prevSectionAdmin = document.getElementById('previousForAdminSection');
          let hasAnyDataAdmin = false;
          
          // Supervisor - comprehensive data loading
          let supervisorCommentsAdmin = null;
          let supervisorSigAdmin = null;
          
          if (formData) {
            if (formData.supervisor_comments) supervisorCommentsAdmin = formData.supervisor_comments;
            if (formData.supervisor_signature) supervisorSigAdmin = formData.supervisor_signature;
          }
          
          if ((!supervisorCommentsAdmin || !supervisorSigAdmin) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!supervisorCommentsAdmin && checkFormData.supervisor_comments) supervisorCommentsAdmin = checkFormData.supervisor_comments;
              if (!supervisorSigAdmin && checkFormData.supervisor_signature) supervisorSigAdmin = checkFormData.supervisor_signature;
            }
          }
          
          if (supervisorCommentsAdmin || supervisorSigAdmin) {
            hasAnyDataAdmin = true;
            const section = document.getElementById('supervisorReadOnlyAdmin');
            if (section) {
              section.style.display = 'block';
              
              const commentsDiv = document.getElementById('supervisorCommentsReadOnlyAdmin');
              if (commentsDiv) {
                if (supervisorCommentsAdmin) commentsDiv.textContent = supervisorCommentsAdmin;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('supervisorSignatureReadOnlyAdmin', supervisorSigAdmin, 'Supervisor Signature');
            }
          }
          
          // Operations Manager - comprehensive data loading
          let opsManagerCommentsAdmin = null;
          let opsManagerSigAdmin = null;
          
          if (formData) {
            if (formData.operations_manager_comments) opsManagerCommentsAdmin = formData.operations_manager_comments;
            if (formData.operations_manager_signature) opsManagerSigAdmin = formData.operations_manager_signature;
            else if (formData.opMan_signature) opsManagerSigAdmin = formData.opMan_signature;
          }
          
          if ((!opsManagerCommentsAdmin || !opsManagerSigAdmin) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!opsManagerCommentsAdmin && checkFormData.operations_manager_comments) opsManagerCommentsAdmin = checkFormData.operations_manager_comments;
              if (!opsManagerSigAdmin) {
                if (checkFormData.operations_manager_signature) opsManagerSigAdmin = checkFormData.operations_manager_signature;
                else if (checkFormData.opMan_signature) opsManagerSigAdmin = checkFormData.opMan_signature;
              }
            }
          }
          
          // Also check submission model fields
          if (!opsManagerCommentsAdmin && submissionData && submissionData.operations_manager_comments) {
            opsManagerCommentsAdmin = submissionData.operations_manager_comments;
          }
          
          if (opsManagerCommentsAdmin || opsManagerSigAdmin) {
            hasAnyDataAdmin = true;
            const section = document.getElementById('opsManagerReadOnlyAdmin');
            if (section) {
              section.style.display = 'block';
              
              const commentsDiv = document.getElementById('opsManagerCommentsReadOnlyAdmin');
              if (commentsDiv) {
                if (opsManagerCommentsAdmin) commentsDiv.textContent = opsManagerCommentsAdmin;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('opsManagerSignatureReadOnlyAdmin', opsManagerSigAdmin, 'Operations Manager Signature');
            }
          }
          
          // Business Development - comprehensive data loading
          let bdCommentsAdmin = null;
          let bdSigAdmin = null;
          
          if (formData) {
            if (formData.business_dev_comments) bdCommentsAdmin = formData.business_dev_comments;
            if (formData.business_dev_signature) bdSigAdmin = formData.business_dev_signature;
          }
          
          if ((!bdCommentsAdmin || !bdSigAdmin) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!bdCommentsAdmin && checkFormData.business_dev_comments) bdCommentsAdmin = checkFormData.business_dev_comments;
              if (!bdSigAdmin && checkFormData.business_dev_signature) bdSigAdmin = checkFormData.business_dev_signature;
            }
          }
          
          // Also check submission model fields
          if (!bdCommentsAdmin && submissionData && submissionData.business_dev_comments) {
            bdCommentsAdmin = submissionData.business_dev_comments;
          }
          
          if (bdCommentsAdmin || bdSigAdmin) {
            hasAnyDataAdmin = true;
            const section = document.getElementById('bdReadOnlyAdmin');
            if (section) {
              section.style.display = 'block';
              
              const commentsDiv = document.getElementById('bdCommentsReadOnlyAdmin');
              if (commentsDiv) {
                if (bdCommentsAdmin) commentsDiv.textContent = bdCommentsAdmin;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('bdSignatureReadOnlyAdmin', bdSigAdmin, 'Business Development Signature');
            }
          }
          
          // Procurement - comprehensive data loading
          let procurementCommentsAdmin = null;
          let procurementSigAdmin = null;
          
          if (formData) {
            if (formData.procurement_comments) procurementCommentsAdmin = formData.procurement_comments;
            if (formData.procurement_signature) procurementSigAdmin = formData.procurement_signature;
          }
          
          if ((!procurementCommentsAdmin || !procurementSigAdmin) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!procurementCommentsAdmin && checkFormData.procurement_comments) procurementCommentsAdmin = checkFormData.procurement_comments;
              if (!procurementSigAdmin && checkFormData.procurement_signature) procurementSigAdmin = checkFormData.procurement_signature;
            }
          }
          
          // Also check submission model fields
          if (!procurementCommentsAdmin && submissionData && submissionData.procurement_comments) {
            procurementCommentsAdmin = submissionData.procurement_comments;
          }
          
          if (procurementCommentsAdmin || procurementSigAdmin) {
            hasAnyDataAdmin = true;
            const section = document.getElementById('procurementReadOnlyAdmin');
            if (section) {
              section.style.display = 'block';
              
              const commentsDiv = document.getElementById('procurementCommentsReadOnlyAdmin');
              if (commentsDiv) {
                if (procurementCommentsAdmin) commentsDiv.textContent = procurementCommentsAdmin;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('procurementSignatureReadOnlyAdmin', procurementSigAdmin, 'Procurement Signature');
            }
          }
          
          // General Manager - comprehensive data loading
          let gmCommentsAdmin = null;
          let gmSigAdmin = null;
          
          if (formData) {
            if (formData.general_manager_comments) gmCommentsAdmin = formData.general_manager_comments;
            if (formData.general_manager_signature) gmSigAdmin = formData.general_manager_signature;
          }
          
          if ((!gmCommentsAdmin || !gmSigAdmin) && submissionData && submissionData.form_data) {
            let checkFormData = submissionData.form_data;
            if (typeof checkFormData === 'string') {
              try { checkFormData = JSON.parse(checkFormData); } catch (e) {}
            }
            if (checkFormData) {
              if (!gmCommentsAdmin && checkFormData.general_manager_comments) gmCommentsAdmin = checkFormData.general_manager_comments;
              if (!gmSigAdmin && checkFormData.general_manager_signature) gmSigAdmin = checkFormData.general_manager_signature;
            }
          }
          
          if (!gmCommentsAdmin && submissionData && submissionData.general_manager_comments) {
            gmCommentsAdmin = submissionData.general_manager_comments;
          }
          if (!gmSigAdmin && submissionData && (submissionData.general_manager_signature || submissionData.generalManagerSignature)) {
            gmSigAdmin = submissionData.general_manager_signature || submissionData.generalManagerSignature;
          }
          
          if (gmCommentsAdmin || gmSigAdmin) {
            hasAnyDataAdmin = true;
            const section = document.getElementById('gmReadOnlyAdmin');
            if (section) {
              section.style.display = 'block';
              
              const commentsDiv = document.getElementById('gmCommentsReadOnlyAdmin');
              if (commentsDiv) {
                if (gmCommentsAdmin) commentsDiv.textContent = gmCommentsAdmin;
                else {
                  commentsDiv.textContent = 'No comments provided';
                  commentsDiv.style.fontStyle = 'italic';
                  commentsDiv.style.color = '#9ca3af';
                }
              }
              
              displaySignatureInContainer('gmSignatureReadOnlyAdmin', gmSigAdmin, 'General Manager Signature');
            }
          }
          
          // Show admin section if any data exists
          if (prevSectionAdmin && hasAnyDataAdmin) {
            prevSectionAdmin.style.display = 'block';
          }
          {% endif %}
        } catch (err) {
          console.error('Failed to load submission data:', err);
        }
        {% endif %}
      }
      
      {% if is_edit_mode %}
      window.addEventListener('DOMContentLoaded', loadSubmissionData);
      {% endif %}

      // Initialize Upload Queue System - Matching HVAC exactly
      let photoQueue = null;
      let photoQueueUI = null;
      
      // Wait for scripts to load, then initialize
      function initPhotoQueue() {
        console.log('🔍 Checking PhotoUploadQueue availability:', {
          PhotoUploadQueue: typeof window.PhotoUploadQueue,
          PhotoQueueUI: typeof window.PhotoQueueUI
        });
        
        if (window.PhotoUploadQueue && window.PhotoQueueUI) {
          console.log('✅ Initializing photo queue system...');
          photoQueue = new window.PhotoUploadQueue({
            uploadEndpoint: modulePrefix + '/upload-photo',
            maxConcurrent: 3,
            onProgress: (stats) => {
              if (photoQueueUI) photoQueueUI.updateProgress(stats);
            },
            onItemComplete: (item, success) => {
              // Update UI when individual items complete
              if (photoQueueUI) {
                photoQueueUI.updatePhotoStatus(item);
              }
              // Update the currentFiles array with the uploaded URL
              if (success && item.url) {
                const fileIndex = currentFiles.findIndex(f => f._queueId === item.id);
                if (fileIndex !== -1) {
                  currentFiles[fileIndex].url = item.url;
                  currentFiles[fileIndex].is_cloud = true;
                }
              }
              updatePhotoCount();
            },
            onQueueComplete: (stats) => {
              console.log('✅ All uploads complete:', stats);
              updatePhotoCount();
              // Show success message if all completed
              if (stats.completed === stats.total && stats.failed === 0) {
                console.log(`✅ Successfully uploaded ${stats.completed} photo(s)`);
              }
            },
            onError: (error) => {
              console.error('Upload error:', error);
            }
          });

          photoQueueUI = new window.PhotoQueueUI({
            containerId: 'photoPreviewContainer',
            onRetry: (photoId) => {
              photoQueue.retryUpload(photoId);
            },
            onRemove: (photoId) => {
              photoQueue.removePhoto(photoId);
              updatePhotoCount();
            }
          });
          console.log('✅ Photo queue system initialized');
          
          // Create progress container (only if photoPreviewContainer exists)
          if (photoPreviewContainer && photoPreviewContainer.parentNode) {
            const progressDiv = document.createElement('div');
            progressDiv.id = 'queue-progress-container';
            progressDiv.className = 'mb-3';
            photoPreviewContainer.parentNode.insertBefore(progressDiv, photoPreviewContainer);
          }

          // Add retry all button event listener
          document.addEventListener('click', (e) => {
            if (e.target.id === 'retry-all-failed-btn' || e.target.closest('#retry-all-failed-btn')) {
              photoQueue.retryAllFailed();
            }
          });
          
          // Handle window resize and orientation changes for mobile responsiveness
          let resizeTimeout;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
              if (photoQueueUI) {
                photoQueueUI.updateLayout();
              }
            }, 250);
          });
          
          window.addEventListener('orientationchange', () => {
            setTimeout(() => {
              if (photoQueueUI) {
                photoQueueUI.updateLayout();
              }
            }, 100);
          });
        } else {
          console.error('❌ PhotoUploadQueue or PhotoQueueUI not available!');
          console.error('Available window properties:', Object.keys(window).filter(k => k.includes('Photo')));
        }
      }
      
      // Try to initialize immediately
      initPhotoQueue();
      
      // If not available, wait a bit and try again (scripts might still be loading)
      if (!photoQueue) {
        setTimeout(() => {
          console.log('⏳ Retrying photo queue initialization...');
          initPhotoQueue();
        }, 500);
      }

      function updatePhotoCount() {
        let count = 0;
        
        if (photoQueue) {
          const stats = photoQueue.getStats();
          count = stats.total || 0;
          console.log('📊 Queue stats:', stats);
        } else {
          count = currentFiles.length;
        }
        
        // Also count visible thumbnails as fallback
        if (photoPreviewContainer && count === 0) {
          count = photoPreviewContainer.querySelectorAll('.photo-item').length;
        }
        
        if (count > 0) {
          photoCount.style.display = 'block';
          photoCount.textContent = `📸 ${count} / ${MAX_PHOTOS} photos added`;
          photoCount.className = 'photo-count alert alert-info';
          photoCount.style.cssText = 'display: block !important; padding: 0.5rem 1rem; margin-top: 0.5rem; border-radius: 4px; font-weight: 600; background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460;';
        } else {
          photoCount.style.display = 'none';
        }
        
        console.log('📊 Photo count updated:', count, 'visible thumbnails:', photoPreviewContainer?.querySelectorAll('.photo-item').length);
      }

      let currentFiles = [];
      let currentPreviews = [];
      let workItemCounter = 1;

      // Auto-download helper function
      function autoDownload(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      function getWorkItemBlocks() {
        return Array.from(document.querySelectorAll('#workItemsContainer .work-item-block'));
      }

      function renumberWorkItems() {
        const blocks = getWorkItemBlocks();
        blocks.forEach((block, idx) => {
          const n = idx + 1;
          block.dataset.index = String(n);
          const title = block.querySelector('.work-item-title');
          if (title) title.textContent = `Work Item ${n}`;
          block.querySelectorAll('.work-item-sn').forEach((el) => (el.textContent = String(n)));
        });
        workItemCounter = blocks.length;
      }

      function cloneEmptyWorkItemBlock() {
        const container = document.getElementById('workItemsContainer');
        if (!container) return null;
        const template = container.querySelector('.work-item-block');
        if (!template) return null;
        const clone = template.cloneNode(true);

        // Clear all inputs/textarea values
        clone.querySelectorAll('input').forEach((input) => {
          if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
          else input.value = '';
        });
        clone.querySelectorAll('textarea').forEach((ta) => (ta.value = ''));

        // Ensure active state cleared
        clone.classList.remove('active');
        clone.querySelectorAll('tr.row-active').forEach((tr) => tr.classList.remove('row-active'));

        return clone;
      }

      // Add Work Item Block (each work item is its own asset)
      document.getElementById('addRowBtn').addEventListener('click', () => {
        const container = document.getElementById('workItemsContainer');
        if (!container) return;
        const newBlock = cloneEmptyWorkItemBlock();
        if (!newBlock) return;
        container.appendChild(newBlock);
        renumberWorkItems();
        saveDraft();
      });

      // Remove Work Item Block (button exists inside Pricing table)
      document.getElementById('workItemsContainer')?.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-work-item');
        if (!btn) return;
        const container = document.getElementById('workItemsContainer');
        if (!container) return;
        const blocks = getWorkItemBlocks();
        if (blocks.length <= 1) {
          statusBox.innerHTML = '<div class="alert alert-warning">⚠️ At least one work item is required</div>';
          return;
        }
        const block = btn.closest('.work-item-block');
        if (block) block.remove();
        renumberWorkItems();
        saveDraft();
      });

      // Active block highlighting (keeps the two internal tables visually linked)
      const workItemsContainer = document.getElementById('workItemsContainer');
      if (workItemsContainer) {
        const clearActive = () => {
          workItemsContainer.querySelectorAll('.work-item-block.active').forEach((b) => b.classList.remove('active'));
          workItemsContainer.querySelectorAll('tbody tr.row-active').forEach((tr) => tr.classList.remove('row-active'));
        };

        const activateBlock = (block) => {
          if (!block) return;
          clearActive();
          block.classList.add('active');
          block.querySelectorAll('tbody tr').forEach((tr) => tr.classList.add('row-active'));
        };

        workItemsContainer.addEventListener('focusin', (e) => {
          activateBlock(e.target.closest('.work-item-block'));
        });
        workItemsContainer.addEventListener('mouseover', (e) => {
          activateBlock(e.target.closest('.work-item-block'));
        });
        workItemsContainer.addEventListener('mouseleave', () => {
          if (document.activeElement && workItemsContainer.contains(document.activeElement)) return;
          clearActive();
        });
      }

      // Image Compression Function
      async function compressImage(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let { width, height } = img;
              
              if (width > MAX_IMAGE_DIMENSION || height > MAX_IMAGE_DIMENSION) {
                if (width > height) {
                  height = Math.round((height / width) * MAX_IMAGE_DIMENSION);
                  width = MAX_IMAGE_DIMENSION;
                } else {
                  width = Math.round((width / height) * MAX_IMAGE_DIMENSION);
                  height = MAX_IMAGE_DIMENSION;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              canvas.toBlob((blob) => {
                if (!blob) {
                  reject(new Error('Compression failed'));
                  return;
                }
                const compressed = new File([blob], file.name.replace(/\.\w+$/, '.jpg'), {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                resolve(compressed);
              }, 'image/jpeg', JPEG_QUALITY);
            };
            img.onerror = () => reject(new Error('Image load failed'));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error('File read failed'));
          reader.readAsDataURL(file);
        });
      }

      if (!checkBrowserSupport()) {
        dropZone.style.display = 'none';
        curPhotos.classList.remove('d-none');
        uploadProgress.innerHTML = '<div class="alert alert-warning">Using fallback mode</div>';
        uploadProgress.style.display = 'block';
      }

      async function handleFiles(files) {
        if (!files || files.length === 0) return;
        
        const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (imageFiles.length === 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = '⚠️ Please select image files only.';
          return;
          return;
        }
        
        // File size validation upfront
        const oversizedFiles = imageFiles.filter(f => f.size > MAX_FILE_SIZE);
        if (oversizedFiles.length > 0) {
          fileWarning.style.display = 'block';
          fileWarning.textContent = `⚠️ ${oversizedFiles.length} file(s) exceed 10MB limit and will be skipped`;
          setTimeout(() => { fileWarning.style.display = 'none'; }, 5000);
        }
        
        const validFiles = imageFiles.filter(f => f.size <= MAX_FILE_SIZE);
        if (validFiles.length === 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = '⚠️ All files exceed 10MB size limit. Please compress them first.';
          return;
          return;
        }
        
        const totalAfter = currentFiles.length + validFiles.length;
        if (totalAfter > MAX_PHOTOS) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = `⚠️ Maximum ${MAX_PHOTOS} photos. You have ${currentFiles.length}, trying to add ${validFiles.length}.`;
          return;
          return;
        }
        
        // Use upload queue if available
        if (photoQueue && photoQueueUI) {
          console.log('📸 Adding photos to queue:', validFiles.length);
          const addedItems = await photoQueue.addPhotos(validFiles);
          console.log('📸 Added items to queue:', addedItems.length);
          console.log('📸 Preview container element:', photoPreviewContainer);
          console.log('📸 Preview container display:', photoPreviewContainer?.style.display);
          
          // Show preview container
          if (photoPreviewContainer) {
            photoPreviewContainer.style.display = 'flex';
            photoPreviewContainer.style.flexWrap = 'wrap';
            photoPreviewContainer.style.gap = '10px';
            photoPreviewContainer.style.marginTop = '1rem';
            photoPreviewContainer.style.padding = '0.5rem';
            photoPreviewContainer.style.minHeight = '140px';
            photoPreviewContainer.style.border = '1px dashed #dee2e6';
            photoPreviewContainer.style.borderRadius = '4px';
            photoPreviewContainer.style.backgroundColor = '#f8f9fa';
            console.log('✅ Preview container made visible');
          } else {
            console.error('❌ photoPreviewContainer not found!');
          }
          
          // Render each photo
          addedItems.forEach((item, idx) => {
            console.log(`📸 Rendering item ${idx + 1}:`, {
              id: item.id,
              preview: item.preview ? 'exists' : 'missing',
              previewUrl: item.preview,
              status: item.status,
              fileName: item.file?.name
            });
            currentFiles.push({ _queueId: item.id, url: null, is_cloud: false });
            
            // Try to render with photoQueueUI
            let rendered = null;
            if (photoQueueUI) {
              rendered = photoQueueUI.renderPhotoItem(item);
              console.log(`✅ Rendered via photoQueueUI item ${idx + 1}:`, rendered);
            }
            
            // Fallback: render directly if photoQueueUI failed
            if (!rendered && photoPreviewContainer && item.preview) {
              console.log(`⚠️ photoQueueUI failed, rendering directly for item ${idx + 1}`);
              const photoDiv = document.createElement('div');
              photoDiv.className = 'photo-item';
              photoDiv.dataset.photoId = item.id;
              photoDiv.style.cssText = 'position: relative; display: inline-block; margin: 8px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: #f8f9fa; border: 2px solid #dee2e6;';
              
              const img = document.createElement('img');
              img.src = item.preview;
              img.alt = 'Photo';
              img.style.cssText = 'display: block !important; width: 120px !important; height: 120px !important; object-fit: cover; background: #fff;';
              img.onerror = () => console.error('❌ Image failed to load:', item.preview);
              img.onload = () => console.log('✅ Image loaded:', item.id);
              
              const removeBtn = document.createElement('button');
              removeBtn.textContent = '×';
              removeBtn.className = 'photo-remove-btn';
              removeBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; border-radius: 50%; background: rgba(220, 53, 69, 0.9); border: none; color: white; font-size: 16px; cursor: pointer; z-index: 10;';
              removeBtn.onclick = (e) => {
                e.stopPropagation();
                photoQueue.removePhoto(item.id);
                photoDiv.remove();
                updatePhotoCount();
              };
              
              photoDiv.appendChild(img);
              photoDiv.appendChild(removeBtn);
              photoPreviewContainer.appendChild(photoDiv);
              rendered = photoDiv;
              console.log(`✅ Rendered directly item ${idx + 1}:`, rendered);
            }
          });
          
          // Force container visibility
          if (photoPreviewContainer && addedItems.length > 0) {
            photoPreviewContainer.style.display = 'flex';
            const computedStyle = window.getComputedStyle(photoPreviewContainer);
            console.log('📸 Container computed display:', computedStyle.display);
            console.log('📸 Container computed visibility:', computedStyle.visibility);
            
            // If still not visible, force it
            if (computedStyle.display === 'none') {
              console.warn('⚠️ Container still hidden, forcing visibility');
              photoPreviewContainer.style.display = 'flex !important';
            }
          }
          
          console.log('📸 Total items in container:', photoPreviewContainer?.children.length);
          console.log('📸 Container display:', photoPreviewContainer?.style.display);
          console.log('📸 Container visibility:', window.getComputedStyle(photoPreviewContainer).display);
          
          // Update count immediately and after a short delay
          updatePhotoCount();
          setTimeout(() => {
            updatePhotoCount();
            console.log('📸 Delayed count check - visible thumbnails:', photoPreviewContainer?.querySelectorAll('.photo-item img').length);
          }, 100);
          
          saveDraft();
          
          // Log queue state after adding
          setTimeout(() => {
            const stats = photoQueue.getStats();
            const uploaded = photoQueue.getUploadedUrls();
            console.log('📸 Queue stats after adding:', stats);
            console.log('📸 Uploaded URLs:', uploaded);
          }, 2000);
          
          return;
        }
        
        // Fallback to original compression logic
        uploadProgress.style.display = 'block';
        
        const BATCH_SIZE = 3;
        let successCount = 0;
        let failedFiles = [];
        
        for (let i = 0; i < validFiles.length; i += BATCH_SIZE) {
          const batch = validFiles.slice(i, i + BATCH_SIZE);
          const promises = batch.map(file => compressImage(file));
          
          try {
            const compressed = await Promise.all(promises);
            compressed.forEach(c => {
              if (c) {
                currentFiles.push(c);
                currentPreviews.push(URL.createObjectURL(c));
                successCount++;
              }
            });
          } catch (err) {
            console.error('Batch compression error:', err);
            batch.forEach(f => failedFiles.push(f.name));
          }
          
          const progress = Math.round(((i + batch.length) / validFiles.length) * 100);
          uploadProgressBar.style.width = progress + '%';
          uploadProgressBar.textContent = `Compressing ${Math.min(i + batch.length, validFiles.length)}/${validFiles.length}...`;
        }
        
        uploadProgress.style.display = 'none';
        
        if (failedFiles.length > 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-danger';
          uploadStatus.innerHTML = `⚠️ Failed to process ${failedFiles.length} file(s): ${failedFiles.slice(0, 3).join(', ')}${failedFiles.length > 3 ? '...' : ''}`;
        }
        
        renderPhotoPreview();
        saveDraft();
      }

      function renderPhotoPreview() {
        photoPreviewContainer.innerHTML = '';
        const count = currentFiles.length;
        
        if (count === 0) {
          photoCount.style.display = 'none';
          photoPreviewContainer.style.display = 'none';
          return;
        }
        
        photoPreviewContainer.style.display = 'flex';
        photoCount.style.display = 'inline-block';
        photoCount.textContent = `${count} / ${MAX_PHOTOS} photos`;
        photoCount.className = 'photo-count mt-2';
        if (count >= MAX_PHOTOS * 0.8) photoCount.classList.add('warning');
        if (count >= MAX_PHOTOS) photoCount.classList.add('danger');
        
        currentPreviews.forEach((url, idx) => {
          const item = document.createElement('div');
          item.className = 'photo-preview-item';
          
          const img = document.createElement('img');
          img.src = url;
          img.alt = `Photo ${idx + 1}`;
          
          const removeBtn = document.createElement('div');
          removeBtn.className = 'photo-preview-remove';
          removeBtn.textContent = '×';
          removeBtn.title = 'Remove this photo';
          removeBtn.onclick = () => removePhoto(idx);
          
          item.appendChild(img);
          item.appendChild(removeBtn);
          photoPreviewContainer.appendChild(item);
        });
      }
      
      function removePhoto(index) {
        if (index < 0 || index >= currentFiles.length) return;
        URL.revokeObjectURL(currentPreviews[index]);
        currentFiles.splice(index, 1);
        currentPreviews.splice(index, 1);
        renderPhotoPreview();
        saveDraft();
      }

      dropZone.addEventListener('click', () => curPhotos.click());
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
      dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
      dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
      curPhotos.addEventListener('change', () => handleFiles(curPhotos.files));

      // Draft Auto-Save
      function saveDraft() {
        try {
          const safeValue = (id) => {
            const el = document.getElementById(id);
            return el ? (el.value || '') : '';
          };

          const draft = {
            date: safeValue('date'),
            project_name: safeValue('project_name'),
            description_of_work: safeValue('description_of_work'),
            area: safeValue('area'),
            area_other: safeValue('area_other'),
            workItemsCount: document.querySelectorAll('#workItemsContainer .work-item-block').length,
            photoCount: currentFiles.length,
            timestamp: Date.now()
          };
          localStorage.setItem('civil_draft', JSON.stringify(draft));
        } catch (err) {
          console.error('Failed to save draft:', err);
        }
      }

      function loadDraft() {
        try {
          const draftJson = localStorage.getItem('civil_draft');
          if (!draftJson) return false;
          
          const draft = JSON.parse(draftJson);
          const ageMinutes = (Date.now() - draft.timestamp) / 60000;
          
          if (ageMinutes > 1440) { // 24 hours
            clearDraft();
            return false;
          }
          
          // Auto-load draft without confirmation
          const safeSet = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.value = value || '';
          };

          // Backward compatibility for older drafts (before Area dropdown)
          if (!draft.area && (draft.location_name || draft.city_area || draft.floor || draft.developer_client)) {
            const legacyBits = [draft.location_name, draft.city_area, draft.floor, draft.developer_client]
              .filter(Boolean)
              .join(' - ');
            draft.area = 'Other';
            draft.area_other = legacyBits;
          }

          safeSet('date', draft.date);
          safeSet('project_name', draft.project_name);
          safeSet('description_of_work', draft.description_of_work);
          safeSet('area', draft.area);
          safeSet('area_other', draft.area_other);

          if (typeof handleAreaChange === 'function') {
            handleAreaChange();
          }
          
          // Draft loaded silently
          if (draft.workItemsCount > 0 || draft.photoCount > 0) {
            console.log(`ℹ️ Draft loaded: ${draft.workItemsCount} work items and ${draft.photoCount} photos`);
          }
          return true;
        } catch (err) {
          console.error('Failed to load draft:', err);
        }
        return false;
      }

      function clearDraft() {
        try {
          localStorage.removeItem('civil_draft');
        } catch (err) {
          console.error('Failed to clear draft:', err);
        }
      }

      // Auto-save every 30 seconds
      setInterval(saveDraft, DRAFT_SAVE_INTERVAL);
      
      // Save on field changes
      ['date', 'project_name', 'description_of_work', 'area', 'area_other'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', saveDraft);
          el.addEventListener('change', saveDraft);
        }
      });

      // Don't auto-load draft on page refresh - always start with a fresh form
      // window.addEventListener('DOMContentLoaded', loadDraft); // DISABLED - forms should be fresh on refresh
      
      // Set default date to today and max date to today (prevent future dates)
      window.addEventListener('DOMContentLoaded', function() {
        const dateField = document.getElementById('date');
        if (dateField) {
          // Always set max date to today to prevent future date selection
          const today = new Date();
          const todayStr = today.toISOString().split('T')[0];
          dateField.setAttribute('max', todayStr);
          
          // Set today's date as default only if not in edit mode and field is empty
          {% if not is_edit_mode %}
          if (!dateField.value) {
            dateField.value = todayStr;
          }
          {% endif %}
        }
        // Clear any existing drafts on page load to ensure fresh form (unless in edit mode)
        {% if not is_edit_mode %}
        clearDraft();
        {% endif %}
      });

      // Upload Images Button Handler
      uploadImagesBtn.addEventListener('click', async () => {
        console.log('📤 Upload button clicked. photoQueue:', photoQueue);
        if (!photoQueue) {
          console.error('❌ Photo queue not initialized!');
          console.error('Window.PhotoUploadQueue:', typeof window.PhotoUploadQueue);
          console.error('Window.PhotoQueueUI:', typeof window.PhotoQueueUI);
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-danger';
          uploadStatus.innerHTML = '⚠️ Photo upload system not available. Please refresh the page.';
          return;
          return;
        }
        
        const stats = photoQueue.getStats();
        if (stats.total === 0) {
          uploadStatus.classList.remove('d-none');
          uploadStatus.className = 'alert alert-warning';
          uploadStatus.innerHTML = '⚠️ Please add photos first before uploading.';
          return;
          return;
        }
        
        // Check if already uploaded
        if (photosUploaded && uploadedPhotoUrls.length > 0) {
          // Auto-reset if already uploaded
          photosUploaded = false;
          uploadedPhotoUrls = [];
        }
        
        // Disable button and show spinner
        uploadImagesBtn.disabled = true;
        uploadImagesBtnText.textContent = 'Uploading...';
        uploadImagesBtnSpinner.classList.remove('d-none');
        uploadStatus.classList.remove('d-none');
        uploadStatus.className = 'alert alert-info';
        uploadStatus.innerHTML = `Uploading ${stats.total} photo(s)...`;
        
        try {
          // Wait for all uploads to complete
          const maxWaitTime = 300000; // 5 minutes max
          const startTime = Date.now();
          
          while (!stats.isComplete && (Date.now() - startTime) < maxWaitTime) {
            await new Promise(resolve => setTimeout(resolve, 500));
            const currentStats = photoQueue.getStats();
            const progress = Math.round((currentStats.completed / currentStats.total) * 100);
            uploadStatus.innerHTML = `Uploading ${currentStats.completed}/${currentStats.total} photos (${progress}%)...`;
            
            if (currentStats.isComplete) break;
          }
          
          // Get uploaded URLs
          const uploadedPhotos = photoQueue.getUploadedUrls();
          uploadedPhotoUrls = uploadedPhotos.map(p => {
            if (typeof p === 'string') return p;
            return p.url || p;
          }).filter(Boolean);
          
          // Fallback: check queue items directly
          if (uploadedPhotoUrls.length === 0 && stats.total > 0) {
            const allItems = photoQueue.queue || [];
            const completedItems = allItems.filter(item => item.status === 'completed' && item.url);
            if (completedItems.length > 0) {
              uploadedPhotoUrls = completedItems.map(item => item.url).filter(Boolean);
            }
          }
          
          if (uploadedPhotoUrls.length === 0) {
            throw new Error('No photos were uploaded successfully. Please check for errors and try again.');
          }
          
          photosUploaded = true;
          uploadStatus.className = 'alert alert-success';
          uploadStatus.innerHTML = `✅ Successfully uploaded ${uploadedPhotoUrls.length} photo(s)! You can now generate reports.`;
          
          // Enable submit button and update text
          submitBtn.disabled = false;
          const photoText = uploadedPhotoUrls.length > 0 ? ` (${uploadedPhotoUrls.length} photos)` : '';
          submitBtnText.textContent = `📄 Generate Reports${photoText}`;
          
          console.log('✅ Photos uploaded:', uploadedPhotoUrls);
          
        } catch (error) {
          console.error('Upload error:', error);
          uploadStatus.className = 'alert alert-danger';
          uploadStatus.innerHTML = `❌ Upload failed: ${error.message}`;
          photosUploaded = false;
          uploadedPhotoUrls = [];
        } finally {
          uploadImagesBtn.disabled = false;
          uploadImagesBtnText.textContent = '📤 Upload Images';
          uploadImagesBtnSpinner.classList.add('d-none');
        }
      });

      // Submit Handler - Using HVAC method with JSON payload
      submitBtn.addEventListener('click', async () => {
        // Basic required field validation (browser built-in validation does not run because this is a JS submit)
        const projectNameValue = (document.getElementById('project_name')?.value || '').trim();
        const visitDateValue = (document.getElementById('date')?.value || '').trim();
        const areaValue = (document.getElementById('area')?.value || '').trim();

        if (!projectNameValue) {
          alert('Please enter the Project Name before submitting.');
          goToTab(1);
          return;
        }

        if (!visitDateValue) {
          alert('Please select the Date before submitting.');
          goToTab(1);
          return;
        }

        if (!areaValue) {
          alert('Please select an Area before submitting.');
          goToTab(1);
          return;
        }

        // Ensure pads are initialized
        if (!pads || !window.signaturePads) {
          pads = initSignaturePads();
          window.signaturePads = pads;
          window.pads = pads;
        }
        
        // Get supervisor signature and comments
        
        // Photos are optional - allow submission even without photos
        console.log('📸 Using pre-uploaded photo URLs:', uploadedPhotoUrls);
        console.log('📸 Total photos to submit:', uploadedPhotoUrls.length);
        
        // Collect work items from the block-based UI
        const workItems = [];
        const blocks = Array.from(document.querySelectorAll('#workItemsContainer .work-item-block'));

        const getVal = (root, selector) => {
          const el = root.querySelector(selector);
          return el ? (el.value || '') : '';
        };

        const isAnyFieldFilled = (item) => {
          const fields = [
            item.description,
            item.quantity,
            item.material,
            item.material_qty,
            item.specification,
            item.unit_price,
            item.price,
            item.labour,
            item.comments
          ];
          return fields.some(v => String(v || '').trim() !== '');
        };

        blocks.forEach((block, index) => {
          let itemPhotoUrls = uploadedPhotoUrls || [];
          if (block.dataset.photoUrls) {
            try {
              const parsed = JSON.parse(block.dataset.photoUrls);
              if (Array.isArray(parsed) && parsed.length) itemPhotoUrls = parsed;
            } catch (e) { /* use uploadedPhotoUrls */ }
          }
          const item = {
            item_number: index + 1,
            description: getVal(block, 'input[name="work_desc[]"]'),
            quantity: getVal(block, 'input[name="work_qty[]"]'),
            material: getVal(block, 'input[name="material[]"]'),
            material_qty: getVal(block, 'input[name="material_qty[]"]'),
            specification: getVal(block, 'input[name="specification[]"]'),
            unit_price: getVal(block, 'input[name="unit_price[]"]'),
            price: getVal(block, 'input[name="price[]"]'),
            labour: getVal(block, 'input[name="labour[]"]'),
            comments: getVal(block, 'textarea[name="comments[]"]'),
            photo_urls: itemPhotoUrls
          };

          // Include block if any field is filled OR it has photos (preserve items with only images)
          const hasPhotos = itemPhotoUrls && itemPhotoUrls.length > 0;
          if (!isAnyFieldFilled(item) && !hasPhotos) return;
          workItems.push(item);
        });
        
        if (workItems.length === 0) {
          statusBox.innerHTML = '<div class="alert alert-warning">⚠️ Please add at least one work item before submitting.</div>';
          return;
          return;
        }
        
        // Count total photos
        const totalPhotos = uploadedPhotoUrls.length;
        if (totalPhotos >= 30) {
          const estimatedTime = Math.ceil(totalPhotos / 10);
          // Show info message instead of confirmation
          if (totalPhotos >= 30) {
            const estimatedTime = Math.ceil(totalPhotos / 10);
            statusBox.innerHTML = `<div class="alert alert-info">⏰ Processing ${totalPhotos} photos. This may take ${estimatedTime}-${estimatedTime + 1} minutes...</div>`;
          }
        }

        // Show loading overlay (photos already uploaded, just generating reports)
        loadingOverlay.style.display = 'flex';
        statusBox.innerHTML = '';
        
        // Get supervisor signature and comments (only required for supervisors)
        let supervisorData = '';
        let supervisorComments = '';
        let supervisorVerified = false;
        const supervisorCommentsField = document.getElementById('supervisorComments');
        const supervisorSignatureData = document.getElementById('supervisorSignatureData');
        
        // Check if supervisor section exists (only supervisors/admins have this)
        const isSupervisor = supervisorCommentsField !== null || supervisorSignatureData !== null;
        
        if (isSupervisor) {
          if (pads && pads.supervisorPad && !pads.supervisorPad.isEmpty()) {
            supervisorData = pads.supervisorPad.toDataURL('image/png');
            if (supervisorSignatureData) supervisorSignatureData.value = supervisorData;
          } else if (supervisorSignatureData) {
            supervisorData = supervisorSignatureData.value || '';
          }
          if (supervisorCommentsField) {
            supervisorComments = supervisorCommentsField.value || '';
          }
          supervisorVerified = isVerified || false;
          
          // Validate supervisor signature (only required for supervisors)
          if (!supervisorData) {
            alert('Please provide your supervisor signature before submitting.');
            loadingOverlay.style.display = 'none';
            return;
          }
        }
        
        // Prepare JSON payload (photos already in cloud)
        const area = document.getElementById('area')?.value || '';
        const areaOther = document.getElementById('area_other')?.value || '';
        const location = (area === 'Other') ? (areaOther || 'Other') : area;

        if (!location) {
          alert('Please select an Area before submitting.');
          loadingOverlay.style.display = 'none';
          return;
        }

        // Build payload - include all existing data from submission if in edit mode
        let payload = {
          project_name: projectNameValue,
          location: location,
          visit_date: visitDateValue,
          description_of_work: document.getElementById('description_of_work').value || '',
          area: area,
          area_other: areaOther,
          work_items: workItems
        };
        
        // If in edit mode, merge with existing submission data to preserve ALL fields, comments, signatures, and data
        {% if is_edit_mode and submission_data %}
        if (typeof submissionData !== 'undefined' && submissionData.form_data) {
          let existingFormData = submissionData.form_data;
          if (typeof existingFormData === 'string') {
            try {
              existingFormData = JSON.parse(existingFormData);
            } catch (e) {
              console.warn('⚠️ Could not parse existing form_data:', e);
              existingFormData = {};
            }
          }
          
          // Preserve ALL existing form fields if current values are empty or missing
          if (existingFormData) {
            // Preserve basic form fields if they're missing or empty in current payload
            if (!payload.project_name && existingFormData.project_name) {
              payload.project_name = existingFormData.project_name;
            }
            if (!payload.location && existingFormData.location) {
              payload.location = existingFormData.location;
            }
            if (!payload.visit_date && existingFormData.visit_date) {
              payload.visit_date = existingFormData.visit_date;
            }
            if (!payload.description_of_work && existingFormData.description_of_work) {
              payload.description_of_work = existingFormData.description_of_work;
            }
            if (!payload.area && existingFormData.area) {
              payload.area = existingFormData.area;
            }
            if (!payload.area_other && existingFormData.area_other) {
              payload.area_other = existingFormData.area_other;
            }
            
            // Preserve work_items if current workItems is empty, or merge with existing
            if (existingFormData.work_items && Array.isArray(existingFormData.work_items)) {
              if (!workItems || workItems.length === 0) {
                // Use existing work_items if current is empty
                payload.work_items = existingFormData.work_items;
                workItems = existingFormData.work_items;
                console.log('✅ Using existing work_items from submission');
              } else {
                // Merge photos from existing work_items into current workItems
                existingFormData.work_items.forEach((existingItem, idx) => {
                  if (workItems[idx] && existingItem.photo_urls && Array.isArray(existingItem.photo_urls)) {
                    const existingPhotos = existingItem.photo_urls || [];
                    const currentPhotos = workItems[idx].photo_urls || [];
                    const allPhotos = [...new Set([...existingPhotos, ...currentPhotos])];
                    workItems[idx].photo_urls = allPhotos;
                  }
                });
                // Append existing-only items (previously submitted, no matching block in current form)
                for (let i = workItems.length; i < existingFormData.work_items.length; i++) {
                  workItems.push(existingFormData.work_items[i]);
                }
                payload.work_items = workItems;
                console.log('✅ Merged work_items: preserved', existingFormData.work_items.length, 'items total');
              }
            }
            
            // Preserve supervisor data if it exists
            if (existingFormData.supervisor_signature && !payload.supervisor_signature) {
              payload.supervisor_signature = existingFormData.supervisor_signature;
            }
            if (existingFormData.supervisor_comments && !supervisorComments) {
              payload.supervisor_comments = existingFormData.supervisor_comments;
            }
            
            // Preserve Operations Manager data if it exists
            if (existingFormData.operations_manager_signature || existingFormData.opMan_signature) {
              payload.operations_manager_signature = existingFormData.operations_manager_signature || existingFormData.opMan_signature;
            }
            if (existingFormData.operations_manager_comments) {
              payload.operations_manager_comments = existingFormData.operations_manager_comments;
            }
            
            // Preserve Business Development data if it exists
            if (existingFormData.business_dev_signature || existingFormData.businessDevSignature) {
              payload.business_dev_signature = existingFormData.business_dev_signature || existingFormData.businessDevSignature;
            }
            if (existingFormData.business_dev_comments) {
              payload.business_dev_comments = existingFormData.business_dev_comments;
            }
            
            // Preserve Procurement data if it exists
            if (existingFormData.procurement_signature || existingFormData.procurementSignature) {
              payload.procurement_signature = existingFormData.procurement_signature || existingFormData.procurementSignature;
            }
            if (existingFormData.procurement_comments) {
              payload.procurement_comments = existingFormData.procurement_comments;
            }
            
            // Preserve General Manager data if it exists
            if (existingFormData.general_manager_signature || existingFormData.generalManagerSignature) {
              payload.general_manager_signature = existingFormData.general_manager_signature || existingFormData.generalManagerSignature;
            }
            if (existingFormData.general_manager_comments) {
              payload.general_manager_comments = existingFormData.general_manager_comments;
            }
            
            console.log('✅ Merged existing submission data into payload to preserve all fields, comments, signatures, and photos');
            console.log('📋 Preserved fields:', {
              project_name: !!payload.project_name,
              location: !!payload.location,
              visit_date: !!payload.visit_date,
              description_of_work: !!payload.description_of_work,
              area: !!payload.area,
              workItemsCount: (payload.work_items || []).length
            });
          }
        }
        {% endif %}
        
        // Add supervisor data if supervisor is submitting
        if (isSupervisor) {
          payload.supervisor_signature = supervisorData || '';
          payload.supervisor_comments = supervisorComments || '';
        }
        
        console.log('📤 Submitting payload with work items:', workItems);
        console.log('📤 Each work item photo_urls:', workItems.map(wi => ({ item: wi.item_number, photo_count: wi.photo_urls?.length || 0, urls: wi.photo_urls })));
        console.log('📤 Payload includes:', {
          supervisorSignature: !!payload.supervisor_signature,
          supervisorComments: !!payload.supervisor_comments,
          omSignature: !!payload.operations_manager_signature,
          omComments: !!payload.operations_manager_comments,
          workItemsCount: workItems.length
        });

        try {
          {% if is_edit_mode %}
          {% if is_supervisor_edit %}
          // Supervisor is approving/reviewing - use workflow endpoints (not admin endpoint)
          const submissionId = window.editSubmissionId;
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          
          // First update the submission with new data using workflow endpoint
          const updateRes = await fetch(`/api/workflow/submissions/${submissionId}/update`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify({
              site_name: payload.project_name,
              visit_date: payload.visit_date,
              form_data: payload
            }),
            credentials: 'include'
          });
          
          if (!updateRes.ok) {
            const txt = await updateRes.text();
            throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
          }
          
          const updateJson = await updateRes.json();
          if (!updateJson.success) {
            throw new Error(updateJson.error || 'Update failed');
          }
          
          // Then approve/resubmit via workflow endpoint (includes form_data for regeneration)
          const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              comments: supervisorComments,
              supervisor_signature: supervisorData,
              verified: supervisorVerified,
              form_data: payload  // Include full form_data for regeneration
            }),
            credentials: 'include'
          });
          
          if (!approveRes.ok) {
            const txt = await approveRes.text();
            throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
          }
          
          const approveJson = await approveRes.json();
          
          if (approveJson.success) {
            const jobId = approveJson.data?.job_id;
            const isRegenerating = approveJson.data?.regenerating || false;
            
            // Show correct workflow hierarchy based on who is approving
            {% if user_designation == 'supervisor' %}
            // Supervisor is submitting/approving - form goes to Operations Manager first
            const workflowList = `
              <li>→ Operations Manager</li>
              <li>→ Business Development & Procurement (parallel review)</li>
              <li>→ General Manager (final approval)</li>
            `;
            {% elif user_designation == 'operations_manager' %}
            // Operations Manager is approving - form goes to BD & Procurement, then GM
            const workflowList = `
              <li>→ Business Development & Procurement (parallel review)</li>
              <li>→ General Manager (final approval)</li>
            `;
            {% elif user_designation in ['business_development', 'procurement'] %}
            // BD or Procurement is approving - form goes to GM (if both approved) or stays in BD/Proc review
            const workflowList = `
              <li>→ General Manager (final approval)</li>
            `;
            {% elif user_designation == 'general_manager' %}
            // General Manager is approving - form is complete
            const workflowList = `
              <li>→ Form Completed ✓</li>
            `;
            {% else %}
            // Default fallback
            const workflowList = `
              <li>→ Operations Manager</li>
              <li>→ Business Development & Procurement (parallel review)</li>
              <li>→ General Manager (final approval)</li>
            `;
            {% endif %}
            
            // If job_id is provided, poll for completion and show download links
            if (jobId && isRegenerating) {
              statusBox.innerHTML = '<div class="alert alert-info">✅ Form resubmitted! Regenerating PDF and Excel reports with your updates... This may take a moment.</div>';
              loadingOverlay.style.display = 'flex';
              
              const pollFn = window.pollJobStatus || pollJobStatusFn;
              if (pollFn && typeof pollFn === 'function') {
                const modulePrefix = '/civil';
                pollFn(modulePrefix, jobId, (js) => {
                  const progress = js.progress || 0;
                  statusBox.innerHTML = `<div class="alert alert-info">Regenerating documents... ${progress}%</div>`;
                }).then(result => {
                  loadingOverlay.style.display = 'none';
                  if (result.state === 'done' || result.status === 'completed') {
                    // Create download links for PDF and Excel
                    const downloadLinksContainer = document.createElement('div');
                    downloadLinksContainer.id = 'download-links-container';
                    downloadLinksContainer.className = 'mt-3';
                    downloadLinksContainer.style.cssText = 'display: flex; gap: 10px; flex-wrap: wrap;';
                    
                    const excelBtn = document.createElement('a');
                    excelBtn.href = `${modulePrefix}/download/${jobId}/excel`;
                    excelBtn.className = 'btn btn-success';
                    excelBtn.innerHTML = '📊 Download Excel';
                    excelBtn.target = '_blank';
                    
                    const pdfBtn = document.createElement('a');
                    pdfBtn.href = `${modulePrefix}/download/${jobId}/pdf`;
                    pdfBtn.className = 'btn btn-danger';
                    pdfBtn.innerHTML = '📄 Download PDF';
                    pdfBtn.target = '_blank';
                    
                    downloadLinksContainer.appendChild(excelBtn);
                    downloadLinksContainer.appendChild(pdfBtn);
                    
                    statusBox.innerHTML = `
                      <div class="alert alert-success">
                        <h5 class="alert-heading">✅ Form Resubmitted Successfully!</h5>
                        <hr>
                        <p class="mb-2"><strong>This form will now be sent to:</strong></p>
                        <ul class="mb-0" style="list-style-position: inside;">
                          ${workflowList}
                        </ul>
                        <hr class="mt-3 mb-2">
                        <p class="mb-2"><strong>Documents regenerated successfully!</strong></p>
                      </div>
                    `;
                    statusBox.appendChild(downloadLinksContainer);
                    statusBox.innerHTML += '<hr class="mt-3 mb-2"><a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>';
                  } else {
                    statusBox.innerHTML = '<div class="alert alert-danger">❌ Document regeneration failed. Please try again.</div>';
                  }
                }).catch(err => {
                  loadingOverlay.style.display = 'none';
                  statusBox.innerHTML = `<div class="alert alert-danger">❌ Error: ${err.message}</div>`;
                });
              } else {
                loadingOverlay.style.display = 'none';
                statusBox.innerHTML = `
                  <div class="alert alert-success">
                    <h5 class="alert-heading">✅ Form Resubmitted Successfully!</h5>
                    <hr>
                    <p class="mb-2"><strong>This form will now be sent to:</strong></p>
                    <ul class="mb-0" style="list-style-position: inside;">
                      ${workflowList}
                    </ul>
                    <hr class="mt-3 mb-2">
                    <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
                  </div>
                `;
              }
            } else {
              // No regeneration needed or job_id not provided
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = `
                <div class="alert alert-success">
                  <h5 class="alert-heading">✅ Form Resubmitted Successfully!</h5>
                  <hr>
                  <p class="mb-2"><strong>This form will now be sent to:</strong></p>
                  <ul class="mb-0" style="list-style-position: inside;">
                    ${workflowList}
                  </ul>
                  <hr class="mt-3 mb-2">
                  <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
                </div>
              `;
            }
            clearDraft();
          } else {
            throw new Error(approveJson.error || 'Approval failed');
          }
          {% else %}
          // Edit mode for reviewers (operations_manager, business_development, procurement, general_manager) or admin
          console.log('🚀🚀🚀 NEW CODE LOADED - VERSION 2026-01-24 11:58 🚀🚀🚀');
          console.log('  - User designation from template: {{ user_designation }}');
          console.log('  - Is edit mode: {{ is_edit_mode }}');
          const submissionId = window.editSubmissionId;
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          
          {% if user_designation == 'operations_manager' %}
          // Operations Manager: First update, then approve (to trigger document generation)
          // Get OM comments and signature for approval payload
          console.log('🔍 Collecting OM data for approval...');
          const omCommentsField = document.getElementById('operationsManagerComments');
          console.log('  - OM comments field:', omCommentsField);
          console.log('  - OM comments field value:', omCommentsField?.value);
          const operationsManagerComments = omCommentsField?.value || '';
          console.log('  - Final operationsManagerComments:', operationsManagerComments);
          
          const opSigInput = document.getElementById('opManSignatureData');
          console.log('  - OM signature input:', opSigInput);
          console.log('  - OM signature input value:', opSigInput?.value ? opSigInput.value.substring(0, 50) + '...' : 'none');
          console.log('  - pads:', pads);
          console.log('  - pads.opPad:', pads?.opPad);
          console.log('  - pads.opPad.isEmpty():', pads?.opPad?.isEmpty());
          
          const opData = (pads && pads.opPad && !pads.opPad.isEmpty()) 
                       ? pads.opPad.toDataURL('image/png') 
                       : (opSigInput?.value || '');
          console.log('  - Final opData length:', opData?.length || 0);
          
          const updateUrl = `/api/workflow/submissions/${submissionId}/update`;
          const updateBody = {
            site_name: payload.project_name,
            visit_date: payload.visit_date,
            form_data: payload
          };
          const updateRes = await fetch(updateUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(updateBody),
            credentials: 'include'
          });
          
          if (!updateRes.ok) {
            const txt = await updateRes.text();
            throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
          }
          
          const updateJson = await updateRes.json();
          if (!updateJson.success) {
            throw new Error(updateJson.error || 'Update failed');
          }
          
          // Step 2: Approve to trigger document generation and move to next stage
          // Ensure signature and comments are in both top-level and form_data for consistency
          const approvalPayload = {
            comments: operationsManagerComments || '',
            signature: opData || '',
            form_data: payload
          };
          
          // Also ensure signature is in form_data for consistency
          if (opData && opData.trim()) {
            approvalPayload.form_data.operations_manager_signature = opData;
            approvalPayload.form_data.opMan_signature = opData;
            console.log('✅ Operations Manager signature included in approval payload (both top-level and form_data)');
          } else {
            console.warn('⚠️ Operations Manager signature is empty - opData:', opData ? 'exists but empty' : 'undefined');
          }
          
          if (operationsManagerComments && operationsManagerComments.trim()) {
            approvalPayload.form_data.operations_manager_comments = operationsManagerComments.trim();
          }
          if (!opData?.trim()) {
            console.warn('⚠️ Operations Manager signature is empty');
          }
          
          console.log('📤 Operations Manager approval payload:', {
            topLevelComments: (approvalPayload.comments || '').substring(0, 80),
            topLevelSignature: (approvalPayload.signature || '').substring(0, 50),
            formDataCommentsLength: (approvalPayload.form_data.operations_manager_comments || '').length,
            formDataSignatureLength: (approvalPayload.form_data.operations_manager_signature || '').length,
            formDataKeys: Object.keys(approvalPayload.form_data || {}),
            workItemsCount: (approvalPayload.form_data.work_items || []).length
          });
          console.log('📤 Full approval payload structure:', JSON.stringify({
            comments: approvalPayload.comments ? 'HAS_COMMENTS' : 'NO_COMMENTS',
            signature: approvalPayload.signature ? 'HAS_SIGNATURE' : 'NO_SIGNATURE',
            form_data_has_om_comments: !!approvalPayload.form_data.operations_manager_comments,
            form_data_has_om_signature: !!approvalPayload.form_data.operations_manager_signature
          }));
          console.log('📤 Approval payload FULL form_data keys:', Object.keys(approvalPayload.form_data || {}));
          console.log('📤 Calling approve-ops-manager endpoint...');
          
          const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve-ops-manager`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(approvalPayload),
            credentials: 'include'
          });
          
          if (!approveRes.ok) {
            const txt = await approveRes.text();
            throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
          }
          
          const approveJson = await approveRes.json();
          if (approveJson.success) {
            const jobId = approveJson.data?.job_id || updateJson.data?.job_id;
            const isRegenerating = approveJson.data?.regenerating || updateJson.data?.regenerating || false;
            
            if (jobId && isRegenerating) {
              statusBox.innerHTML = '<div class="alert alert-info">✅ Form approved! Regenerating documents with your comments and signature... This may take a moment.</div>';
              loadingOverlay.style.display = 'flex';
              const pollFn = window.pollJobStatus || pollJobStatusFn;
              if (pollFn && typeof pollFn === 'function') {
                pollFn(modulePrefix, jobId, (js) => {
                  statusBox.innerHTML = `<div class="alert alert-info">Regenerating documents... ${js.progress || 0}%</div>`;
                }).then(result => {
                  loadingOverlay.style.display = 'none';
                  if (result.state === 'done' || result.status === 'completed') {
                    statusBox.innerHTML = '<div class="alert alert-success">✅ Documents regenerated successfully! <a href="/dashboard">Return to Dashboard</a></div>';
                  } else {
                    statusBox.innerHTML = '<div class="alert alert-danger">❌ Document regeneration failed. Please try again.</div>';
                  }
                }).catch(err => {
                  loadingOverlay.style.display = 'none';
                  statusBox.innerHTML = `<div class="alert alert-danger">❌ Error: ${err.message}</div>`;
                });
              }
            } else {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = `
                <div class="alert alert-success">
                  <h5 class="alert-heading">✅ Form Approved & Signed Successfully!</h5>
                  <hr>
                  <p class="mb-2"><strong>This form will now be sent to:</strong></p>
                  <ul class="mb-0" style="list-style-position: inside;">
                    <li>→ Business Development & Procurement (parallel review)</li>
                    <li>→ General Manager (final approval)</li>
                  </ul>
                  <hr class="mt-3 mb-2">
                  <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
                </div>
              `;
              
              // Update OM signature hint to show "Form signed"
              const opManHint = document.getElementById('opManSignatureHint');
              if (opManHint) {
                opManHint.textContent = '✓ Form signed';
                opManHint.classList.remove('text-danger');
                opManHint.classList.add('text-success');
              }
              
              clearDraft();
            }
          } else {
            throw new Error(approveJson.error || 'Approval failed');
          }
          
          {% elif user_designation == 'business_development' %}
          const businessDevComments = document.getElementById('businessDevComments')?.value || '';
          const bdSigData = (pads && pads.businessDevPad && !pads.businessDevPad.isEmpty()) 
                         ? pads.businessDevPad.toDataURL('image/png') 
                         : (document.getElementById('businessDevSignatureData')?.value || '');
          if (businessDevComments && businessDevComments.trim()) {
            payload.business_dev_comments = businessDevComments.trim();
          }
          if (bdSigData && bdSigData.trim()) {
            payload.business_dev_signature = bdSigData;
            payload.businessDevSignature = bdSigData;
          }
          const updateUrl = `/api/workflow/submissions/${submissionId}/update`;
          const updateBody = {
            site_name: payload.project_name,
            visit_date: payload.visit_date,
            form_data: payload
          };
          const updateRes = await fetch(updateUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(updateBody),
            credentials: 'include'
          });
          if (!updateRes.ok) {
            const txt = await updateRes.text();
            throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
          }
          const updateJson = await updateRes.json();
          if (!updateJson.success) {
            throw new Error(updateJson.error || 'Update failed');
          }
          const bdApprovalPayload = {
            comments: businessDevComments || '',
            signature: bdSigData || '',
            form_data: payload
          };
          if (!bdApprovalPayload.form_data.business_dev_comments && businessDevComments?.trim()) {
            bdApprovalPayload.form_data.business_dev_comments = businessDevComments.trim();
          }
          if (!bdApprovalPayload.form_data.business_dev_signature && bdSigData?.trim()) {
            bdApprovalPayload.form_data.business_dev_signature = bdSigData;
            bdApprovalPayload.form_data.businessDevSignature = bdSigData;
          }
          
          console.log('📤 Business Development approval payload:', {
            commentsLength: (businessDevComments || '').length,
            signatureLength: (bdSigData || '').length,
            workItemsCount: (bdApprovalPayload.form_data.work_items || []).length
          });
          
          const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve-bd`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(bdApprovalPayload),
            credentials: 'include'
          });
          
          if (!approveRes.ok) {
            const txt = await approveRes.text();
            throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
          }
          
          const approveJson = await approveRes.json();
          if (approveJson.success) {
            loadingOverlay.style.display = 'none';
            statusBox.innerHTML = `
              <div class="alert alert-success">
                <h5 class="alert-heading">✅ Form Approved & Signed Successfully!</h5>
                <hr>
                <p class="mb-2"><strong>${approveJson.data?.message || approveJson.message || 'Approved successfully. Waiting for Procurement approval.'}</strong></p>
                <hr class="mt-3 mb-2">
                <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
              </div>
            `;
            
            // Update BD signature hint
            const bdHint = document.getElementById('bdSignatureHint');
            if (bdHint) {
              bdHint.textContent = '✓ Form signed';
              bdHint.classList.remove('text-danger');
              bdHint.classList.add('text-success');
            }
            
            clearDraft();
          } else {
            throw new Error(approveJson.error || 'Approval failed');
          }
          
          {% elif user_designation == 'procurement' %}
          const procurementComments = document.getElementById('procurementComments')?.value || '';
          const procurementSigData = (pads && pads.procurementPad && !pads.procurementPad.isEmpty()) 
                                   ? pads.procurementPad.toDataURL('image/png') 
                                   : (document.getElementById('procurementSignatureData')?.value || '');
          if (procurementComments && procurementComments.trim()) {
            payload.procurement_comments = procurementComments.trim();
          }
          if (procurementSigData && procurementSigData.trim()) {
            payload.procurement_signature = procurementSigData;
            payload.procurementSignature = procurementSigData;
          }
          const updateUrl = `/api/workflow/submissions/${submissionId}/update`;
          const updateBody = {
            site_name: payload.project_name,
            visit_date: payload.visit_date,
            form_data: payload
          };
          const updateRes = await fetch(updateUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(updateBody),
            credentials: 'include'
          });
          if (!updateRes.ok) {
            const txt = await updateRes.text();
            throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
          }
          const updateJson = await updateRes.json();
          if (!updateJson.success) {
            throw new Error(updateJson.error || 'Update failed');
          }
          const procurementApprovalPayload = {
            comments: procurementComments || '',
            signature: procurementSigData || '',
            form_data: payload
          };
          if (!procurementApprovalPayload.form_data.procurement_comments && procurementComments?.trim()) {
            procurementApprovalPayload.form_data.procurement_comments = procurementComments.trim();
          }
          if (!procurementApprovalPayload.form_data.procurement_signature && procurementSigData?.trim()) {
            procurementApprovalPayload.form_data.procurement_signature = procurementSigData;
            procurementApprovalPayload.form_data.procurementSignature = procurementSigData;
          }
          
          console.log('📤 Procurement approval payload:', {
            commentsLength: (procurementComments || '').length,
            signatureLength: (procurementSigData || '').length,
            workItemsCount: (procurementApprovalPayload.form_data.work_items || []).length
          });
          
          const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve-procurement`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(procurementApprovalPayload),
            credentials: 'include'
          });
          
          if (!approveRes.ok) {
            const txt = await approveRes.text();
            throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
          }
          
          const approveJson = await approveRes.json();
          if (approveJson.success) {
            loadingOverlay.style.display = 'none';
            statusBox.innerHTML = `
              <div class="alert alert-success">
                <h5 class="alert-heading">✅ Form Approved & Signed Successfully!</h5>
                <hr>
                <p class="mb-2"><strong>${approveJson.data?.message || approveJson.message || 'Approved successfully. Waiting for Business Development approval.'}</strong></p>
                <hr class="mt-3 mb-2">
                <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
              </div>
            `;
            
            // Update Procurement signature hint
            const procurementHint = document.getElementById('procurementSignatureHint');
            if (procurementHint) {
              procurementHint.textContent = '✓ Form signed';
              procurementHint.classList.remove('text-danger');
              procurementHint.classList.add('text-success');
            }
            
            clearDraft();
          } else {
            throw new Error(approveJson.error || 'Approval failed');
          }
          
          {% elif user_designation == 'general_manager' %}
          const generalManagerComments = document.getElementById('generalManagerComments')?.value || '';
          const gmSigData = (pads && pads.generalManagerPad && !pads.generalManagerPad.isEmpty()) 
                         ? pads.generalManagerPad.toDataURL('image/png') 
                         : (document.getElementById('generalManagerSignatureData')?.value || '');
          if (generalManagerComments && generalManagerComments.trim()) {
            payload.general_manager_comments = generalManagerComments.trim();
          }
          if (gmSigData && gmSigData.trim()) {
            payload.general_manager_signature = gmSigData;
            payload.generalManagerSignature = gmSigData;
          }
          const updateUrl = `/api/workflow/submissions/${submissionId}/update`;
          const updateBody = {
            site_name: payload.project_name,
            visit_date: payload.visit_date,
            form_data: payload
          };
          const updateRes = await fetch(updateUrl, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(updateBody),
            credentials: 'include'
          });
          if (!updateRes.ok) {
            const txt = await updateRes.text();
            throw new Error('Update failed: ' + updateRes.status + ' ' + txt);
          }
          const updateJson = await updateRes.json();
          if (!updateJson.success) {
            throw new Error(updateJson.error || 'Update failed');
          }
          const gmApprovalPayload = {
            comments: generalManagerComments || '',
            signature: gmSigData || '',
            form_data: payload
          };
          if (!gmApprovalPayload.form_data.general_manager_comments && generalManagerComments?.trim()) {
            gmApprovalPayload.form_data.general_manager_comments = generalManagerComments.trim();
          }
          if (!gmApprovalPayload.form_data.general_manager_signature && gmSigData?.trim()) {
            gmApprovalPayload.form_data.general_manager_signature = gmSigData;
            gmApprovalPayload.form_data.generalManagerSignature = gmSigData;
          }
          
          console.log('📤 General Manager approval payload:', {
            commentsLength: (generalManagerComments || '').length,
            signatureLength: (gmSigData || '').length,
            workItemsCount: (gmApprovalPayload.form_data.work_items || []).length
          });
          
          const approveRes = await fetch(`/api/workflow/submissions/${submissionId}/approve-gm`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(gmApprovalPayload),
            credentials: 'include'
          });
          
          if (!approveRes.ok) {
            const txt = await approveRes.text();
            throw new Error('Approval failed: ' + approveRes.status + ' ' + txt);
          }
          
          const approveJson = await approveRes.json();
          if (approveJson.success) {
            const jobId = approveJson.data?.job_id || updateJson.data?.job_id;
            const isRegenerating = approveJson.data?.regenerating || updateJson.data?.regenerating || false;
            
            if (jobId && isRegenerating) {
              statusBox.innerHTML = '<div class="alert alert-info">✅ Form approved! Regenerating final documents with all signatures... This may take a moment.</div>';
              loadingOverlay.style.display = 'flex';
              const pollFn = window.pollJobStatus || pollJobStatusFn;
              if (pollFn && typeof pollFn === 'function') {
                pollFn(modulePrefix, jobId, (js) => {
                  statusBox.innerHTML = `<div class="alert alert-info">Regenerating documents... ${js.progress || 0}%</div>`;
                }).then(result => {
                  loadingOverlay.style.display = 'none';
                  if (result.state === 'done' || result.status === 'completed') {
                    statusBox.innerHTML = '<div class="alert alert-success">✅ Documents regenerated successfully! <a href="/dashboard">Return to Dashboard</a></div>';
                  } else {
                    statusBox.innerHTML = '<div class="alert alert-danger">❌ Document regeneration failed. Please try again.</div>';
                  }
                }).catch(err => {
                  loadingOverlay.style.display = 'none';
                  statusBox.innerHTML = `<div class="alert alert-danger">❌ Error: ${err.message}</div>`;
                });
              }
            } else {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = `
                <div class="alert alert-success">
                  <h5 class="alert-heading">✅ Form Completed Successfully!</h5>
                  <hr>
                  <p class="mb-2"><strong>${approveJson.data?.message || approveJson.message || 'All approvals complete. Form is now finalized.'}</strong></p>
                  <hr class="mt-3 mb-2">
                  <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
                </div>
              `;
              
              // Update GM signature hint
              const gmHint = document.getElementById('gmSignatureHint');
              if (gmHint) {
                gmHint.textContent = '✓ Form signed';
                gmHint.classList.remove('text-danger');
                gmHint.classList.add('text-success');
              }
              
              clearDraft();
            }
          } else {
            throw new Error(approveJson.error || 'Approval failed');
          }
          
          {% else %}
          // Admin role - use admin endpoint
          const res = await fetch(`/api/admin/submissions/${submissionId}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify({
              site_name: payload.project_name,
              visit_date: payload.visit_date,
              form_data: payload
            }),
            credentials: 'include'
          });
          
          if (!res.ok) {
            const txt = await res.text();
            throw new Error('Server error: ' + res.status + ' ' + txt);
          }
          
          const json = await res.json();
          
          if (json.success) {
            if (json.data && json.data.job_id && json.data.regenerating) {
              statusBox.innerHTML = '<div class="alert alert-info">✅ Submission updated! Regenerating documents... This may take a moment.</div>';
              loadingOverlay.style.display = 'flex';
              const pollFn = window.pollJobStatus || pollJobStatusFn;
              if (pollFn && typeof pollFn === 'function') {
                pollFn(modulePrefix, json.data.job_id, (js) => {
                  statusBox.innerHTML = `<div class="alert alert-info">Regenerating documents... ${js.progress || 0}%</div>`;
                }).then(result => {
                  loadingOverlay.style.display = 'none';
                  if (result.state === 'done' || result.status === 'completed') {
                    statusBox.innerHTML = '<div class="alert alert-success">✅ Documents regenerated successfully! <a href="/dashboard">Return to Dashboard</a></div>';
                  } else {
                    statusBox.innerHTML = '<div class="alert alert-danger">❌ Document regeneration failed. Please try again.</div>';
                  }
                }).catch(err => {
                  loadingOverlay.style.display = 'none';
                  statusBox.innerHTML = `<div class="alert alert-danger">❌ Error: ${err.message}</div>`;
                });
              } else {
                loadingOverlay.style.display = 'none';
                statusBox.innerHTML = '<div class="alert alert-success">✅ Submission updated! Documents are being regenerated in the background. <a href="/dashboard">Return to Dashboard</a></div>';
              }
            } else {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = '<div class="alert alert-success">✅ Submission updated successfully! <a href="/dashboard">Return to Dashboard</a></div>';
              clearDraft();
            }
          } else {
            throw new Error(json.error || 'Update failed');
          }
          {% endif %}
          {% endif %}
        {% else %}
          // Create new submission
          const submitUrl = modulePrefix + '/submit-with-urls';
          const token = localStorage.getItem('access_token');
          const headers = { 'Content-Type': 'application/json' };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          const res = await fetch(submitUrl, { 
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload),
            credentials: 'include'
          });
          
          if (!res.ok) {
            const txt = await res.text();
            let message = txt;
            try {
              const parsed = JSON.parse(txt);
              message = parsed.error || parsed.message || parsed.details || txt;
            } catch (e) {
              // not JSON
            }
            throw new Error(`Server error: ${res.status} ${message}`);
          }
          
          const json = await res.json();
          
          // Hide upload modal, show loading overlay
          uploadModal.style.display = 'none';
          loadingOverlay.style.display = 'flex';
          
          if (json.job_id) {
            clearDraft(); // Clear draft after successful submission
            
            // Ensure pollJobStatusFn is available - use multiple fallbacks
            let pollFn = null;
            try {
              // First try: use the pollJobStatusFn defined at the top of the IIFE
              if (typeof pollJobStatusFn !== 'undefined') {
                pollFn = pollJobStatusFn;
              }
              // Second try: use window.pollJobStatusFn
              else if (typeof window !== 'undefined' && typeof window.pollJobStatusFn !== 'undefined') {
                pollFn = window.pollJobStatusFn;
              }
              // Third try: use window.pollJobStatus
              else if (typeof window !== 'undefined' && typeof window.pollJobStatus !== 'undefined') {
                pollFn = window.pollJobStatus;
              }
              // Fourth try: define it inline as last resort
              else {
                pollFn = async function(modulePrefix, jobId, onUpdate, interval=1500) {
                  const statusUrl = `${modulePrefix}/status/${jobId}`;
                  return new Promise((resolve, reject) => {
                    const id = setInterval(async () => {
                      try {
                        const r = await fetch(statusUrl);
                        if (!r.ok) throw new Error('Job not found');
                        const js = await r.json();
                        if (onUpdate) onUpdate(js);
                        const isDone = js.state === 'done' || js.status === 'completed';
                        const isFailed = js.state === 'failed' || js.status === 'failed';
                        if (isDone || isFailed) {
                          clearInterval(id);
                          resolve(js);
                        }
                      } catch (e) {
                        clearInterval(id);
                        reject(e);
                      }
                    }, interval);
                  });
                };
              }
            } catch (e) {
              console.error('Error getting pollJobStatus function:', e);
            }
            
            if (!pollFn || typeof pollFn !== 'function') {
              loadingOverlay.style.display = 'none';
              statusBox.innerHTML = '<div class="alert alert-danger">❌ Error: pollJobStatus function not available. Please refresh the page.</div>';
              console.error('pollFn is not a function. pollJobStatusFn:', typeof pollJobStatusFn, 'window.pollJobStatusFn:', typeof (window && window.pollJobStatusFn), 'window.pollJobStatus:', typeof (window && window.pollJobStatus));
              return;
            }
            
            const jobId = json.job_id;
            pollFn(modulePrefix, jobId, (js) => {
              statusBox.innerHTML = `<div class="alert alert-info">Generating reports... ${js.progress || 0}%</div>`;
            }).then(result => {
              loadingOverlay.style.display = 'none';
              
              // Debug logging
              console.log('Job polling completed. Full result:', result);
              
              // Check both 'state' (legacy) and 'status' (current)
              const isDone = result.state === 'done' || result.status === 'completed';
              const isFailed = result.state === 'failed' || result.status === 'failed';
              
              // Support both 'results' and 'result_data'
              const results = result.results || result.result_data || {};
              
              if (window.safeLog) {
                window.safeLog.log('Extracted results:', results);
                window.safeLog.log('Is done?', isDone, 'Status:', result.status, 'State:', result.state);
              }
              
              if (isDone) {
                loadingOverlay.style.display = 'none';
                
                // Check for download links (Excel and PDF) - support both excel_url/pdf_url AND excel/pdf field names
                const excelUrl = results.excel_url || results.excel;
                const pdfUrl = results.pdf_url || results.pdf;
                
                // Get download container
                const downloadContainer = document.getElementById('download-links-container');
                const links = [];
                
                // Create download buttons - use download endpoint (it handles both local and Cloudinary files)
                // The download endpoint fetches file URLs from job results in the database
                if (excelUrl) {
                  const excelBtn = document.createElement('a');
                  excelBtn.href = `${modulePrefix}/download/${jobId}/excel`;
                  // Don't use download attribute - let the server's Content-Disposition header handle it
                  // This prevents browser from trying to open local file paths
                  excelBtn.className = 'btn btn-success me-2 mt-2';
                  excelBtn.style.cssText = 'text-decoration: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; display: inline-block; font-weight: 600;';
                  excelBtn.textContent = '📥 Download Excel Report';
                  links.push(excelBtn);
                }
                
                if (pdfUrl) {
                  const pdfBtn = document.createElement('a');
                  pdfBtn.href = `${modulePrefix}/download/${jobId}/pdf`;
                  // Don't use download attribute - let the server's Content-Disposition header handle it
                  // This prevents browser from trying to open local file paths
                  pdfBtn.className = 'btn btn-success me-2 mt-2';
                  pdfBtn.style.cssText = 'text-decoration: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; display: inline-block; font-weight: 600;';
                  pdfBtn.textContent = '📥 Download PDF Report';
                  links.push(pdfBtn);
                }
                
                // Show workflow progression message for supervisor submissions
                {% if user_designation == 'supervisor' %}
                if (downloadContainer && links.length > 0) {
                  // Show both workflow message and download links
                  const successMsg = document.createElement('div');
                  successMsg.className = 'alert alert-success mb-3';
                  successMsg.innerHTML = `
                    <h5 class="alert-heading">✅ Form Signed Successfully!</h5>
                    <hr style="margin: 0.5rem 0;">
                    <p class="mb-2"><strong>This form will now be sent to:</strong></p>
                    <ul class="mb-2" style="list-style-position: inside;">
                      <li>→ Operations Manager</li>
                      <li>→ Business Development & Procurement (parallel review)</li>
                      <li>→ General Manager (final approval)</li>
                    </ul>
                    <p class="mb-0 small">Download your PDF and Excel reports below.</p>
                  `;
                  downloadContainer.innerHTML = '';
                  downloadContainer.appendChild(successMsg);
                  
                  // Add download buttons
                  links.forEach(btn => downloadContainer.appendChild(btn));
                  
                  // Add Return to Dashboard button
                  const dashboardBtn = document.createElement('a');
                  dashboardBtn.href = '/dashboard';
                  dashboardBtn.className = 'btn btn-primary me-2 mt-2';
                  dashboardBtn.style.cssText = 'text-decoration: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; display: inline-block; font-weight: 600;';
                  dashboardBtn.textContent = '← Return to Dashboard';
                  downloadContainer.appendChild(dashboardBtn);
                  
                  downloadContainer.style.display = 'block';
                  statusBox.style.display = 'none';
                } else {
                  // No download links, show workflow message in statusBox
                  statusBox.innerHTML = `
                    <div class="alert alert-success">
                      <h5 class="alert-heading">✅ Form Signed Successfully!</h5>
                      <hr>
                      <p class="mb-2"><strong>This form will now be sent to:</strong></p>
                      <ul class="mb-0" style="list-style-position: inside;">
                        <li>→ Operations Manager</li>
                        <li>→ Business Development & Procurement (parallel review)</li>
                        <li>→ General Manager (final approval)</li>
                      </ul>
                      <hr class="mt-3 mb-2">
                      <a href="/dashboard" class="btn btn-sm btn-primary">Return to Dashboard</a>
                    </div>
                  `;
                }
                clearDraft();
                {% else %}
                // For non-supervisors, show download links
                if (downloadContainer && links.length > 0) {
                  const successMsg = document.createElement('div');
                  successMsg.className = 'alert alert-success mb-3';
                  successMsg.innerHTML = '<strong>✅ Reports generated successfully!</strong>';
                  downloadContainer.innerHTML = '';
                  downloadContainer.appendChild(successMsg);
                  
                  // Add download buttons
                  links.forEach(btn => downloadContainer.appendChild(btn));
                  
                  // Add Return to Dashboard button
                  const dashboardBtn = document.createElement('a');
                  dashboardBtn.href = '/dashboard';
                  dashboardBtn.className = 'btn btn-primary me-2 mt-2';
                  dashboardBtn.style.cssText = 'text-decoration: none; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; display: inline-block; font-weight: 600;';
                  dashboardBtn.textContent = '← Return to Dashboard';
                  downloadContainer.appendChild(dashboardBtn);
                  
                  downloadContainer.style.display = 'block';
                  statusBox.style.display = 'none';
                } else if (downloadContainer && links.length === 0) {
                  downloadContainer.innerHTML = '<div class="alert alert-warning"><strong>⚠️ Job completed but no download links found.</strong></div>';
                  downloadContainer.style.display = 'block';
                statusBox.style.display = 'none';
                } else {
                  statusBox.innerHTML = '<div class="alert alert-success">✅ Reports generated successfully!</div>';
                }
                {% endif %}
              } else if (isFailed) {
                statusBox.innerText = "❌ Job failed: " + (result.error || JSON.stringify(results));
              } else {
                statusBox.innerText = "❌ Unknown job state: " + JSON.stringify(result);
              }
            }).catch(err => {
              loadingOverlay.style.display = 'none';
              statusBox.innerText = "❌ Error polling job status: " + err.message;
            });
          } else {
            loadingOverlay.style.display = 'none';
            statusBox.innerHTML = '<div class="alert alert-warning">Submission accepted but no job ID</div>';
          }
          {% endif %}
        } catch (err) {
          loadingOverlay.style.display = 'none';
          statusBox.innerHTML = `<div class="alert alert-danger">❌ Submission failed: ${err.message}</div>`;
        }
      });
    })();
  </script>
</body>
</html>