<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>HVAC & MEP - Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
</head>
<body class="p-4">
  <div class="container">
    <h2>HVAC & MEP Form</h2>

    <form id="mainForm">
      <div class="mb-3">
        <label for="site_name">Site name</label>
        <input id="site_name" name="site_name" class="form-control" required>
      </div>

      <div class="mb-3">
        <label for="visit_date">Date</label>
        <input id="visit_date" name="visit_date" type="date" class="form-control" required>
      </div>

      <div class="mb-3">
        <label>Technician Signature</label>
        <canvas id="techSignaturePad" style="border:1px solid #ccc; width:100%; height:120px;"></canvas>
      </div>

      <div class="mb-3">
        <label>Operation Manager Signature</label>
        <canvas id="opManSignaturePad" style="border:1px solid #ccc; width:100%; height:120px;"></canvas>
      </div>

      <div class="mb-3">
        <label for="photos">Photos</label>
        <input id="photos" name="photos" type="file" multiple class="form-control">
      </div>

      <button type="button" id="submitBtn" class="btn btn-primary">Submit</button>
      <div id="statusBox" class="mt-3"></div>
    </form>
  </div>

  <script>
    const modulePrefix = "{{ url_for('hvac_mep_bp.index') }}".replace('/form','');
  </script>
  <script src="{{ url_for('static', filename='form.js') }}"></script>
  <script>
    (function(){
      const form = document.getElementById('mainForm');
      const statusBox = document.getElementById('statusBox');
      const pads = initSignaturePads();

      document.getElementById('submitBtn').addEventListener('click', async () => {
        statusBox.innerText = "Submitting...";
        try {
          const data = await submitForm(modulePrefix, form, pads);
          statusBox.innerText = "Queued job: " + data.job_id;
          const result = await pollJobStatus(modulePrefix, data.job_id, (js) => {
            statusBox.innerText = `State: ${js.state}, progress: ${js.progress}%`;
          });
          if (result.state === 'done') {
            const links = result.results.map(r => `<a href="${r.url}" target="_blank">${r.filename}</a>`).join('<br>');
            statusBox.innerHTML = `Done.<br>${links}`;
          } else {
            statusBox.innerText = "Job failed: " + JSON.stringify(result.results);
          }
        } catch (e) {
          statusBox.innerText = "Error: " + e.message;
        }
      });
    })();
  </script>
</body>
</html>